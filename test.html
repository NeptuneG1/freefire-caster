<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FFBR — Player Performance</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
    --brand:#ffbd59; --brand2:#ff7733; --line:#313131;
    --heat-rgb:255,189,89; --heat-min:.06; --heat-max:.22; --heat-top-outline:.42; --heat-radius:8px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
  h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
  .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
  .chip{font-size:.85rem;color:#ddd}
  .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}
  .shell{max-width:1100px;margin:22px auto;padding:0 12px}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
  .section h2{margin:0 0 10px;color:var(--brand)}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
  .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
  .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 8px;font-size:.9rem}
  .muted{color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipbtn{cursor:pointer;border:1px solid #3a3a3a;background:#1a1a1a;color:#e6e6e6;border-radius:999px;padding:6px 10px;font-weight:700}
  .chipbtn:hover{border-color:#555}
  .chipbtn.active{background:var(--brand2);color:#111;border-color:#000}
  details.accordion{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:0;margin-bottom:14px}
  details.accordion > summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line);user-select:none}
  details.accordion[open] > summary{border-bottom-color:var(--line)}
  details.accordion > .accordion-body{padding:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
  thead th{background:#191919;position:sticky;top:0;text-align:left;border-radius:8px;padding:8px 6px}
  th,td{padding:6px 6px;vertical-align:top}
  .right{text-align:right}
  td[data-key]{transition:background-color .18s ease, box-shadow .18s ease;border-radius:var(--heat-radius);background-clip:padding-box}
  td.heat-top{box-shadow:inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline))}
  .skillcell{display:flex;align-items:center;gap:8px}
  .skillcell img{width:28px;height:28px;object-fit:cover;border-radius:6px;border:1px solid #2a2a2a;background:#0f0f0f}
  @media (max-width: 880px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>FFBR — Player Performance</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <!-- PLAYER FILTER -->
  <div class="section">
    <h2>Player</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <label style="flex:1;min-width:240px">
        <input type="search" id="playerSearch" placeholder="Type and press Enter…" class="btn secondary" style="width:100%;padding:10px">
      </label>
      <label>
        <select id="playerSelect" class="btn secondary" style="min-width:220px;padding:10px">
          <option value="">— Select player —</option>
        </select>
      </label>
      <button class="btn secondary" id="clearPlayer">Clear</button>
      <button class="btn" id="copyLink">Copy Link</button>
    </div>
    <div class="muted" id="pickerHint">Loading…</div>
    <div id="playerChips" class="chips">—</div>
  </div>

  <!-- OVERVIEW -->
  <div class="section" id="playerHeader">
    <h2 id="playerTitle">Player Overview</h2>
    <div class="grid2">
      <div class="card" id="playerIdentity">
        <h3>Identity</h3>
        <div id="identityBody" class="muted">Select a player.</div>
      </div>
      <div class="card" id="playerKPIs">
        <h3>Key KPIs</h3>
        <div id="kpiBody">—</div>
      </div>
    </div>
  </div>

  <!-- RECENT ENTRIES (Top 10 for selected player) -->
  <details class="accordion" open>
    <summary>Recent Entries (Top 10)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblRecent">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: ACTIVE SKILL (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Active Skill Usage — All Players (Top 10)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblActive">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: PET (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Pet Usage — All Players (Top 10)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblPet">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: TOP 10 PLAYERS BY KILLS -->
  <details class="accordion" open>
    <summary>Top 10 Players by Kills</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblTopKillers">—</div>
      </div>
    </div>
  </details>
</div>

<script>
/* ===== Supabase ===== */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);
(async ()=>{
  const { data: { session } } = await client.auth.getSession();
  // If your RLS allows anon reads you can comment out the redirect:
  if (!session) { /* window.location.href = 'index.html'; */ }
  const ui = document.getElementById('user-info');
  if (ui && session?.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
  else ui.textContent = 'Anon access';
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ===== Utils ===== */
const el = id => document.getElementById(id);
const norm = v => (v==null ? '' : String(v).trim());
const n = v => {
  if (v == null || v === '') return 0;
  const x = typeof v === 'number' ? v : parseFloat(String(v).replace(/,/g,''));
  return Number.isFinite(x) ? x : 0;
};
const uniq = arr => Array.from(new Set(arr));
const sum = (arr, k) => arr.reduce((t,r)=> t + n(r[k]), 0);
function getCI(obj, ...names){
  if (!obj) return '';
  const keys = Object.keys(obj);
  for (const want of names){
    const k = keys.find(x => x.toLowerCase() === String(want).toLowerCase());
    if (k) return obj[k];
  }
  for (const want of names){
    const rx = new RegExp('^'+String(want).replace(/\s+/g,'\\s*')+'$','i');
    const k = keys.find(x => rx.test(x));
    if (k) return obj[k];
  }
  // fuzzy: collapse whitespace and compare
  const wantLow = names.map(s => String(s).toLowerCase().replace(/\s+/g,' ').trim());
  for (const k of keys){
    const lk = k.toLowerCase().replace(/\s+/g,' ').trim();
    if (wantLow.includes(lk)) return obj[k];
  }
  return '';
}

/* ===== Normalizer for ffbr_lopsdata ===== */
function normalizeRow(r){
  const o = {...r};
  o._created   = getCI(o,'created_at','Created','Timestamp') || null;
  o._id        = n(getCI(o,'id','ID'));
  o._player    = norm(getCI(o,'Player name','Player Name','Player','IGN'));
  o._team      = norm(getCI(o,'Team','TAG','TeamName','Team Name'));
  o._map       = norm(getCI(o,'Map','map','Match Map'));
  o.kills      = n(getCI(o,'KILLS','Kills','Kill'));
  o.assists    = n(getCI(o,'ASSISTS','Assists','Assist'));
  o.headshots  = n(getCI(o,'HEADSHOTRS','HEADSHOTS','Headshots','HS'));
  o.damage     = n(getCI(o,'DAMAGE','Damage','DMG'));
  o.grenade    = n(getCI(o,'Grenade kill','Grenade kills','Nade Kills','Grenade'));
  o.active     = norm(getCI(o,'Active Skill','Active','Skill','ActiveSkill'));
  o.pet        = norm(getCI(o,'Pet','Pet Name','PetName'));
  o._tournament= norm(getCI(o,'Tournament','Event','Series'));
  return o;
}

/* ===== Character index (character.json) ===== */
let CHARIDX = new Map();
const NC = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

function dig(obj, ...paths){
  for (const p of paths){
    try{
      const parts = Array.isArray(p) ? p : String(p).split('.');
      let cur = obj;
      for (const seg of parts){ if (cur==null) break; cur = cur[seg]; }
      if (cur != null && cur !== '') return cur;
    }catch{}
  }
  return '';
}
function indexCharacters(list){
  const m = new Map();
  for (const c of list){
    const name = norm(c.name || c.Name || c.character || c.title);
    const portrait = dig(c, 'icon','image','portrait','img','images.portrait','images.icon') || '';
    const activeName = dig(c, 'active.name','skill.active.name','skill.name','activeSkill.name','ability.active.name') || name;
    const activeDesc = dig(c, 'active.desc','skill.active.desc','skill.description','activeSkill.description','ability.active.description') || '';
    const aliases = (c.aliases || c.Aliases || []).map(norm).filter(Boolean);
    const keyset = new Set([name, ...aliases]);
    keyset.forEach(k => m.set(NC(k), { name, portrait, activeName, activeDesc }));
  }
  return m;
}
async function loadCharacters(){
  try{
    const resp = await fetch('character.json', { cache:'no-store' });
    if (resp.ok){
      const json = await resp.json();
      CHARIDX = indexCharacters(json);
    }
  }catch(e){ console.warn('character.json fetch failed:', e); }
}
function charInfoForActive(activeName){
  if (!activeName) return null;
  const key = NC(activeName);
  return CHARIDX.get(key) || null;
}

/* ===== Data fetch (no fragile order) ===== */
async function fetchAllRows(){
  const CHUNK = 1000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_lopsdata')
      .select('*')
      .range(from, from + CHUNK - 1);
    if (error){ console.error('ffbr_lopsdata fetch failed:', error); break; }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }
  const normed = out.map(normalizeRow);
  // show basic status
  document.getElementById('pickerHint').textContent = `Loaded ${normed.length} rows • Columns detected (example): ${Object.keys(out[0]||{}).slice(0,8).join(', ')}${Object.keys(out[0]||{}).length>8?'…':''}`;
  return normed.filter(r => r._player);
}

/* ===== Heatmap ===== */
function applyColumnHeatmap(containerId, keys){
  const wrap = el(containerId);
  const table = wrap?.querySelector('table'); if (!table) return;
  table.querySelectorAll('td[data-key]').forEach(td=>{
    td.style.backgroundColor = ''; td.classList.remove('heat-top');
  });
  const styles = getComputedStyle(document.documentElement);
  const rgb    = styles.getPropertyValue('--heat-rgb') || '255,189,89';
  const minA   = parseFloat(styles.getPropertyValue('--heat-min')) || .06;
  const maxA   = parseFloat(styles.getPropertyValue('--heat-max')) || .22;
  const radius = styles.getPropertyValue('--heat-radius') || '8px';
  const BANDS  = 5;
  for (const key of keys){
    const cells = Array.from(table.querySelectorAll(`td[data-key="${key}"]`));
    if (!cells.length) continue;
    const entries = cells.map((td,i)=>{
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      return { td, i, v: isFinite(v) ? v : null };
    }).filter(e => e.v != null);
    if (!entries.length) continue;
    const asc = entries.slice().sort((a,b)=> a.v - b.v);
    const n   = asc.length;
    const topVal = asc[n-1].v;
    const bandByIndex = new Map();
    asc.forEach((e, rank)=>{
      const p = (n<=1) ? 1 : (rank/(n-1));
      const band = Math.min(BANDS-1, Math.floor(p * BANDS));
      bandByIndex.set(e.i, band);
    });
    cells.forEach((td,i)=>{
      const band = bandByIndex.get(i);
      if (band == null) return;
      const alpha = minA + ((band)/(BANDS-1)) * (maxA - minA);
      td.style.backgroundColor = `rgba(${rgb}, ${alpha.toFixed(3)})`;
      td.style.borderRadius = radius;
      td.style.backgroundClip = 'padding-box';
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      if (isFinite(v) && v === topVal) td.classList.add('heat-top');
    });
  }
}

/* ===== Render helpers ===== */
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.html) v = c.html(r);
    else if (c.format==='pct') v = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
    else if (c.format==='1d') v = isFinite(v) ? Number(v).toFixed(1) : '—';
    else if (c.format==='2d') v = isFinite(v) ? Number(v).toFixed(2) : '—';
    else if (c.format==='0d') v = isFinite(v) ? Number(v).toFixed(0) : '—';
    return `<td data-key="${c.key}" class="${c.right?'right':''}">${(v==null||v==='')?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}

function identityBlock(playerName, rows){
  const teams = uniq(rows.map(r=>r._team).filter(Boolean)).join(', ') || '—';
  const tourns = uniq(rows.map(r=>r._tournament).filter(Boolean)).length;
  return `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:72px;height:72px;border:1px solid #2a2a2a;border-radius:10px;background:#111;display:flex;align-items:center;justify-content:center;font-weight:800">${(playerName||'?').slice(0,2).toUpperCase()}</div>
      <div>
        <div style="font-size:1.1rem;font-weight:800">${playerName||'—'}</div>
        <div class="muted">${teams} • ${tourns||0} tournament(s)</div>
      </div>
    </div>`;
}

function kpisForPlayer(rows){
  const cnt = rows.length;
  const kills = sum(rows,'kills');
  const assists = sum(rows,'assists');
  const hs = sum(rows,'headshots');
  const dmg = sum(rows,'damage');
  const gk = sum(rows,'grenade');
  return {
    rows: cnt, kills, assists, hs, dmg, gk,
    kpr: cnt? kills/cnt : 0,
    apr: cnt? assists/cnt : 0,
    dpr: cnt? dmg/cnt : 0,
    hsr: kills? hs/kills : 0,
  };
}
function renderOverview(player, rows){
  el('playerTitle').textContent = player ? `Player Overview — ${player}` : 'Player Overview';
  el('identityBody').innerHTML = player ? identityBlock(player, rows) : 'Select a player.';
  const k = kpisForPlayer(rows);
  el('kpiBody').innerHTML = k.rows ? `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.rows}</strong></div>
      <div class="kpi">Kills <strong>${k.kills}</strong> <span class="muted">(${k.kpr.toFixed(2)}/row)</span></div>
      <div class="kpi">Assists <strong>${k.assists}</strong> <span class="muted">(${k.apr.toFixed(2)}/row)</span></div>
      <div class="kpi">Grenade <strong>${k.gk}</strong></div>
      <div class="kpi">Damage <strong>${Math.round(k.dmg)}</strong> <span class="muted">(${Math.round(k.dpr)}/row)</span></div>
      <div class="kpi">Headshots <strong>${k.hs}</strong> <span class="muted">(${(k.hsr*100).toFixed(1)}%)</span></div>
    </div>` : '<div class="muted">—</div>';
}

/* ===== Tables ===== */
// Recent for selected player
function renderRecent(rows){
  const sorted = rows.slice().sort((a,b)=>{
    const ad = new Date(a._created||0).getTime() || 0;
    const bd = new Date(b._created||0).getTime() || 0;
    if (ad !== bd) return bd - ad;
    return (b._id||0) - (a._id||0);
  }).slice(0,10);
  const cols = [
    { label:'Map', key:'_map' },
    { label:'Tournament', key:'_tournament' },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
  ];
  el('tblRecent').innerHTML = renderSimpleTable(sorted, cols);
  applyColumnHeatmap('tblRecent', ['kills','assists','headshots','grenade','damage']);
}

// Aggregate helper
function aggregateBy(rows, key){
  const m = new Map();
  for (const r of rows){
    const k = norm(r[key]) || '—';
    if (!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  }
  const out = [];
  for (const [name, list] of m.entries()){
    const picks = list.length;
    const kills = sum(list,'kills');
    const assists = sum(list,'assists');
    const headshots = sum(list,'headshots');
    const grenade = sum(list,'grenade');
    const damage = sum(list,'damage');
    out.push({
      name, picks, kills, assists, headshots, grenade, damage,
      kpr: picks? kills/picks : 0,
      dpr: picks? damage/picks : 0,
      hsr: kills? headshots/kills : 0
    });
  }
  return out;
}

// GLOBAL: Active (ALL players)
function renderActiveGlobal(allRows){
  const agg = aggregateBy(allRows, 'active')
    .sort((a,b)=> b.picks - a.picks || b.kills - a.kills || a.name.localeCompare(b.name))
    .slice(0,10);
  const cols = [
    { label:'Active Skill', key:'name', html:(r)=>{
        const ci = charInfoForActive(r.name);
        if (ci){
          const tip = (ci.activeDesc||'').replace(/"/g,'&quot;');
          return `<div class="skillcell" title="${tip}">
            <img src="${ci.portrait||''}" alt="${ci.name||r.name}">
            <div><div style="font-weight:700">${ci.name||r.name}</div>
            <div class="muted" style="font-size:.78rem;line-height:1.2">${ci.activeName||''}</div></div>
          </div>`;
        }
        return `<div class="skillcell"><img src="" alt="" style="display:none"><div><div style="font-weight:700">${r.name||'—'}</div></div></div>`;
      }},
    { label:'Picks', key:'picks', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'HS %', key:'hsr', format:'pct', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
    { label:'Kills/row', key:'kpr', format:'2d', right:true },
    { label:'Dmg/row', key:'dpr', format:'1d', right:true },
  ];
  el('tblActive').innerHTML = renderSimpleTable(agg, cols);
  applyColumnHeatmap('tblActive', ['picks','kills','assists','headshots','hsr','grenade','damage','kpr','dpr']);
}

// GLOBAL: Pet (ALL players)
function renderPetGlobal(allRows){
  const agg = aggregateBy(allRows, 'pet')
    .sort((a,b)=> b.picks - a.picks || b.kills - a.kills || a.name.localeCompare(b.name))
    .slice(0,10);
  const cols = [
    { label:'Pet', key:'name' },
    { label:'Picks', key:'picks', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'HS %', key:'hsr', format:'pct', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
    { label:'Kills/row', key:'kpr', format:'2d', right:true },
    { label:'Dmg/row', key:'dpr', format:'1d', right:true },
  ];
  el('tblPet').innerHTML = renderSimpleTable(agg, cols);
  applyColumnHeatmap('tblPet', ['picks','kills','assists','headshots','hsr','grenade','damage','kpr','dpr']);
}

// GLOBAL: Top 10 players by kills
function renderTopKillers(allRows){
  const m = new Map();
  for (const r of allRows){
    const p = r._player;
    if (!p) continue;
    if (!m.has(p)) m.set(p,{player:p, kills:0, assists:0, headshots:0, grenade:0, damage:0, rows:0});
    const o = m.get(p);
    o.kills += r.kills; o.assists += r.assists; o.headshots += r.headshots; o.grenade += r.grenade; o.damage += r.damage; o.rows++;
  }
  const list = Array.from(m.values()).sort((a,b)=> b.kills - a.kills || a.player.localeCompare(b.player)).slice(0,10);
  const cols = [
    { label:'Player', key:'player' },
    { label:'Rows', key:'rows', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
  ];
  el('tblTopKillers').innerHTML = renderSimpleTable(list, cols);
  applyColumnHeatmap('tblTopKillers', ['rows','kills','assists','headshots','grenade','damage']);
}

/* ===== Player list & selection ===== */
let ALL = [];
let CURRENT_PLAYER = '';

function buildPlayerLists(allRows){
  const names = uniq(allRows.map(r=>r._player).filter(Boolean)).sort((a,b)=> a.localeCompare(b));
  const sel = el('playerSelect');
  sel.innerHTML = `<option value="">— Select player —</option>` + names.map(nm=>`<option value="${nm.replaceAll('"','&quot;')}">${nm}</option>`).join('');
  // Quick chips: top 10 by kills
  const m = new Map();
  for (const r of allRows){
    if (!r._player) continue;
    if (!m.has(r._player)) m.set(r._player, 0);
    m.set(r._player, m.get(r._player) + r.kills);
  }
  const chips = Array.from(m.entries()).map(([p,k])=>({p,k})).sort((a,b)=> b.k - a.k || a.p.localeCompare(b.p)).slice(0,10);
  el('playerChips').innerHTML = chips.map(x=>`<button class="chipbtn" data-name="${x.p}">${x.p} <span class="muted">• ${x.k}</span></button>`).join('') || '<div class="muted">No players.</div>';
  el('playerChips').querySelectorAll('.chipbtn').forEach(btn=> btn.onclick = ()=> selectPlayer(btn.getAttribute('data-name')));
  el('pickerHint').textContent = `${names.length} unique players • Top 10 chips shown below`;
}

function selectPlayer(name){
  CURRENT_PLAYER = (name||'').trim();
  el('playerSearch').value = CURRENT_PLAYER;
  el('playerSelect').value = CURRENT_PLAYER;

  const rows = ALL.filter(r => (r._player||'').toLowerCase() === CURRENT_PLAYER.toLowerCase());
  renderOverview(CURRENT_PLAYER, rows);
  renderRecent(rows);

  // highlight chip
  document.querySelectorAll('.chipbtn').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('data-name').toLowerCase() === CURRENT_PLAYER.toLowerCase());
  });
}

/* Copy link (?player=) */
function copyLinkToClipboard(){
  const url = new URL(window.location.href);
  if (CURRENT_PLAYER) url.searchParams.set('player', CURRENT_PLAYER);
  else url.searchParams.delete('player');
  navigator.clipboard.writeText(url.toString()).then(()=>{
    const btn = el('copyLink'); const old = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(()=> btn.textContent = old, 1200);
  });
}

/* ===== Wiring ===== */
async function initial(){
  await loadCharacters();
  ALL = await fetchAllRows(); // robust fetch + normalize

  // Build player lists
  buildPlayerLists(ALL);

  // Global tables (NOT player-dependent)
  renderActiveGlobal(ALL);
  renderPetGlobal(ALL);
  renderTopKillers(ALL);

  // URL ?player=
  const url = new URL(window.location.href);
  const qp = (url.searchParams.get('player')||'').trim();
  if (qp){
    selectPlayer(qp);
  }

  // Search enter
  el('playerSearch').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const name = (e.target.value||'').trim();
      if (!name) return;
      // prefer exact match
      const names = uniq(ALL.map(r=>r._player).filter(Boolean));
      const exact = names.find(nm=> nm.toLowerCase() === name.toLowerCase());
      selectPlayer(exact || name);
    }
  });

  // Dropdown change
  el('playerSelect').addEventListener('change', e=>{
    const v = (e.target.value||'').trim();
    if (!v) return;
    selectPlayer(v);
  });

  // Clear & copy
  el('clearPlayer').onclick = ()=>{
    CURRENT_PLAYER = '';
    el('playerSearch').value = '';
    el('playerSelect').value = '';
    el('playerTitle').textContent = 'Player Overview';
    el('identityBody').innerHTML = 'Select a player.';
    el('kpiBody').innerHTML = '—';
    el('tblRecent').innerHTML = '—';
    document.querySelectorAll('.chipbtn').forEach(b=> b.classList.remove('active'));
  };
  el('copyLink').onclick = copyLinkToClipboard;
}

initial();
</script>
</body>
</html>
