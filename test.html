<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clash Squad — Team Compare (Vertical details + stacked skills)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.08rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:#111;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{background:#e6a74f}
    .shell{max-width:1200px;margin:22px auto;padding:0 12px}

    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="date"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}
    .muted{color:var(--muted);font-size:.9rem}

    details.accordion{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin-bottom:14px;overflow:hidden;}
    details.accordion > summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:800;background:linear-gradient(180deg,#1b1b1b 0%, #171717 100%);user-select:none;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--line);}
    details.accordion > summary::-webkit-details-marker{display:none}
    details.accordion > summary::after{content:'▾';margin-left:auto;transition:transform .18s ease;opacity:.9;}
    details.accordion[open] > summary::after{ transform:rotate(-180deg); }
    details.accordion .accordion-body{ padding:12px; }

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}

    /* ===== Match card: left details, right skills (stacked) ===== */
    .matchCard{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:12px;
      background:#121212;
      border:1px solid #272727;
      border-radius:12px;
      padding:10px;
    }
    @media (max-width:980px){ .matchCard{grid-template-columns:1fr} }

    /* left details (vertical list) */
    .mInfo{display:flex;flex-direction:column;gap:6px}
    .mRow{display:flex;gap:10px;align-items:center}
    .mKey{width:86px;color:var(--muted);font-size:.88rem}
    .mVal{font-size:.95rem;line-height:1.1}
    .mono{font-variant-numeric:tabular-nums}
    .wl{font-weight:700;padding:2px 8px;border-radius:999px;display:inline-block}
    .wl.W{background:#193e2b;color:var(--good);border:1px solid #245b3e}
    .wl.L{background:#401e1e;color:var(--bad);border:1px solid #6b2c2c}
    .banBox{display:flex;gap:8px;align-items:center}
    .banBox img{width:22px;height:22px;border-radius:5px;border:1px solid #333;background:#111;object-fit:cover}

    /* right: stacked player skill blocks */
    .mPlayers{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-content:start;
    }

    .pBadge{
      display:grid;
      grid-template-columns:44px 1fr auto;
      gap:10px;
      align-items:center;
      background:#0f0f0f;
      border:1px solid #2a2a2a;
      border-radius:10px;
      padding:6px 8px;
      min-height:52px;
    }
    .pAct{width:44px;height:44px;border-radius:8px;border:1px solid #333;object-fit:cover;background:#0b0b0b}
    .pMeta{min-width:0}
    .pName{font-size:12px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pHero{font-size:11px;color:#cfcfcf;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pPass{display:flex;gap:6px;align-items:center}
    .pPass img{width:16px;height:16px;border-radius:3px;border:1px solid #333;background:#0b0b0b;object-fit:cover}
  </style>
</head>
<body>
<header>
  <h1>Clash Squad — Team Compare</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">

  <div class="bar">
    <div class="controls">
      <label>From <input type="date" id="fFrom"></label>
      <label>To <input type="date" id="fTo"></label>
      <label>Map
        <select id="fMap">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option><option value="Kalahari">Kalahari</option>
          <option value="Purgatory">Purgatory</option><option value="Alpine">Alpine</option>
          <option value="Nexterra">Nexterra</option><option value="Solara">Solara</option>
        </select>
      </label>
      <label>Tournament <select id="fTourn"></select></label>
      <label>Outcome
        <select id="fWL">
          <option value="__ALL__">All</option>
          <option value="W">Wins only</option>
          <option value="L">Losses only</option>
        </select>
      </label>
      <label>Team A <select id="cmpTeamA"></select></label>
      <label>Team B <select id="cmpTeamB"></select></label>
      <button class="btn" id="cmpSwap" title="Swap A/B">Swap</button>
      <button class="btn" id="applyBtn">Apply</button>
    </div>
    <div class="muted" id="meta" style="margin-left:auto">—</div>
  </div>

  <details class="accordion" open>
    <summary>Matches (Active + 3×Passive per player)</summary>
    <div class="accordion-body">
      <div class="grid2">
        <div class="card"><h3 id="labelMatchesA">Team A</h3><div id="matchesA">Loading…</div></div>
        <div class="card"><h3 id="labelMatchesB">Team B</h3><div id="matchesB">Loading…</div></div>
      </div>
    </div>
  </details>

</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = "index.html"; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = "index.html";
};

/* ========= Utils ========= */
const PLACEHOLDER = 'https://imgur.com/AdvPwAO.png';
const el = (id) => document.getElementById(id);
const ymd = (d)=>{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;}
const parseState = (v)=>{ if(!v) return {}; if(typeof v==='object') return v; try{return JSON.parse(v)}catch{return {}} };
const safe = s => String(s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

/* ========= Filters init ========= */
(function initFilters(){
  const today = new Date(); const from = new Date(today); from.setDate(from.getDate()-30);
  el('fFrom').value = ymd(from); el('fTo').value = ymd(today);
  el('fMap').value='__ALL__'; el('fWL').value='__ALL__';
  el('fTourn').innerHTML = `<option value="__ALL__">All tournaments</option>`;
})();

/* ========= State ========= */
let RAW_RECORDS = [];
let FIRST_LOAD_TOURN = true;

/* ========= Fetch ========= */
async function fetchRecords(){
  const from  = el('fFrom').value;
  const toRaw = el('fTo').value;
  const map   = el('fMap').value;
  const tourn = el('fTourn').value || '__ALL__';

  let q = client
    .from('draft_records')
    .select('id, match_date, game_number, team_left, team_right, team_left_score, team_right_score, map, tournament_name, state')
    .gte('match_date', from);

  if (toRaw){
    const d = new Date(toRaw); d.setDate(d.getDate()+1);
    q = q.lt('match_date', ymd(d));
  }
  if (map!=='__ALL__') q = q.eq('map', map);
  if (tourn!=='__ALL__') q = q.eq('tournament_name', tourn);

  q = q.order('match_date', { ascending:false }).order('id', { ascending:false });

  const { data, error } = await q;
  if (error){ console.error(error); alert('Failed to load records: '+error.message); return []; }
  return data || [];
}

async function populateTournamentDropdown(records){
  const dd = el('fTourn'); const prior = dd.value || '__ALL__';
  const tourns = new Set(); let latest=null;
  records.forEach(r => {
    const tn = r.tournament_name; if (!tn) return;
    tourns.add(tn);
    if (!latest || (String(r.match_date) > String(latest?.date))) latest = { name: tn, date: r.match_date };
  });
  dd.innerHTML = `<option value="__ALL__">All tournaments</option>` + [...tourns].sort().map(t=>`<option value="${t}">${t}</option>`).join('');
  if (FIRST_LOAD_TOURN && latest && (prior==='__ALL__' || !prior)){ dd.value = latest.name; FIRST_LOAD_TOURN=false; } else { dd.value = prior; }
}

function populateTeamDropdowns(records){
  const teams = [...new Set(records.flatMap(r=>[r.team_left, r.team_right]).filter(Boolean))].sort();
  const A = el('cmpTeamA'), B = el('cmpTeamB');
  const prevA = A.value, prevB = B.value;
  const opts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
  A.innerHTML = opts; B.innerHTML = opts;
  A.value = teams.includes(prevA) ? prevA : (teams[0] || '');
  B.value = teams.includes(prevB) ? prevB : (teams[1] || teams[0] || '');
}

/* ========= Transform ========= */
function explodeRecordToRows(rec){
  const s = parseState(rec.state);
  const picks    = Array.isArray(s.picks)       ? s.picks       : [];
  const passives = Array.isArray(s.passives)    ? s.passives    : [];
  const bans     = Array.isArray(s.bans)        ? s.bans        : [];
  const names    = Array.isArray(s.playerCards) ? s.playerCards : [];

  const leftWin  = (rec.team_left_score ?? 0) > (rec.team_right_score ?? 0);
  const rightWin = (rec.team_right_score ?? 0) > (rec.team_left_score ?? 0);

  function sideRow(side){
    const isL = side==='L';
    const team = isL ? rec.team_left : rec.team_right;
    const opp  = isL ? rec.team_right : rec.team_left;
    const ts   = isL ? (rec.team_left_score ?? 0) : (rec.team_right_score ?? 0);
    const os   = isL ? (rec.team_right_score ?? 0) : (rec.team_left_score ?? 0);
    const res  = (isL ? leftWin : rightWin) ? 'W' : 'L';
    const banObj = bans[ isL ? 0 : 1 ] || {};
    const ban    = banObj?.name || '';
    const banImg = banObj?.image_url || PLACEHOLDER;

    const idx = isL ? [0,1,2,3] : [7,6,5,4];
    const actives = idx.map((i,k)=>{
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const heroObj = (picks[i] && typeof picks[i]==='object') ? picks[i] : null;
      return { player, hero: heroObj?.name || '', heroImg: heroObj?.image_url || PLACEHOLDER };
    });
    const passiveLines = idx.map((i,k)=>{
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const trioRaw = Array.isArray(passives[i]) ? passives[i] : [];
      const trioObjs = trioRaw.filter(Boolean).map(ps=>({name: ps?.name || '', img: ps?.image_url || PLACEHOLDER}));
      while (trioObjs.length<3) trioObjs.push({name:'', img: PLACEHOLDER});
      return { player, trio: trioObjs.slice(0,3) };
    });

    return {
      rec_id:rec.id,
      tournament: rec.tournament_name || '—',
      match_date:rec.match_date,
      game_number:rec.game_number ?? 0,
      map:rec.map,
      team, opponent:opp, team_score:ts, opp_score:os, result:res,
      banName:ban, banImg,
      actives, passives:passiveLines
    };
  }
  return [sideRow('L'), sideRow('R')];
}

function applyWL(rows){
  const wl = el('fWL').value;
  if (wl==='__ALL__') return rows;
  return rows.filter(r => r.result === wl);
}
function rowsForTeam(team){
  const rows = RAW_RECORDS.flatMap(explodeRecordToRows).filter(r=>r.team===team);
  return applyWL(rows);
}

/* ========= Render helpers ========= */
function playerBadge(active, trio){
  const ico = (ps)=>`<img src="${ps.img||PLACEHOLDER}" alt="${safe(ps.name||'')}" title="${safe(ps.name||'')}">`;
  const p0 = trio?.[0] || {}, p1 = trio?.[1] || {}, p2 = trio?.[2] || {};
  const aName = safe(active.hero||'');
  const pName = safe(active.player||'');
  return `
    <div class="pBadge" title="${pName}${aName?(' — '+aName):''}">
      <img class="pAct" src="${active.heroImg||PLACEHOLDER}" alt="${aName}">
      <div class="pMeta">
        <div class="pName">${pName}</div>
        <div class="pHero">${aName||'—'}</div>
      </div>
      <div class="pPass">${ico(p0)}${ico(p1)}${ico(p2)}</div>
    </div>`;
}

function matchCard(r){
  const score = `${r.team_score} - ${r.opp_score}`;
  const g = r.game_number ? `Game ${r.game_number}` : '—';
  const players = r.actives.map((a,i)=>playerBadge(a, (r.passives[i]||{}).trio)).join('');
  return `
    <div class="matchCard">
      <div class="mInfo">
        <div class="mRow"><div class="mKey">Date</div><div class="mVal mono">${String(r.match_date||'').slice(0,10)}</div></div>
        <div class="mRow"><div class="mKey">Game</div><div class="mVal">${g}</div></div>
        <div class="mRow"><div class="mKey">Map</div><div class="mVal">${r.map||'—'}</div></div>
        <div class="mRow"><div class="mKey">Team</div><div class="mVal">${r.team||'—'}<div class="muted" style="line-height:1.1">vs ${r.opponent||'—'}</div></div></div>
        <div class="mRow"><div class="mKey">Score</div><div class="mVal mono">${score}</div></div>
        <div class="mRow"><div class="mKey">Result</div><div class="mVal"><span class="wl ${r.result}">${r.result}</span></div></div>
        <div class="mRow"><div class="mKey">Ban</div><div class="mVal banBox"><img src="${r.banImg||PLACEHOLDER}" alt="${safe(r.banName||'')}" title="${safe(r.banName||'')}"><span class="muted">${safe(r.banName||'—')}</span></div></div>
      </div>
      <div class="mPlayers">
        ${players}
      </div>
    </div>`;
}

function matchesCards(rows){
  if(!rows.length) return `<div class="muted">No matches for selection.</div>`;
  const sorted = [...rows].sort((a,b)=>{
    const da = new Date(a.match_date), db = new Date(b.match_date);
    return db - da || (a.game_number||0) - (b.game_number||0) || a.rec_id - b.rec_id;
  });
  return sorted.map(matchCard).join('');
}

/* ========= Render ========= */
function renderAll(){
  const a = el('cmpTeamA').value, b = el('cmpTeamB').value;
  if (!a || !b || a===b){
    el('meta').textContent = 'Pick two different teams.';
    el('matchesA').innerHTML = '<div class="muted">—</div>';
    el('matchesB').innerHTML = '<div class="muted">—</div>';
    return;
  }

  const mapLabel   = (el('fMap').value==='__ALL__')?'All maps':el('fMap').value;
  const tournLabel = (el('fTourn').value==='__ALL__')?'All tournaments':el('fTourn').value;
  const wlLabel    = (el('fWL').value==='__ALL__')?'All outcomes':(el('fWL').value==='W'?'Wins only':'Losses only');
  el('meta').textContent = `${a} vs ${b} • ${mapLabel} • ${tournLabel} • ${wlLabel}`;

  const rowsA = rowsForTeam(a), rowsB = rowsForTeam(b);
  el('labelMatchesA').textContent = a;
  el('labelMatchesB').textContent = b;

  el('matchesA').innerHTML = matchesCards(rowsA);
  el('matchesB').innerHTML = matchesCards(rowsB);
}

/* ========= Refresh ========= */
async function refresh(){
  RAW_RECORDS = await fetchRecords();
  await populateTournamentDropdown(RAW_RECORDS);
  populateTeamDropdowns(RAW_RECORDS);
  renderAll();
}

/* ========= Events ========= */
el('applyBtn').onclick = refresh;
['cmpTeamA','cmpTeamB'].forEach(id=> el(id).addEventListener('change', renderAll));
el('cmpSwap').addEventListener('click', ()=>{ const A=el('cmpTeamA'),B=el('cmpTeamB'); const t=A.value; A.value=B.value; B.value=t; renderAll(); });

/* ========= First load ========= */
refresh();
</script>
</body>
</html>
