<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Teams</title>
  <!-- Supabase v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
      --brand:#ffbd59; --brand2:#ff7733; --line:#313131;
      --tile-w:96px; --tile-h:104px; --logo:44px; --code-fs:.74rem;
      --heat-rgb:255,189,89; --heat-min:.06; --heat-max:.22; --heat-top-outline:.42; --heat-radius:8px;
      --good:#62e887; --bad:#ff6b6b; --step-h:48px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:20;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd;background:#272727;border:1px solid #3a3a3a;border-radius:999px;padding:4px 10px}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}
    .btn.ghost{background:transparent;color:#ddd;border:1px solid #3a3a3a}
    .shell{max-width:1180px;margin:22px auto;padding:0 12px}

    .gerr{display:none;margin:0 0 12px;background:#2a1111;border:1px solid #553; color:#ffb4b4;border-radius:10px;padding:10px 12px;white-space:pre-wrap}
    .gerr.show{display:block}

    .steps{position:sticky;top:61px;z-index:15;background:#151515;border:1px solid var(--line);border-radius:12px;height:var(--step-h);display:flex;align-items:center;gap:8px;padding:6px 8px;margin-bottom:12px}
    .step{flex:1;display:flex;align-items:center;gap:8px;justify-content:center;height:100%;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#cacaca;font-weight:700;cursor:pointer}
    .step .num{display:inline-grid;place-items:center;width:24px;height:24px;border-radius:999px;border:1px solid #3a3a3a;background:#1a1a1a;font-size:.9rem}
    .step.active{outline:2px solid var(--brand);color:#fff}
    .pager-nav{display:flex;gap:8px;justify-content:space-between;margin:8px 0 16px}
    .steps-hint{color:var(--muted);font-size:.9rem}

    .page{display:none}
    .page.active{display:block}
    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 10px;font-size:.9rem}
    .kpi strong{font-weight:800}
    .bar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .bar label{color:var(--muted);font-size:.9rem}
    .input{background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:7px 10px}
    .muted{color:var(--muted)}

    .team-grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(var(--tile-w), 1fr));gap:8px}
    .team-tile{height:var(--tile-h);background:#131313;border:1px solid #2a2a2a;border-radius:10px;padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;transition:transform .1s ease, border-color .1s ease;overflow:hidden}
    .team-tile:hover{transform:translateY(-2px);border-color:#444}
    .team-tile.active{outline:2px solid var(--brand2)}
    .team-logo{ width:var(--logo); height:var(--logo); object-fit:contain; filter:drop-shadow(0 0 8px rgba(0,0,0,.4)) }
    .team-code{ font-weight:800; font-size:var(--code-fs); line-height:1.1; letter-spacing:.2px }

    table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
    thead th{background:#191919;position:sticky;top:0;text-align:left;border-radius:8px;padding:8px 6px;z-index:1}
    th,td{padding:6px 6px;vertical-align:top}
    .right{text-align:right}
    td[data-key]{transition:background-color .18s ease, box-shadow .18s ease;border-radius:var(--heat-radius);background-clip:padding-box}
    td.heat-top{box-shadow:inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline))}
    .err{background:#2a1111;border:1px solid #4a1a1a;color:#ffb4b4;border-radius:8px;padding:8px 10px}

    details.accordion{background:var(--panel);border:1px solid var(--line);border-radius:12px}
    details.accordion > summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line)}
    details.accordion > .accordion-body{ padding:12px }

    #veil{position:fixed;inset:0;display:grid;place-items:center;background:rgba(10,10,10,.95);z-index:9999}
    #veil .box{background:#121212;border:1px solid #2a2a2a;border-radius:12px;padding:14px 16px;color:#ddd}
    #veil.hide{display:none}

    @media (max-width: 980px){ .grid3{grid-template-columns:1fr} }
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Teams</h1>
  <div class="user-controls">
    <a class="btn secondary" id="homeBtn" href="dashboard.html">← Back to Dashboard</a>
    <span class="chip" id="scopeChip">Scope: —</span>
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div id="veil"><div class="box">Loading data…</div></div>

<div class="shell">
  <div id="globalErr" class="gerr"></div>

  <div class="steps" id="steps">
    <div class="step" data-page="1"><span class="num">1</span><span class="label">Overall</span></div>
    <div class="step" data-page="2"><span class="num">2</span><span class="label">Team + Players</span></div>
  </div>
  <div class="pager-nav">
    <button class="btn secondary" id="prevBtn">← Prev</button>
    <div class="steps-hint">Use ←/→ keys to navigate</div>
    <button class="btn secondary" id="nextBtn">Next →</button>
  </div>

  <!-- PAGE 1 -->
  <div class="page" id="page1" data-page="1">
    <div class="section">
      <h2>Filters</h2>
      <div class="bar">
        <label>Tournament
          <select id="gTournament" class="input" style="min-width:260px">
            <option value="__all__">All tournaments</option>
          </select>
        </label>
        <button class="btn secondary" id="gTournReset">Reset</button>
      </div>
      <div class="muted" id="filterHint">—</div>
    </div>

    <div class="section" id="overallSection">
      <h2>Overall Performance (All Teams)</h2>
      <div class="bar">
        <label for="overallSortKey">Sort by</label>
        <select id="overallSortKey" class="input">
          <option value="total_pm">Total / m</option>
          <option value="total" selected>Total</option>
          <option value="elims_pm">Elims / m</option>
          <option value="elims">Elims</option>
          <option value="placement_pm">Placement / m</option>
          <option value="placement">Placement</option>
          <option value="booyah_rate">Booyah %</option>
          <option value="booyahs">Booyahs</option>
          <option value="matches">Matches</option>
          <option value="top3_rate">Top-3 %</option>
          <option value="team">Team (A→Z)</option>
        </select>
        <button class="btn secondary" id="overallSortDir" data-dir="desc">Desc</button>
        <button class="btn secondary" id="overallReset">Reset</button>
      </div>
      <div class="card" style="margin:0">
        <div id="tblOverall">Loading…</div>
      </div>
    </div>

    <div class="section" id="perMapAllSection">
      <h2>All Teams — Per-Map Breakdown</h2>
      <div class="bar">
        <label for="mapFilter">Map</label>
        <select id="mapFilter" class="input" style="min-width:220px">
          <option value="__all__" selected>All maps</option>
        </select>
        <label for="perMapSortKey">Sort by</label>
        <select id="perMapSortKey" class="input">
          <option value="total_pm">Total / m</option>
          <option value="total" selected>Total</option>
          <option value="elims_pm">Elims / m</option>
          <option value="elims">Elims</option>
          <option value="placement_pm">Placement / m</option>
          <option value="placement">Placement</option>
          <option value="booyah_rate">Booyah %</option>
          <option value="booyahs">Booyahs</option>
          <option value="matches">Matches</option>
          <option value="top3_rate">Top-3 %</option>
          <option value="team">Team (A→Z)</option>
        </select>
        <button class="btn secondary" id="perMapSortDir" data-dir="desc">Desc</button>
        <button class="btn secondary" id="perMapReset">Reset</button>
      </div>
      <div class="card" style="margin:0">
        <div id="tblPerMapAllTeams">Loading…</div>
      </div>
    </div>

    <!-- Global sections -->
    <details class="accordion" id="lopsTopKillersSection">
      <summary>Top Players by Kills</summary>
      <div class="accordion-body">
        <div class="bar">
          <label>Top</label>
          <select id="lopsTopKillersTop" class="input">
            <option>10</option><option>20</option><option>50</option><option>100</option>
          </select>
        </div>
        <div class="card" style="margin:0"><div id="tblLopsTopKillers">Loading…</div></div>
      </div>
    </details>

    <details class="accordion" id="lopsUsageSection">
      <summary>Active Skill & Pet Usage</summary>
      <div class="accordion-body">
        <div class="grid2">
          <div class="card">
            <h3>Active Skill Usage</h3>
            <div class="bar">
              <label>Top</label>
              <select id="lopsActiveTop" class="input">
                <option>10</option><option>20</option><option>50</option><option>100</option>
              </select>
            </div>
            <div id="tblLopsActive">Loading…</div>
          </div>
          <div class="card">
            <h3>Pet Usage</h3>
            <div class="bar">
              <label>Top</label>
              <select id="lopsPetTop" class="input">
                <option>10</option><option>20</option><option>50</option><option>100</option>
              </select>
            </div>
            <div id="tblLopsPet">Loading…</div>
          </div>
        </div>
      </div>
    </details>
  </div>

  <!-- PAGE 2 -->
  <div class="page" id="page2" data-page="2">
    <div class="section">
      <h2>Team Selection</h2>
      <div class="bar">
        <input type="search" id="teamSearch" placeholder="Search team / region…" class="input" style="flex:1;max-width:420px">
        <span class="chip">Scope: <span id="scopeChipTeam">—</span> • <a href="#" id="editFilters1" class="btn ghost" style="padding:4px 10px">Edit filters</a></span>
      </div>
      <div id="teamGrid" class="team-grid">Loading teams…</div>
      <div id="teamGridErr"></div>
    </div>

    <div class="section" id="teamHeader">
      <h2 id="teamTitle">Overview</h2>
      <div class="grid2">
        <div class="card" id="teamIdentity">
          <h3>Identity</h3>
          <div id="identityBody">Select a team.</div>
        </div>
        <div class="card" id="teamKPIs">
          <h3>Key KPIs</h3>
          <div id="kpiBody">—</div>
        </div>
      </div>
      <div class="grid3" style="margin-top:12px">
        <div class="card"><h3>Totals</h3><div id="teamTotals" class="kpis">—</div></div>
        <div class="card"><h3>Per Match Averages</h3><div id="teamAverages" class="kpis">—</div></div>
        <div class="card"><h3>Signals</h3><div id="teamSignals" class="kpis">—</div></div>
      </div>
    </div>

    <!-- Players -->
    <details class="accordion" id="playersSection">
      <summary>Player Stats</summary>
      <div class="accordion-body">
        <div class="card" style="margin:0"><div id="tblPlayers">Loading…</div></div>
      </div>
    </details>

    <!-- By Map + By Day -->
    <details class="accordion" id="mapsDaysSection">
      <summary>By Map & By Day Stats</summary>
      <div class="accordion-body">
        <div class="card" style="margin:0 0 12px 0">
          <h3>By Map</h3>
          <div id="tblMapTeam">—</div>
        </div>
        <div class="card" style="margin:0">
          <h3>By Day (Pivot by Map)</h3>
          <div id="tblByDay">—</div>
        </div>
      </div>
    </details>

    <!-- Usage -->
    <details class="accordion" id="teamCharsUsageSection">
      <summary>Character and Pet Usage</summary>
      <div class="accordion-body">
        <div class="grid2">
          <div class="card">
            <h3>Active Skill Usage</h3>
            <div class="bar"><label>Top</label><select id="teamActiveTop" class="input"><option>10</option><option>20</option><option>50</option><option>100</option></select></div>
            <div id="tblTeamActive">Loading…</div>
          </div>
          <div class="card">
            <h3>Pet Usage</h3>
            <div class="bar"><label>Top</label><select id="teamPetTop" class="input"><option>10</option><option>20</option><option>50</option><option>100</option></select></div>
            <div id="tblTeamPet">Loading…</div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Per-Player Character Usage (Active + Passive)</h3>
          <div class="bar">
            <label>Top players</label>
            <select id="charUsageTop" class="input"><option>10</option><option>20</option><option>50</option><option>100</option></select>
          </div>
          <div id="tblCharUsage">Loading…</div>
          <div class="muted" style="margin-top:6px" id="charMapHint">—</div>
        </div>
      </div>
    </details>

    <details class="accordion" id="teamInfoSection">
      <summary>Team Info</summary>
      <div class="accordion-body"><div class="card" style="margin:0"><div id="teamInfoBody" class="muted">—</div></div></div>
    </details>

    <details class="accordion" id="teamRosterSection">
      <summary>Roster & Accolades</summary>
      <div class="accordion-body"><div class="card" style="margin:0"><div id="teamRosterBody" class="muted">—</div></div></div>
    </details>
  </div>
</div>

<script>
/* ===== Guard: Supabase loaded? ===== */
if (!window.supabase) {
  document.getElementById('veil').classList.add('hide');
  const g = document.getElementById('globalErr');
  if (g) { g.textContent = 'Supabase SDK failed to load.'; g.classList.add('show'); }
  throw new Error('Supabase SDK not found');
}
var client = window.supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

/* ===== Utils ===== */
function el(id){ return document.getElementById(id); }
function fmtPct(x){ return isFinite(x) ? (x*100).toFixed(1)+'%' : '—'; }
function n(x){ return Number(x!=null ? x : 0) || 0; }
function norm(v){ return v==null ? '' : String(v).trim(); }
function sum(arr,k){ var t=0; for(var i=0;i<arr.length;i++){ var r=arr[i]; t += Number(r && r[k]!=null ? r[k] : 0) || 0; } return t; }
function safeDiv(a,b){ a=Number(a!=null?a:0)||0; b=Number(b!=null?b:0)||0; return b? (a/b) : 0; }
function groupBy(arr,fn){ var m=new Map(); for(var i=0;i<arr.length;i++){ var r=arr[i]; var k=fn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }
function looksLikeURL(v){ return /^https?:\/\//i.test(String(v||'')); }

/* ===== Error surfacing ===== */
function gerr(msg){
  var box=el('globalErr'); if(!box) return;
  box.textContent = msg; box.classList.add('show');
  console.error('[FFBR]', msg);
}
window.addEventListener('error', function(e){
  try{ gerr((e && e.message) ? e.message : 'Script error'); }catch(_){}
  var v=document.getElementById('veil'); if(v) v.classList.add('hide');
});

/* ===== Pager ===== */
var PAGES=[1,2];
function setActiveStep(p){
  var steps=document.querySelectorAll('.step');
  for(var i=0;i<steps.length;i++){ var s=steps[i]; s.classList.toggle('active', String(s.getAttribute('data-page'))===String(p)); }
}
function showPage(p){
  var target=document.querySelector('.page[data-page="'+p+'"]'); if(!target) return;
  var pages=document.querySelectorAll('.page');
  for(var i=0;i<pages.length;i++){ pages[i].classList.remove('active'); }
  target.classList.add('active');
  setActiveStep(p);
  try{ localStorage.setItem('ffbr_page', String(p)); }catch(_){}
  try{
    var url=new URL(window.location.href);
    url.searchParams.set('p', String(p));
    history.replaceState(null,'',url.toString());
  }catch(_){}
}
function currentPage(){
  try{
    var url=new URL(window.location.href);
    var qp=Number(url.searchParams.get('p'));
    if(PAGES.indexOf(qp)>-1) return qp;
  }catch(_){}
  try{
    var ls=Number(localStorage.getItem('ffbr_page'));
    if(PAGES.indexOf(ls)>-1) return ls;
  }catch(_){}
  return 1;
}
function nextPage(){ var p=currentPage(); var idx=PAGES.indexOf(p); showPage(PAGES[Math.min(PAGES.length-1, idx+1)]); }
function prevPage(){ var p=currentPage(); var idx=PAGES.indexOf(p); showPage(PAGES[Math.max(0, idx-1)]); }
var _steps=document.querySelectorAll('.step');
for(var _i=0;_i<_steps.length;_i++){ _steps[_i].addEventListener('click', function(){ showPage(Number(this.getAttribute('data-page'))); }); }
el('prevBtn').addEventListener('click', prevPage);
el('nextBtn').addEventListener('click', nextPage);
window.addEventListener('keydown', function(e){ if(e.key==='ArrowLeft') prevPage(); if(e.key==='ArrowRight') nextPage(); });
el('editFilters1').addEventListener('click', function(e){ e.preventDefault(); showPage(1); window.scrollTo({top:0,behavior:'smooth'}); });

/* ===== Session chip ===== */
(function(){
  client.auth.getSession().then(function(res){
    var session = res && res.data && res.data.session;
    el('user-info').textContent = (session && session.user && session.user.email) ? ('Logged in: ' + session.user.email) : 'Anon access';
  });
})();
el('logoutBtn').onclick = function(){ client.auth.signOut().then(function(){ location.reload(); }); };

/* ===== State ===== */
var TEAMS=[]; var TEAM_BY_CODE={}; var TEAM_BY_NAME={}; var ALLOWED_TAGS=new Set();
var ALL=[]; var TEAM_ROWS=[]; var CURRENT_TEAM=null;
var LOPS_ALL=[];
var MATCH_API_MAP = new Map();

/* ===== Helpers ===== */
function buildTeamIndexes(){
  TEAM_BY_CODE = {}; TEAM_BY_NAME = {}; ALLOWED_TAGS=new Set();
  for(var i=0;i<TEAMS.length;i++){
    var t=TEAMS[i];
    TEAM_BY_CODE[String(t.name||'').toLowerCase()] = t;
    TEAM_BY_NAME[String(t.fullname||'').toLowerCase()] = t;
    if(t.name) ALLOWED_TAGS.add(String(t.name).toUpperCase());
  }
}
function deriveTeamsFromData(rows){
  var s=new Set();
  for(var i=0;i<rows.length;i++){
    var r=rows[i], code=norm(r.tag||r.TAG||r._tag).toUpperCase();
    if(code) s.add(code);
  }
  var codes=[].concat(Array.from(s)).sort();
  var out=[];
  for(var j=0;j<codes.length;j++){
    var c=codes[j]; out.push({ name:c, fullname:c, logo:'', ew:'', region:'', alt:'' });
  }
  return out;
}
function normalizeRow(r){
  r._tag = norm(r.tag!=null ? r.tag : (r.TAG!=null ? r.TAG : '')).toUpperCase();
  if (r.elimination == null) r.elimination = r.elims!=null ? r.elims : (r.kills!=null ? r.kills : 0);
  if (r.placement   == null) r.placement   = r.place!=null ? r.place : 0;
  if (r.top3        == null) r.top3        = r.top_3!=null ? r.top_3 : 0;
  return r;
}
async function fetchAllRows(){
  var CHUNK=1000, from=0, out=[];
  while(true){
    var res = await client.from('ffbr_data').select('*').order('id',{ascending:true}).range(from, from+CHUNK-1);
    if(res.error){ gerr('ffbr_data fetch failed. Check RLS / table name.\n\n'+(res.error.message||res.error)); break; }
    var rows=res.data||[]; if(!rows.length) break;
    for(var i=0;i<rows.length;i++) out.push(rows[i]);
    from+=rows.length;
  }
  for(var k=0;k<out.length;k++) out[k]=normalizeRow(out[k]);
  return out;
}
async function fetchHelperTeams(){
  try{
    var res=await client.from('helper_team').select('*').order('TAG');
    if(res.error) throw res.error;
    var rows=res.data||[];
    var out=[];
    for(var i=0;i<rows.length;i++){
      var r=rows[i];
      var code = norm(r.TAG).toUpperCase();
      out.push({
        name:code,
        fullname: norm(r.TEAM)||code,
        logo: norm(r.LOGO)||'',
        ew: norm(r['E/W'])||'',
        region: norm(r.REGION)||'',
        alt: norm(r['ALT NAME 1'])||''
      });
    }
    return out;
  }catch(e){
    console.warn('helper_team error:', e.message||e);
    return [];
  }
}

/* ===== Tournaments ===== */
function tournamentsWithMaxId(rows){
  var m=new Map();
  for(var i=0;i<rows.length;i++){
    var r=rows[i];
    var t=norm(r.tournament); if(!t) continue;
    var id=n(r.id);
    var key=t.toLowerCase();
    if(!m.has(key)) m.set(key, { name:t, maxId:id });
    else m.get(key).maxId = Math.max(m.get(key).maxId, id);
  }
  var vals=Array.from(m.values());
  vals.sort(function(a,b){ return (b.maxId - a.maxId) || a.name.localeCompare(b.name); });
  return vals;
}
function populateGlobalTournament(defaultToLatest){
  var sel=el('gTournament'); if(!sel) return;
  var items=tournamentsWithMaxId(ALL);
  var html = '<option value="__all__">All tournaments</option>';
  for(var i=0;i<items.length;i++){
    var nm=String(items[i].name||'');
    html += '<option value="'+ nm.split('"').join('&quot;') +'">'+ nm +'</option>';
  }
  sel.innerHTML = html;
  if(defaultToLatest && items.length){ sel.value = items[0].name; } else { sel.value='__all__'; }
  updateFilterHint();
}
function selectedTournament(){
  var s=el('gTournament'); return s ? String(s.value||'__all__').trim() : '__all__';
}
function baseRowsByTournament(rows){
  var t=selectedTournament(); if(t==='__all__') return rows.slice();
  var lf=t.toLowerCase(), out=[];
  for(var i=0;i<rows.length;i++){ var r=rows[i]; if(norm(r.tournament).toLowerCase()===lf) out.push(r); }
  return out;
}
function updateFilterHint(){
  var t=selectedTournament(); var total=baseRowsByTournament(ALL).length;
  el('filterHint').textContent = (t==='__all__') ? ('Scope: All tournaments • Rows: ' + total) : ('Scope: ' + t + ' • Rows: ' + total);
  el('scopeChip').textContent = 'Scope: ' + ((t==='__all__') ? 'All tournaments' : t);
  el('scopeChipTeam').textContent = (t==='__all__') ? 'All tournaments' : t;
}

/* ===== Table + heat ===== */
function renderSimpleTable(list, cols){
  if (!list || !list.length) return '<div class="muted">No rows.</div>';
  var head = '<thead><tr>'+ cols.map(function(c){ return '<th data-key="'+c.key+'" class="'+(c.right?'right':'')+'">'+c.label+'</th>'; }).join('') +'</tr></thead>';
  var body = '<tbody>'+ list.map(function(r,i){
    return '<tr>' + cols.map(function(c){
      var v;
      if (typeof c.html==='function'){ v=c.html(r,i); }
      else {
        v=r[c.key];
        if (c.format==='pct') v=isFinite(v)?(v*100).toFixed(1)+'%':'—';
        else if (c.format==='1d') v=isFinite(v)?Number(v).toFixed(1):'—';
        else if (c.format==='0d') v=isFinite(v)?Number(v).toFixed(0):'—';
        if (c.link && v && looksLikeURL(v)) v='<a href="'+v+'" target="_blank" rel="noopener">'+v+'</a>';
      }
      return '<td data-key="'+c.key+'" class="'+(c.right?'right':'')+'">'+((v==null||v==='')?'—':v)+'</td>';
    }).join('') + '</tr>';
  }).join('') +'</tbody>';
  return '<table>'+head+body+'</table>';
}
function applyColumnHeatmap(containerId, keys){
  var wrap=el(containerId); if(!wrap) return;
  var table=wrap.querySelector('table'); if(!table) return;
  var tds=table.querySelectorAll('td[data-key]');
  for(var i=0;i<tds.length;i++){ var td=tds[i]; td.style.backgroundColor=''; td.classList.remove('heat-top'); }
  var styles=getComputedStyle(document.documentElement);
  var rgb=styles.getPropertyValue('--heat-rgb')||'255,189,89';
  var minA=parseFloat(styles.getPropertyValue('--heat-min'))||.06;
  var maxA=parseFloat(styles.getPropertyValue('--heat-max'))||.22;
  var BANDS=5;
  for(var j=0;j<keys.length;j++){
    var key=keys[j];
    var cells=[].slice.call(table.querySelectorAll('td[data-key="'+key+'"]'));
    if(!cells.length) continue;
    var entries=[];
    for(var c=0;c<cells.length;c++){
      var td=cells[c];
      var raw=(td.textContent||'').trim().replace('%','').replace(/,/g,'');
      var val=parseFloat(raw);
      if(isFinite(val)) entries.push({td:td,i:c,v:val});
    }
    if(!entries.length) continue;
    var asc=entries.slice().sort(function(a,b){ return a.v-b.v; });
    var nlen=asc.length, bandByIndex=new Map();
    for(var r=0;r<asc.length;r++){
      var p=(nlen<=1)?1:(r/(nlen-1));
      var band=Math.min(BANDS-1, Math.floor(p*BANDS));
      bandByIndex.set(asc[r].i, band);
    }
    var topVal=asc[nlen-1].v;
    for(var c2=0;c2<cells.length;c2++){
      var b=bandByIndex.get(c2);
      if(b==null) continue;
      var alpha=minA + (b/(BANDS-1))*(maxA-minA);
      cells[c2].style.backgroundColor='rgba('+rgb+', '+alpha.toFixed(3)+')';
      var num=parseFloat(cells[c2].textContent);
      if(isFinite(num) && num===topVal) cells[c2].classList.add('heat-top');
    }
  }
}

/* ===== Aggregations (ffbr_data) ===== */
function codeFromRow(r){ var code=norm(r._tag).toUpperCase(); return ALLOWED_TAGS.has(code) ? code : null; }
function metaFromCode(code){ return code ? TEAM_BY_CODE[String(code).toLowerCase()] : null; }
function aggregateOverall(rows){
  var grouped=new Map();
  for(var i=0;i<rows.length;i++){ var r=rows[i]; var code=codeFromRow(r); if(!code) continue; if(!grouped.has(code)) grouped.set(code,[]); grouped.get(code).push(r); }
  var out=[];
  grouped.forEach(function(list,code){
    var meta=metaFromCode(code); var m=list.length; if(!m||!meta) return;
    var booyahs=sum(list,'booyah'), elims=sum(list,'elimination'), place=sum(list,'placement'), total=sum(list,'total');
    out.push({ team:meta.fullname, code:meta.name, region:(meta.region||'—'), ew: meta.ew||'',
      matches:m, booyahs:booyahs, elims:elims, placement:place, total:total,
      booyah_rate:booyahs/m, elims_pm:elims/m, placement_pm:place/m, total_pm:total/m, top3_rate: sum(list,'top3')/m });
  });
  return out;
}
function aggregateTeamsForMap(rows,mapValue){
  var perTeam=new Map();
  for(var i=0;i<rows.length;i++){
    var r=rows[i];
    if(mapValue && mapValue!=='__all__'){ if((norm(r.map)||'').toLowerCase()!==String(mapValue).toLowerCase()) continue; }
    var code=codeFromRow(r); if(!code) continue;
    if(!perTeam.has(code)) perTeam.set(code,[]); perTeam.get(code).push(r);
  }
  var out=[];
  perTeam.forEach(function(list,code){
    var meta=metaFromCode(code); var m=list.length; if(!m||!meta) return;
    var booyahs=sum(list,'booyah'), elims=sum(list,'elimination'), place=sum(list,'placement'), total=sum(list,'total');
    out.push({ team:meta.fullname, code:meta.name, region:(meta.region||'—'), ew: meta.ew||'',
      matches:m, booyahs:booyahs, elims:elims, placement:place, total:total,
      booyah_rate:booyahs/m, elims_pm:elims/m, placement_pm:place/m, total_pm:total/m, top3_rate: sum(list,'top3')/m });
  });
  return out;
}
function uniqueMaps(rows){
  var s=new Set();
  for(var i=0;i<rows.length;i++){ var m=norm(rows[i].map); if(m) s.add(m); }
  return Array.from(s).sort(function(a,b){ return a.localeCompare(b); });
}

/* ===== Team info helpers ===== */
function splitToLines(val){
  if (val == null) return [];
  if (Array.isArray(val) ) return val.flat().map(function(x){return String(x).trim();}).filter(Boolean);
  var s=String(val).trim();
  try{ if(/^\s*\[/.test(s)){ var arr=JSON.parse(s); if(Array.isArray(arr)) return arr.flat().map(function(x){return String(x).trim();}).filter(Boolean); } }catch(_){}
  s=s.replace(/[•\u2022\u00b7]/g,'\n');
  var parts=s.split(/\r?\n|;|\|/); if(parts.length===1 && s.indexOf(',')>-1) parts=s.split(',');
  return parts.map(function(x){return x.trim();}).filter(Boolean);
}
function asListHTML(val){
  var items = splitToLines(val); if(!items.length) return '—';
  return '<ul style="margin:0;padding-left:16px">'+ items.map(function(it){ return '<li>'+it+'</li>'; }).join('') +'</ul>';
}
async function fetchTeamInfoBy(codeRaw){
  var codeUp=norm(codeRaw).toUpperCase();
  try{
    var res=await client.from('br_team_info').select('*').eq('Team Initials', codeUp).limit(1);
    if(res.error) throw res.error;
    if(res.data && res.data.length) return res.data[0];
  }catch(e){ console.warn('br_team_info fetch error:', e.message||e); }
  return null;
}
async function fetchPlayersBy(codeRaw){
  var codeUp=norm(codeRaw).toUpperCase();
  try{
    var res=await client.from('br_player_info').select('*').eq('TAG', codeUp);
    if(res.error) throw res.error;
    return res.data||[];
  }catch(e){ console.warn('br_player_info fetch error:', e.message||e); return []; }
}

/* ===== Roster field pickers + IGN/Age ===== */
function pickKey(keys, patterns){
  for(var i=0;i<patterns.length;i++){
    var rx = patterns[i];
    for(var j=0;j<keys.length;j++){ var k=keys[j]; if(rx.test(k)) return k; }
  }
  return null;
}
function parseAgeValue(record, ageKey, dobKey){
  if(ageKey){
    var raw = record[ageKey];
    if(raw!=null && String(raw).trim()!==''){
      var m = String(raw).match(/(\d{1,3})/);
      if(m){ var v = Number(m[1]); if(isFinite(v) && v>=0 && v<130) return v; }
    }
  }
  if(dobKey){
    var raw2 = String(record[dobKey] || '').trim();
    if(raw2){
      var d = new Date(raw2);
      if(!isNaN(d.getTime())){
        var today = new Date();
        var age = today.getFullYear() - d.getFullYear();
        var mo = today.getMonth() - d.getMonth();
        if(mo < 0 || (mo === 0 && today.getDate() < d.getDate())) age--;
        if(isFinite(age) && age>=0 && age<130) return age;
      }
    }
  }
  return null;
}
function renderRoster(players){
  var box=el('teamRosterBody');
  if(!players || !players.length){ box.innerHTML='<div class="muted">No players found.</div>'; return; }
  var keys=Object.keys(players[0]||{});
  var avatarKey = pickKey(keys, [/photo|avatar|image|picture/i]);
  var ignKey = pickKey(keys, [/^ign$/i,/\bplayer\s*ign\b/i,/\bin-?\s*game\s*name\b/i,/\bnick\s*name\b/i,/\bnickname\b/i,/\bhandle\b/i,/\balias\b/i,/\bplayer\s*name\b/i,/^name$/i]) || null;
  var roleKey    = pickKey(keys, [/^role$/i, /\bposition\b/i]) || null;
  var countryKey = pickKey(keys, [/^country$/i, /\bnation\b/i]) || null;
  var ageKey = pickKey(keys, [/^age\b/i, /\bage\s*\(?(yrs|years)?\)?/i, /\byears?\s*old\b/i]) || null;
  var dobKey = pickKey(keys, [/\b(dob|birth(date)?|date\s*of\s*birth)\b/i]) || null;
  var accolKey = keys.indexOf('Accolades')>-1 ? 'Accolades' : (pickKey(keys, [/accolade|achievement|title|award/i]) || null);
  var formerKey = pickKey(keys, [/\b(former|previous|past|ex)[\s_]*teams?\b/i,/\bteam\s*history\b/i,/^Former Team(s)?$/i]) || 'Former Team';

  var rows = players.slice().map(function(p){
    var avatar = (avatarKey && p[avatarKey]) ? ('<img src="'+p[avatarKey]+'" alt="" style="width:38px;height:38px;object-fit:cover;border-radius:8px;border:1px solid #2a2a2a">') : '';
    var ign = (function(){
      var tryKeys = ignKey ? [ignKey] : [];
      tryKeys.push('IGN','In-game Name','Player IGN','Player Name','Nickname','Name','name');
      for(var i=0;i<tryKeys.length;i++){ var k=tryKeys[i]; if(k in p && String(p[k]).trim()!=='') return String(p[k]).trim(); }
      return '—';
    })();
    var role    = roleKey    ? (p[roleKey]    !=null ? p[roleKey]    : '—') : '—';
    var country = countryKey ? (p[countryKey] !=null ? p[countryKey] : '—') : '—';
    var ageNum = parseAgeValue(p, ageKey, dobKey);
    var age    = (ageNum==null) ? (ageKey? String(p[ageKey]||'—'): '—') : ageNum;
    var accHTML    = accolKey  ? asListHTML(p[accolKey])  : '—';
    var formerHTML = formerKey ? asListHTML(p[formerKey]) : '—';
    return { avatar:avatar, ign:ign, role:role, country:country, age:age, formerHTML:formerHTML, accHTML:accHTML };
  });
  rows.sort(function(a,b){ return String(a.role||'').localeCompare(String(b.role||'')) || String(a.ign||'').localeCompare(String(b.ign||'')); });
  box.innerHTML = renderSimpleTable(rows, [
    {label:'', key:'avatar'},
    {label:'IGN', key:'ign'},
    {label:'Role', key:'role'},
    {label:'Country', key:'country'},
    {label:'Age', key:'age', right:true},
    {label:'Former Team', key:'formerHTML'},
    {label:'Accolades', key:'accHTML'},
  ]);
}

/* ===== Team-specific (ffbr_data) ===== */
function kpiDataset(rows){
  var matches=rows.length, booyahs=sum(rows,'booyah'), total=sum(rows,'total'), elims=sum(rows,'elimination'), place=sum(rows,'placement'), damage=sum(rows,'damage'), top3=sum(rows,'top3');
  return {
    matches:matches, booyahs:booyahs, elims:elims, placement:place, total:total,
    booyah_rate: matches? booyahs/matches : 0,
    total_per_match: matches? total/matches : 0,
    elims_per_match: matches? elims/matches : 0,
    place_per_match: matches? place/matches : 0,
    dmg_per_match: matches? damage/matches : 0,
    top3_rate: matches? top3/matches : 0
  };
}
function teamMapPerf(rows){
  var g = groupBy(rows, function(r){ return r.map||'—'; });
  var out=[];
  g.forEach(function(list,map){
    var m=list.length, booyahs=sum(list,'booyah'), elims=sum(list,'elimination'), place=sum(list,'placement'), total=sum(list,'total');
    out.push({ map:map, matches:m, booyahs:booyahs, elims:elims, placement:place, total:total,
      booyah_rate:m?booyahs/m:0, elims_pm:m?elims/m:0, placement_pm:m?place/m:0, total_pm:m?total/m:0 });
  });
  out.sort(function(a,b){ return (b.total_pm - a.total_pm) || (b.matches - a.matches) || a.map.localeCompare(b.map); });
  return out;
}

/* ===== LOPS normalize (+ last played + tournament scope) ===== */
function normLopsRow(r){
  function get(k,alt){ if(r[k]!=null) return r[k]; if(alt){ for(var i=0;i<alt.length;i++){ if(r[alt[i]]!=null) return r[alt[i]]; } } return null; }
  function toI(v){ return Number(v!=null?v:0) || 0; }
  function toS(v){ return v==null ? '' : String(v).trim(); }

  var team = toS(get('TeamName')) || toS(get('Team')) || '';
  var player = toS(get('PLAYER NAME',['Player name','Player Name','Player','IGN']));
  var map = toS(get('MAP',['Map','map']));
  var tournament = toS(get('TOURNAMENT',['Tournament','tournament']));

  var year  = toI(get('YEAR',['Year','year']));
  var week  = toI(get('WEEK',['Week','week']));
  var day   = toI(get('DAY',['Day','day']));
  var matchN = toI(get('MATCH',['Match','match','Game','Game No','GameNo']));

  var dateRaw = get('DATE',['Date','date']);
  var dateISO = '', ts = 0;
  if(dateRaw){
    var d = new Date(String(dateRaw));
    if(!isNaN(d)) { dateISO = d.toISOString().slice(0,10); ts = d.getTime(); }
  }
  var created = get('created_at', []);
  if(!ts && created){
    var d2 = new Date(String(created));
    if(!isNaN(d2)) { if(!dateISO) dateISO = d2.toISOString().slice(0,10); ts = d2.getTime(); }
  }
  var idVal = toI(get('id',['ID']));

  var shots = toI(get('SHOOTS')), hits  = toI(get('HITS'));
  var headA = toI(get('HEADSHOTRS')), headB = toI(get('Headshot Kill Times'));
  var glooDestroyed = toI(get('IcewallDestroyedTimes')) + toI(get('SkylerIceWallDestroy'));
  var revivesGiven  = toI(get('ReviveTeammateTimes')) + toI(get('Revive Teammate Nums'));
  var nadeKills = toI(get('Grenade kill')) + toI(get('Ice Grenade kill')) + toI(get('Dragon Grenade Kill'));
  var c1 = toS(get('Character 1')); var c2 = toS(get('Character 2')); var c3 = toS(get('Character 3')); var c4 = toS(get('Character 4'));
  var act1 = toS(get('SkillActive_1',['SkillActive','Active'])); var act2 = toS(get('SkillActive_2')); var act3 = toS(get('SkillActive_3')); var act4 = toS(get('SkillActive_4'));

  return {
    _team: team.toUpperCase(), _player: player, _map: map,
    tournament: tournament, year: year, week: week, day: day, match: matchN, date: dateISO, ts: ts, id: idVal,
    kills: toI(get('KILLS')), assists: toI(get('ASSISTS')), shots: shots, hits: hits,
    headshots: headA || headB || 0, damage: toI(get('DAMAGE')),
    knockdowns: toI(get('Knock Down')), vehicle: toI(get('Vehicle Kill')), grenade: nadeKills,
    gloo_used: toI(get('IcewallUse')), gloo_break: glooDestroyed, medkits: toI(get('MedkitUse')),
    moving_distance: toI(get('MovingDistance')), vehicle_move_distance: toI(get('Vehicle Move Distance')),
    revives: toI(get('ReviveTeammateTimes')) + toI(get('Revive Teammate Nums')),
    revived: toI(get('RevivedTimes')), survival_time: toI(get('Survival Time')),
    active: act1 || '', pet: toS(get('Pet Skill Name',['Pet','Pet Name'])) || '',
    mvp: toI(get('MVP')) ? 1 : 0,
    char1: c1, char2: c2, char3: c3, char4: c4,
    charActives: [act1,act2,act3,act4]
  };
}
async function fetchAllLopsRows(){
  var CHUNK=1000, from=0, out=[];
  while(true){
    var res=await client.from('ffbr_lopsdata').select('*').range(from, from+CHUNK-1);
    if(res.error){ gerr('ffbr_lopsdata fetch failed. Check RLS / table name.\n\n'+(res.error.message||res.error)); break; }
    var rows=res.data||[]; if(!rows.length) break;
    for(var i=0;i<rows.length;i++) out.push(rows[i]);
    from+=rows.length;
  }
  out = out.map(normLopsRow).filter(function(r){ return r._player && r._team; });
  return out;
}
function lopsRowsForTeam(all, teamObj){
  if(!teamObj) return [];
  var code=(teamObj.name||'').trim().toUpperCase();
  return all.filter(function(r){ return (r._team||'').toUpperCase()===code; });
}
function lopsRowsForTeamScoped(teamObj){
  var rows = lopsRowsForTeam(LOPS_ALL, teamObj);
  var t = selectedTournament();
  if(t==='__all__') return rows;
  var lf = String(t).toLowerCase();
  return rows.filter(function(r){ return String(r.tournament||'').toLowerCase()===lf; });
}
function countByName(rows,key){
  var m=new Map();
  for(var i=0;i<rows.length;i++){
    var raw=norm(rows[i][key]); if(!raw) continue;
    var k=raw.toLowerCase().replace(/\s+/g,' ').trim();
    if(!m.has(k)) m.set(k,{name:raw,picks:0});
    m.get(k).picks += 1;
  }
  return Array.from(m.values());
}
function lopsTopPlayersByKills(rows){
  var m=new Map();
  for(var i=0;i<rows.length;i++){
    var r=rows[i], p=r._player; if(!p) continue;
    if(!m.has(p)) m.set(p,{player:p, team:r._team||'—', kills:0, assists:0, headshots:0, grenade:0, damage:0, rows:0});
    var o=m.get(p); o.kills+=r.kills; o.assists+=r.assists; o.headshots+=r.headshots; o.grenade+=r.grenade; o.damage+=r.damage; o.rows++;
  }
  return Array.from(m.values());
}

/* ===== Sorting ===== */
function sortRows(rows, key, dir, isText){
  if(isText){
    rows.sort(function(a,b){
      var A=String(a[key]||''), B=String(b[key]||'');
      return dir==='desc' ? B.localeCompare(A) : A.localeCompare(B);
    });
    return rows;
  }
  rows.sort(function(a,b){
    var A=(a[key]!=null?a[key]:0), B=(b[key]!=null?b[key]:0);
    return dir==='desc' ? (B-A) : (A-B);
  });
  return rows;
}

/* ===== match_api mapping (type=2) ===== */
async function fetchMatchApiMap(){
  try{
    var res=await client.from('match_api').select('id,name,type').limit(10000);
    if(res.error) throw res.error;
    MATCH_API_MAP.clear();
    var data=res.data||[];
    for(var i=0;i<data.length;i++){
      var r=data[i];
      var t = (r.type===undefined||r.type===null) ? '' : String(r.type).trim();
      var isChar = (t==='2' || Number(t)===2);
      if(!isChar) continue;
      var id = String(r.id || '').trim();
      var nm = String(r.name || '').trim();
      if(id && nm) MATCH_API_MAP.set(id, nm);
    }
    var hint=el('charMapHint');
    if(hint) hint.textContent = MATCH_API_MAP.size
      ? ('Character map loaded from match_api (type=2): ' + MATCH_API_MAP.size + ' entries.')
      : 'match_api had no rows with type=2. Using IDs/fallbacks.';
  }catch(e){
    console.warn('match_api load error:', e.message||e);
    var hint2=el('charMapHint'); if(hint2) hint2.textContent = 'Could not load match_api (type=2). Using IDs/fallbacks.';
  }
}
function mapCharName(id, fallback){
  var key = String(id||'').trim();
  if(!key) return fallback || '—';
  if(MATCH_API_MAP.has(key)) return MATCH_API_MAP.get(key);
  return fallback || ('ID '+key);
}

/* ===== Last Played helpers ===== */
function fmtLastPlayed(meta){
  if(!meta) return '—';
  var parts=[];
  if(isFinite(meta.week) && meta.week>0) parts.push('W'+meta.week);
  if(isFinite(meta.day)  && meta.day>0)  parts.push('D'+meta.day);
  if(isFinite(meta.match)&& meta.match>0)parts.push('M'+meta.match);
  if(meta.date) parts.push(meta.date);
  return parts.join(' • ') || '—';
}
function pickLatestDayMatch(rows){
  if(!rows.length) return null;
  var bestKey=null, best=null;
  function cmp(a,b){
    for(var i=0;i<a.length;i++){ var av=a[i]||0, bv=b[i]||0; if(av>bv) return 1; if(av<bv) return -1; }
    return 0;
  }
  for(var i=0;i<rows.length;i++){
    var r=rows[i];
    var key=[n(r.ts), n(r.year), n(r.week), n(r.day), n(r.match), n(r.id), i];
    if(!bestKey || cmp(key,bestKey)>0){ bestKey=key; best=r; }
  }
  if(!best) return null;
  return { week: n(best.week)||null, day: n(best.day)||null, match: n(best.match)||null, date: best.date || null };
}

/* ===== Renders ===== */
function renderOverall(){
  var rows = aggregateOverall(baseRowsByTournament(ALL));
  var sortKey = el('overallSortKey').value;
  var dir = el('overallSortDir').getAttribute('data-dir') || 'desc';
  if (sortKey==='team') sortRows(rows, 'team', dir, true);
  else sortRows(rows, sortKey, dir, false);
  el('tblOverall').innerHTML = renderSimpleTable(rows, [
    {label:'Team',key:'team'},{label:'Code',key:'code'},{label:'E/W',key:'ew'},{label:'Region',key:'region'},
    {label:'Matches',key:'matches',right:true},{label:'Booyahs',key:'booyahs',right:true},{label:'Elims',key:'elims',right:true},
    {label:'Placement',key:'placement',right:true},{label:'Total',key:'total',right:true},
    {label:'Booyah %',key:'booyah_rate',format:'pct',right:true},{label:'Elims/m',key:'elims_pm',format:'1d',right:true},
    {label:'Place/m',key:'placement_pm',format:'1d',right:true},{label:'Total/m',key:'total_pm',format:'1d',right:true},
    {label:'Top3%',key:'top3_rate',format:'pct',right:true},
  ]);
  applyColumnHeatmap('tblOverall', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
}
function renderPerMapAllTeams(){
  var base=baseRowsByTournament(ALL);
  var mapSel=el('mapFilter').value;
  var rows = aggregateTeamsForMap(base, mapSel);
  var sortKey = el('perMapSortKey').value;
  var dir = el('perMapSortDir').getAttribute('data-dir') || 'desc';
  if (sortKey==='team') sortRows(rows, 'team', dir, true);
  else sortRows(rows, sortKey, dir, false);
  el('tblPerMapAllTeams').innerHTML = renderSimpleTable(rows, [
    {label:'Team',key:'team'},{label:'Code',key:'code'},{label:'E/W',key:'ew'},{label:'Region',key:'region'},
    {label:'Matches',key:'matches',right:true},{label:'Booyahs',key:'booyahs',right:true},{label:'Elims',key:'elims',right:true},
    {label:'Placement',key:'placement',right:true},{label:'Total',key:'total',right:true},
    {label:'Booyah %',key:'booyah_rate',format:'pct',right:true},{label:'Elims/m',key:'elims_pm',format:'1d',right:true},
    {label:'Place/m',key:'placement_pm',format:'1d',right:true},{label:'Total/m',key:'total_pm',format:'1d',right:true},
    {label:'Top3%',key:'top3_rate',format:'pct',right:true},
  ]);
  applyColumnHeatmap('tblPerMapAllTeams', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
}
function kpiAndByMap(){
  if(!CURRENT_TEAM){
    el('teamTitle').textContent='Selected Team — Overview';
    el('identityBody').innerHTML='Select a team.'; el('kpiBody').innerHTML='—'; return;
  }
  el('teamTitle').textContent = 'Selected Team — Overview';
  el('identityBody').innerHTML = ''
    + '<div style="display:flex;gap:12px;align-items:center">'
    +   '<img src="'+(CURRENT_TEAM.logo||'')+'" alt="'+(CURRENT_TEAM.fullname||'')+' logo" style="width:72px;height:72px;object-fit:contain" onerror="this.style.visibility=\'hidden\'">'
    +   '<div><div style="font-size:1.1rem;font-weight:800">'+CURRENT_TEAM.name+'</div>'
    +   '<div class="muted">'+(CURRENT_TEAM.fullname||'')+' • '+(CURRENT_TEAM.region||'—')+(CURRENT_TEAM.ew?(' • '+CURRENT_TEAM.ew):'')+'</div></div>'
    + '</div>';
  var k=kpiDataset(TEAM_ROWS);
  el('kpiBody').innerHTML = k.matches ? (
    '<div class="kpis">'
      + '<div class="kpi">Rows <strong>'+k.matches+'</strong></div>'
      + '<div class="kpi">Booyahs <strong>'+k.booyahs+'</strong> (<strong>'+fmtPct(k.booyah_rate)+'</strong>)</div>'
      + '<div class="kpi">Elims <strong>'+k.elims+'</strong> • <strong>'+k.elims_per_match.toFixed(1)+'</strong>/m</div>'
      + '<div class="kpi">Placement <strong>'+k.placement+'</strong> • <strong>'+k.place_per_match.toFixed(1)+'</strong>/m</div>'
      + '<div class="kpi">Damage <strong>'+k.dmg_per_match.toFixed(0)+'</strong>/m</div>'
      + '<div class="kpi">Total <strong>'+k.total+'</strong> • <strong>'+k.total_per_match.toFixed(1)+'</strong>/m</div>'
      + '<div class="kpi">Top3 <strong>'+fmtPct(k.top3_rate)+'</strong></div>'
    + '</div>'
  ) : '<div class="muted">No rows.</div>';

  var rows=teamMapPerf(TEAM_ROWS);
  var mapWrap = el('tblMapTeam');
  if(mapWrap){
    mapWrap.innerHTML = renderSimpleTable(rows, [
      {label:'Map',key:'map'},
      {label:'Matches',key:'matches',right:true},
      {label:'Booyahs',key:'booyahs',right:true},
      {label:'Elims',key:'elims',right:true},
      {label:'Placement',key:'placement',right:true},
      {label:'Total',key:'total',right:true},
      {label:'Booyah %',key:'booyah_rate',format:'pct',right:true},
      {label:'Elims / m',key:'elims_pm',format:'1d',right:true},
      {label:'Placement / m',key:'placement_pm',format:'1d',right:true},
      {label:'Total / m',key:'total_pm',format:'1d',right:true}
    ]);
    applyColumnHeatmap('tblMapTeam', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
  }
}
function renderTeamCombinedMetrics(){
  var totalsEl = el('teamTotals'), avgsEl = el('teamAverages'), sigEl = el('teamSignals');
  if(!CURRENT_TEAM){ totalsEl.innerHTML=avgsEl.innerHTML=sigEl.innerHTML='—'; return; }
  var games=TEAM_ROWS.length||0;

  var teamLops = lopsRowsForTeamScoped(CURRENT_TEAM);

  var totals = {
    kills:sum(teamLops,'kills'), dmg:sum(teamLops,'damage'), assists:sum(teamLops,'assists'), knock:sum(teamLops,'knockdowns'),
    glooUsed:sum(teamLops,'gloo_used'), glooBreak:sum(teamLops,'gloo_break'),
    revives:sum(teamLops,'revives'), nade:sum(teamLops,'grenade'), vehicle:sum(teamLops,'vehicle'), hs:sum(teamLops,'headshots'),
    shots:sum(teamLops,'shots'), hits:sum(teamLops,'hits'), survival:sum(teamLops,'survival_time'), mvp:sum(teamLops,'mvp')
  };
  var acc=safeDiv(totals.hits, totals.shots);
  var hsRate=safeDiv(totals.hs, totals.kills);
  totalsEl.innerHTML = ''
    + '<div class="kpi">TOTAL ELIMS <strong>'+totals.kills+'</strong></div>'
    + '<div class="kpi">TOTAL DMG <strong>'+totals.dmg+'</strong></div>'
    + '<div class="kpi">TOTAL ASSISTS <strong>'+totals.assists+'</strong></div>'
    + '<div class="kpi">KNOCKDOWNS <strong>'+totals.knock+'</strong></div>'
    + '<div class="kpi">GLOO USED <strong>'+totals.glooUsed+'</strong></div>'
    + '<div class="kpi">GLOO DESTROYED <strong>'+totals.glooBreak+'</strong></div>'
    + '<div class="kpi">REVIVES <strong>'+totals.revives+'</strong></div>'
    + '<div class="kpi">NADE KILLS <strong>'+totals.nade+'</strong></div>'
    + '<div class="kpi">VEHICLE KILLS <strong>'+totals.vehicle+'</strong></div>'
    + '<div class="kpi">HEADSHOTS <strong>'+totals.hs+'</strong></div>'
    + '<div class="kpi">MVPs <strong>'+totals.mvp+'</strong></div>'
    + '<div class="kpi">GAMES PLAYED <strong>'+games+'</strong></div>';
  avgsEl.innerHTML = games ? (
    '<div class="kpi">AVG ELIMS <strong>'+ (totals.kills/games).toFixed(1) +'</strong></div>'
    + '<div class="kpi">AVG DMG <strong>'+ (totals.dmg/games).toFixed(0) +'</strong></div>'
    + '<div class="kpi">AVG ASSISTS <strong>'+ (totals.assists/games).toFixed(1) +'</strong></div>'
    + '<div class="kpi">AVG HEADSHOTS <strong>'+ (totals.hs/games).toFixed(1) +'</strong></div>'
  ) : '<div class="muted">No games found for averages.</div>';

  var lastMeta = pickLatestDayMatch(teamLops);
  sigEl.innerHTML = ''
    + '<div class="kpi">ACCURACY <strong>'+fmtPct(acc)+'</strong></div>'
    + '<div class="kpi">HS / KILL <strong>'+(isFinite(hsRate)?hsRate.toFixed(2):'—')+'</strong></div>'
    + '<div class="kpi">LAST PLAYED <strong>'+fmtLastPlayed(lastMeta)+'</strong></div>';
}
function renderTeamActiveUsage(){
  var limit=Number(el('teamActiveTop').value)||10;
  var list=countByName(lopsRowsForTeamScoped(CURRENT_TEAM),'active')
    .sort(function(a,b){ return (b.picks-a.picks) || a.name.localeCompare(b.name); })
    .slice(0,limit).map(function(r,i){ r.rank=i+1; return r; });
  el('tblTeamActive').innerHTML = renderSimpleTable(list, [
    {label:'#',key:'rank',right:true},
    {label:'Active Skill',key:'name'},
    {label:'Picks',key:'picks',right:true},
  ]);
  applyColumnHeatmap('tblTeamActive', ['picks']);
}
function renderTeamPetUsage(){
  var limit=Number(el('teamPetTop').value)||10;
  var list=countByName(lopsRowsForTeamScoped(CURRENT_TEAM),'pet')
    .sort(function(a,b){ return (b.picks-a.picks) || a.name.localeCompare(b.name); })
    .slice(0,limit).map(function(r,i){ r.rank=i+1; return r; });
  el('tblTeamPet').innerHTML = renderSimpleTable(list, [
    {label:'#',key:'rank',right:true},
    {label:'Pet',key:'name'},
    {label:'Picks',key:'picks',right:true},
  ]);
  applyColumnHeatmap('tblTeamPet', ['picks']);
}
function renderPlayers(){
  var base=lopsRowsForTeamScoped(CURRENT_TEAM);
  if(!base.length){ el('tblPlayers').innerHTML='<div class="muted">No lops rows for team.</div>'; return; }
  var g = groupBy(base, function(r){ return r._player||'—'; });
  var rows=[];
  g.forEach(function(list,player){
    var kills=sum(list,'kills'), assists=sum(list,'assists'), dmg=sum(list,'damage');
    var hs=sum(list,'headshots'), nade=sum(list,'grenade'), veh=sum(list,'vehicle'), downs=sum(list,'knockdowns');
    var shots=sum(list,'shots'), hits=sum(list,'hits'), acc=safeDiv(hits, shots), hsRate=safeDiv(hs, kills);
    function mode(arr){ var m=new Map(); for(var i=0;i<arr.length;i++){ var v=norm(arr[i]); if(!v) continue; m.set(v,(m.get(v)||0)+1); } var best='',cnt=0; m.forEach(function(c,k){ if(c>cnt){best=k;cnt=c;} }); return best||'—'; }
    rows.push({ player:player, rows:list.length, kills:kills, assists:assists, dmg:dmg, hs:hs, nade:nade, veh:veh, downs:downs, acc:acc, hsRate:hsRate, active:mode(list.map(function(r){return r.active;})), pet:mode(list.map(function(r){return r.pet;})) });
  });
  rows.sort(function(a,b){ return (b.kills-a.kills) || a.player.localeCompare(b.player); });
  rows = rows.map(function(r,i){ r.rank=i+1; return r; });
  el('tblPlayers').innerHTML = renderSimpleTable(rows, [
    {label:'#',key:'rank',right:true},
    {label:'Player',key:'player'},
    {label:'Rows',key:'rows',right:true},
    {label:'Kills',key:'kills',right:true},
    {label:'Assists',key:'assists',right:true},
    {label:'Damage',key:'dmg',right:true},
    {label:'HS',key:'hs',right:true},
    {label:'Acc',key:'acc',right:true,html:function(r){return isFinite(r.acc)?fmtPct(r.acc):'—';}},
    {label:'HS/K',key:'hsRate',right:true,html:function(r){return isFinite(r.hsRate)?r.hsRate.toFixed(2):'—';}},
    {label:'Grenade',key:'nade',right:true},
    {label:'Vehicle',key:'veh',right:true},
    {label:'Knockdowns',key:'downs',right:true},
    {label:'Most Active',key:'active'},
    {label:'Most Pet',key:'pet'},
  ]);
  applyColumnHeatmap('tblPlayers', ['kills','assists','dmg','hs','nade','veh','downs','rows']);
}

/* ===== By Day pivot ===== */
function renderByDay(){
  if(!TEAM_ROWS.length){
    el('tblByDay').innerHTML = '<div class="muted">No rows.</div>';
    return;
  }
  function dayLabel(r){ return 'Y'+(n(r.year)||'—')+' W'+(n(r.week)||'—')+' D'+(n(r.day)||'—'); }

  var daySet = new Set(), mapSet = new Set();
  for(var i=0;i<TEAM_ROWS.length;i++){ var r=TEAM_ROWS[i]; mapSet.add(norm(r.map) || '—'); daySet.add(dayLabel(r)); }
  var days = Array.from(daySet).sort(function(a,b){ return a.localeCompare(b); });
  var maps = Array.from(mapSet).sort(function(a,b){ return a.localeCompare(b); });

  var totals = new Map();
  for(var j=0;j<TEAM_ROWS.length;j++){
    var rr=TEAM_ROWS[j];
    var m = norm(rr.map) || '—';
    var d = dayLabel(rr);
    if(!totals.has(m)) totals.set(m, new Map());
    var row = totals.get(m);
    row.set(d, (row.get(d) || 0) + n(rr.total));
  }

  var thead = '<thead><tr><th data-key="map">Map</th>'+ days.map(function(d){ return '<th data-key="'+d+'" class="right">'+d+'</th>'; }).join('') +'</tr></thead>';
  var tbody = '<tbody>';
  for(var k=0;k<maps.length;k++){
    var mname=maps[k], row = totals.get(mname) || new Map();
    tbody += '<tr><td data-key="map">'+mname+'</td>' +
      days.map(function(d){
        var v = row.get(d);
        return '<td data-key="'+d+'" class="right">'+ ((v!=null && isFinite(v)) ? Number(v).toFixed(0) : '—') +'</td>';
      }).join('') + '</tr>';
  }
  tbody += '</tbody>';

  el('tblByDay').innerHTML = '<table>'+thead+tbody+'</table>';
  applyColumnHeatmap('tblByDay', days);
}

/* ===== Char usage ===== */
function renderCharUsage(){
  var topN = Number(el('charUsageTop').value)||10;
  var base = lopsRowsForTeamScoped(CURRENT_TEAM);
  if(!base.length){ el('tblCharUsage').innerHTML='<div class="muted">No rows.</div>'; return; }

  var per = new Map();
  function ensure(player){
    if(!per.has(player)) per.set(player,{player:player, rows:0, active:new Map(), passive:new Map()});
    return per.get(player);
  }
  function bump(map, name){ map.set(name, (map.get(name)||0)+1); }

  for(var i=0;i<base.length;i++){
    var r=base[i], P = ensure(r._player||'—'); P.rows++;
    var aName = mapCharName(r.char1, (r.charActives && r.charActives[0]) || r.active || '');
    if(aName && aName!=='—') bump(P.active, aName);
    var p2 = mapCharName(r.char2, (r.charActives && r.charActives[1]) || '');
    var p3 = mapCharName(r.char3, (r.charActives && r.charActives[2]) || '');
    var p4 = mapCharName(r.char4, (r.charActives && r.charActives[3]) || '');
    if(p2 && p2!=='—') bump(P.passive, p2);
    if(p3 && p3!=='—') bump(P.passive, p3);
    if(p4 && p4!=='—') bump(P.passive, p4);
  }

  function listToText(m){
    var arr=Array.from(m.entries()).map(function(x){ return {name:x[0], c:x[1]}; });
    arr.sort(function(a,b){ return (b.c-a.c) || a.name.localeCompare(b.name); });
    return arr.map(function(x){ return x.name+' × '+x.c; }).join(', ') || '—';
  }
  function totalMap(m){ var t=0; m.forEach(function(v){ t+=v; }); return t; }

  var rows = Array.from(per.values()).map(function(o){
    return {
      player:o.player, rows:o.rows,
      activeCount: totalMap(o.active),
      passiveCount: totalMap(o.passive),
      activeList: listToText(o.active),
      passiveList: listToText(o.passive),
    };
  });

  rows.sort(function(a,b){
    return ((b.activeCount+b.passiveCount) - (a.activeCount+a.passiveCount)) || a.player.localeCompare(b.player);
  });
  rows = rows.slice(0, topN);

  el('tblCharUsage').innerHTML = renderSimpleTable(rows, [
    {label:'Player', key:'player'},
    {label:'Active', key:'activeList'},
    {label:'Passive', key:'passiveList'},
  ]);
  applyColumnHeatmap('tblCharUsage', ['rows','activeCount','passiveCount']);
}

/* ===== Team grid ===== */
function renderTeamGrid(filter){
  var grid=el('teamGrid'); var q=String(filter||'').trim().toLowerCase();
  var items=TEAMS.filter(function(t){
    return [t.name,t.fullname,t.region,t.ew,t.alt].join(' ').toLowerCase().indexOf(q)>-1;
  });
  if(!items.length){ grid.innerHTML='<div class="muted">No matches.</div>'; return; }
  var html='';
  for(var i=0;i<items.length;i++){
    var t=items[i];
    html += ''
      + '<div class="team-tile" data-code="'+t.name+'" title="'+t.fullname+'">'
      +   '<img class="team-logo" src="'+(t.logo||'')+'" alt="'+t.fullname+' logo" loading="lazy" onerror="this.style.visibility=\'hidden\'">'
      +   '<div class="team-code">'+t.name+'</div>'
      + '</div>';
  }
  grid.innerHTML = html;
  var tiles = grid.querySelectorAll('.team-tile');
  for(var j=0;j<tiles.length;j++){
    tiles[j].onclick = (function(div){
      return function(){
        var code=div.getAttribute('data-code').toLowerCase();
        var info=TEAM_BY_CODE[code];
        if(info){ selectTeam(info); div.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); }
      };
    })(tiles[j]);
  }
  highlightActiveTile();
}
function highlightActiveTile(){
  var grid=el('teamGrid'); if(!grid) return;
  var tiles=grid.querySelectorAll('.team-tile');
  for(var i=0;i<tiles.length;i++){
    var code=tiles[i].getAttribute('data-code');
    tiles[i].classList.toggle('active', !!CURRENT_TEAM && CURRENT_TEAM.name===code);
  }
}

/* ===== Selection flow ===== */
async function selectTeam(teamObj){
  CURRENT_TEAM = teamObj;
  try{
    var url=new URL(window.location.href);
    url.searchParams.set('team', CURRENT_TEAM.name);
    history.replaceState(null,'',url.toString());
  }catch(_){}
  TEAM_ROWS = baseRowsByTournament(ALL).filter(function(r){
    return (norm(r._tag).toUpperCase()||'') === String(teamObj.name||'').toUpperCase();
  });
  kpiAndByMap();
  renderTeamCombinedMetrics();
  renderTeamActiveUsage();
  renderTeamPetUsage();
  renderPlayers();
  renderByDay();
  renderCharUsage();
  highlightActiveTile();
  var info = await fetchTeamInfoBy(teamObj.name); renderTeamInfo(info);
  var roster = await fetchPlayersBy(teamObj.name); renderRoster(roster);
}

/* ===== Init ===== */
function populateMapFilter(){
  var maps = uniqueMaps(baseRowsByTournament(ALL));
  var html = '<option value="__all__">All maps</option>';
  for(var i=0;i<maps.length;i++) html += '<option>'+maps[i]+'</option>';
  el('mapFilter').innerHTML = html;
}
function wireControls(){
  el('gTournament').addEventListener('change', function(){
    updateFilterHint();
    populateMapFilter();
    renderOverall();
    renderPerMapAllTeams();
    if(CURRENT_TEAM){
      TEAM_ROWS = baseRowsByTournament(ALL).filter(function(r){ return (norm(r._tag).toUpperCase()||'') === String(CURRENT_TEAM.name||'').toUpperCase(); });
      kpiAndByMap(); renderTeamCombinedMetrics(); renderTeamActiveUsage(); renderTeamPetUsage(); renderPlayers(); renderByDay(); renderCharUsage();
      fetchPlayersBy(CURRENT_TEAM.name).then(renderRoster).catch(function(){});
    }
    renderLopsActive(); renderLopsPet(); renderLopsTopKillers();
  });
  el('gTournReset').addEventListener('click', function(){
    var items=tournamentsWithMaxId(ALL);
    el('gTournament').value = items.length ? items[0].name : '__all__';
    el('gTournament').dispatchEvent(new Event('change'));
  });

  el('overallSortKey').addEventListener('change', renderOverall);
  el('overallSortDir').addEventListener('click', function(){
    var b=el('overallSortDir'); var cur=(b.getAttribute('data-dir')==='desc'?'asc':'desc');
    b.setAttribute('data-dir',cur); b.textContent=(cur==='desc'?'Desc':'Asc'); renderOverall();
  });
  el('overallReset').addEventListener('click', function(){
    el('overallSortKey').value='total';
    el('overallSortDir').setAttribute('data-dir','desc'); el('overallSortDir').textContent='Desc';
    renderOverall();
  });

  el('mapFilter').addEventListener('change', renderPerMapAllTeams);
  el('perMapSortKey').addEventListener('change', renderPerMapAllTeams);
  el('perMapSortDir').addEventListener('click', function(){
    var b=el('perMapSortDir'); var cur=(b.getAttribute('data-dir')==='desc'?'asc':'desc');
    b.setAttribute('data-dir',cur); b.textContent=(cur==='desc'?'Desc':'Asc'); renderPerMapAllTeams();
  });
  el('perMapReset').addEventListener('click', function(){
    el('mapFilter').value='__all__'; el('perMapSortKey').value='total';
    el('perMapSortDir').setAttribute('data-dir','desc'); el('perMapSortDir').textContent='Desc';
    renderPerMapAllTeams();
  });

  el('teamSearch').addEventListener('input', function(e){ renderTeamGrid(e.target.value||''); });
  el('teamActiveTop').addEventListener('change', renderTeamActiveUsage);
  el('teamPetTop').addEventListener('change', renderTeamPetUsage);
  el('lopsActiveTop').addEventListener('change', renderLopsActive);
  el('lopsPetTop').addEventListener('change', renderLopsPet);
  el('lopsTopKillersTop').addEventListener('change', renderLopsTopKillers);
  el('charUsageTop').addEventListener('change', renderCharUsage);
}

async function initial(){
  try{
    el('scopeChip').textContent='Scope: —';
    el('scopeChipTeam').textContent='—';

    ALL = await fetchAllRows();
    TEAMS = await fetchHelperTeams();
    if(!TEAMS.length) TEAMS = deriveTeamsFromData(ALL);
    buildTeamIndexes();

    populateGlobalTournament(true);
    populateMapFilter();

    el('overallSortDir').setAttribute('data-dir','desc'); el('overallSortDir').textContent='Desc';
    el('perMapSortDir').setAttribute('data-dir','desc'); el('perMapSortDir').textContent='Desc';
    renderOverall();
    renderPerMapAllTeams();

    renderTeamGrid('');
    try{
      var url=new URL(window.location.href);
      var qTeam=(url.searchParams.get('team')||'').trim().toLowerCase();
      if(qTeam && TEAM_BY_CODE[qTeam]) await selectTeam(TEAM_BY_CODE[qTeam]);
      else if(TEAMS.length) await selectTeam(TEAMS[0]);
    }catch(_){
      if(TEAMS.length) await selectTeam(TEAMS[0]);
    }

    LOPS_ALL = await fetchAllLopsRows();
    await fetchMatchApiMap();

    renderTeamCombinedMetrics(); renderTeamActiveUsage(); renderTeamPetUsage(); renderPlayers(); renderByDay(); renderCharUsage();
    renderLopsActive(); renderLopsPet(); renderLopsTopKillers();

    wireControls();

    document.querySelectorAll('details.accordion').forEach(function(d){ d.open=false; });

    showPage(2);
    el('veil').classList.add('hide');
  }catch(e){
    gerr('Fatal error initializing page:\n\n' + (e && (e.stack||e.message) ? (e.stack||e.message) : String(e)));
    el('veil').classList.add('hide');
  }
}

/* ===== LOPS global (not team-scoped) ===== */
function renderLopsActive(){
  var limit=Number(el('lopsActiveTop').value)||10;
  var list=countByName(LOPS_ALL,'active').sort(function(a,b){ return (b.picks-a.picks) || a.name.localeCompare(b.name); }).slice(0,limit);
  list = list.map(function(r,i){ r.rank=i+1; return r; });
  el('tblLopsActive').innerHTML = renderSimpleTable(list, [
    {label:'#',key:'rank',right:true},
    {label:'Active Skill',key:'name'},
    {label:'Picks',key:'picks',right:true}
  ]);
  applyColumnHeatmap('tblLopsActive', ['picks']);
}
function renderLopsPet(){
  var limit=Number(el('lopsPetTop').value)||10;
  var list=countByName(LOPS_ALL,'pet').sort(function(a,b){ return (b.picks-a.picks) || a.name.localeCompare(b.name); }).slice(0,limit);
  list = list.map(function(r,i){ r.rank=i+1; return r; });
  el('tblLopsPet').innerHTML = renderSimpleTable(list, [
    {label:'#',key:'rank',right:true},
    {label:'Pet',key:'name'},
    {label:'Picks',key:'picks',right:true}
  ]);
  applyColumnHeatmap('tblLopsPet', ['picks']);
}
function renderLopsTopKillers(){
  var limit=Number(el('lopsTopKillersTop').value)||10;
  var list=lopsTopPlayersByKills(LOPS_ALL).sort(function(a,b){ return (b.kills-a.kills) || a.player.localeCompare(b.player); }).slice(0,limit);
  list = list.map(function(r,i){ r.rank=i+1; return r; });
  el('tblLopsTopKillers').innerHTML = renderSimpleTable(list, [
    {label:'#',key:'rank',right:true},
    {label:'Player',key:'player'},
    {label:'Team',key:'team'},
    {label:'Rows',key:'rows',right:true},
    {label:'Kills',key:'kills',right:true},
    {label:'Assists',key:'assists',right:true},
    {label:'HS',key:'headshots',right:true},
    {label:'Grenade',key:'grenade',right:true},
    {label:'Damage',key:'damage',right:true}
  ]);
  applyColumnHeatmap('tblLopsTopKillers', ['rows','kills','assists','headshots','grenade','damage']);
}

initial();

/* ===== Team info render (defined late to use DOM safely) ===== */
function renderTeamInfo(info){
  var box=el('teamInfoBody');
  if(!box) return;
  if(!info){ box.innerHTML='<div class="muted">No team info found.</div>'; return; }
  var keys=Object.keys(info);
  var rewardsKey = null;
  for(var i=0;i<keys.length;i++){ var k=keys[i]; if(k.toLowerCase()==='rewards'){ rewardsKey=k; break; } }
  if(!rewardsKey){
    for(var j=0;j<keys.length;j++){ if(/reward/i.test(keys[j])){ rewardsKey=keys[j]; break; } }
  }
  var hide = {'id':1,'created_at':1,'updated_at':1,'code':1,'team_code':1,'team':1,'team_name':1,'logo':1,'logo_url':1,'photo':1,'image':1,'image_url':1};
  var preferred=['Team Initials','country','region','coach','manager','owner','org','sponsor','website','twitter','facebook','youtube','instagram','tiktok','discord'];
  if (rewardsKey) preferred.push(rewardsKey);
  var picked=[];
  for(var p=0;p<preferred.length;p++){ if(keys.indexOf(preferred[p])>-1) picked.push(preferred[p]); }
  for(var q=0;q<keys.length;q++){ var k2=keys[q]; if(preferred.indexOf(k2)===-1 && !hide[k2]) picked.push(k2); }
  var rows='';
  for(var r=0;r<picked.length;r++){
    var k3=picked[r], v=info[k3]; if(v==null || v==='') continue;
    if(k3===rewardsKey) v=asListHTML(v);
    else { if(typeof v==='object'){ try{ v=JSON.stringify(v); }catch(_){ } } if(looksLikeURL(v)) v='<a href="'+v+'" target="_blank" rel="noopener">'+v+'</a>'; }
    rows += '<tr><th style="width:160px;color:var(--muted);font-weight:600">'+String(k3).replace(/_/g,' ')+'</th><td>'+v+'</td></tr>';
  }
  var logoUrl=info.logo_url||info.logo||'';
  var maybeLogo=logoUrl?('<div style="margin-bottom:8px"><img src="'+logoUrl+'" alt="team logo" style="width:84px;height:84px;object-fit:contain;border:1px solid #2a2a2a;border-radius:8px;background:#111"></div>'):'';
  box.innerHTML = maybeLogo + '<table>'+(rows || '<tr><td class="muted">No visible fields.</td></tr>')+'</table>';
}
</script>
</body>
</html>
