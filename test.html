<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clash Squad — Skills per Match (with Images)</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    client.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = "index.html";
      } else {
        const userInfo = document.getElementById("user-info");
        if (userInfo && session.user?.email) {
          userInfo.textContent = "Logged in as: " + session.user.email;
        }
      }
    });

    function logout() {
      client.auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>

  <!-- Fonts + Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0e0e0e;
      --panel: #1c1c1c;
      --panel-2: #1f1f1f;
      --text: #f5f5f5;
      --muted: #bbb;
      --muted-2: #888;
      --b: #444;
      --gold: #ffbd59;
      --accent: #ff7733;
      --danger: #ff5a5a;
      --row: #141414;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--panel-2); padding: 20px; text-align: center; border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 3; }
    h1 { margin: 0; font-family: 'Orbitron', sans-serif; color: var(--gold); font-size: 1.8rem; }
    .user-controls { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; }
    .user-controls #user-info { font-size: 14px; color: #ccc; }
    .btn { background: var(--gold); color: #1c1c1c; font-weight: bold; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #e0a84f; }
    a.btn { text-decoration: none; display: inline-block; }
    main { width: 95%; max-width: 1400px; margin: 18px auto 60px; }

    .filters { background: var(--panel); border: 1px solid var(--b); border-radius: 10px; padding: 12px; display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; }
    .filters label { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--muted); }
    .filters input[type="date"], .filters select { background: #2a2a2a; color: var(--gold); border: 1px solid var(--b); border-radius: 6px; padding: 8px; }
    .filters .row { grid-column: 1/-1; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filters .pill { padding: 6px 8px; border: 1px dashed var(--b); border-radius: 6px; font-size: 12px; color: var(--muted); }

    .toolbar { margin: 12px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .toolbar .count { color: var(--muted); font-size: 13px; }

    .table-wrap { background: var(--panel); border: 1px solid var(--b); border-radius: 10px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { position: sticky; top: 0; background: #181818; z-index: 1; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #2a2a2a; text-align: left; font-size: 12.5px; vertical-align: top; }
    tbody tr:nth-child(odd) { background: var(--row); }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .win { background: #1d3f2a; color: #39d27d; border: 1px solid #2d6b47; }
    .loss { background: #3f1d1d; color: #ff8c8c; border: 1px solid #6b2d2d; }
    .ban { background: #2a2a2a; color: #f3cccc; border: 1px solid #533; }

    .players { display: grid; grid-template-columns: repeat(4, minmax(140px,1fr)); gap: 8px; }
    .pbox { padding: 8px; background: #151515; border: 1px solid #2a2a2a; border-radius: 8px; }
    .pbox .p { color: var(--muted-2); font-size: 11px; margin-bottom: 4px; }
    .pbox .a { font-size: 12.5px; color: #fff; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .pbox .s { font-size: 11.5px; }
    .hero-img { width: 42px; height: 42px; border-radius: 6px; object-fit: cover; background: #222; border: 1px solid #333; }
    .ban-img { width: 18px; height: 18px; border-radius: 3px; border: 1px solid #333; background:#222; object-fit: cover; }
    .passive-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .passive-chip { display: inline-flex; align-items: center; gap: 6px; padding: 2px 6px; border: 1px solid #2a2a2a; border-radius: 999px; background: #101010; color: #bbb; }
    .passive-chip img { width: 14px; height: 14px; border-radius: 3px; object-fit: cover; background:#222; border: 1px solid #333; }

    .caps { text-transform: uppercase; letter-spacing: .4px; font-weight: 700; color: var(--muted); font-size: 11px; }

    .empty { text-align: center; padding: 30px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="user-controls">
      <span id="user-info">Checking login...</span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
    <h1>Skills per Match</h1>
  </header>

  <main>
    <div class="toolbar">
      <a class="btn" href="dashboard.html">← Back to Dashboard</a>
      <span class="count" id="rowCount">—</span>
    </div>

    <section class="filters">
      <label>
        Team
        <select id="teamFilter">
          <option value="__ALL__">All teams</option>
        </select>
      </label>

      <label>
        Result
        <select id="resultFilter">
          <option value="__ALL__">All</option>
          <option value="Win">Win</option>
          <option value="Loss">Loss</option>
        </select>
      </label>

      <label>
        Map
        <select id="mapFilter">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Kalahari">Kalahari</option>
          <option value="Purgatory">Purgatory</option>
          <option value="Alpine">Alpine</option>
          <option value="Nexterra">Nexterra</option>
          <option value="Solara">Solara</option>
        </select>
      </label>

      <label>
        From date
        <input type="date" id="fromDate">
      </label>

      <label>
        To date
        <input type="date" id="toDate">
      </label>

      <div class="row">
        <button class="btn" id="applyBtn">Apply Filters</button>
        <button class="btn" id="resetBtn" style="background:#2a2a2a;color:#fff;border:1px solid #444;">Reset</button>
      </div>
    </section>

    <div class="table-wrap" style="margin-top:14px;">
      <table id="skillsTable">
        <thead>
          <tr>
            <th data-sort="date">Date</th>
            <th data-sort="game">Game</th>
            <th data-sort="map">Map</th>
            <th data-sort="team">Team</th>
            <th>Opponent</th>
            <th data-sort="result">Result</th>
            <th>Ban</th>
            <th style="min-width:560px;">Players (Actives & Passives)</th>
          </tr>
        </thead>
        <tbody id="skillsBody">
          <tr><td class="empty" colspan="8">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    const PLACEHOLDER = 'https://imgur.com/AdvPwAO.png';
    let CHAR_INDEX = new Map(); // name -> { image_url, ... }

    // -------- Helpers --------
    function safe(obj, def = null) { return obj ?? def; }
    function byNameImg(name) {
      if (!name) return PLACEHOLDER;
      const c = CHAR_INDEX.get(name);
      return c?.image_url || PLACEHOLDER;
    }

    // Build a row object (one per team per match)
    function buildRow(record, side) {
      const s = safe(record.state, {});
      const picks = safe(s.picks, []);
      const passives = safe(s.passives, []);
      const bans = safe(s.bans, []);

      const isLeft = side === 'left';
      const team = isLeft ? record.team_left : record.team_right;
      const opp  = isLeft ? record.team_right : record.team_left;
      const teamScore = isLeft ? (record.team_left_score ?? 0) : (record.team_right_score ?? 0);
      const oppScore  = isLeft ? (record.team_right_score ?? 0) : (record.team_left_score ?? 0);
      const result = teamScore > oppScore ? 'Win' : 'Loss';

      const banObj = bans[isLeft ? 0 : 1] || null;
      const banName = safe(banObj?.name, '—');
      const banImg  = safe(banObj?.image_url, null) || byNameImg(banName);

      // player indices
      const idx = isLeft ? [0,1,2,3] : [4,5,6,7];

      const players = idx.map((i, k) => {
        const activeName = safe(picks[i]?.name, 'None');
        const activeImg  = safe(picks[i]?.image_url, null) || byNameImg(activeName);

        const psList = (passives[i] || []).filter(Boolean).map(x => ({
          name: x.name,
          image: x.image_url || byNameImg(x.name)
        }));

        return {
          label: `P${k+1}`,
          activeName,
          activeImg,
          passives: psList
        };
      });

      return {
        id: record.id,
        date: record.match_date,
        game: record.game_number,
        map: record.map || '—',
        team,
        opponent: opp,
        result,
        banName,
        banImg,
        players
      };
    }

    function playerCellHTML(p) {
      const passHTML = p.passives.length
        ? `<div class="passive-list">${p.passives.map(ps => `
             <span class="passive-chip">
               <img src="${ps.image || PLACEHOLDER}" alt="">
               ${ps.name}
             </span>`).join('')}
           </div>`
        : `<div class="passive-list" style="color:#666;">—</div>`;

      return `
        <div class="pbox">
          <div class="p caps">${p.label}</div>
          <div class="a">
            <img class="hero-img" src="${p.activeImg || PLACEHOLDER}" alt="">
            <span>${p.activeName}</span>
          </div>
          ${passHTML}
        </div>
      `;
    }

    function rowHTML(r) {
      const badge = r.result === 'Win' ? 'win' : 'loss';
      return `
        <tr>
          <td>${r.date}</td>
          <td>G${r.game}</td>
          <td>${r.map}</td>
          <td><strong>${r.team}</strong></td>
          <td>${r.opponent}</td>
          <td><span class="badge ${badge}">${r.result}</span></td>
          <td><span class="badge ban"><img class="ban-img" src="${r.banImg || PLACEHOLDER}" alt=""> ${r.banName}</span></td>
          <td>
            <div class="players">
              ${r.players.map(playerCellHTML).join('')}
            </div>
          </td>
        </tr>
      `;
    }

    // -------- Data + filters --------
    let ALL_ROWS = [];
    let SORT_KEY = null;
    let SORT_ASC = true;

    function setDefaultDates() {
      const to = new Date();
      const from = new Date(to);
      from.setMonth(from.getMonth() - 3); // last 90 days by default

      const toEl = document.getElementById('toDate');
      const fromEl = document.getElementById('fromDate');

      const fmt = d => d.toISOString().slice(0,10);
      toEl.value = fmt(to);
      fromEl.value = fmt(from);
    }

    async function loadCharacters() {
      try {
        const resp = await fetch('https://neptuneg1.github.io/freefire-caster/character.json');
        const list = await resp.json();
        CHAR_INDEX = new Map(list.map(c => [c.name, c]));
      } catch (e) {
        console.warn('Could not load character index for fallback images:', e);
        CHAR_INDEX = new Map();
      }
    }

    async function loadData() {
      const from = document.getElementById('fromDate').value;
      const to   = document.getElementById('toDate').value;

      let q = client
        .from('draft_records')
        .select('id, match_date, game_number, team_left, team_right, team_left_score, team_right_score, map, state')
        .order('match_date', { ascending: false })
        .order('id', { ascending: false });

      if (from) q = q.gte('match_date', from);
      if (to)   q = q.lte('match_date', to);

      const { data, error } = await q;
      const body = document.getElementById('skillsBody');

      if (error) {
        console.error('Fetch error:', error);
        body.innerHTML = `<tr><td class="empty" colspan="8">Failed to fetch data.</td></tr>`;
        return;
      }

      const rows = [];
      data.forEach(rec => {
        rows.push(buildRow(rec, 'left'));
        rows.push(buildRow(rec, 'right'));
      });

      ALL_ROWS = rows;

      // Build team dropdown from data (unique)
      const teamSet = new Set();
      rows.forEach(r => { if (r.team) teamSet.add(r.team); });
      const teamSel = document.getElementById('teamFilter');
      teamSel.innerHTML = `<option value="__ALL__">All teams</option>`;
      [...teamSet].sort().forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        teamSel.appendChild(opt);
      });

      applyFilters();
    }

    function applyFilters() {
      const team   = document.getElementById('teamFilter').value;
      const result = document.getElementById('resultFilter').value;
      const map    = document.getElementById('mapFilter').value;

      let rows = ALL_ROWS.slice();

      if (team !== '__ALL__')   rows = rows.filter(r => r.team === team);
      if (result !== '__ALL__') rows = rows.filter(r => r.result === result);
      if (map !== '__ALL__')    rows = rows.filter(r => r.map === map);

      if (SORT_KEY) {
        rows.sort((a,b) => {
          const A = a[SORT_KEY];
          const B = b[SORT_KEY];
          if (A == null && B == null) return 0;
          if (A == null) return 1;
          if (B == null) return -1;
          if (A < B) return SORT_ASC ? -1 : 1;
          if (A > B) return SORT_ASC ? 1 : -1;
          return 0;
        });
      }
      renderTable(rows);
    }

    function renderTable(rows) {
      const body = document.getElementById('skillsBody');
      const count = document.getElementById('rowCount');
      count.textContent = `${rows.length} team-rows`;

      if (!rows.length) {
        body.innerHTML = `<tr><td class="empty" colspan="8">No rows match your filters.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map(rowHTML).join('');
    }

    function resetFilters() {
      document.getElementById('teamFilter').value = '__ALL__';
      document.getElementById('resultFilter').value = '__ALL__';
      document.getElementById('mapFilter').value = '__ALL__';
      setDefaultDates();
      loadData();
    }

    // -------- UI wiring --------
    document.addEventListener('DOMContentLoaded', async () => {
      setDefaultDates();
      await loadCharacters();   // for fallback images if state is missing URLs
      await loadData();

      document.getElementById('applyBtn').addEventListener('click', applyFilters);
      document.getElementById('resetBtn').addEventListener('click', resetFilters);
      document.getElementById('teamFilter').addEventListener('change', applyFilters);
      document.getElementById('resultFilter').addEventListener('change', applyFilters);
      document.getElementById('mapFilter').addEventListener('change', applyFilters);
      document.getElementById('fromDate').addEventListener('change', loadData);
      document.getElementById('toDate').addEventListener('change', loadData);

      document.querySelectorAll('thead th[data-sort]').forEach(th => {
        th.style.cursor = 'pointer';
        th.title = 'Click to sort';
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-sort');
          if (SORT_KEY === key) {
            SORT_ASC = !SORT_ASC;
          } else {
            SORT_KEY = key;
            SORT_ASC = true;
          }
          applyFilters();
        });
      });
    });
  </script>
</body>
</html>
