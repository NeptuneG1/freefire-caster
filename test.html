<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FFBR — LOPS Data (Players, Active Skill, Pet)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
    --brand:#ffbd59; --brand2:#ff7733; --line:#313131;

    /* Heatmap tint (brand-ish) */
    --heat-rgb:255,189,89;   /* brand yellow */
    --heat-min:.06;          /* min alpha */
    --heat-max:.22;          /* max alpha */
    --heat-top-outline:.42;  /* alpha for top outline */
    --heat-radius:8px;       /* rounded heatmap cells */
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
  h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
  .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
  .chip{font-size:.85rem;color:#ddd}
  .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}
  .shell{max-width:1100px;margin:22px auto;padding:0 12px}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
  .section h2{margin:0 0 10px;color:var(--brand)}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
  .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
  .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
  .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 8px;font-size:.9rem}

  .bar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .bar label{color:var(--muted);font-size:.9rem}
  .input{background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:7px 10px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#222;border:1px solid #2a2a2a;font-size:.8rem}

  /* Collapsible */
  details.accordion{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:12px;
    padding:0;
    margin-bottom:14px;
  }
  details.accordion > summary{
    list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line);user-select:none;
  }
  details.accordion[open] > summary{ border-bottom-color:var(--line); }
  details.accordion > .accordion-body{ padding:12px; }

  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
  thead th{background:#191919;position:sticky;top:0;text-align:left;border-radius:8px;padding:8px 6px}
  tbody tr td{border-bottom:none}
  th,td{padding:6px 6px;vertical-align:top}
  .right{text-align:right}
  td[data-key]{transition:background-color .18s ease, box-shadow .18s ease; border-radius:var(--heat-radius); background-clip:padding-box;}
  td.heat-top{box-shadow:inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline));}

  /* Player mini panel */
  .mini{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mini h4{margin:0 0 6px;color:var(--brand)}
  .rowlist{display:flex;flex-direction:column;gap:6px;max-height:340px;overflow:auto}
  .rowitem{display:grid;grid-template-columns:1fr repeat(5,70px);gap:8px;background:#101010;border:1px solid #2a2a2a;border-radius:10px;padding:6px 8px}
  .rowitem .right{text-align:right}

  @media (max-width: 900px){
    .grid2,.grid3{grid-template-columns:1fr}
    .mini{grid-template-columns:1fr}
    .rowitem{grid-template-columns:1fr repeat(5,64px)}
  }
</style>
</head>
<body>
<header>
  <h1>FFBR — LOPS Data</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">

  <!-- Global Filters -->
  <div class="section">
    <h2>Filters</h2>
    <div class="bar">
      <label>Tournament
        <select id="gTournament" class="input" style="min-width:260px">
          <option value="__all__" selected>All tournaments</option>
        </select>
      </label>
      <label>Player
        <input list="playerList" id="playerSearch" class="input" style="min-width:240px" placeholder="Type player name…">
        <datalist id="playerList"></datalist>
      </label>
      <button class="btn secondary" id="gReset">Reset</button>
    </div>
    <div class="muted" id="filterHint">—</div>
  </div>

  <!-- Overview -->
  <div class="section">
    <h2>Overview</h2>
    <div class="grid3">
      <div class="card">
        <h3>Dataset</h3>
        <div class="kpis" id="kpiDataset">—</div>
      </div>
      <div class="card">
        <h3>Kills & Damage</h3>
        <div class="kpis" id="kpiDamage">—</div>
      </div>
      <div class="card">
        <h3>Accuracy / Headshots</h3>
        <div class="kpis" id="kpiHS">—</div>
      </div>
    </div>
  </div>

  <!-- Usage tables -->
  <details class="accordion" open>
    <summary>Active Skill Usage</summary>
    <div class="accordion-body">
      <div class="bar">
        <span class="muted">Counts & performance by Active Skill</span>
      </div>
      <div class="card" style="margin:0">
        <div id="tblActiveSkill">Loading…</div>
      </div>
    </div>
  </details>

  <details class="accordion" open>
    <summary>Pet Usage</summary>
    <div class="accordion-body">
      <div class="bar">
        <span class="muted">Counts & performance by Pet</span>
      </div>
      <div class="card" style="margin:0">
        <div id="tblPet">Loading…</div>
      </div>
    </div>
  </details>

  <!-- Players -->
  <details class="accordion" open>
    <summary>Top Players — Eliminations</summary>
    <div class="accordion-body">
      <div class="bar">
        <label>Sort by
          <select id="topSort" class="input">
            <option value="kills" selected>Kills</option>
            <option value="damage">Damage</option>
            <option value="assists">Assists</option>
            <option value="hsr">Headshot %</option>
            <option value="grenade">Grenade Kills</option>
          </select>
        </label>
        <label>Limit
          <select id="topLimit" class="input">
            <option>10</option><option>20</option><option>30</option><option>50</option>
          </select>
        </label>
      </div>
      <div class="card" style="margin:0">
        <div id="tblTopPlayers">Loading…</div>
      </div>
    </div>
  </details>

  <!-- Player Mini Panel -->
  <details class="accordion" open>
    <summary>Player Explorer</summary>
    <div class="accordion-body">
      <div id="miniPanel" class="card" style="margin:0">
        <div class="muted">Select a player from “Player” in Filters, or click a row in Top Players.</div>
      </div>
    </div>
  </details>

</div>

<script>
/* ====== Supabase init + auth ====== */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ====== Utilities ====== */
const el = id => document.getElementById(id);
const norm = v => (v==null ? '' : String(v).trim());
const n = v => {
  if (v == null || v === '') return 0;
  const x = typeof v === 'number' ? v : parseFloat(String(v).replace(/,/g,''));
  return Number.isFinite(x) ? x : 0;
};
const uniq = arr => Array.from(new Set(arr));
const groupBy = (arr, keyFn) => {
  const m = new Map();
  for (const r of arr){ const k = keyFn(r); if (!m.has(k)) m.set(k, []); m.get(k).push(r); }
  return m;
};
const sum = (arr,key) => arr.reduce((t,r)=> t + n(r[key]), 0);
const fmt = (x,d=0)=>Number(n(x)).toFixed(d);
const fmtPct = x => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';

/* Case-insensitive getter over an object */
function getCI(obj, ...names){
  if (!obj) return '';
  const keys = Object.keys(obj);
  for (const want of names){
    const idx = keys.find(k => k.toLowerCase() === String(want).toLowerCase());
    if (idx) return obj[idx];
  }
  // partial/regex fallbacks (e.g., "Grenade kill")
  for (const want of names){
    const rx = new RegExp('^'+String(want).replace(/\s+/g,'\\s*')+'$','i');
    const k2 = keys.find(k => rx.test(k));
    if (k2) return obj[k2];
  }
  return '';
}

/* ====== Normalization ====== */
function normalizeRow(r){
  const o = {...r};
  // Tournament fields
  o._tournament = norm(getCI(o,'Tournament','tournament','Event','Series'));
  o._tournament_id = n(getCI(o,'tournament_id','Tournament ID','TID','ID'));
  o._created = getCI(o,'created_at','Created','Timestamp') || null;

  // Player (primary: "Player name")
  let pn = norm(getCI(o,'Player name','Player Name'));
  if (!pn) pn = norm(getCI(o,'Player','player','IGN','ign','Player IGN','InGameName','IGName'));
  o._player = pn;

  // Team (best-effort)
  o._team = norm(getCI(o,'Team','TEAM','TeamName','Team Name','TAG','Tag'));

  // Map (optional)
  o._map = norm(getCI(o,'Map','map','Match Map'));

  // Core numbers
  o.kills     = n(getCI(o,'KILLS','Kills','Kill'));
  o.assists   = n(getCI(o,'ASSISTS','Assists','Assist'));
  // HEADSHOTRS (typo) + variants
  o.headshots = n(getCI(o,'HEADSHOTRS','HEADSHOTS','Headshots','HS','Head shot','Head-shot'));
  o.damage    = n(getCI(o,'DAMAGE','Damage','DMG'));
  // grenade
  const gk = getCI(o,'Grenade kill','Grenade kills','Grenade','Nade Kills','Nade');
  o.grenade   = n(gk);

  // Active Skill / Pet
  o.active_skill = norm(getCI(o,'Active Skill','Active','Skill','ActiveSkill'));
  o.pet          = norm(getCI(o,'Pet','Pet Name','PetName'));

  return o;
}

/* ====== Fetch all from ffbr_lopsdata (paginated) ====== */
async function fetchAllRows(){
  const CHUNK = 1000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_lopsdata')
      .select('*')
      .order('tournament_id', { ascending: true, nullsFirst:true }) // stable order across pages
      .order('id', { ascending: true, nullsFirst:true })
      .range(from, from + CHUNK - 1);

    if (error){ console.error('ffbr_lopsdata fetch failed:', error); break; }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }

  // Normalize & strip obvious header echoes like TeamName-only rows
  const normed = out.map(normalizeRow).filter(r => r._player || r.kills || r.damage || r.assists || r.headshots);
  const filtered = normed.filter(r => String(r._team).toLowerCase() !== 'teamname'); // safety

  return filtered;
}

/* ====== Tournament indexing & default (prefer FFWS GLOBAL FINALS 2025) ====== */
const PREFERRED_LATEST_NAME = 'ffws global finals 2025';

function tournamentsIndex(rows){
  const m = new Map(); // key: lower(name) -> {name, idMax, count}
  for (const r of rows){
    const name = norm(r._tournament); if (!name) continue;
    const key = name.toLowerCase();
    const id  = n(r._tournament_id);
    if (!m.has(key)) m.set(key, { name, idMax: Number.isFinite(id)? id : -Infinity, count: 1 });
    else {
      const o = m.get(key);
      if (Number.isFinite(id)) o.idMax = Math.max(o.idMax, id);
      o.count++;
    }
  }
  return m;
}
function defaultTournamentName(rows){
  const idx = tournamentsIndex(rows);
  if (!idx.size) return null;
  for (const v of idx.values()){
    if (v.name.toLowerCase() === PREFERRED_LATEST_NAME) return v.name;
  }
  // else choose highest idMax then by count
  const all = Array.from(idx.values()).sort((a,b)=>{
    const af = Number.isFinite(a.idMax), bf = Number.isFinite(b.idMax);
    if (af && bf && a.idMax !== b.idMax) return b.idMax - a.idMax;
    if (a.count !== b.count) return b.count - a.count;
    return a.name.localeCompare(b.name);
  });
  return all[0].name;
}
function uniqueTournaments(rows){
  const idx = tournamentsIndex(rows);
  const items = Array.from(idx.values()).sort((a,b)=>{
    const af = Number.isFinite(a.idMax), bf = Number.isFinite(b.idMax);
    if (af && bf && a.idMax !== b.idMax) return b.idMax - a.idMax;
    if (a.count !== b.count) return b.count - a.count;
    return a.name.localeCompare(b.name);
  });
  return items;
}

/* ====== Global state ====== */
let ALL = [];
let CURRENT_PLAYER = '';

/* ====== Filtering ====== */
function selectedTournament(){ return (el('gTournament')?.value || '__all__').trim(); }
function baseRowsByTournament(rows){
  const t = selectedTournament();
  if (t === '__all__') return rows;
  const lf = t.toLowerCase();
  return rows.filter(r => r._tournament.toLowerCase() === lf);
}

/* ====== Rendering helpers ====== */
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.format==='pct') v = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
    else if (c.format==='1d') v = isFinite(v) ? Number(v).toFixed(1) : '—';
    else if (c.format==='2d') v = isFinite(v) ? Number(v).toFixed(2) : '—';
    else if (c.format==='0d') v = isFinite(v) ? Number(v).toFixed(0) : '—';
    return `<td data-key="${c.key}" class="${c.right?'right':''}">${(v==null||v==='')?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}

/* ====== Quantile-band Heatmap (5 bands) ====== */
function applyColumnHeatmap(containerId, keys){
  const wrap = el(containerId);
  const table = wrap?.querySelector('table'); if (!table) return;

  table.querySelectorAll('td[data-key]').forEach(td=>{
    td.style.backgroundColor = '';
    td.classList.remove('heat-top');
  });

  const styles = getComputedStyle(document.documentElement);
  const rgb    = styles.getPropertyValue('--heat-rgb') || '255,189,89';
  const minA   = parseFloat(styles.getPropertyValue('--heat-min')) || .06;
  const maxA   = parseFloat(styles.getPropertyValue('--heat-max')) || .22;
  const radius = styles.getPropertyValue('--heat-radius') || '8px';
  const BANDS  = 5;

  for (const key of keys){
    const cells = Array.from(table.querySelectorAll(`td[data-key="${key}"]`));
    if (!cells.length) continue;

    const entries = cells.map((td,i)=>{
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      return { td, i, v: isFinite(v) ? v : null };
    }).filter(e => e.v != null);

    if (!entries.length) continue;

    const asc = entries.slice().sort((a,b)=> a.v - b.v);
    const n = asc.length;
    const topVal = asc[n-1].v;

    const bandByIndex = new Map();
    asc.forEach((e, rank)=>{
      const p = (n<=1) ? 1 : (rank / (n - 1)); // 0..1
      const band = Math.min(BANDS-1, Math.floor(p * BANDS)); // 0..4
      bandByIndex.set(e.i, band);
    });

    cells.forEach((td, i)=>{
      const band = bandByIndex.get(i);
      if (band == null) return;
      const alpha = minA + ((band)/(BANDS-1)) * (maxA - minA);
      td.style.backgroundColor = `rgba(${rgb}, ${alpha.toFixed(3)})`;
      td.style.borderRadius = radius;
      td.style.backgroundClip = 'padding-box';

      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      if (isFinite(v) && v === topVal) td.classList.add('heat-top');
    });
  }
}

/* ====== KPIs ====== */
function renderKPIs(rows){
  const players = uniq(rows.map(r=>r._player).filter(Boolean));
  const matches = rows.length;
  const totalKills = sum(rows,'kills');
  const totalAssists = sum(rows,'assists');
  const totalHS = sum(rows,'headshots');
  const totalDmg = sum(rows,'damage');
  const totalG = sum(rows,'grenade');

  el('kpiDataset').innerHTML = `
    <div class="kpi">Rows <strong>${matches}</strong></div>
    <div class="kpi">Players <strong>${players.length}</strong></div>
    <div class="kpi">Avg Kills/row <strong>${fmt(matches? totalKills/matches : 0,2)}</strong></div>
    <div class="kpi">Avg Dmg/row <strong>${fmt(matches? totalDmg/matches : 0,0)}</strong></div>
  `;
  el('kpiDamage').innerHTML = `
    <div class="kpi">Kills <strong>${totalKills}</strong></div>
    <div class="kpi">Assists <strong>${totalAssists}</strong></div>
    <div class="kpi">Grenade Kills <strong>${totalG}</strong></div>
    <div class="kpi">Damage <strong>${fmt(totalDmg,0)}</strong></div>
  `;
  const hsr = totalKills>0 ? (totalHS/totalKills) : 0;
  el('kpiHS').innerHTML = `
    <div class="kpi">Headshots <strong>${totalHS}</strong></div>
    <div class="kpi">HS Rate <strong>${fmtPct(hsr)}</strong></div>
  `;
}

/* ====== Usage: Active Skill & Pet ====== */
function aggregateByKey(rows, key){
  const g = groupBy(rows, r=> norm(r[key]) || '—');
  const out = [];
  for (const [name,list] of g.entries()){
    const picks = list.length;
    const players = uniq(list.map(r=>r._player).filter(Boolean)).length;
    const kills = sum(list,'kills');
    const assists = sum(list,'assists');
    const dmg = sum(list,'damage');
    const hs = sum(list,'headshots');
    const gk = sum(list,'grenade');
    out.push({
      name, picks, players,
      kills, assists, damage:dmg, headshots:hs, grenade:gk,
      kpr: picks? kills/picks : 0,
      dpr: picks? dmg/picks : 0,
      hsr: kills? hs/kills : 0,
      usage: rows.length? picks/rows.length : 0
    });
  }
  // sort by picks desc then kills desc
  out.sort((a,b)=> b.picks - a.picks || b.kills - a.kills || a.name.localeCompare(b.name));
  return out;
}

function renderActiveSkill(rows){
  const agg = aggregateByKey(rows, 'active_skill');
  const cols = [
    {label:'Active Skill', key:'name'},
    {label:'Picks', key:'picks', right:true},
    {label:'Players', key:'players', right:true},
    {label:'Usage %', key:'usage', format:'pct', right:true},
    {label:'Kills', key:'kills', right:true},
    {label:'Assists', key:'assists', right:true},
    {label:'Damage', key:'damage', right:true},
    {label:'HS', key:'headshots', right:true},
    {label:'HS %', key:'hsr', format:'pct', right:true},
    {label:'Grenade', key:'grenade', right:true},
    {label:'Kills/row', key:'kpr', format:'2d', right:true},
    {label:'Dmg/row', key:'dpr', format:'1d', right:true},
  ];
  el('tblActiveSkill').innerHTML = renderSimpleTable(agg, cols);
  applyColumnHeatmap('tblActiveSkill', ['picks','players','usage','kills','assists','damage','headshots','grenade','kpr','dpr','hsr']);
}

function renderPet(rows){
  const agg = aggregateByKey(rows, 'pet');
  const cols = [
    {label:'Pet', key:'name'},
    {label:'Picks', key:'picks', right:true},
    {label:'Players', key:'players', right:true},
    {label:'Usage %', key:'usage', format:'pct', right:true},
    {label:'Kills', key:'kills', right:true},
    {label:'Assists', key:'assists', right:true},
    {label:'Damage', key:'damage', right:true},
    {label:'HS', key:'headshots', right:true},
    {label:'HS %', key:'hsr', format:'pct', right:true},
    {label:'Grenade', key:'grenade', right:true},
    {label:'Kills/row', key:'kpr', format:'2d', right:true},
    {label:'Dmg/row', key:'dpr', format:'1d', right:true},
  ];
  el('tblPet').innerHTML = renderSimpleTable(agg, cols);
  applyColumnHeatmap('tblPet', ['picks','players','usage','kills','assists','damage','headshots','grenade','kpr','dpr','hsr']);
}

/* ====== Top Players ====== */
function aggregatePlayers(rows){
  const byP = groupBy(rows, r=> r._player || '—');
  const out = [];
  for (const [player, list] of byP.entries()){
    if (!player || player==='—') continue;
    const team = uniq(list.map(r=>r._team).filter(Boolean)).join(', ');
    const cnt = list.length;
    const kills = sum(list,'kills');
    const assists = sum(list,'assists');
    const hs = sum(list,'headshots');
    const dmg = sum(list,'damage');
    const gk = sum(list,'grenade');
    out.push({
      player, team, rows:cnt,
      kills, assists, damage:dmg, headshots:hs, grenade:gk,
      kpr: cnt? kills/cnt : 0,
      dpr: cnt? dmg/cnt : 0,
      hsr: kills? hs/kills : 0
    });
  }
  return out;
}
function renderTopPlayers(rows){
  const sortKey = el('topSort')?.value || 'kills';
  const limit = parseInt(el('topLimit')?.value || '10',10);
  const agg = aggregatePlayers(rows);
  const dir = (sortKey==='hsr') ? 'desc' : 'desc';
  agg.sort((a,b)=>{
    if (sortKey==='player') return a.player.localeCompare(b.player);
    const av = Number(a[sortKey]); const bv = Number(b[sortKey]);
    if (!isFinite(av) && !isFinite(bv)) return 0;
    if (!isFinite(av)) return 1;
    if (!isFinite(bv)) return -1;
    return dir==='desc' ? (bv - av) : (av - bv);
  });
  const cut = agg.slice(0, limit);

  const cols = [
    {label:'Player', key:'player'},
    {label:'Team', key:'team'},
    {label:'Rows', key:'rows', right:true},
    {label:'Kills', key:'kills', right:true},
    {label:'Assists', key:'assists', right:true},
    {label:'HS', key:'headshots', right:true},
    {label:'HS %', key:'hsr', format:'pct', right:true},
    {label:'Grenade', key:'grenade', right:true},
    {label:'Damage', key:'damage', right:true},
    {label:'Kills/row', key:'kpr', format:'2d', right:true},
    {label:'Dmg/row', key:'dpr', format:'1d', right:true},
  ];
  el('tblTopPlayers').innerHTML = renderSimpleTable(cut, cols);
  applyColumnHeatmap('tblTopPlayers', ['kills','assists','headshots','hsr','grenade','damage','kpr','dpr','rows']);

  // make rows clickable -> mini panel
  const table = el('tblTopPlayers').querySelector('table');
  if (table){
    const bodyRows = table.querySelectorAll('tbody tr');
    bodyRows.forEach((tr)=>{
      const name = (tr.querySelector('td[data-key="player"]')?.textContent || '').trim();
      if (!name) return;
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', ()=>{
        CURRENT_PLAYER = name;
        el('playerSearch').value = name;
        renderMiniPanel(baseRowsByTournament(ALL), name);
        // scroll to player explorer
        document.querySelector('#miniPanel')?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
  }
}

/* ====== Player Mini Panel ====== */
function renderMiniPanel(rows, playerName){
  const list = rows.filter(r => (r._player||'').toLowerCase() === playerName.toLowerCase());
  const box = el('miniPanel');
  if (!list.length){
    box.innerHTML = `<div class="muted">No rows for <b>${playerName}</b> in current scope.</div>`;
    return;
  }
  const team = uniq(list.map(r=>r._team).filter(Boolean)).join(', ') || '—';
  const cnt = list.length;
  const kills = sum(list,'kills');
  const assists = sum(list,'assists');
  const hs = sum(list,'headshots');
  const dmg = sum(list,'damage');
  const gk = sum(list,'grenade');
  const hsr = kills? hs/kills : 0;

  // by Active Skill
  const byAS = aggregateByKey(list,'active_skill');
  // by Pet
  const byPet = aggregateByKey(list,'pet');

  const topRows = list.slice(-10); // last 10 rows as “recent”
  const recent = topRows.map(r=>`
    <div class="rowitem">
      <div><span class="pill">${r._map||'—'}</span> <span class="muted">• ${r._tournament||'—'}</span></div>
      <div class="right" title="Kills">${fmt(r.kills)}</div>
      <div class="right" title="Assists">${fmt(r.assists)}</div>
      <div class="right" title="HS">${fmt(r.headshots)}</div>
      <div class="right" title="Grenade">${fmt(r.grenade)}</div>
      <div class="right" title="Damage">${fmt(r.damage)}</div>
    </div>
  `).join('');

  box.innerHTML = `
    <div class="mini">
      <div>
        <h3>${playerName} <span class="muted">(${team})</span></h3>
        <div class="kpis">
          <div class="kpi">Rows <strong>${cnt}</strong></div>
          <div class="kpi">Kills <strong>${kills}</strong> <span class="muted">(${fmt(kills/cnt,2)}/row)</span></div>
          <div class="kpi">Assists <strong>${assists}</strong> <span class="muted">(${fmt(assists/cnt,2)}/row)</span></div>
          <div class="kpi">Grenade <strong>${gk}</strong></div>
          <div class="kpi">Damage <strong>${fmt(dmg,0)}</strong> <span class="muted">(${fmt(dmg/cnt,0)}/row)</span></div>
          <div class="kpi">HS <strong>${hs}</strong> <span class="muted">(${fmtPct(hsr)})</span></div>
        </div>
        <h4>Recent (last 10)</h4>
        <div class="rowlist">${recent || '<div class="muted">—</div>'}</div>
      </div>
      <div>
        <h4>By Active Skill</h4>
        ${renderSimpleTable(byAS.slice(0,8), [
          {label:'Active', key:'name'},
          {label:'Picks', key:'picks', right:true},
          {label:'Kills', key:'kills', right:true},
          {label:'HS %', key:'hsr', format:'pct', right:true},
        ])}
        <div style="height:10px"></div>
        <h4>By Pet</h4>
        ${renderSimpleTable(byPet.slice(0,8), [
          {label:'Pet', key:'name'},
          {label:'Picks', key:'picks', right:true},
          {label:'Kills', key:'kills', right:true},
          {label:'HS %', key:'hsr', format:'pct', right:true},
        ])}
      </div>
    </div>
  `;

  // heatmaps inside mini (small sets)
  const miniEl = box;
  miniEl.querySelectorAll('table').forEach((t,i)=>{
    const id = `mini_${i}`;
    const wrap = document.createElement('div');
    wrap.id = id;
    t.parentElement.replaceChildren(wrap);
    wrap.appendChild(t);
    applyColumnHeatmap(id, ['picks','kills','hsr']);
  });
}

/* ====== Map filter options: players list & tournaments ====== */
function populatePlayersDatalist(rows){
  const names = uniq(rows.map(r=>r._player).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
  const dl = el('playerList');
  dl.innerHTML = names.map(nm=>`<option value="${nm}">`).join('');
}

function populateGlobalTournament(){
  const sel = el('gTournament');
  const items = uniqueTournaments(ALL);
  const latest = defaultTournamentName(ALL);

  sel.innerHTML = `<option value="__all__">All tournaments</option>` +
    items.map(o=> `<option value="${o.name.replaceAll('"','&quot;')}">${o.name}</option>`).join('');

  sel.value = latest || '__all__';
  updateFilterHint();
}
function updateFilterHint(){
  const t = selectedTournament();
  const rows = baseRowsByTournament(ALL).length;
  el('filterHint').textContent = t==='__all__'
    ? `Scope: All tournaments • Rows: ${rows}`
    : `Scope: ${t} • Rows: ${rows} • Default prefers “FFWS GLOBAL FINALS 2025”, else latest by tournament_id`;
}

/* ====== Wiring ====== */
function renderAll(){
  const base = baseRowsByTournament(ALL);
  renderKPIs(base);
  renderActiveSkill(base);
  renderPet(base);
  renderTopPlayers(base);

  // refresh datalist (once is fine; cheap to do again)
  populatePlayersDatalist(base);

  // if a player is currently selected, refresh mini
  if (CURRENT_PLAYER) renderMiniPanel(base, CURRENT_PLAYER);
}

async function initial(){
  // controls
  el('topSort').addEventListener('change', ()=> renderTopPlayers(baseRowsByTournament(ALL)));
  el('topLimit').addEventListener('change', ()=> renderTopPlayers(baseRowsByTournament(ALL)));
  el('gTournament').addEventListener('change', ()=> { updateFilterHint(); renderAll(); });
  el('gReset').addEventListener('click', ()=>{
    el('gTournament').value = defaultTournamentName(ALL) || '__all__';
    el('playerSearch').value = '';
    CURRENT_PLAYER = '';
    el('gTournament').dispatchEvent(new Event('change'));
  });
  el('playerSearch').addEventListener('change', (e)=>{
    const name = (e.target.value||'').trim();
    CURRENT_PLAYER = name;
    renderMiniPanel(baseRowsByTournament(ALL), name);
  });

  // data
  ALL = await fetchAllRows();

  // populate tournament filter & players
  populateGlobalTournament();
  populatePlayersDatalist(ALL);

  // render all for default scope
  renderAll();
}

initial();
</script>
</body>
</html>
