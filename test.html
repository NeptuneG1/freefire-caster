<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Free Fire Dashboard</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Supabase JS v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#07090f;
      --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.08);
      --ink:#f4f6ff;
      --muted:#aab1c5;

      --brand:#ffbd59;
      --brand2:#ff7733;
      --accent:#4dd3ff;

      --radius:16px;
      --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);

      --sb-w: 260px;
      --sb-collapsed: 78px;
      --right-w: 350px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(77,211,255,.15), transparent 60%),
        radial-gradient(700px 420px at 85% 18%, rgba(255,189,89,.12), transparent 60%),
        radial-gradient(900px 620px at 50% 110%, rgba(255,119,51,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    body.modal-open{ overflow:hidden; }

    body::before, body::after{
      content:"";
      position:fixed;
      inset:auto auto 0 0;
      width:520px; height:520px;
      border-radius:50%;
      border:10px solid rgba(77,211,255,.14);
      transform: translate(-45%, -35%);
      filter: blur(.2px);
      pointer-events:none;
    }
    body::after{
      inset: -120px 0 auto auto;
      width:420px; height:420px;
      border:10px solid rgba(77,211,255,.10);
      transform: translate(38%, 0%);
    }

    a{color:inherit}

    /* App Layout */
    .app{
      height:100%;
      display:flex;
      gap:18px;
      padding:18px;
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Sidebar */
    .sidebar{
      width: var(--sb-w);
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      transition: width .18s ease;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:16px 16px 10px 16px;
      border-bottom: 1px solid var(--line);
      min-height: 64px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,189,89,.25), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-family: Orbitron, sans-serif;
      letter-spacing:.5px;
      color:var(--brand);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0;
      font-family: Orbitron, sans-serif;
      font-size: 1.05rem;
      letter-spacing:.6px;
    }
    .brand small{
      display:block;
      color: var(--muted);
      font-size:.78rem;
      margin-top:2px;
    }

    .nav{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
    }
    .nav::-webkit-scrollbar{width:10px}
    .nav::-webkit-scrollbar-thumb{background: rgba(255,255,255,.08); border-radius:10px}
    .nav::-webkit-scrollbar-track{background: transparent}

    .nav-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      text-decoration:none;
      transition: .2s ease;
      cursor:pointer;
      min-height: 44px;
    }
    .nav-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color: var(--ink);
    }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(255,189,89,.14), rgba(77,211,255,.09));
      border-color: rgba(255,189,89,.22);
      color: var(--ink);
    }
    .nav-ico{
      width:26px;height:26px;border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:grid;place-items:center;
      flex: 0 0 auto;
    }
    .nav-ico svg{width:14px;height:14px;opacity:.9}
    .nav-label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sidebar-foot{
      margin-top:auto;
      padding:12px 14px 14px 14px;
      border-top:1px solid var(--line);
      color: var(--muted);
      font-size:.82rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.09);
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background: var(--brand);
      box-shadow: 0 0 18px rgba(255,189,89,.35);
    }

    /* Desktop collapsed sidebar */
    @media (min-width: 981px){
      body.sb-collapsed .sidebar{ width: var(--sb-collapsed); }
      body.sb-collapsed .brand{ padding:16px 10px 10px 10px; justify-content:center; }
      body.sb-collapsed .brand > div:last-child{ display:none; }
      body.sb-collapsed .nav{ padding:12px 10px; }
      body.sb-collapsed .nav-item{ justify-content:center; padding:10px; }
      body.sb-collapsed .nav-label{ display:none; }
      body.sb-collapsed .sidebar-foot{ padding:12px 10px 14px 10px; text-align:center; }
      body.sb-collapsed .sidebar-foot .pill{ justify-content:center; width:100%; padding:8px 0; }
      body.sb-collapsed .sidebar-foot .pill span:last-child{ display:none; }
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
      gap: 14px;
    }

    /* Topbar */
    .topbar{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .icon-btn{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.2s ease;
      color: var(--ink);
    }
    .icon-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .icon-btn svg{width:18px;height:18px;opacity:.92}

    /* Mobile burger */
    .burger{display:none;}

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      min-width: 0;
    }
    .search input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--ink);
      font-size: .95rem;
    }
    .search input::placeholder{color: rgba(170,177,197,.75)}

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .userchip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      max-width: 240px;
    }
    .avatar{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,189,89,.30), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
    }
    .usertext{min-width:0}
    .usertext b{
      display:block;
      font-size:.92rem;
      font-family: Orbitron, sans-serif;
      color: var(--brand);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 170px;
    }
    .usertext span{display:block; font-size:.78rem; color: var(--muted)}

    .logout{
      color: rgba(255,255,255,.70);
      text-decoration:none;
      font-size:.85rem;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      transition:.2s ease;
      cursor:pointer;
      white-space:nowrap;
    }
    .logout:hover{
      border-color: rgba(255,77,77,.35);
      color: #ff8d8d;
      box-shadow: 0 0 0 3px rgba(255,77,77,.10);
    }

    /* Content Grid */
    .content{
      display:grid;
      grid-template-columns: 1fr var(--right-w);
      gap: 14px;
      min-height: 0;
      flex:1;
    }
    .center{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .right{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    /* Cards */
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-inner{padding:14px}
    .muted{color: var(--muted)}
    .title{
      font-family: Orbitron, sans-serif;
      letter-spacing: .6px;
    }

    /* Hero */
    .hero{
      position:relative;
      height: 160px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.10)),
        url('https://i.imgur.com/qXFpizS.jpg') center/cover no-repeat;
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 220px at 55% 45%, rgba(255,189,89,.16), transparent 60%);
      pointer-events:none;
    }
    .hero-content{
      position:absolute;
      left:16px; right:16px; bottom:14px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 12px;
    }
    .hero-title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .hero-title h2{
      font-family: Orbitron, sans-serif;
      font-size: 1.55rem;
      color: var(--brand);
      text-shadow: 0 0 18px rgba(255,189,89,.20);
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(244,246,255,.88);
      font-size: .82rem;
      white-space:nowrap;
    }
    .chip .mini-dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 16px rgba(77,211,255,.25);
    }

    .hero-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }
    .cta{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,189,89,.25);
      background: linear-gradient(135deg, rgba(255,189,89,.18), rgba(255,119,51,.10));
      cursor:pointer;
      transition:.2s ease;
      text-decoration:none;
      font-weight:700;
      color: var(--ink);
      font-size: .92rem;
    }
    .cta:hover{transform: translateY(-1px); box-shadow: 0 0 0 3px rgba(255,189,89,.10)}
    .cta svg{width:16px;height:16px}

    /* Tiles Row */
    .tiles{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .tile{
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.09);
      cursor:pointer;
      transition:.2s ease;
      min-width:0;
    }
    .tile:hover{transform: translateY(-1px); background: rgba(255,255,255,.07)}
    .tile .k{
      color: var(--muted);
      font-size:.82rem;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tile .v{
      font-family: Orbitron, sans-serif;
      font-size: 1.25rem;
      letter-spacing:.6px;
      color: var(--brand);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .badge{
      font-size:.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(244,246,255,.80);
      white-space:nowrap;
    }

    /* Quick View */
    .qv{
      padding: 12px 14px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .qv .box{
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.09);
    }
    .qv label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size:.8rem;
      font-weight:700;
      margin-bottom:8px;
      letter-spacing:.2px;
    }

    .picker-btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.22);
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition:.2s ease;
    }
    .picker-btn:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,189,89,.22);
      box-shadow: 0 0 0 3px rgba(255,189,89,.08);
    }
    .picker-btn .left{
      min-width:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .picker-btn .mini{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,189,89,.22), rgba(77,211,255,.14));
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      overflow:hidden;
      display:grid;place-items:center;
      font-family: Orbitron, sans-serif;
      color: var(--brand);
      font-size:.8rem;
    }
    .picker-btn .mini img{
      width:100%;height:100%;
      display:block;
      object-fit: cover;
    }
    .picker-btn .name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 210px;
      font-weight:700;
    }
    .picker-btn .hint{
      color: var(--muted);
      font-weight:700;
      font-size:.8rem;
      white-space:nowrap;
    }

    .preview{
      margin-top:10px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .preview img{
      width:100%;
      height: 150px;
      object-fit: contain;      /* fit in card (no cut off) */
      display:block;
      background: rgba(255,255,255,.04);
      padding: 8px;
    }
    .preview .info{ padding: 10px; }
    .preview .info b{
      display:block;
      font-size: .95rem;
      margin-bottom:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .preview .info p{
      margin:0;
      color: var(--muted);
      font-size:.82rem;
      line-height:1.25rem;
      max-height: 2.5rem;
      overflow:hidden;
    }

    /* Backdrop + Mobile sidebar overlay */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity:0;
      pointer-events:none;
      transition:.22s ease;
      z-index: 25;
    }
    .backdrop.show{ opacity:1; pointer-events:auto; }

    /* ===== Modal Picker (shared) ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 80;
      padding: 16px;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: min(980px, 96vw);
      max-height: 88vh;
      background: rgba(14, 18, 28, .86);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius-lg);
      box-shadow: 0 28px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .modal-head .ttl{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .modal-head .ttl b{
      font-family: Orbitron, sans-serif;
      letter-spacing:.6px;
      color: var(--brand);
      font-size: 1.02rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-head .ttl span{
      color: var(--muted);
      font-size:.82rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-close{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--ink);
      cursor:pointer;
      display:grid;place-items:center;
      transition:.2s ease;
    }
    .modal-close:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,189,89,.20);
      box-shadow: 0 0 0 3px rgba(255,189,89,.08);
    }
    .modal-close svg{width:18px;height:18px;opacity:.95}

    .modal-body{
      padding: 12px;
      overflow:auto;
      max-height: calc(88vh - 66px);
    }

    .modal-cols{
      display:grid;
      grid-template-columns: 1fr 300px;
      gap: 12px;
      align-items:start;
    }

    .modal-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }

    .modal-search{
      flex:1;
      min-width: 240px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
    }
    .modal-search input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--ink);
      font-size:.95rem;
    }
    .modal-search input::placeholder{color: rgba(170,177,197,.75)}

    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .fchip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(244,246,255,.88);
      font-size: .82rem;
      cursor:pointer;
      user-select:none;
      transition:.18s ease;
      white-space:nowrap;
    }
    .fchip:hover{background: rgba(255,255,255,.07)}
    .fchip.active{
      border-color: rgba(255,189,89,.28);
      box-shadow: 0 0 0 3px rgba(255,189,89,.08);
      background: linear-gradient(135deg, rgba(255,189,89,.16), rgba(77,211,255,.08));
    }
    .fchip .mini-dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 14px rgba(77,211,255,.22);
    }

    .pick-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
      gap: 10px;
    }
    .pick-card{
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      padding: 8px;
      cursor:pointer;
      transition: .16s ease;
      outline:none;
      position:relative;
    }
    .pick-card:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .pick-card.selected{
      border-color: rgba(255,189,89,.30);
      box-shadow: 0 0 0 3px rgba(255,189,89,.10);
    }
    .pick-card img{
      width:100%;
      border-radius: 12px;
      border: 2px solid transparent;
      background: rgba(0,0,0,.15);
      display:block;
    }
    .pick-card.char img,
    .pick-card.pet img{
      aspect-ratio: 3/4;
      object-fit: cover;
    }
    .pick-card.weapon img{
      aspect-ratio: 16/9;
      object-fit: contain;
      padding: 8px;
      background: rgba(0,0,0,.18);
    }

    .pick-card img.active{ border-color: #00d2ff; }
    .pick-card img.passive{ border-color: #ff59c7; }

    .pick-card .nm{
      margin-top: 6px;
      font-size: .78rem;
      color: rgba(244,246,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }

    .detail{
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position: sticky;
      top: 8px;
    }
    .detail .ph{
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.04);
    }
    .detail .ph b{
      font-family: Orbitron, sans-serif;
      color: var(--brand);
      letter-spacing:.6px;
      font-size: .95rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }
    .detail .ph span{
      color: var(--muted);
      font-size:.78rem;
      white-space:nowrap;
    }
    .detail .body{ padding: 12px; }
    .detail img{
      width:100%;
      height: 220px;
      object-fit: contain;
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      padding: 8px;
      display:block;
      margin-bottom: 10px;
    }
    .detail .txt p{
      margin: 0 0 8px 0;
      color: rgba(244,246,255,.90);
      font-size: .86rem;
      line-height: 1.25rem;
    }
    .detail .txt p small{ color: var(--muted); }

    .detail .pick{
      margin-top:10px;
      width:100%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,189,89,.25);
      background: linear-gradient(135deg, rgba(255,189,89,.18), rgba(255,119,51,.10));
      cursor:pointer;
      transition:.2s ease;
      text-decoration:none;
      font-weight:800;
      color: var(--ink);
      font-size: .92rem;
    }
    .detail .pick:hover{transform: translateY(-1px); box-shadow: 0 0 0 3px rgba(255,189,89,.10)}

    @media (max-width: 980px){
      .content{grid-template-columns: 1fr;}
      .right{order: 2}
      .center{order: 1}

      .burger{display:grid;}
      .sidebar{
        position: fixed;
        top: 18px; bottom: 18px; left: 18px;
        width: var(--sb-w);
        transform: translateX(-110%);
        transition: .22s ease;
        z-index: 30;
      }
      .sidebar.open{transform: translateX(0)}
      body.sb-collapsed .sidebar{ width: var(--sb-w); }
      .app{padding: 14px;}

      .modal-cols{ grid-template-columns: 1fr; }
      .detail{ position: static; }
    }

    @media (max-width: 1180px){
      :root{ --right-w: 320px; }
      .tiles{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
  </style>
</head>

<body>
  <div class="backdrop" id="backdrop"></div>

  <!-- ===== Character Modal ===== -->
  <div class="modal-backdrop" id="charModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="ttl">
          <b>Quick View — Pick a Character</b>
          <span class="muted">Search + filter, click to select</span>
        </div>
        <button class="modal-close" id="charModalClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-cols">
          <div>
            <div class="modal-controls">
              <div class="modal-search">
                <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
                  <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input id="charModalSearch" placeholder="Search character name..." autocomplete="off" />
              </div>

              <div class="filter-row" id="charFilterRow" aria-label="Filters">
                <span class="fchip active" data-meta="all"><span class="mini-dot"></span>All</span>
                <span class="fchip" data-meta="meta"><span class="mini-dot" style="background:var(--brand)"></span>Meta (BR)</span>
                <span class="fchip" data-meta="cs_meta"><span class="mini-dot" style="background:var(--brand2)"></span>Meta (CS)</span>

                <span class="fchip active" data-skill="all"><span class="mini-dot" style="background:var(--accent)"></span>Any</span>
                <span class="fchip" data-skill="Active"><span class="mini-dot" style="background:#00d2ff"></span>Active</span>
                <span class="fchip" data-skill="Passive"><span class="mini-dot" style="background:#ff59c7"></span>Passive</span>
              </div>
            </div>

            <div class="pick-grid" id="charModalGrid"></div>
          </div>

          <aside class="detail" id="charModalDetail">
            <div class="ph">
              <b id="charDetailName">—</b>
              <span id="charDetailTag">—</span>
            </div>
            <div class="body">
              <img id="charDetailImg" src="https://i.imgur.com/qXFpizS.jpg" alt="preview"/>
              <div class="txt" id="charDetailText">
                <p><small>Hover / tap a card to see details here.</small></p>
              </div>
              <button class="pick" id="charDetailPickBtn" type="button">Use this character</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Pet Modal ===== -->
  <div class="modal-backdrop" id="petModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="ttl">
          <b>Quick View — Pick a Pet</b>
          <span class="muted">Search, click to select</span>
        </div>
        <button class="modal-close" id="petModalClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-cols">
          <div>
            <div class="modal-controls">
              <div class="modal-search">
                <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
                  <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input id="petModalSearch" placeholder="Search pet name..." autocomplete="off" />
              </div>
            </div>

            <div class="pick-grid" id="petModalGrid"></div>
          </div>

          <aside class="detail" id="petModalDetail">
            <div class="ph">
              <b id="petDetailName">—</b>
              <span id="petDetailTag">—</span>
            </div>
            <div class="body">
              <img id="petDetailImg" src="https://i.imgur.com/qXFpizS.jpg" alt="preview"/>
              <div class="txt" id="petDetailText">
                <p><small>Hover / tap a card to see details here.</small></p>
              </div>
              <button class="pick" id="petDetailPickBtn" type="button">Use this pet</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Weapon Modal ===== -->
  <div class="modal-backdrop" id="weaponModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="ttl">
          <b>Quick View — Pick a Weapon</b>
          <span class="muted">Search, click to select</span>
        </div>
        <button class="modal-close" id="weaponModalClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-cols">
          <div>
            <div class="modal-controls">
              <div class="modal-search">
                <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
                  <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input id="weaponModalSearch" placeholder="Search weapon name..." autocomplete="off" />
              </div>
            </div>

            <div class="pick-grid" id="weaponModalGrid"></div>
          </div>

          <aside class="detail" id="weaponModalDetail">
            <div class="ph">
              <b id="weaponDetailName">—</b>
              <span id="weaponDetailTag">—</span>
            </div>
            <div class="body">
              <img id="weaponDetailImg" src="https://i.imgur.com/qXFpizS.jpg" alt="preview"/>
              <div class="txt" id="weaponDetailText">
                <p><small>Hover / tap a card to see details here.</small></p>
              </div>
              <button class="pick" id="weaponDetailPickBtn" type="button">Use this weapon</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">FF</div>
        <div>
          <h1>Free Fire</h1>
          <small class="muted">Caster Dashboard</small>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a class="nav-item active" href="dashboard.html" data-page="dashboard.html" title="Dashboard">
          <span class="nav-ico">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 13h7V4H4v9Zm9 7h7V4h-7v16ZM4 20h7v-5H4v5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span class="nav-label">Dashboard</span>
        </a>

        <a class="nav-item" href="char.html" data-page="char.html" title="Character Skills">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Character Skills</span>
        </a>

        <a class="nav-item" href="pet.html" data-page="pet.html" title="Pets">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 14c-1.7 0-3-1.3-3-3S5.3 8 7 8s3 1.3 3 3-1.3 3-3 3Zm10 0c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3ZM7 20c-2.8 0-5-1.8-5-4v-1h6v1c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-1h6v1c0 2.2-2.2 4-5 4H7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Pets</span>
        </a>

        <a class="nav-item" href="weapon.html" data-page="weapon.html" title="Weapons">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M3 21l6-6m0 0 2 2 8-8-2-2-8 8Zm0 0-2-2 4-4 2 2-4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Weapons</span>
        </a>

        <a class="nav-item" href="map.html" data-page="map.html" title="Map">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M10 6 4 8v14l6-2 4 2 6-2V6l-6 2-4-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Map</span>
        </a>

        <a class="nav-item" href="split-view.html" data-page="split-view.html" title="Split View">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Split View</span>
        </a>

        <a class="nav-item" href="clash-draft.html" data-page="clash-draft.html" title="Clash Squad Draft">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h10M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Draft</span>
        </a>

        <a class="nav-item" href="clash-data.html" data-page="clash-data.html" title="Clash Squad Data">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 19V5m0 14h16M8 17v-6m4 6V7m4 10v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Data</span>
        </a>

        <a class="nav-item" href="clash-compare.html" data-page="clash-compare.html" title="Clash Squad Comparison">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M10 3v18M14 3v18M4 7h6M14 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Comparison</span>
        </a>

        <a class="nav-item" href="clash-report.html" data-page="clash-report.html" title="Clash Squad Team Report">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M6 3h12v18H6zM9 7h6M9 11h6M9 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Team Report</span>
        </a>

        <a class="nav-item" href="clash-store.html" data-page="clash-store.html" title="Clash Squad Store">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16l-1 14H5L4 7Zm3 0 1-3h8l1 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Store</span>
        </a>

        <a class="nav-item" href="br_team2.html" data-page="br_team2.html" title="BR Data">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M6 20V10m6 10V4m6 16v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">BR Data</span>
        </a>

        <a class="nav-item" href="ff-update.html" data-page="ff-update.html" title="Free Fire Update">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2v6m0 14v-6M4.9 4.9l4.2 4.2m10.8 10.8-4.2-4.2M2 12h6m14 0h-6M4.9 19.1l4.2-4.2m10.8-10.8-4.2 4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Free Fire Update</span>
        </a>
      </nav>

      <div class="sidebar-foot">
        <span class="pill"><span class="dot"></span><span>Neptune UI • V2</span></span>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <!-- Desktop collapse toggle -->
        <button class="icon-btn" id="collapseBtn" aria-label="Toggle sidebar (desktop)" title="Collapse sidebar">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M10 6 4 12l6 6M20 6v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Mobile menu toggle -->
        <button class="icon-btn burger" id="burger" aria-label="Open menu" title="Open menu">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>

        <div class="search">
          <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
            <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="searchInput" placeholder="Search pages..." />
        </div>

        <div class="top-actions">
          <div class="userchip">
            <div class="avatar"></div>
            <div class="usertext">
              <b id="gamertag">PlayerOne</b>
              <span id="userEmail" class="muted">loading…</span>
            </div>
          </div>

          <a class="logout" href="#" id="logoutBtn">Logout</a>
        </div>
      </header>

      <section class="content">
        <!-- CENTER -->
        <div class="center">
          <div class="card">
            <div class="hero">
              <div class="hero-content">
                <div class="hero-title">
                  <h2>Free Fire Dashboard</h2>
                  <div class="chips">
                    <span class="chip"><span class="mini-dot"></span> Live-ready tools</span>
                    <span class="chip"><span class="mini-dot" style="background:var(--brand)"></span> Brand: #ffbd59</span>
                    <span class="chip"><span class="mini-dot" style="background:var(--brand2)"></span> Neptune Build</span>
                  </div>
                </div>

                <div class="hero-actions">
                  <a class="cta" href="clash-draft.html">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    Open Draft Tool
                  </a>
                </div>
              </div>
            </div>

            <div class="card-inner">
              <div class="tiles">
                <div class="tile" onclick="location.href='char.html'">
                  <div class="k"><span>Characters</span><span class="badge" id="charMeta">meta</span></div>
                  <div class="v" id="charCount">—</div>
                </div>
                <div class="tile" onclick="location.href='pet.html'">
                  <div class="k"><span>Pets</span><span class="badge">support</span></div>
                  <div class="v" id="petCount">—</div>
                </div>
                <div class="tile" onclick="location.href='weapon.html'">
                  <div class="k"><span>Weapons</span><span class="badge">armory</span></div>
                  <div class="v" id="weaponCount">—</div>
                </div>
                <div class="tile" onclick="location.href='br_team2.html'">
                  <div class="k"><span>BR Data</span><span class="badge">analytics</span></div>
                  <div class="v">Open</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <aside class="right">
          <div class="card">
            <div class="card-inner" style="padding-bottom:0">
              <div class="row-head">
                <h3 class="title">Quick View</h3>
                <span class="muted">Pick & preview</span>
              </div>
            </div>

            <div class="qv">
              <div class="box">
                <label>
                  <span>Character</span>
                  <span class="muted" id="charTag">—</span>
                </label>
                <button class="picker-btn" id="openCharPicker" type="button">
                  <span class="left">
                    <span class="mini" id="charMini">FF</span>
                    <span class="name" id="charPickName">Select a character</span>
                  </span>
                  <span class="hint">Browse</span>
                </button>
                <div class="preview" id="characterPreview"></div>
              </div>

              <div class="box">
                <label>
                  <span>Pet</span>
                  <span class="muted" id="petTag">—</span>
                </label>
                <button class="picker-btn" id="openPetPicker" type="button">
                  <span class="left">
                    <span class="mini" id="petMini">FF</span>
                    <span class="name" id="petPickName">Select a pet</span>
                  </span>
                  <span class="hint">Browse</span>
                </button>
                <div class="preview" id="petPreview"></div>
              </div>

              <div class="box">
                <label>
                  <span>Weapon</span>
                  <span class="muted" id="weaponTag">—</span>
                </label>
                <button class="picker-btn" id="openWeaponPicker" type="button">
                  <span class="left">
                    <span class="mini" id="weaponMini">FF</span>
                    <span class="name" id="weaponPickName">Select a weapon</span>
                  </span>
                  <span class="hint">Browse</span>
                </button>
                <div class="preview" id="weaponPreview"></div>
              </div>

              <div class="muted" style="font-size:.8rem; padding: 0 2px;">
                Free Fire Caster © 2025 — Neptune
              </div>
            </div>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <script>
    /***********************
     * Supabase Auth
     ***********************/
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    async function ensureSession(){
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        window.location.href = "index.html";
        return null;
      }
      return session;
    }

    async function logout(){
      await client.auth.signOut();
      window.location.href = "index.html";
    }

    /***********************
     * Sidebar Collapsible + Mobile Overlay
     ***********************/
    const sidebar = document.getElementById('sidebar');
    const burger = document.getElementById('burger');
    const backdrop = document.getElementById('backdrop');
    const collapseBtn = document.getElementById('collapseBtn');

    function isMobile(){ return window.matchMedia('(max-width: 980px)').matches; }

    function openSidebar(){ sidebar.classList.add('open'); backdrop.classList.add('show'); }
    function closeSidebar(){ sidebar.classList.remove('open'); backdrop.classList.remove('show'); }

    burger?.addEventListener('click', () => {
      if (sidebar.classList.contains('open')) closeSidebar();
      else openSidebar();
    });
    backdrop?.addEventListener('click', closeSidebar);

    function applyCollapsedFromStorage(){
      const v = localStorage.getItem('ff_sb_collapsed');
      document.body.classList.toggle('sb-collapsed', v === '1');
    }
    function toggleCollapsed(){
      if (isMobile()) return;
      document.body.classList.toggle('sb-collapsed');
      localStorage.setItem('ff_sb_collapsed', document.body.classList.contains('sb-collapsed') ? '1' : '0');
    }
    collapseBtn?.addEventListener('click', toggleCollapsed);
    window.addEventListener('resize', () => { if (isMobile()) closeSidebar(); });
    applyCollapsedFromStorage();

    // active nav
    (function setActiveNav(){
      const here = (location.pathname.split('/').pop() || 'dashboard.html').toLowerCase();
      document.querySelectorAll('.nav-item').forEach(a => {
        const page = (a.getAttribute('data-page') || '').toLowerCase();
        a.classList.toggle('active', page === here);
      });
    })();

    // top search filters nav
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      const q = (e.target.value || '').toLowerCase().trim();
      document.querySelectorAll('#nav .nav-item').forEach(a => {
        const txt = a.textContent.toLowerCase();
        a.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });

    /***********************
     * Data + Helpers
     ***********************/
    const characterData = [];
    const petData = [];
    const weaponData = [];

    function safeText(v){ return (v ?? '').toString(); }
    function isYes(v){ return (v || 'no') === 'yes'; }

    function loadIdx(key, fallback=0){
      const v = Number(localStorage.getItem(key));
      return Number.isFinite(v) ? v : fallback;
    }
    function saveIdx(key, idx){
      localStorage.setItem(key, String(idx));
    }

    function makePreview(item){
      const img = item?.image_url || item?.icon || item?.img || item?.image || '';
      const title = safeText(item?.name || '—');

      const lineA = safeText(item?.skill || item?.type || item?.category || item?.role || '');
      const lineB = safeText(item?.description || item?.desc || '');
      const desc = (lineA && lineB) ? `${lineA} — ${lineB}` : (lineA || lineB);

      return `
        ${img ? `<img src="${img}" alt="${title}" />` : `<img src="https://i.imgur.com/qXFpizS.jpg" alt="preview" />`}
        <div class="info">
          <b title="${title}">${title}</b>
          <p title="${desc}">${desc || 'No description available.'}</p>
        </div>
      `;
    }

    async function loadJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Fetch failed: ' + url);
      return await res.json();
    }

    function setMini(el, item){
      if (!el) return;
      const img = item?.image_url || item?.icon || item?.img || item?.image || '';
      if (img){
        el.innerHTML = `<img src="${img}" alt="mini" />`;
      } else {
        const nm = safeText(item?.name || 'FF').slice(0,2).toUpperCase() || 'FF';
        el.textContent = nm;
      }
    }

    /***********************
     * Generic Picker Factory
     ***********************/
    function createPicker(opts){
      const {
        kind,
        dataArr,
        storageKey,
        modalId, closeId, openId,
        searchId, gridId,
        detailNameId, detailTagId, detailImgId, detailTextId, detailPickBtnId,
        tagSpanId, previewId,
        pickNameId, miniId,
        cardKindClass,
        getTagText,
        buildDetailText,
        extraFilter,      // (item)=> boolean
        onFiltersReady    // optional hook
      } = opts;

      const state = {
        selectedIndex: -1,
        hoverIndex: -1,
        q: ''
      };

      const modal = document.getElementById(modalId);
      const closeBtn = document.getElementById(closeId);
      const openBtn = document.getElementById(openId);
      const search = document.getElementById(searchId);
      const grid = document.getElementById(gridId);

      const detailName = document.getElementById(detailNameId);
      const detailTag = document.getElementById(detailTagId);
      const detailImg = document.getElementById(detailImgId);
      const detailText = document.getElementById(detailTextId);
      const pickBtn = document.getElementById(detailPickBtnId);

      const tagSpan = document.getElementById(tagSpanId);
      const preview = document.getElementById(previewId);

      const pickName = document.getElementById(pickNameId);
      const mini = document.getElementById(miniId);

      function data(){ return dataArr; }

      function open(){
        if (!modal) return;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        const idx = state.selectedIndex >= 0 ? state.selectedIndex : 0;
        showDetail(idx);
        setTimeout(() => search?.focus(), 0);
      }
      function close(){
        if (!modal) return;
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
      }

      function applySelection(idx){
        const arr = data();
        const item = arr[idx];
        if (!item) return;

        state.selectedIndex = idx;
        saveIdx(storageKey, idx);

        // dashboard preview + tag
        if (preview) preview.innerHTML = makePreview(item);
        if (tagSpan) tagSpan.textContent = safeText(getTagText(item));

        // button label + mini
        if (pickName) pickName.textContent = safeText(item.name || `Selected ${kind}`);
        setMini(mini, item);

        renderGrid();
      }

      function showDetail(idx){
        const arr = data();
        const item = arr[idx];
        if (!item) return;

        state.hoverIndex = idx;

        if (detailName) detailName.textContent = safeText(item.name || '—');
        if (detailTag) detailTag.textContent = safeText(getTagText(item));

        const img = item?.image_url || item?.icon || item?.img || item?.image || 'https://i.imgur.com/qXFpizS.jpg';
        if (detailImg){
          detailImg.src = img;
          detailImg.alt = safeText(item.name || 'preview');
        }
        if (detailText) detailText.innerHTML = buildDetailText(item);
      }

      function filteredIdxList(){
        const arr = data();
        const q = (state.q || '').toLowerCase().trim();
        return arr
          .map((it, idx) => ({ it, idx }))
          .filter(({it}) => {
            if (!it) return false;
            if (q && !safeText(it.name).toLowerCase().includes(q)) return false;
            if (typeof extraFilter === 'function' && !extraFilter(it)) return false;
            return true;
          });
      }

      function renderGrid(){
        if (!grid) return;
        const list = filteredIdxList();

        if (!list.length){
          grid.innerHTML = `<div class="muted" style="padding:10px 4px;">No matches found.</div>`;
          return;
        }

        grid.innerHTML = list.map(({it, idx}) => {
          const sel = (idx === state.selectedIndex) ? 'selected' : '';
          const img = it?.image_url || it?.icon || it?.img || it?.image || 'https://i.imgur.com/qXFpizS.jpg';

          // character border colors (active/passive)
          let skillClass = '';
          if (kind === 'character'){
            const st = safeText(it.skill_type);
            skillClass = (st === 'Passive') ? 'passive' : 'active';
          }

          return `
            <div class="pick-card ${cardKindClass} ${sel}" tabindex="0" data-idx="${idx}" title="${safeText(it.name)}">
              <img src="${img}" alt="${safeText(it.name)}" class="${skillClass}" />
              <div class="nm">${safeText(it.name)}</div>
            </div>
          `;
        }).join('');

        grid.querySelectorAll('.pick-card').forEach(card => {
          const idx = Number(card.getAttribute('data-idx'));

          card.addEventListener('mouseenter', () => showDetail(idx));
          card.addEventListener('focus', () => showDetail(idx));

          card.addEventListener('click', () => {
            applySelection(idx);
            close();
          });

          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              applySelection(idx);
              close();
            }
          });
        });
      }

      // open / close / outside click / esc
      openBtn?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.classList.contains('show')) close();
      });

      search?.addEventListener('input', (e) => {
        state.q = e.target.value || '';
        renderGrid();
      });

      pickBtn?.addEventListener('click', () => {
        const idx = (state.hoverIndex >= 0) ? state.hoverIndex : (state.selectedIndex >= 0 ? state.selectedIndex : 0);
        applySelection(idx);
        close();
      });

      if (typeof onFiltersReady === 'function') onFiltersReady({ renderGrid, state, applySelection, showDetail });

      return {
        state,
        renderGrid,
        applySelection,
        showDetail,
        open,
        close
      };
    }

    /***********************
     * Character Picker Filters
     ***********************/
    const charFilterState = { meta: 'all', skill: 'all' };

    function charExtraFilter(c){
      if (!c) return false;

      // meta filter
      if (charFilterState.meta === 'meta' && !isYes(c.meta)) return false;
      if (charFilterState.meta === 'cs_meta' && !isYes(c.cs_meta)) return false;

      // skill filter
      if (charFilterState.skill !== 'all' && safeText(c.skill_type) !== charFilterState.skill) return false;

      return true;
    }

    function setChipsActive(chips, predicate){
      chips.forEach(x => x.classList.toggle('active', predicate(x)));
    }

    function bindCharacterFilterChips(picker){
      const chips = Array.from(document.querySelectorAll('#charFilterRow .fchip'));
      const metaChips = chips.filter(x => x.getAttribute('data-meta'));
      const skillChips = chips.filter(x => x.getAttribute('data-skill'));

      chips.forEach(ch => {
        ch.addEventListener('click', () => {
          const meta = ch.getAttribute('data-meta');
          const skill = ch.getAttribute('data-skill');

          if (meta){
            charFilterState.meta = meta;
            setChipsActive(metaChips, (x) => x.getAttribute('data-meta') === meta);
          }
          if (skill){
            charFilterState.skill = skill;
            setChipsActive(skillChips, (x) => x.getAttribute('data-skill') === skill);
          }

          picker.renderGrid();
        });
      });
    }

    /***********************
     * Init
     ***********************/
    window.addEventListener('DOMContentLoaded', async () => {
      // auth
      const session = await ensureSession();
      if (!session) return;

      const email = session.user?.email || '';
      document.getElementById('userEmail').textContent = email || 'signed in';
      const username = email ? email.split('@')[0] : 'PlayerOne';
      document.getElementById('gamertag').textContent = username;

      document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });

      // data loads
      try{
        const [chars, pets, weapons] = await Promise.all([
          loadJson('https://neptuneg1.github.io/freefire-caster/character.json'),
          loadJson('https://neptuneg1.github.io/freefire-caster/pet.json'),
          loadJson('https://neptuneg1.github.io/freefire-caster/weapon.json')
        ]);

        characterData.push(...(Array.isArray(chars) ? chars : []));
        petData.push(...(Array.isArray(pets) ? pets : []));
        weaponData.push(...(Array.isArray(weapons) ? weapons : []));

        // counts
        document.getElementById('charCount').textContent = characterData.length.toLocaleString();
        document.getElementById('petCount').textContent = petData.length.toLocaleString();
        document.getElementById('weaponCount').textContent = weaponData.length.toLocaleString();

        // meta badge detection
        const hasMeta = characterData.some(x => x && (x.meta !== undefined || x.cs_meta !== undefined));
        document.getElementById('charMeta').textContent = hasMeta ? 'meta/cs_meta' : 'library';

        // ===== Create pickers =====

        const characterPicker = createPicker({
          kind: 'character',
          dataArr: characterData,
          storageKey: 'ff_qv_char_idx',
          modalId: 'charModal',
          closeId: 'charModalClose',
          openId: 'openCharPicker',
          searchId: 'charModalSearch',
          gridId: 'charModalGrid',
          detailNameId: 'charDetailName',
          detailTagId: 'charDetailTag',
          detailImgId: 'charDetailImg',
          detailTextId: 'charDetailText',
          detailPickBtnId: 'charDetailPickBtn',
          tagSpanId: 'charTag',
          previewId: 'characterPreview',
          pickNameId: 'charPickName',
          miniId: 'charMini',
          cardKindClass: 'char',
          getTagText: (c) => {
            if (!c) return '—';
            if (c.meta !== undefined || c.cs_meta !== undefined){
              if (isYes(c.meta)) return 'meta';
              if (isYes(c.cs_meta)) return 'cs_meta';
            }
            return c.role || c.skill_type || '—';
          },
          buildDetailText: (c) => {
            const st = safeText(c.skill_type || '—');
            const skill = safeText(c.skill || '—');
            const desc = safeText(c.description || '');
            const role = safeText(c.role || 'N/A');
            return `
              <p><small>${st} Skill</small><br><b>${skill}</b></p>
              <p>${desc || '<small>No description available.</small>'}</p>
              <p><small>Role:</small> ${role}</p>
            `;
          },
          extraFilter: charExtraFilter,
          onFiltersReady: ({ renderGrid }) => {
            bindCharacterFilterChips({ renderGrid });
          }
        });

        const petPicker = createPicker({
          kind: 'pet',
          dataArr: petData,
          storageKey: 'ff_qv_pet_idx',
          modalId: 'petModal',
          closeId: 'petModalClose',
          openId: 'openPetPicker',
          searchId: 'petModalSearch',
          gridId: 'petModalGrid',
          detailNameId: 'petDetailName',
          detailTagId: 'petDetailTag',
          detailImgId: 'petDetailImg',
          detailTextId: 'petDetailText',
          detailPickBtnId: 'petDetailPickBtn',
          tagSpanId: 'petTag',
          previewId: 'petPreview',
          pickNameId: 'petPickName',
          miniId: 'petMini',
          cardKindClass: 'pet',
          getTagText: (p) => p?.type || p?.role || 'pet',
          buildDetailText: (p) => {
            const skill = safeText(p.skill || p.ability || '—');
            const desc = safeText(p.description || p.desc || '');
            const type = safeText(p.type || p.role || 'N/A');
            return `
              <p><small>Type</small><br><b>${type}</b></p>
              <p><small>Skill</small><br><b>${skill}</b></p>
              <p>${desc || '<small>No description available.</small>'}</p>
            `;
          }
        });

        const weaponPicker = createPicker({
          kind: 'weapon',
          dataArr: weaponData,
          storageKey: 'ff_qv_weapon_idx',
          modalId: 'weaponModal',
          closeId: 'weaponModalClose',
          openId: 'openWeaponPicker',
          searchId: 'weaponModalSearch',
          gridId: 'weaponModalGrid',
          detailNameId: 'weaponDetailName',
          detailTagId: 'weaponDetailTag',
          detailImgId: 'weaponDetailImg',
          detailTextId: 'weaponDetailText',
          detailPickBtnId: 'weaponDetailPickBtn',
          tagSpanId: 'weaponTag',
          previewId: 'weaponPreview',
          pickNameId: 'weaponPickName',
          miniId: 'weaponMini',
          cardKindClass: 'weapon',
          getTagText: (w) => w?.type || w?.category || w?.class || 'weapon',
          buildDetailText: (w) => {
            const type = safeText(w.type || w.category || w.class || 'N/A');
            const desc = safeText(w.description || w.desc || w.special || '');

            // show a few common stat fields if they exist
            const keys = [
              ['damage','Damage'],
              ['range','Range'],
              ['accuracy','Accuracy'],
              ['rate_of_fire','ROF'],
              ['reload','Reload'],
              ['magazine','Magazine'],
              ['ammo','Ammo'],
              ['penetration','Penetration'],
              ['stability','Stability']
            ];
            const stats = keys
              .filter(([k]) => w[k] !== undefined && w[k] !== null && safeText(w[k]) !== '')
              .slice(0, 6)
              .map(([k, label]) => `<p><small>${label}:</small> ${safeText(w[k])}</p>`)
              .join('');

            return `
              <p><small>Type</small><br><b>${type}</b></p>
              ${stats || ''}
              <p>${desc || '<small>No description available.</small>'}</p>
            `;
          }
        });

        // initial selections from storage (fallback 0)
        if (characterData.length){
          characterPicker.applySelection(Math.min(loadIdx('ff_qv_char_idx', 0), characterData.length-1));
          characterPicker.renderGrid();
        } else {
          document.getElementById('characterPreview').innerHTML = makePreview(null);
          document.getElementById('charPickName').textContent = 'No characters loaded';
        }

        if (petData.length){
          petPicker.applySelection(Math.min(loadIdx('ff_qv_pet_idx', 0), petData.length-1));
          petPicker.renderGrid();
        } else {
          document.getElementById('petPreview').innerHTML = makePreview(null);
          document.getElementById('petPickName').textContent = 'No pets loaded';
        }

        if (weaponData.length){
          weaponPicker.applySelection(Math.min(loadIdx('ff_qv_weapon_idx', 0), weaponData.length-1));
          weaponPicker.renderGrid();
        } else {
          document.getElementById('weaponPreview').innerHTML = makePreview(null);
          document.getElementById('weaponPickName').textContent = 'No weapons loaded';
        }

      }catch(err){
        console.error(err);
        document.getElementById('charCount').textContent = '—';
        document.getElementById('petCount').textContent = '—';
        document.getElementById('weaponCount').textContent = '—';
      }
    });
  </script>
</body>
</html>
