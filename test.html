<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FFBR — Player Performance</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
    --brand:#ffbd59; --brand2:#ff7733; --line:#313131;
    --heat-rgb:255,189,89; --heat-min:.06; --heat-max:.22; --heat-top-outline:.42; --heat-radius:8px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
  h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
  .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
  .chip{font-size:.85rem;color:#ddd}
  .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}
  .shell{max-width:1140px;margin:22px auto;padding:0 12px}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
  .section h2{margin:0 0 10px;color:var(--brand)}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
  .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
  .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 8px;font-size:.9rem}
  .muted{color:var(--muted)}
  details.accordion{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:0;margin-bottom:14px}
  details.accordion > summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line);user-select:none}
  details.accordion[open] > summary{border-bottom-color:var(--line)}
  details.accordion > .accordion-body{padding:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
  thead th{background:#191919;text-align:left;border-radius:8px;padding:8px 6px}
  th,td{padding:6px 6px;vertical-align:top}
  .right{text-align:right}
  td[data-key]{transition:background-color .18s ease, box-shadow .18s ease;border-radius:var(--heat-radius);background-clip:padding-box}
  td.heat-top{box-shadow:inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline))}
  .pill{background:#161616;border:1px solid #303030;border-radius:999px;padding:6px 10px;color:#d7d7d7}
  .input{background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:7px 10px}
  .linklike{background:transparent;border:0;padding:0;margin:0;color:#7fd2ff;text-decoration:underline;cursor:pointer;font:inherit}
  @media (max-width: 880px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>FFBR — Player Performance</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <!-- PLAYER PICKER -->
  <div class="section">
    <h2>Player</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <label class="pill">Player
        <select id="playerSelect" class="input" style="min-width:260px">
          <option value="">— Select player —</option>
        </select>
      </label>
      <input id="playerSearch" class="input" placeholder="Type a name and press Enter…" style="min-width:240px"/>
      <button class="btn secondary" id="clearPlayer">Clear</button>
      <button class="btn" id="copyLink">Copy Link</button>
    </div>
    <div class="muted" id="pickerHint">Loading…</div>
  </div>

  <!-- OVERVIEW -->
  <div class="section" id="playerHeader">
    <h2 id="playerTitle">Player Overview</h2>
    <div class="grid2">
      <div class="card" id="playerIdentity">
        <h3>Identity</h3>
        <div id="identityBody" class="muted">Select a player.</div>
      </div>
      <div class="card" id="playerKPIs">
        <h3>Key KPIs</h3>
        <div id="kpiBody">—</div>
      </div>
    </div>
  </div>

  <!-- RECENT ENTRIES (Top 10 for selected player) -->
  <details class="accordion" open>
    <summary>Recent Entries (Top 10)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblRecent">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: ACTIVE SKILL (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Active Skill Usage — All Players (Top 50 by count)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblActive">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: PET (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Pet Usage — All Players (Top 50 by count)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblPet">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: TOP 10 PLAYERS BY KILLS -->
  <details class="accordion" open>
    <summary>Top 10 Players by Kills</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblTopKillers">—</div>
      </div>
    </div>
  </details>

  <!-- MINI PANEL: per-player pick profile (uses SAME logic as your LOPS page) -->
  <details class="accordion">
    <summary>Player Mini Panel — Pick Profile & Rates</summary>
    <div class="accordion-body">
      <div class="kpis" id="ppKPIs" style="margin-bottom:10px"></div>
      <div class="grid2">
        <div class="card" style="margin:0">
          <h3>Active Skills — Player Picks</h3>
          <div id="ppActive">—</div>
        </div>
        <div class="card" style="margin:0">
          <h3>Pet Skills — Player Picks</h3>
          <div id="ppPet">—</div>
        </div>
      </div>
    </div>
  </details>
</div>

<script>
/* ===== Supabase ===== */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);
(async ()=>{
  const { data: { session } } = await client.auth.getSession();
  const ui = document.getElementById('user-info');
  if (session?.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
  else ui.textContent = 'Anon access';
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut(); window.location.href = 'index.html';
};

/* ===== Utils ===== */
const el = id => document.getElementById(id);
const norm = v => (v==null ? '' : String(v).trim());
const low  = v => norm(v).toLowerCase();
const n = v => {
  if (v==null || v==='') return 0;
  if (typeof v === 'number') return isFinite(v) ? v : 0;
  const s = String(v).replace(/[, ]/g,'').trim();
  const m = s.match(/^(-?\d+(\.\d+)?)$/);
  return m ? Number(m[1]) : 0;
};
const uniq = arr => Array.from(new Set(arr));
function sum(arr, k){ let t=0; for(const r of arr) t += n(r[k]); return t; }
function looksLikeDate(s){ return !isNaN(new Date(s).getTime()); }

/* case-insensitive getter with alias attempts */
function getCI(obj, ...names){
  if (!obj) return '';
  const keys = Object.keys(obj);
  for (const want of names){
    const k1 = keys.find(k => k === want);
    if (k1 && obj[k1]!=null && obj[k1]!=='') return obj[k1];
    const k2 = keys.find(k => k.toLowerCase() === String(want).toLowerCase());
    if (k2 && obj[k2]!=null && obj[k2]!=='') return obj[k2];
  }
  return '';
}

/* ===== Normalizer (columns you flagged) ===== */
function normalizeRow(r){
  const o = {...r};
  o._created = getCI(o,'created_at','Created','Timestamp');
  o._id      = n(getCI(o,'id','ID'));

  o._player  = norm(getCI(o,'Player name','Player Name','Player','IGN','InGameName'));
  o._team    = norm(getCI(o,'Team','TeamName','TAG'));
  o._map     = norm(getCI(o,'Map','Match Map','map'));
  o._tournament = norm(getCI(o,'Tournament','Event','Series'));

  // core stats (numeric)
  o.kills     = n(getCI(o,'KILLS','Kills','Kill'));
  o.assists   = n(getCI(o,'ASSISTS','Assist','Assists'));
  o.headshots = n(getCI(o,'HEADSHOTRS','HEADSHOTS','Headshots','HS'));
  o.damage    = n(getCI(o,'DAMAGE','Damage','DMG'));
  o.grenade   = n(getCI(o,'Grenade kill','Grenade Kill','Grenade Kills'));

  // picks (strings)
  o.active = norm(getCI(o,'Active Skill','Active','Skill','ActiveSkill'));
  o.pet    = norm(getCI(o,'Pet','Pet Skill Name','PetSkill','PetName'));

  // a per-game fingerprint to de-dupe if needed
  o._pgkey = `${low(o._player)}|${low(o._team)}|${low(o._map)}|${looksLikeDate(o._created)?new Date(o._created).getTime():low(o._created)}`;
  return o;
}

/* ===== Fetch ===== */
async function fetchAllRows(){
  const CHUNK = 2000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_lopsdata')
      .select('*')
      .range(from, from + CHUNK - 1);
    if (error){ console.error('ffbr_lopsdata fetch failed:', error); break; }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }
  return out.map(normalizeRow).filter(r => r._player);
}

/* ===== Heatmap (optional visual) ===== */
function applyColumnHeatmap(containerId, keys){
  const wrap = el(containerId);
  const table = wrap?.querySelector('table'); if (!table) return;
  table.querySelectorAll('td[data-key]').forEach(td=>{
    td.style.backgroundColor = ''; td.classList.remove('heat-top');
  });
  const styles = getComputedStyle(document.documentElement);
  const rgb    = styles.getPropertyValue('--heat-rgb') || '255,189,89';
  const minA   = parseFloat(styles.getPropertyValue('--heat-min')) || .06;
  const maxA   = parseFloat(styles.getPropertyValue('--heat-max')) || .22;
  const radius = styles.getPropertyValue('--heat-radius') || '8px';
  const BANDS  = 5;

  for (const key of keys){
    const cells = Array.from(table.querySelectorAll(`td[data-key="${key}"]`));
    if (!cells.length) continue;
    const entries = cells.map((td,i)=>{
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      return { td, i, v: isFinite(v) ? v : null };
    }).filter(e => e.v != null);
    if (!entries.length) continue;
    const asc = entries.slice().sort((a,b)=> a.v - b.v);
    const n   = asc.length;
    const topVal = asc[n-1].v;
    const bandByIndex = new Map();
    asc.forEach((e, rank)=>{
      const p = (n<=1) ? 1 : (rank/(n-1));
      const band = Math.min(BANDS-1, Math.floor(p * BANDS));
      bandByIndex.set(e.i, band);
    });
    cells.forEach((td,i)=>{
      const band = bandByIndex.get(i);
      if (band == null) return;
      const alpha = minA + ((band)/(BANDS-1)) * (maxA - minA);
      td.style.backgroundColor = `rgba(${rgb}, ${alpha.toFixed(3)})`;
      td.style.borderRadius = radius;
      td.style.backgroundClip = 'padding-box';
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      if (isFinite(v) && v === topVal) td.classList.add('heat-top');
    });
  }
}

/* ===== Render helpers ===== */
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.html) v = c.html(r);
    else if (c.format==='pct') v = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
    else if (c.format==='1d') v = isFinite(v) ? Number(v).toFixed(1) : '—';
    else if (c.format==='2d') v = isFinite(v) ? Number(v).toFixed(2) : '—';
    else if (c.format==='0d') v = isFinite(v) ? Number(v).toFixed(0) : '—';
    return `<td data-key="${c.key}" class="${c.right?'right':''}">${(v==null||v==='')?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}
function identityBlock(playerName, rows){
  const teams = Array.from(new Set(rows.map(r=>r._team).filter(Boolean))).join(', ') || '—';
  const tourns = new Set(rows.map(r=>r._tournament).filter(Boolean)).size;
  return `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:72px;height:72px;border:1px solid #2a2a2a;border-radius:10px;background:#111;display:flex;align-items:center;justify-content:center;font-weight:800">${(playerName||'?').slice(0,2).toUpperCase()}</div>
      <div>
        <div style="font-size:1.1rem;font-weight:800">${playerName||'—'}</div>
        <div class="muted">${teams} • ${tourns||0} tournament(s)</div>
      </div>
    </div>`;
}
function kpisForPlayer(rows){
  const cnt = rows.length;
  const kills = sum(rows,'kills');
  const assists = sum(rows,'assists');
  const hs = sum(rows,'headshots');
  const dmg = sum(rows,'damage');
  const gk = sum(rows,'grenade');
  return {
    rows: cnt, kills, assists, hs, dmg, gk,
    kpr: cnt? kills/cnt : 0,
    apr: cnt? assists/cnt : 0,
    dpr: cnt? dmg/cnt : 0,
    hsr: kills? hs/kills : 0,
  };
}

/* ===== Global pick logic (exactly your LOPS logic) ===== */
function tally(list){
  const m=new Map();
  for(const v of list){ const k=norm(v); if(!k) continue; m.set(k,(m.get(k)||0)+1); }
  return Array.from(m.entries()).map(([name,count])=>({name,count}));
}
function renderPickTable(items, mountId, title){
  const total = items.reduce((t,x)=>t+x.count,0) || 1;
  const rows = items.sort((a,b)=> b.count-a.count || a.name.localeCompare(b.name))
                    .slice(0,50)
                    .map((x,i)=>({ rank:i+1, name:x.name, count:x.count, rate:x.count/total }));
  el(mountId).innerHTML = renderSimpleTable(rows, [
    {label:'#', key:'rank', right:true},
    {label:title, key:'name'},
    {label:'Count', key:'count', right:true},
    {label:'Pick %', key:'rate', right:true, format:'pct'}
  ]);
}

/* ===== Data + State ===== */
let ALL = [];
let CURRENT_PLAYER = '';

/* ===== Build player list ===== */
function buildPlayerList(){
  const names = uniq(ALL.map(r=>r._player).filter(Boolean)).sort((a,b)=> a.localeCompare(b));
  const sel = el('playerSelect');
  sel.innerHTML = `<option value="">— Select player —</option>` + names.map(nm=>`<option value="${nm.replaceAll('"','&quot;')}">${nm}</option>`).join('');
  el('pickerHint').textContent = `${names.length} unique players`;
}

/* ===== Selection ===== */
function selectPlayer(name){
  CURRENT_PLAYER = (name||'').trim();
  el('playerSearch').value = CURRENT_PLAYER;
  el('playerSelect').value = CURRENT_PLAYER;

  const rows = ALL.filter(r => (r._player||'').toLowerCase() === CURRENT_PLAYER.toLowerCase());
  el('playerTitle').textContent = CURRENT_PLAYER ? `Player Overview — ${CURRENT_PLAYER}` : 'Player Overview';
  el('identityBody').innerHTML = CURRENT_PLAYER ? identityBlock(CURRENT_PLAYER, rows) : 'Select a player.';
  const k = kpisForPlayer(rows);
  el('kpiBody').innerHTML = k.rows ? `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.rows}</strong></div>
      <div class="kpi">Kills <strong>${k.kills}</strong> <span class="muted">(${k.kpr.toFixed(2)}/row)</span></div>
      <div class="kpi">Assists <strong>${k.assists}</strong> <span class="muted">(${k.apr.toFixed(2)}/row)</span></div>
      <div class="kpi">Grenade <strong>${k.gk}</strong></div>
      <div class="kpi">Damage <strong>${Math.round(k.dmg)}</strong> <span class="muted">(${Math.round(k.dpr)}/row)</span></div>
      <div class="kpi">Headshots <strong>${k.hs}</strong> <span class="muted">(${(k.hsr*100).toFixed(1)}%)</span></div>
    </div>` : '<div class="muted">—</div>';

  // Recent top 10
  const sorted = rows.slice().sort((a,b)=>{
    const ad = new Date(a._created||0).getTime() || 0;
    const bd = new Date(b._created||0).getTime() || 0;
    if (ad !== bd) return bd - ad;
    return (b._id||0) - (a._id||0);
  }).slice(0,10);

  el('tblRecent').innerHTML = renderSimpleTable(sorted, [
    { label:'Map', key:'_map' },
    { label:'Tournament', key:'_tournament' },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
  ]);
  applyColumnHeatmap('tblRecent', ['kills','assists','headshots','grenade','damage']);

  // Mini panel (per-player tallies, same logic)
  renderMiniPanel(rows);
}

/* ===== Mini panel using the same tally logic per player ===== */
function renderMiniPanel(playerRows){
  const k = kpisForPlayer(playerRows);
  el('ppKPIs').innerHTML = k.rows ? `
    <div class="kpis">
      <div class="kpi"><div class="t">Matches (rows)</div><div class="v">${k.rows}</div></div>
      <div class="kpi"><div class="t">Kills</div><div class="v">${k.kills}</div></div>
      <div class="kpi"><div class="t">Assists</div><div class="v">${k.assists}</div></div>
      <div class="kpi"><div class="t">Headshots</div><div class="v">${k.hs}</div></div>
      <div class="kpi"><div class="t">Damage</div><div class="v">${Math.round(k.dmg)}</div></div>
      <div class="kpi"><div class="t">Grenade</div><div class="v">${k.gk}</div></div>
    </div>
  ` : '<div class="muted">—</div>';

  const act = playerRows.map(r=> r.active).filter(Boolean);
  const pet = playerRows.map(r=> r.pet).filter(Boolean);

  if (act.length){
    const items = tally(act);
    const total = items.reduce((t,x)=>t+x.count,0) || 1;
    const rowsAct = items.sort((a,b)=> b.count-a.count || a.name.localeCompare(b.name))
                         .slice(0,30)
                         .map((x,i)=>({ rank:i+1, name:x.name, count:x.count, rate:x.count/total }));
    el('ppActive').innerHTML = renderSimpleTable(rowsAct, [
      {label:'#', key:'rank', right:true},
      {label:'Active Skill', key:'name'},
      {label:'Count', key:'count', right:true},
      {label:'Pick %', key:'rate', right:true, format:'pct'}
    ]);
  } else {
    el('ppActive').innerHTML = '<div class="muted">No Active Skill picks for this player.</div>';
  }

  if (pet.length){
    const items = tally(pet);
    const total = items.reduce((t,x)=>t+x.count,0) || 1;
    const rowsPet = items.sort((a,b)=> b.count-a.count || a.name.localeCompare(b.name))
                         .slice(0,30)
                         .map((x,i)=>({ rank:i+1, name:x.name, count:x.count, rate:x.count/total }));
    el('ppPet').innerHTML = renderSimpleTable(rowsPet, [
      {label:'#', key:'rank', right:true},
      {label:'Pet Skill', key:'name'},
      {label:'Count', key:'count', right:true},
      {label:'Pick %', key:'rate', right:true, format:'pct'}
    ]);
  } else {
    el('ppPet').innerHTML = '<div class="muted">No Pet Skill picks for this player.</div>';
  }
}

/* ===== Global tables ===== */
function renderActiveGlobal(allRows){
  const list = tally(allRows.map(r=>r.active).filter(Boolean));
  if (!list.length){ el('tblActive').innerHTML = '<div class="muted">No Active Skill data.</div>'; return; }
  renderPickTable(list, 'tblActive', 'Active Skill');
}
function renderPetGlobal(allRows){
  const list = tally(allRows.map(r=>r.pet).filter(Boolean));
  if (!list.length){ el('tblPet').innerHTML = '<div class="muted">No Pet Skill data.</div>'; return; }
  renderPickTable(list, 'tblPet', 'Pet Skill');
}
function renderTopKillers(allRows){
  const m = new Map();
  for (const r of allRows){
    const p = r._player; if (!p) continue;
    if (!m.has(p)) m.set(p,{player:p, kills:0, assists:0, headshots:0, grenade:0, damage:0, rows:0});
    const o = m.get(p);
    o.kills += r.kills; o.assists += r.assists; o.headshots += r.headshots; o.grenade += r.grenade; o.damage += r.damage; o.rows++;
  }
  const list = Array.from(m.values()).sort((a,b)=> b.kills - a.kills || a.player.localeCompare(b.player)).slice(0,10);
  el('tblTopKillers').innerHTML = renderSimpleTable(list, [
    { label:'Player', key:'player' },
    { label:'Rows', key:'rows', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
  ]);
  applyColumnHeatmap('tblTopKillers', ['rows','kills','assists','headshots','grenade','damage']);
}

/* ===== Copy link ===== */
function copyLinkToClipboard(){
  const url = new URL(window.location.href);
  if (CURRENT_PLAYER) url.searchParams.set('player', CURRENT_PLAYER);
  else url.searchParams.delete('player');
  navigator.clipboard.writeText(url.toString()).then(()=>{
    const btn = el('copyLink'); const old = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(()=> btn.textContent = old, 1200);
  });
}

/* ===== Init / Wiring ===== */
async function initial(){
  const raw = await fetchAllRows();
  ALL = raw;

  buildPlayerList();
  renderActiveGlobal(ALL);
  renderPetGlobal(ALL);
  renderTopKillers(ALL);

  // Deep link
  const url = new URL(window.location.href);
  const qp = (url.searchParams.get('player')||'').trim();
  if (qp){
    const exact = uniq(ALL.map(r=>r._player)).find(nm=> nm.toLowerCase()===qp.toLowerCase());
    if (exact) selectPlayer(exact);
  }

  // UI events
  el('playerSelect').addEventListener('change', e=>{
    const v = (e.target.value||'').trim();
    selectPlayer(v);
  });
  el('playerSearch').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const name = (e.target.value||'').trim();
      if (!name) return;
      const exact = uniq(ALL.map(r=>r._player)).find(nm=> nm.toLowerCase()===name.toLowerCase());
      selectPlayer(exact || name);
    }
  });
  el('clearPlayer').onclick = ()=>{
    CURRENT_PLAYER = '';
    el('playerSelect')..value = '';
    el('playerSearch').value = '';
    el('playerTitle').textContent = 'Player Overview';
    el('identityBody').innerHTML = 'Select a player.';
    el('kpiBody').innerHTML = '—';
    el('tblRecent').innerHTML = '—';
    el('ppKPIs').innerHTML = '—';
    el('ppActive').innerHTML = '—';
    el('ppPet').innerHTML = '—';
  };
  el('copyLink').onclick = copyLinkToClipboard;

  // Make player cells clickable in top killers table to jump mini-panel
  document.addEventListener('click', (e)=>{
    const td = e.target.closest('td');
    if (!td) return;
    const row = td.parentElement;
    const head = td.closest('table')?.querySelectorAll('thead th') ?? [];
    const idx = Array.from(head).findIndex(th => th.textContent.trim().toLowerCase() === 'player');
    if (idx >= 0){
      const nameCell = row.children[idx];
      if (nameCell){
        const name = nameCell.textContent.trim();
        if (name){
          selectPlayer(name);
          // open the mini panel for quick glance
          document.querySelectorAll('details.accordion').forEach(d=>{
            if (d.querySelector('#ppKPIs')) d.open = true;
          });
        }
      }
    }
  });
}
initial();
</script>
</body>
</html>
