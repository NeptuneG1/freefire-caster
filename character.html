<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Skills</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Supabase JS v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#07090f;
      --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.08);
      --ink:#f4f6ff;
      --muted:#aab1c5;

      --brand:#ffbd59;
      --brand2:#ff7733;
      --accent:#4dd3ff;

      --radius:16px;
      --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);

      --sb-w: 260px;
      --sb-w-collapsed: 82px;

      --active:#4dd3ff;   /* skill-type color */
      --passive:#ff59c7;  /* skill-type color */
      --metaDot:#ffbd59;  /* meta indicator dot */
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(77,211,255,.15), transparent 60%),
        radial-gradient(700px 420px at 85% 18%, rgba(255,189,89,.12), transparent 60%),
        radial-gradient(900px 620px at 50% 110%, rgba(255,119,51,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
      overflow-y:auto;
    }

    body::before, body::after{
      content:"";
      position:fixed;
      inset:auto auto 0 0;
      width:520px; height:520px;
      border-radius:50%;
      border:10px solid rgba(77,211,255,.14);
      transform: translate(-45%, -35%);
      pointer-events:none;
      z-index:0;
    }
    body::after{
      inset: -120px 0 auto auto;
      width:420px; height:420px;
      border:10px solid rgba(77,211,255,.10);
      transform: translate(38%, 0%);
    }

    a{color:inherit}

    select{
      color-scheme: dark;
      background: rgba(0,0,0,.28);
      color: var(--ink);
    }
    select option{ background:#0b1020; color:var(--ink); }

    .app{
      display:flex;
      gap:18px;
      padding:18px;
      max-width: 1440px;
      margin: 0 auto;
      position:relative;
      z-index:1;
      align-items:flex-start;
    }

    /* Sidebar */
    .sidebar{
      width: var(--sb-w);
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transition: width .18s ease;
      flex: 0 0 auto;
      position: sticky;
      top: 18px;
      height: calc(100vh - 36px);
    }
    .sidebar.collapsed{ width: var(--sb-w-collapsed); }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:16px 16px 10px 16px;
      border-bottom: 1px solid var(--line);
    }
    .brand-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,189,89,.25), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-family: Orbitron, sans-serif;
      letter-spacing:.5px;
      color:var(--brand);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-family: Orbitron, sans-serif;
      font-size: 1.05rem;
      letter-spacing:.6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }
    .brand small{
      display:block;
      color: var(--muted);
      font-size:.78rem;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }

    .nav{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      min-height:0;
      flex:1;
    }
    .nav::-webkit-scrollbar{width:10px}
    .nav::-webkit-scrollbar-thumb{background: rgba(255,255,255,.08); border-radius:10px}
    .nav::-webkit-scrollbar-track{background: transparent}

    .nav-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      text-decoration:none;
      transition: .2s ease;
      cursor:pointer;
      min-width:0;
    }
    .nav-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color: var(--ink);
    }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(255,189,89,.14), rgba(77,211,255,.09));
      border-color: rgba(255,189,89,.22);
      color: var(--ink);
    }
    .nav-ico{
      width:26px;height:26px;border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:grid;place-items:center;
      flex: 0 0 auto;
    }
    .nav-ico svg{width:14px;height:14px;opacity:.9}
    .nav-label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    .sidebar.collapsed .brand h1,
    .sidebar.collapsed .brand small,
    .sidebar.collapsed .nav-label{display:none;}
    .sidebar.collapsed .brand{justify-content:center;}
    .sidebar.collapsed .brand-left{justify-content:center;}
    .sidebar.collapsed .nav-item{
      justify-content:center;
      gap:0;
      padding:10px 8px;
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
      gap: 14px;
    }

    .topbar{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      min-width: 0;
    }
    .search input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--ink);
      font-size: .95rem;
    }
    .search input::placeholder{color: rgba(170,177,197,.75)}

    .icon-btn{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.2s ease;
      color: var(--ink);
      flex:0 0 auto;
    }
    .icon-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .icon-btn svg{width:18px;height:18px;opacity:.92}

    .userchip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      max-width: 260px;
      flex: 0 0 auto;
    }
    .avatar{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,189,89,.30), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
    }
    .usertext{min-width:0}
    .usertext b{
      display:block;
      font-size:.92rem;
      font-family: Orbitron, sans-serif;
      color: var(--brand);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 170px;
    }
    .usertext span{display:block; font-size:.78rem; color: var(--muted)}

    .logout{
      color: rgba(255,255,255,.70);
      text-decoration:none;
      font-size:.85rem;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      transition:.2s ease;
      cursor:pointer;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .logout:hover{
      border-color: rgba(255,77,77,.35);
      color: #ff8d8d;
      box-shadow: 0 0 0 3px rgba(255,77,77,.10);
    }

    /* Content */
    .content{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .panel-card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-inner{padding:14px}

    .hero{
      position:relative;
      height: 170px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.10)),
        url('https://i.imgur.com/qXFpizS.jpg') center/cover no-repeat;
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 220px at 55% 45%, rgba(255,189,89,.16), transparent 60%);
      pointer-events:none;
    }
    .hero-content{
      position:absolute;
      left:16px; right:16px; bottom:14px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 12px;
    }
    .hero-title h2{
      font-family: Orbitron, sans-serif;
      font-size: 1.55rem;
      color: var(--brand);
      text-shadow: 0 0 18px rgba(255,189,89,.20);
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .hero-sub{
      margin-top:6px;
      color: rgba(244,246,255,.80);
      font-size: .9rem;
    }

    .hero-actions{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
      align-items:center;
    }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(244,246,255,.88);
      cursor:pointer;
      font-weight:800;
      font-size:.84rem;
      transition:.2s ease;
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      border-color: rgba(77,211,255,.22);
      transform: translateY(-1px);
    }
    .btn.brand{
      background: linear-gradient(135deg, rgba(255,189,89,.18), rgba(255,119,51,.12));
      border-color: rgba(255,189,89,.22);
    }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.04);
    }

    /* Legend: only skill-type dots (meta legend removed per request) */
    .legend{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: rgba(244,246,255,.88);
      font-weight:800;
      font-size:.82rem;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      display:inline-block;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }

    .section-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 4px;
    }
    .section-head h3{
      margin:0;
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
      color: rgba(244,246,255,.94);
      font-size: 1.05rem;
    }
    .section-head small{ color: var(--muted); font-size:.85rem; }

    .grid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
    }

    .char-card{
      padding: 10px 10px 8px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.09);
      cursor:pointer;
      transition:.18s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
      user-select:none;
    }
    .char-card:hover{
      background: rgba(255,255,255,.08);
      transform: translateY(-1px);
      border-color: rgba(255,189,89,.18);
    }

    .thumb{
      width:100%;
      aspect-ratio: 3 / 4;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      object-position: center top; /* keep top visible */
      display:block;
      background: rgba(255,255,255,.02);
    }

    /* Skill-type dot (keep titles, remove Active/Passive words from card) */
    .type-dot{
      position:absolute;
      left:8px;
      top:8px;
      width:12px;
      height:12px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.25);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
    }
    .type-dot.active{ background: var(--active); }
    .type-dot.passive{ background: var(--passive); }

    /* Meta dot added on cards (so no need meta in legend) */
    .meta-dot{
      position:absolute;
      right:8px;
      top:8px;
      width:10px;
      height:10px;
      border-radius:50%;
      background: var(--metaDot);
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
      display:none;
    }
    .char-card.is-meta .meta-dot{ display:block; }

    .name{
      font-size:.84rem;
      font-weight:900;
      color: rgba(244,246,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }
    .subline{
      text-align:center;
      font-size:.74rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Role overview */
    .role-wrap{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .role-wrap{ grid-template-columns: 1fr; }
      .userchip{display:none;}
    }

    .role-card{
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
    }
    .role-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .role-title b{
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
      color: var(--brand);
      font-size: .98rem;
    }
    .role-title span{
      color: var(--muted);
      font-size:.82rem;
      white-space:nowrap;
    }
    .role-mini{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .mini{
      width:62px;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .mini .miniimg{
      width:62px;
      height:86px;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .mini .miniimg img{
      width:100%; height:100%;
      object-fit: cover;
      object-position: center top;
      display:block;
    }
    .miniDot{
      position:absolute;
      left:6px;
      top:6px;
      width:10px;
      height:10px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
    }
    .miniDot.active{ background: var(--active); }
    .miniDot.passive{ background: var(--passive); }

    .miniMeta{
      position:absolute;
      right:6px;
      top:6px;
      width:8px;
      height:8px;
      border-radius:50%;
      background: var(--metaDot);
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 0 0 3px rgba(0,0,0,.18);
      display:none;
    }
    .mini.is-meta .miniMeta{ display:block; }

    .mini small{
      width:100%;
      text-align:center;
      color: rgba(244,246,255,.80);
      font-size:.7rem;
      line-height:1.05rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Tooltip */
    .tip{
      position: fixed;
      z-index: 9999;
      width: min(340px, calc(100vw - 24px));
      background: rgba(14, 18, 28, .94);
      border: 1px solid rgba(255,189,89,.28);
      border-radius: 16px;
      box-shadow: 0 26px 80px rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 10px 12px 10px;
      display:none;
    }
    .tip.show{ display:block; }

    .tip-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tip-title{ min-width:0; display:flex; gap:10px; align-items:flex-start; }
    .tip-title b{
      display:block;
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
      color: var(--brand);
      font-size: 1.02rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 230px;
    }
    .tip-title span{
      display:block;
      color: var(--muted);
      font-size:.82rem;
      margin-top:2px;
    }
    .tip-close{
      width:34px;height:34px;border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .tip-close:hover{ background: rgba(255,255,255,.09); }

    .tip-body{
      color: rgba(244,246,255,.88);
      font-size: .9rem;
      line-height: 1.28rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .muted{ color: var(--muted); }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-left">
          <div class="logo">FF</div>
          <div class="brand-text">
            <h1>Free Fire</h1>
            <small class="muted">Caster Dashboard</small>
          </div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a class="nav-item" href="dashboard.html" data-page="dashboard.html" title="Dashboard">
          <span class="nav-ico">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 13h7V4H4v9Zm9 7h7V4h-7v16ZM4 20h7v-5H4v5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span class="nav-label">Dashboard</span>
        </a>

        <a class="nav-item active" href="char.html" data-page="char.html" title="Character Skills">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Character Skills</span>
        </a>

        <a class="nav-item" href="pet.html" data-page="pet.html" title="Pets">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 14c-1.7 0-3-1.3-3-3S5.3 8 7 8s3 1.3 3 3-1.3 3-3 3Zm10 0c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3ZM7 20c-2.8 0-5-1.8-5-4v-1h6v1c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-1h6v1c0 2.2-2.2 4-5 4H7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Pets</span>
        </a>

        <a class="nav-item" href="weapon.html" data-page="weapon.html" title="Weapons">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M3 21l6-6m0 0 2 2 8-8-2-2-8 8Zm0 0-2-2 4-4 2 2-4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Weapons</span>
        </a>

        <a class="nav-item" href="br_team2.html" data-page="br_team2.html" title="BR Data">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M6 20V10m6 10V4m6 16v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">BR Data</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <button class="icon-btn" id="sbToggle" aria-label="Collapse sidebar" title="Collapse sidebar">
          <svg viewBox="0 0 24 24" fill="none">
            <path id="sbTogglePath" d="M14 7l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="search">
          <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
            <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="pageSearch" placeholder="Search characters (name, skill, role)..." />
        </div>

        <div class="userchip">
          <div class="avatar"></div>
          <div class="usertext">
            <b id="gamertag">PlayerOne</b>
            <span id="userEmail" class="muted">loading‚Ä¶</span>
          </div>
        </div>

        <a class="logout" href="#" id="logoutBtn">Logout</a>
      </header>

      <section class="content">
        <div class="panel-card">
          <div class="hero">
            <div class="hero-content">
              <div class="hero-title">
                <h2>Character Skills</h2>
                <div class="hero-sub">Meta toggle + full roster ‚Ä¢ Click any card for details</div>
              </div>
              <div class="hero-actions">
                <a class="btn" href="character-comparison.html" title="Compare characters">Compare</a>
                <a class="btn brand" href="dashboard.html" title="Back to Dashboard">Dashboard</a>
              </div>
            </div>
          </div>

          <div class="card-inner">
            <div class="controls-row">
              <!-- Skill-type legend (keep titles); META legend removed -->
              <div class="legend">
                <span class="chip" title="Skill type colors">
                  <span class="dot" style="background:var(--active)"></span> Active
                  <span class="dot" style="background:var(--passive); margin-left:10px;"></span> Passive
                </span>
              </div>

              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <span class="muted" style="font-weight:800;">Show Meta For:</span>
                <button class="btn brand" id="toggleModeBtn" type="button" title="Toggle meta mode">Battle Royale</button>
                <span class="chip" id="countChip" title="Visible count">‚Äî</span>
              </div>
            </div>

            <!-- META -->
            <div style="margin-top:14px;">
              <div class="section-head">
                <h3 id="metaTitle">Meta Characters (Battle Royale)</h3>
                <small class="muted" id="metaSub">‚Äî</small>
              </div>
              <div class="grid" id="metaGrid"><div class="muted">Loading meta characters‚Ä¶</div></div>
            </div>

            <!-- NON META -->
            <div style="margin-top:18px;">
              <div class="section-head">
                <h3>Non-Meta Characters</h3>
                <small class="muted" id="nonMetaSub">‚Äî</small>
              </div>
              <div class="grid" id="nonMetaGrid"><div class="muted">Loading non-meta characters‚Ä¶</div></div>
            </div>

            <!-- ROLE OVERVIEW -->
            <div style="margin-top:18px;">
              <div class="section-head">
                <h3>Overview by Role</h3>
                <small class="muted">All characters, grouped. Click a mini card for details.</small>
              </div>
              <div class="role-wrap" id="byRole"><div class="muted">Building role overview‚Ä¶</div></div>
            </div>

            <div class="muted" style="font-size:.8rem; padding: 14px 2px 0 2px;">
              Free Fire Caster ¬© 2025 ‚Äî Neptune
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Global Tooltip -->
  <div class="tip" id="tip" role="dialog" aria-hidden="true">
    <div class="tip-top">
      <div class="tip-title">
        <div>
          <b id="tipName">‚Äî</b>
          <span id="tipMeta">‚Äî</span>
        </div>
      </div>
      <button class="tip-close" id="tipClose" aria-label="Close" title="Close">
        <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;">
          <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="tip-body" id="tipBody">‚Äî</div>
  </div>

  <script>
    /***********************
     * Supabase Auth
     ***********************/
    const client = supabase.createClient(
      'https://gkugecflfddkpitlrmws.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
    );

    async function ensureSession(){
      const { data: { session } } = await client.auth.getSession();
      if (!session) {
        window.location.href = "index.html";
        return null;
      }
      return session;
    }

    async function logout(){
      await client.auth.signOut();
      window.location.href = "index.html";
    }

    /***********************
     * Sidebar collapse + active nav
     ***********************/
    const sidebar = document.getElementById('sidebar');

    (function initSidebarCollapse(){
      const key = 'ff_sidebar_collapsed_v1';
      const saved = localStorage.getItem(key);
      if (saved === '1') sidebar.classList.add('collapsed');

      const btn = document.getElementById('sbToggle');
      const path = document.getElementById('sbTogglePath');

      function syncIcon(){
        path.setAttribute('d', sidebar.classList.contains('collapsed')
          ? 'M10 7l5 5-5 5'
          : 'M14 7l-5 5 5 5'
        );
      }
      syncIcon();

      btn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem(key, sidebar.classList.contains('collapsed') ? '1' : '0');
        syncIcon();
      });
    })();

    (function setActiveNav(){
      const here = (location.pathname.split('/').pop() || 'char.html').toLowerCase();
      document.querySelectorAll('.nav-item').forEach(a => {
        const page = (a.getAttribute('data-page') || '').toLowerCase();
        a.classList.toggle('active', page === here);
      });
    })();

    /***********************
     * Data + helpers
     ***********************/
    const CHAR_URL = 'https://neptuneg1.github.io/freefire-caster/character.json';

    let ALL = [];
    let currentMetaMode = 'meta'; // 'meta' or 'cs_meta'
    let query = '';

    const metaGrid = document.getElementById('metaGrid');
    const nonMetaGrid = document.getElementById('nonMetaGrid');
    const byRole = document.getElementById('byRole');

    const metaTitle = document.getElementById('metaTitle');
    const metaSub = document.getElementById('metaSub');
    const nonMetaSub = document.getElementById('nonMetaSub');
    const countChip = document.getElementById('countChip');

    const roleIcons = {
      Attack: "‚öîÔ∏è",
      Support: "üõ°Ô∏è",
      Info: "üì°",
      Heal: "üíä",
      Defense: "üß±",
      Scout: "üëÅÔ∏è",
      Other: "‚ùì"
    };

    function safeText(v){ return (v ?? '').toString(); }
    function norm(v){ return safeText(v).trim(); }
    function normLower(v){ return norm(v).toLowerCase(); }
    function isPassive(c){ return normLower(c?.skill_type) === 'passive'; }

    function isMeta(c){
      return normLower(c?.[currentMetaMode] || 'no') === 'yes';
    }

    function matchesQuery(c){
      if (!query) return true;
      const blob = [
        c?.name, c?.skill_type, c?.skill, c?.description, c?.role,
      ].map(safeText).join(' ').toLowerCase();
      return blob.includes(query);
    }

    function escapeHtml(str){
      return safeText(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // IMPORTANT: remove Active/Passive TEXT from card (only dots) ‚Äî done here.
    function cardHTML(c){
      const name = safeText(c?.name || '‚Äî');
      const img = safeText(c?.image_url || '');
      const role = safeText(c?.role || 'Other') || 'Other';
      const skType = isPassive(c) ? 'Passive' : 'Active';

      return `
        <div class="char-card ${isMeta(c) ? 'is-meta' : ''}"
             data-name="${escapeHtml(name)}"
             data-role="${escapeHtml(role)}"
             data-skilltype="${escapeHtml(skType)}"
             data-skill="${escapeHtml(safeText(c?.skill || ''))}"
             data-desc="${escapeHtml(safeText(c?.description || ''))}"
             data-img="${escapeHtml(img)}"
             data-meta="${isMeta(c) ? 'yes' : 'no'}"
             tabindex="0"
             title="${escapeHtml(name)}">
          <div class="thumb">
            <span class="type-dot ${isPassive(c) ? 'passive' : 'active'}" title="${escapeHtml(skType)}"></span>
            <span class="meta-dot" title="Meta"></span>
            <img src="${img}" alt="${escapeHtml(name)}" referrerpolicy="no-referrer" crossorigin="anonymous">
          </div>
          <div class="name">${escapeHtml(name)}</div>
          <div class="subline">${escapeHtml(role)}</div>
        </div>
      `;
    }

    function miniHTML(c){
      const name = safeText(c?.name || '‚Äî');
      const img = safeText(c?.image_url || '');
      const role = safeText(c?.role || 'Other') || 'Other';
      const skType = isPassive(c) ? 'Passive' : 'Active';

      return `
        <div class="mini ${isMeta(c) ? 'is-meta' : ''}"
             data-name="${escapeHtml(name)}"
             data-role="${escapeHtml(role)}"
             data-skilltype="${escapeHtml(skType)}"
             data-skill="${escapeHtml(safeText(c?.skill || ''))}"
             data-desc="${escapeHtml(safeText(c?.description || ''))}"
             data-img="${escapeHtml(img)}"
             data-meta="${isMeta(c) ? 'yes' : 'no'}"
             tabindex="0"
             title="${escapeHtml(name)}">
          <div class="miniimg">
            <span class="miniDot ${isPassive(c) ? 'passive' : 'active'}" title="${escapeHtml(skType)}"></span>
            <span class="miniMeta" title="Meta"></span>
            <img src="${img}" alt="${escapeHtml(name)}" referrerpolicy="no-referrer" crossorigin="anonymous">
          </div>
          <small title="${escapeHtml(name)}">${escapeHtml(name)}</small>
        </div>
      `;
    }

    async function loadCharacters(){
      const res = await fetch(CHAR_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load character.json');
      const data = await res.json();
      ALL = Array.isArray(data) ? data : [];
    }

    function render(){
      const list = ALL.filter(matchesQuery);

      const meta = [];
      const non = [];
      for (const c of list){
        (isMeta(c) ? meta : non).push(c);
      }

      metaGrid.innerHTML = meta.length ? meta.map(cardHTML).join('') : `<div class="muted">No meta characters found.</div>`;
      nonMetaGrid.innerHTML = non.length ? non.map(cardHTML).join('') : `<div class="muted">No non-meta characters found.</div>`;

      metaSub.textContent = `${meta.length.toLocaleString()} character${meta.length===1?'':'s'} ‚Ä¢ Based on: ${currentMetaMode === 'meta' ? 'BR Meta' : 'CS Meta'}`;
      nonMetaSub.textContent = `${non.length.toLocaleString()} character${non.length===1?'':'s'} ‚Ä¢ Always shown`;
      countChip.textContent = `${list.length.toLocaleString()} shown / ${ALL.length.toLocaleString()} total`;

      const roleGroups = {};
      for (const c of list){
        const role = safeText(c?.role || 'Other') || 'Other';
        (roleGroups[role] ||= []).push(c);
      }

      const roleOrder = Object.keys(roleGroups).sort((a,b) => a.localeCompare(b));
      byRole.innerHTML = roleOrder.length
        ? roleOrder.map(role => {
            const icon = roleIcons[role] || "üî∏";
            const chars = roleGroups[role] || [];
            return `
              <div class="role-card">
                <div class="role-title">
                  <b>${icon} ${escapeHtml(role)}</b>
                  <span>${chars.length.toLocaleString()} char${chars.length===1?'':'s'}</span>
                </div>
                <div class="role-mini">
                  ${chars.map(miniHTML).join('')}
                </div>
              </div>
            `;
          }).join('')
        : `<div class="muted">No roles to show.</div>`;
    }

    /***********************
     * Meta toggle
     ***********************/
    const toggleModeBtn = document.getElementById('toggleModeBtn');
    toggleModeBtn.addEventListener('click', () => {
      currentMetaMode = (currentMetaMode === 'meta') ? 'cs_meta' : 'meta';
      toggleModeBtn.textContent = (currentMetaMode === 'meta') ? 'Battle Royale' : 'Clash Squad';
      metaTitle.textContent = (currentMetaMode === 'meta')
        ? 'Meta Characters (Battle Royale)'
        : 'Meta Characters (Clash Squad)';
      closeTip();
      render();
    });

    /***********************
     * Search
     ***********************/
    document.getElementById('pageSearch').addEventListener('input', (e) => {
      query = (e.target.value || '').toLowerCase().trim();
      closeTip();
      render();
    });

    /***********************
     * Tooltip logic (KEEP "Active/Passive" titles here)
     ***********************/
    const tip = document.getElementById('tip');
    const tipName = document.getElementById('tipName');
    const tipMeta = document.getElementById('tipMeta');
    const tipBody = document.getElementById('tipBody');
    const tipClose = document.getElementById('tipClose');

    let tipOpen = false;

    function openTipFromEl(el){
      if (!el) return;

      const name = el.getAttribute('data-name') || '‚Äî';
      const role = el.getAttribute('data-role') || 'Other';
      const skillType = (el.getAttribute('data-skilltype') || '').toLowerCase();
      const skill = el.getAttribute('data-skill') || '';
      const desc = el.getAttribute('data-desc') || '';
      const meta = (el.getAttribute('data-meta') || 'no') === 'yes';

      const readableSkillType = (skillType === 'passive') ? 'Passive' : 'Active';
      const dotColor = (skillType === 'passive') ? 'var(--passive)' : 'var(--active)';

      tipName.textContent = name;
      tipMeta.textContent = `${role} ‚Ä¢ ${meta ? 'Meta' : 'Non-Meta'} ‚Ä¢ ${currentMetaMode === 'meta' ? 'BR' : 'CS'} ‚Ä¢ ${readableSkillType}`;

      tipBody.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <span class="dot" style="background:${dotColor}; box-shadow:none;"></span>
          <span class="muted" style="font-size:.82rem;">${readableSkillType} Skill</span>
          ${meta ? `<span class="dot" style="background:var(--metaDot); box-shadow:none; margin-left:10px;"></span><span class="muted" style="font-size:.82rem;">Meta</span>` : ``}
        </div>
        <div>${skill ? `<b>Skill:</b> ${skill}` : `<span class="muted">No skill text</span>`}</div>
        <div style="margin-top:8px;">${desc ? desc : `<span class="muted">No description</span>`}</div>
      `;

      const rect = el.getBoundingClientRect();
      const margin = 10;

      tip.classList.add('show');
      tip.setAttribute('aria-hidden','false');

      requestAnimationFrame(() => {
        const tr = tip.getBoundingClientRect();
        let left = rect.left + rect.width/2 - tr.width/2;
        let top = rect.bottom + 10;

        if (top + tr.height > window.innerHeight - margin){
          top = rect.top - tr.height - 10;
        }

        left = Math.max(margin, Math.min(left, window.innerWidth - tr.width - margin));
        top  = Math.max(margin, Math.min(top,  window.innerHeight - tr.height - margin));

        tip.style.left = left + 'px';
        tip.style.top  = top + 'px';
        tipOpen = true;
      });
    }

    function closeTip(){
      tip.classList.remove('show');
      tip.setAttribute('aria-hidden','true');
      tipOpen = false;
    }

    tipClose.addEventListener('click', (e) => { e.stopPropagation(); closeTip(); });
    tip.addEventListener('click', (e) => e.stopPropagation());

    function onAnyClick(e){
      const card = e.target.closest('.char-card, .mini');
      if (!card){
        if (tipOpen) closeTip();
        return;
      }
      e.stopPropagation();
      openTipFromEl(card);
    }

    metaGrid.addEventListener('click', onAnyClick);
    nonMetaGrid.addEventListener('click', onAnyClick);
    byRole.addEventListener('click', onAnyClick);

    function onAnyKey(e){
      const card = e.target.closest?.('.char-card, .mini');
      if (!card) return;
      if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        openTipFromEl(card);
      }
    }
    metaGrid.addEventListener('keydown', onAnyKey);
    nonMetaGrid.addEventListener('keydown', onAnyKey);
    byRole.addEventListener('keydown', onAnyKey);

    document.addEventListener('click', () => { if (tipOpen) closeTip(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && tipOpen) closeTip(); });
    window.addEventListener('resize', () => { if (tipOpen) closeTip(); });

    /***********************
     * Init
     ***********************/
    window.addEventListener('DOMContentLoaded', async () => {
      const session = await ensureSession();
      if (!session) return;

      const email = session.user?.email || '';
      document.getElementById('userEmail').textContent = email || 'signed in';
      const username = email ? email.split('@')[0] : 'PlayerOne';
      document.getElementById('gamertag').textContent = username;

      document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });

      try{
        await loadCharacters();
        render();
      }catch(err){
        console.error(err);
        metaGrid.innerHTML = `<div class="muted">Failed to load character.json</div>`;
        nonMetaGrid.innerHTML = `<div class="muted">Failed to load character.json</div>`;
        byRole.innerHTML = `<div class="muted">Failed to load character.json</div>`;
      }
    });
  </script>
</body>
</html>
