<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- ✅ mobile-safe area + notch support -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Clash Squad Draft — Free Fire</title>

  <!-- Fonts (same theme) -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- ✅ Supabase JS v2 pinned -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.90.1"></script>

  <style>
    :root{
      --bg:#07090f;
      --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.08);
      --ink:#f4f6ff;
      --muted:#aab1c5;

      --brand:#ffbd59;
      --brand2:#ff7733;
      --accent:#4dd3ff;

      --radius:16px;
      --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);

      --sb-w: 260px;
      --sb-w-collapsed: 82px;

      --danger:#ff6b6b;
      --good:#71d083;

      --skill-active:#4dd3ff;
      --skill-passive:#ff59c7;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 18% 12%, rgba(77,211,255,.15), transparent 60%),
        radial-gradient(700px 420px at 85% 18%, rgba(255,189,89,.12), transparent 60%),
        radial-gradient(900px 620px at 50% 110%, rgba(255,119,51,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    body::before, body::after{
      content:"";
      position:fixed;
      inset:auto auto 0 0;
      width:520px; height:520px;
      border-radius:50%;
      border:10px solid rgba(77,211,255,.14);
      transform: translate(-45%, -35%);
      filter: blur(.2px);
      pointer-events:none;
    }
    body::after{
      inset: -120px 0 auto auto;
      width:420px; height:420px;
      border:10px solid rgba(77,211,255,.10);
      transform: translate(38%, 0%);
    }

    a{color:inherit}
    .muted{color:var(--muted)}

    /* dropdowns / inputs theme */
    select, input, textarea{
      color-scheme: dark;
      background: rgba(0,0,0,.22);
      color: var(--ink);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      outline:none;
      padding: 10px 12px;
      font-size: .92rem;
    }
    select:focus, input:focus, textarea:focus{
      box-shadow: 0 0 0 3px rgba(77,211,255,.12);
      border-color: rgba(77,211,255,.22) !important;
    }
    select option{
      background:#0b1020;
      color:var(--ink);
    }

    .app{
      height:100%;
      display:flex;
      gap:18px;
      padding:18px;
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Sidebar */
    .sidebar{
      width: var(--sb-w);
      background: var(--panel2);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      transition: width .18s ease;
    }
    .sidebar.collapsed{ width: var(--sb-w-collapsed); }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:16px 16px 10px 16px;
      border-bottom: 1px solid var(--line);
    }
    .brand-left{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,189,89,.25), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-family: Orbitron, sans-serif;
      letter-spacing:.5px;
      color:var(--brand);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-family: Orbitron, sans-serif;
      font-size: 1.05rem;
      letter-spacing:.6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }
    .brand small{
      display:block;
      color: var(--muted);
      font-size:.78rem;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 150px;
    }

    .nav{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
    }
    .nav::-webkit-scrollbar{width:10px}
    .nav::-webkit-scrollbar-thumb{background: rgba(255,255,255,.08); border-radius:10px}
    .nav::-webkit-scrollbar-track{background: transparent}

    .nav-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      text-decoration:none;
      transition: .2s ease;
      cursor:pointer;
      min-width:0;
    }
    .nav-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      color: var(--ink);
    }
    .nav-item.active{
      background: linear-gradient(135deg, rgba(255,189,89,.14), rgba(77,211,255,.09));
      border-color: rgba(255,189,89,.22);
      color: var(--ink);
    }
    .nav-ico{
      width:26px;height:26px;border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:grid;place-items:center;
      flex: 0 0 auto;
    }
    .nav-ico svg{width:14px;height:14px;opacity:.9}
    .nav-label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    .sidebar.collapsed .brand h1,
    .sidebar.collapsed .brand small,
    .sidebar.collapsed .nav-label{display:none;}
    .sidebar.collapsed .brand{justify-content:center;}
    .sidebar.collapsed .brand-left{justify-content:center;}
    .sidebar.collapsed .nav-item{
      justify-content:center;
      gap:0;
      padding:10px 8px;
    }

    /* Main */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
      gap: 14px;
    }

    /* Topbar */
    .topbar{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .icon-btn{
      width:42px;height:42px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.2s ease;
      color: var(--ink);
      flex:0 0 auto;
    }
    .icon-btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .icon-btn svg{width:18px;height:18px;opacity:.92}

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      min-width: 0;
    }
    .search input{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--ink);
      font-size: .95rem;
      padding:0;
    }
    .search input::placeholder{color: rgba(170,177,197,.75)}

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .userchip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      max-width: 260px;
    }
    .avatar{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(135deg, rgba(255,189,89,.30), rgba(77,211,255,.18));
      border:1px solid rgba(255,255,255,.10);
    }
    .usertext{min-width:0}
    .usertext b{
      display:block;
      font-size:.92rem;
      font-family: Orbitron, sans-serif;
      color: var(--brand);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 170px;
    }
    .usertext span{display:block; font-size:.78rem; color: var(--muted)}

    .logout, .btn{
      color: rgba(255,255,255,.82);
      text-decoration:none;
      font-size:.85rem;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      transition:.2s ease;
      cursor:pointer;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .logout:hover{
      border-color: rgba(255,77,77,.35);
      color: #ff8d8d;
      box-shadow: 0 0 0 3px rgba(255,77,77,.10);
    }
    .btn:hover{
      border-color: rgba(77,211,255,.22);
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
      transform: translateY(-1px);
    }
    .btn.primary{
      border-color: rgba(255,189,89,.28);
      background: linear-gradient(135deg, rgba(255,189,89,.14), rgba(77,211,255,.08));
      color: rgba(244,246,255,.95);
      font-weight:900;
    }
    .btn.danger{
      border-color: rgba(255,107,107,.28);
      background: rgba(255,107,107,.10);
    }

    .lang-btn{
      color: rgba(244,246,255,.86);
      text-decoration:none;
      font-size:.85rem;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid rgba(77,211,255,.18);
      background: rgba(77,211,255,.06);
      transition:.2s ease;
      cursor:pointer;
      white-space:nowrap;
      font-weight:900;
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
    }
    .lang-btn:hover{
      border-color: rgba(77,211,255,.40);
      box-shadow: 0 0 0 3px rgba(77,211,255,.12);
      transform: translateY(-1px);
    }

    /* Content */
    .content{
      min-height: 0;
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .card-head h2{
      margin:0;
      font-family: Orbitron, sans-serif;
      letter-spacing:.6px;
      color: var(--brand);
      font-size: 1.08rem;
    }
    .card-head p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size:.85rem;
    }
    .card-inner{padding:14px}

    /* Layout blocks */
    .grid-2{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    .grid-2b{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 1100px){
      .grid-2{ grid-template-columns: 1fr; }
      .grid-2b{ grid-template-columns: 1fr; }
    }

    /* Draft controls */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row .grow{flex:1; min-width: 220px;}
    .row .tight{min-width: 150px;}
    .hint{
      font-size:.82rem;
      color: var(--muted);
    }
    .status{
      font-size:.82rem;
      color: rgba(244,246,255,.85);
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .status.ok{ border-color: rgba(113,208,131,.22); box-shadow: 0 0 0 3px rgba(113,208,131,.08); }
    .status.bad{ border-color: rgba(255,107,107,.22); box-shadow: 0 0 0 3px rgba(255,107,107,.08); }

    /* Board */
    .board{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1100px){ .board{grid-template-columns:1fr;} }

    .team-panel{
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-width:0;
    }
    .team-top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .team-top .name{
      font-family: Orbitron, sans-serif;
      letter-spacing:.4px;
      color: rgba(244,246,255,.95);
      font-size: 1.02rem;
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 240px;
      flex: 1;
    }
    .team-top .name input{
      padding: 10px 12px;
      border-radius: 14px;
      width:100%;
      min-width: 220px;
    }
    .scorebox{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .scorebox input{
      width:84px;
      text-align:center;
      font-weight:900;
      font-size: 1rem;
      font-family: Orbitron, sans-serif;
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(244,246,255,.92);
      font-weight:900;
      font-size:.92rem;
      letter-spacing:.2px;
    }
    .badge{
      font-size:.72rem;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(244,246,255,.78);
      flex:0 0 auto;
    }

    .ban-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pick-row{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 10px;
      align-items:stretch;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.08);
    }
    @media (max-width: 620px){
      .pick-row{ grid-template-columns: 1fr; }
    }

    .player-col{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .player-col input{
      width:100%;
      font-weight:800;
    }

    .slot-wrap{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 10px;
      min-width:0;
    }
    @media (max-width: 620px){
      .slot-wrap{ grid-template-columns: 1fr; }
    }

    .slot{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      transition: .18s ease;
      min-width:0;
      position:relative;
      overflow:hidden;
    }
    .slot:hover{
      background: rgba(255,255,255,.07);
      transform: translateY(-1px);
      border-color: rgba(255,189,89,.18);
    }
    .slot.small{
      padding: 8px 10px;
      border-radius: 14px;
    }
    .slot .thumb{
      width:42px;height:42px;border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .slot.small .thumb{ width:34px; height:34px; border-radius: 12px; }
    .slot .thumb img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: rgba(255,255,255,.02);
    }
    .slot .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
    }
    .slot .meta b{
      font-size:.92rem;
      color: rgba(244,246,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.1rem;
    }
    .slot .meta span{
      font-size:.8rem;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.05rem;
    }

    .slot .pill{
      position:absolute;
      top:10px; right:10px;
      font-size:.68rem;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(244,246,255,.78);
    }
    .slot .pill.active{ border-color: rgba(77,211,255,.22); }
    .slot .pill.passive{ border-color: rgba(255,89,199,.22); }

    .passive-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top:8px;
    }

    /* Summary */
    .summary{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 1100px){ .summary{grid-template-columns:1fr;} }

    .sum-panel{
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      min-width:0;
    }
    .sum-panel h3{
      margin:0 0 10px 0;
      font-family: Orbitron, sans-serif;
      letter-spacing:.5px;
      color: var(--brand);
      font-size: 1.02rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sum-list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .sum-line{
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .sum-line .pname{
      width: 140px;
      font-weight:900;
      color: rgba(244,246,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:0 0 auto;
    }
    .sum-line .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .chip{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:.82rem;
      color: rgba(244,246,255,.88);
      min-width:0;
    }
    .chip img{
      width:18px;height:18px;object-fit:contain;display:block;
    }
    .chip .t{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }

    /* History */
    details.collapse{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
    }
    details.collapse > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 14px;
      font-weight:900;
      color: rgba(244,246,255,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    details.collapse > summary::-webkit-details-marker{display:none;}
    .history-inner{ padding: 14px; display:flex; flex-direction:column; gap: 12px; }
    .hist-table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }
    .hist-table th, .hist-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size: .86rem;
      color: rgba(244,246,255,.88);
      vertical-align:top;
    }
    .hist-table th{
      font-family: Orbitron, sans-serif;
      font-size:.8rem;
      color: rgba(244,246,255,.78);
      letter-spacing:.3px;
      background: rgba(255,255,255,.03);
    }
    .hist-table tr:hover td{ background: rgba(255,255,255,.03); }
    .hist-actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding: 7px 9px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      color: rgba(244,246,255,.88);
      font-weight:800;
      font-size:.8rem;
    }
    .mini:hover{ box-shadow: 0 0 0 3px rgba(77,211,255,.10); border-color: rgba(77,211,255,.22); }

    /* Modal Picker */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal.show{display:flex;}
    .modal-card{
      width: min(1040px, 100%);
      max-height: min(86vh, 860px);
      background: rgba(14, 18, 28, .92);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: 0 26px 80px rgba(0,0,0,.65);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modal-top h3{
      margin:0;
      font-family: Orbitron, sans-serif;
      letter-spacing:.6px;
      color: var(--brand);
      font-size: 1.05rem;
    }
    .modal-top p{
      margin:6px 0 0 0;
      color: var(--muted);
      font-size:.85rem;
    }
    .modal-controls{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-controls input{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      outline:none;
      color: var(--ink);
      font-size:.95rem;
      min-width: 220px;
    }
    .modal-count{
      flex:0 0 auto;
      font-size:.78rem;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(244,246,255,.80);
      white-space:nowrap;
    }
    .filter-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .pill-btn{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(244,246,255,.86);
      cursor:pointer;
      font-weight:800;
      font-size:.82rem;
      transition:.18s ease;
      white-space:nowrap;
    }
    .pill-btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(77,211,255,.22);
      box-shadow: 0 0 0 3px rgba(77,211,255,.10);
    }
    .pill-btn.active{
      background: linear-gradient(135deg, rgba(255,189,89,.18), rgba(255,119,51,.10));
      border-color: rgba(255,189,89,.25);
      color: rgba(244,246,255,.95);
    }
    .modal-grid{
      padding: 14px;
      overflow:auto;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
      gap: 12px;
    }
    .modal-grid::-webkit-scrollbar{width:10px}
    .modal-grid::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius:10px}
    .modal-grid::-webkit-scrollbar-track{background: transparent}
    .pick-card{
      padding: 10px 10px 8px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.09);
      cursor:pointer;
      transition:.18s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .pick-card:hover{
      background: rgba(255,255,255,.08);
      transform: translateY(-1px);
      border-color: rgba(255,189,89,.18);
    }
    .pick-thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .pick-thumb img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: rgba(255,255,255,.02);
    }
    .pick-name{
      font-size:.82rem;
      font-weight:800;
      color: rgba(244,246,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-left">
          <div class="logo">FF</div>
          <div class="brand-text">
            <h1>Free Fire</h1>
            <small class="muted">Caster Dashboard</small>
          </div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a class="nav-item" href="dashboard.html" data-page="dashboard.html" title="Dashboard">
          <span class="nav-ico">
            <svg viewBox="0 0 24 24" fill="none"><path d="M4 13h7V4H4v9Zm9 7h7V4h-7v16ZM4 20h7v-5H4v5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          <span class="nav-label">Dashboard</span>
        </a>

        <a class="nav-item" href="character.html" data-page="character.html" title="Character Skills">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Character Skills</span>
        </a>

        <a class="nav-item" href="pet.html" data-page="pet.html" title="Pets">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M7 14c-1.7 0-3-1.3-3-3S5.3 8 7 8s3 1.3 3 3-1.3 3-3 3Zm10 0c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3ZM7 20c-2.8 0-5-1.8-5-4v-1h6v1c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-1h6v1c0 2.2-2.2 4-5 4H7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Pets</span>
        </a>

        <a class="nav-item active" href="clash-draft.html" data-page="clash-draft.html" title="Clash Squad Draft">
          <span class="nav-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h10M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span class="nav-label">Clash Squad Draft</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <button class="icon-btn" id="sbToggle" aria-label="Collapse sidebar" title="Collapse sidebar">
          <svg viewBox="0 0 24 24" fill="none">
            <path id="sbTogglePath" d="M14 7l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="search">
          <svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;opacity:.85">
            <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="searchInput" placeholder="Search pages..." />
        </div>

        <div class="top-actions">
          <div class="userchip">
            <div class="avatar"></div>
            <div class="usertext">
              <b id="gamertag">PlayerOne</b>
              <span id="userEmail" class="muted">loading…</span>
            </div>
          </div>

          <button class="lang-btn" id="langBtn" type="button" title="Toggle language">EN</button>
          <a class="logout" href="#" id="logoutBtn">Logout</a>
        </div>
      </header>

      <section class="content">
        <!-- HISTORY + MATCH INFO -->
        <div class="grid-2">
          <div class="card">
            <div class="card-head">
              <div>
                <h2>Draft History</h2>
                <p>Load past drafts. Tournament filter defaults to the most recent record.</p>
              </div>
              <div class="row">
                <button class="btn" id="refreshHistoryBtn" type="button">Refresh</button>
              </div>
            </div>
            <div class="card-inner">
              <details class="collapse" open>
                <summary>
                  Filters & Records
                  <span class="badge" id="histBadge">—</span>
                </summary>

                <div class="history-inner">
                  <div class="row">
                    <select id="tournamentFilter" class="tight" title="Tournament">
                      <option value="__ALL__">All tournaments</option>
                    </select>
                    <select id="teamFilter" class="tight" title="Team">
                      <option value="__ALL__">All teams</option>
                    </select>
                    <input id="historySearch" class="grow" placeholder="Search (team, map, tournament)..." />
                  </div>

                  <table class="hist-table">
                    <thead>
                      <tr>
                        <th style="width:110px">Date</th>
                        <th style="width:60px">Game</th>
                        <th style="width:190px">Tournament</th>
                        <th>Match</th>
                        <th style="width:140px">Map</th>
                        <th style="width:90px">Score</th>
                        <th style="width:140px">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="historyBody">
                      <tr><td colspan="7" class="muted">Loading…</td></tr>
                    </tbody>
                  </table>

                  <div class="hint">
                    Tip: Save creates/updates the current record. New Draft resets and clears record id.
                  </div>
                </div>
              </details>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <div>
                <h2>Match Info</h2>
                <p>These fields are saved with the draft record.</p>
              </div>
              <div class="row">
                <button class="btn primary" id="saveBtn" type="button">Save</button>
                <button class="btn" id="newBtn" type="button">New Draft</button>
                <button class="btn danger" id="resetBtn" type="button">Reset</button>
                <button class="btn" id="copyBtn" type="button">Copy Summary</button>
              </div>
            </div>
            <div class="card-inner">
              <div class="row">
                <input id="matchDate" class="tight" type="date" />
                <input id="gameNumber" class="tight" type="number" min="1" step="1" placeholder="Game #" />
                <input id="mapName" class="grow" placeholder="Map (e.g., Bermuda)" />
              </div>
              <div class="row">
                <input id="tournamentName" class="grow" placeholder="Tournament (e.g., FFWS Global Finals 2025)" />
                <input id="stageName" class="grow" placeholder="Stage (optional)" />
              </div>
              <div class="row">
                <div class="status" id="statusBox">Ready.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- DRAFT BOARD -->
        <div class="card">
          <div class="card-head">
            <div>
              <h2>Draft Board</h2>
              <p>Pick Characters + Pets + 3 Passives per player. Bans are characters.</p>
            </div>
            <div class="row">
              <span class="badge" id="dataBadge">Loading data…</span>
            </div>
          </div>

          <div class="card-inner">
            <div class="board" id="board"></div>
          </div>
        </div>

        <!-- SUMMARY -->
        <div class="card">
          <div class="card-head">
            <div>
              <h2>Summary</h2>
              <p>Quick view for broadcast notes (includes pets).</p>
            </div>
            <div class="row">
              <span class="badge" id="recordBadge">Record: —</span>
            </div>
          </div>
          <div class="card-inner">
            <div class="summary">
              <div class="sum-panel">
                <h3><span id="sumTeamLeft">TEAM LEFT</span> <span class="badge" id="sumScoreLeft">0</span></h3>
                <div class="hint" id="sumBansLeft">Bans: —</div>
                <div class="sum-list" id="sumListLeft"></div>
              </div>
              <div class="sum-panel">
                <h3><span id="sumTeamRight">TEAM RIGHT</span> <span class="badge" id="sumScoreRight">0</span></h3>
                <div class="hint" id="sumBansRight">Bans: —</div>
                <div class="sum-list" id="sumListRight"></div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- PICKER MODAL -->
  <div class="modal" id="pickerModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Picker">
      <div class="modal-top">
        <div>
          <h3 id="pickerTitle">Select</h3>
          <p id="pickerSub">Click an item to apply.</p>
        </div>
        <button class="icon-btn" id="pickerClose" aria-label="Close picker" title="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>

      <div class="modal-controls">
        <div class="modal-row">
          <input id="pickerSearch" placeholder="Search..." />
          <div class="modal-count" id="pickerCount">—</div>
        </div>
        <div class="filter-pills" id="pickerPills"></div>
      </div>

      <div class="modal-grid" id="pickerGrid"></div>
    </div>
  </div>

  <script>
    /**********************************************************
     * CONFIG
     **********************************************************/
    const SUPABASE_URL = 'https://gkugecflfddkpitlrmws.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE';

    // Supabase table name (change if yours differs)
    const TABLE_DRAFTS = 'draft_records';

    // JSON data sources
    const URL_CHAR = 'https://neptuneg1.github.io/freefire-caster/character.json';
    const URL_PET  = 'https://neptuneg1.github.io/freefire-caster/pet.json';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**********************************************************
     * UTIL
     **********************************************************/
    const $ = (id) => document.getElementById(id);

    function safeText(v){
      if (v == null) return '';
      if (typeof v === 'string') return v;
      if (typeof v === 'number' || typeof v === 'boolean') return String(v);
      if (typeof v === 'object') {
        const maybe = v.EN ?? v.en ?? v.MS ?? v.ms ?? v.description ?? v.text ?? null;
        if (typeof maybe === 'string') return maybe;
        for (const k of Object.keys(v)) if (typeof v[k] === 'string') return v[k];
        return '';
      }
      return '';
    }

    function pickImg(item){
      return item?.image_url || item?.icon || item?.img || item?.portrait || 'https://i.imgur.com/qXFpizS.jpg';
    }

    // Language
    const LANG_KEY = 'ff_lang_v1';
    let currentLang = (localStorage.getItem(LANG_KEY) || 'en'); // en|ms

    function pickLang(en, ms){
      const E = safeText(en).trim();
      const M = safeText(ms).trim();
      if (currentLang === 'ms') return M || E || '';
      return E || M || '';
    }

    function getDesc(obj){
      if (!obj) return '';
      return pickLang(obj.description, obj.description_ms)
          || pickLang(obj.description_en, obj.description_ms)
          || safeText(obj.desc || obj.special || '');
    }

    function setStatus(msg, bad=false){
      const box = $('statusBox');
      if (!box) return;
      box.textContent = msg;
      box.classList.toggle('bad', !!bad);
      box.classList.toggle('ok', !bad);
      if (msg === 'Ready.' || msg === 'Saved.' || msg === 'Loaded.') {
        setTimeout(() => {
          if (box.textContent === msg) {
            box.textContent = 'Ready.';
            box.classList.remove('bad');
            box.classList.remove('ok');
          }
        }, 1800);
      }
    }

    function todayISO(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    async function loadJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Fetch failed: ' + url);
      return await res.json();
    }

    /**********************************************************
     * AUTH + UI HEADER
     **********************************************************/
    async function ensureSession(){
      const { data, error } = await client.auth.getSession();
      if (error) {
        console.error(error);
        window.location.href = "index.html";
        return null;
      }
      if (!data?.session) {
        window.location.href = "index.html";
        return null;
      }
      return data.session;
    }

    async function logout(){
      const { error } = await client.auth.signOut();
      if (error) console.error('signOut error:', error);
      window.location.href = "index.html";
    }

    function syncLangBtn(){
      const b = $('langBtn');
      if (!b) return;
      b.textContent = (currentLang === 'ms') ? 'MS' : 'EN';
      b.title = (currentLang === 'ms') ? 'Bahasa Melayu' : 'English';
    }

    /**********************************************************
     * SIDEBAR + NAV
     **********************************************************/
    (function initSidebarCollapse(){
      const sidebar = $('sidebar');
      const key = 'ff_sidebar_collapsed_v1';
      if (localStorage.getItem(key) === '1') sidebar.classList.add('collapsed');

      const btn = $('sbToggle');
      const path = $('sbTogglePath');

      function syncIcon(){
        if (!path) return;
        path.setAttribute('d', sidebar.classList.contains('collapsed')
          ? 'M10 7l5 5-5 5'
          : 'M14 7l-5 5 5 5'
        );
      }
      syncIcon();

      btn?.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem(key, sidebar.classList.contains('collapsed') ? '1' : '0');
        syncIcon();
      });
    })();

    $('searchInput')?.addEventListener('input', (e) => {
      const q = (e.target.value || '').toLowerCase().trim();
      document.querySelectorAll('#nav .nav-item').forEach(a => {
        const txt = a.textContent.toLowerCase();
        a.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });

    /**********************************************************
     * DATASETS
     **********************************************************/
    const DATA = {
      chars: [],
      pets: []
    };

    function isPassive(ch){
      return safeText(ch?.skill_type || '').toLowerCase() === 'passive';
    }
    function isActive(ch){
      const t = safeText(ch?.skill_type || '').toLowerCase();
      return t && t !== 'passive';
    }
    function isBRMeta(ch){ return safeText(ch?.meta || 'no').toLowerCase() === 'yes'; }
    function isCSMeta(ch){ return safeText(ch?.cs_meta || 'no').toLowerCase() === 'yes'; }

    /**********************************************************
     * DRAFT STATE
     **********************************************************/
    const LS_KEY = 'ff_cs_draft_state_v2';
    let CURRENT_RECORD_ID = null;
    let SESSION = null;

    function blankPick(){
      return { character:null, pet:null, passives:[null,null,null] };
    }

    function newState(){
      return {
        match: {
          match_date: todayISO(),
          game_number: 1,
          tournament_name: '',
          stage_name: '',
          map_name: '',
          team_left_score: 0,
          team_right_score: 0
        },
        teamNames: ['TEAM LEFT','TEAM RIGHT'],
        bans: { left:[null,null], right:[null,null] },
        players: {
          left: [
            { name:'P1', ...blankPick() },
            { name:'P2', ...blankPick() },
            { name:'P3', ...blankPick() },
            { name:'P4', ...blankPick() },
          ],
          right: [
            { name:'P1', ...blankPick() },
            { name:'P2', ...blankPick() },
            { name:'P3', ...blankPick() },
            { name:'P4', ...blankPick() },
          ]
        }
      };
    }

    let draftState = newState();

    function saveLocal(){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify({ draftState, CURRENT_RECORD_ID }));
      }catch(_){}
    }

    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed?.draftState) draftState = parsed.draftState;
        if (parsed?.CURRENT_RECORD_ID) CURRENT_RECORD_ID = parsed.CURRENT_RECORD_ID;
      }catch(_){}
    }

    function syncMatchInputs(){
      $('matchDate').value = draftState.match.match_date || todayISO();
      $('gameNumber').value = Number(draftState.match.game_number || 1);
      $('tournamentName').value = safeText(draftState.match.tournament_name);
      $('stageName').value = safeText(draftState.match.stage_name);
      $('mapName').value = safeText(draftState.match.map_name);
    }

    function pullMatchInputs(){
      draftState.match.match_date = $('matchDate').value || todayISO();
      draftState.match.game_number = Number($('gameNumber').value || 1);
      draftState.match.tournament_name = $('tournamentName').value || '';
      draftState.match.stage_name = $('stageName').value || '';
      draftState.match.map_name = $('mapName').value || '';
    }

    function setRecordBadge(){
      $('recordBadge').textContent = 'Record: ' + (CURRENT_RECORD_ID ? CURRENT_RECORD_ID : '—');
    }

    /**********************************************************
     * BOARD RENDER
     **********************************************************/
    function slotHTML(label, obj, pillText, pillClass){
      const has = !!obj;
      const img = has ? pickImg(obj) : '';
      const name = has ? safeText(obj.name || obj.skill || obj.title || '—') : '—';
      const sub  = has ? (safeText(obj.skill || '').trim() || safeText(obj.ability || '').trim() || '') : 'Click to select';
      return `
        <div class="slot" role="button" tabindex="0">
          <div class="thumb">${img ? `<img src="${img}" alt="">` : ''}</div>
          <div class="meta">
            <b>${name || '—'}</b>
            <span>${has ? (sub || '') : 'Click to select'}</span>
          </div>
          ${pillText ? `<span class="pill ${pillClass||''}">${pillText}</span>` : ''}
        </div>
      `;
    }

    function renderTeamPanel(side){ // side: 'left'|'right'
      const isLeft = (side === 'left');
      const teamIdx = isLeft ? 0 : 1;
      const teamName = draftState.teamNames[teamIdx] || (isLeft ? 'TEAM LEFT' : 'TEAM RIGHT');
      const score = isLeft ? Number(draftState.match.team_left_score||0) : Number(draftState.match.team_right_score||0);

      const bans = isLeft ? draftState.bans.left : draftState.bans.right;
      const players = isLeft ? draftState.players.left : draftState.players.right;

      const banSlots = bans.map((b, i) => `
        <div class="ban-slot" data-side="${side}" data-ban="${i}">
          ${slotHTML('Ban', b, 'BAN', 'active')}
        </div>
      `).join('');

      const pickRows = players.map((p, i) => {
        const ch = p.character;
        const pet = p.pet;
        const passives = (p.passives || [null,null,null]);

        const p0 = passives[0] || null;
        const p1 = passives[1] || null;
        const p2 = passives[2] || null;

        return `
          <div class="pick-row" data-side="${side}" data-player="${i}">
            <div class="player-col">
              <input class="playerName" data-side="${side}" data-player="${i}" value="${safeText(p.name || '')}" placeholder="Player ${i+1} name" />
              <div class="hint">Row ${i+1}</div>
            </div>

            <div>
              <div class="slot-wrap">
                <div class="pick-char" data-side="${side}" data-player="${i}">
                  ${slotHTML('Character', ch, isPassive(ch) ? 'PASSIVE' : 'ACTIVE', isPassive(ch) ? 'passive' : 'active')}
                </div>
                <div class="pick-pet" data-side="${side}" data-player="${i}">
                  ${slotHTML('Pet', pet, 'PET', '')}
                </div>
              </div>

              <div class="passive-row">
                <div class="pick-passive" data-side="${side}" data-player="${i}" data-passive="0">
                  ${slotHTML('Passive 1', p0, 'P1', 'passive')}
                </div>
                <div class="pick-passive" data-side="${side}" data-player="${i}" data-passive="1">
                  ${slotHTML('Passive 2', p1, 'P2', 'passive')}
                </div>
                <div class="pick-passive" data-side="${side}" data-player="${i}" data-passive="2">
                  ${slotHTML('Passive 3', p2, 'P3', 'passive')}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="team-panel" data-team="${side}">
          <div class="team-top">
            <div class="name">
              <span class="badge">${isLeft ? 'LEFT' : 'RIGHT'}</span>
              <input class="teamName" data-team="${teamIdx}" value="${safeText(teamName)}" placeholder="${isLeft?'TEAM LEFT':'TEAM RIGHT'}" />
            </div>
            <div class="scorebox">
              <span class="badge">Score</span>
              <input class="teamScore" data-team="${teamIdx}" type="number" min="0" step="1" value="${score}" />
            </div>
          </div>

          <div>
            <div class="section-title">
              <span>Bans</span>
              <span class="badge">2 slots</span>
            </div>
            <div class="ban-row">${banSlots}</div>
          </div>

          <div>
            <div class="section-title">
              <span>Picks</span>
              <span class="badge">4 players</span>
            </div>
            <div class="hint" style="margin:6px 0 10px 0">Click Character, Pet, or Passive slots to select.</div>
            <div class="pick-col">${pickRows}</div>
          </div>
        </div>
      `;
    }

    function renderBoard(){
      const board = $('board');
      board.innerHTML = renderTeamPanel('left') + renderTeamPanel('right');
      wireBoardEvents();
    }

    function chipHTML(item){
      if (!item) return '';
      const img = pickImg(item);
      const name = safeText(item.name || item.skill || '—');
      return `<span class="chip"><img src="${img}" alt=""><span class="t">${name}</span></span>`;
    }

    function bansLine(arr){
      const names = (arr||[]).filter(Boolean).map(b => safeText(b.name || '—')).filter(Boolean);
      return names.length ? names.join(', ') : '—';
    }

    function renderSummary(){
      $('sumTeamLeft').textContent = safeText(draftState.teamNames?.[0] || 'TEAM LEFT');
      $('sumTeamRight').textContent = safeText(draftState.teamNames?.[1] || 'TEAM RIGHT');

      $('sumScoreLeft').textContent = Number(draftState.match.team_left_score||0);
      $('sumScoreRight').textContent = Number(draftState.match.team_right_score||0);

      $('sumBansLeft').textContent = 'Bans: ' + bansLine(draftState.bans.left);
      $('sumBansRight').textContent = 'Bans: ' + bansLine(draftState.bans.right);

      const leftList = $('sumListLeft');
      const rightList = $('sumListRight');

      leftList.innerHTML = draftState.players.left.map((p,i) => {
        const chips = [
          chipHTML(p.character),
          chipHTML(p.pet),
          ...(p.passives||[]).map(chipHTML)
        ].filter(Boolean).join('');
        return `
          <div class="sum-line">
            <div class="pname">${safeText(p.name || 'P'+(i+1))}</div>
            <div class="chips">${chips || '<span class="muted">—</span>'}</div>
          </div>
        `;
      }).join('');

      rightList.innerHTML = draftState.players.right.map((p,i) => {
        const chips = [
          chipHTML(p.character),
          chipHTML(p.pet),
          ...(p.passives||[]).map(chipHTML)
        ].filter(Boolean).join('');
        return `
          <div class="sum-line">
            <div class="pname">${safeText(p.name || 'P'+(i+1))}</div>
            <div class="chips">${chips || '<span class="muted">—</span>'}</div>
          </div>
        `;
      }).join('');
    }

    function refreshUI(){
      syncMatchInputs();
      renderBoard();
      renderSummary();
      setRecordBadge();
      saveLocal();
    }

    /**********************************************************
     * PICKER MODAL (Character / Pet / Passive / Ban)
     **********************************************************/
    const pickerModal = $('pickerModal');
    const pickerTitle = $('pickerTitle');
    const pickerSub   = $('pickerSub');
    const pickerSearch= $('pickerSearch');
    const pickerCount = $('pickerCount');
    const pickerGrid  = $('pickerGrid');
    const pickerPills = $('pickerPills');

    let PICK_CTX = null;

    function openPicker(ctx){
      // ctx: { mode:'ban'|'character'|'pet'|'passive', side, playerIdx, passiveIdx, banIdx }
      PICK_CTX = ctx;

      const title =
        ctx.mode === 'ban' ? 'Select Ban (Character)' :
        ctx.mode === 'character' ? 'Select Character' :
        ctx.mode === 'pet' ? 'Select Pet' :
        'Select Passive (Character skill)';

      pickerTitle.textContent = title;
      pickerSub.textContent = 'Click an item to apply it.';
      pickerSearch.value = '';

      buildPillsForMode(ctx.mode);
      renderPickerGrid();

      pickerModal.classList.add('show');
      pickerModal.setAttribute('aria-hidden','false');
      setTimeout(() => pickerSearch.focus(), 0);
    }

    function closePicker(){
      pickerModal.classList.remove('show');
      pickerModal.setAttribute('aria-hidden','true');
      PICK_CTX = null;
    }

    function buildPillsForMode(mode){
      // For character/ban: allow filters
      // For pet: no pills
      // For passive: only passive (still show pill row with one active)
      pickerPills.innerHTML = '';

      if (mode === 'pet'){
        pickerPills.style.display = 'none';
        return;
      }

      pickerPills.style.display = 'flex';

      if (mode === 'passive'){
        pickerPills.innerHTML = `<button class="pill-btn active" data-f="passive">Passive Only</button>`;
        return;
      }

      // character/ban
      const opts = [
        { id:'all', label:'All' },
        { id:'brmeta', label:'BR Meta' },
        { id:'csmeta', label:'CS Meta' },
        { id:'active', label:'Active' },
        { id:'passive', label:'Passive' },
      ];
      const current = (PICK_CTX?.filter || 'all');

      pickerPills.innerHTML = opts.map(o => `
        <button class="pill-btn ${current===o.id?'active':''}" data-f="${o.id}">${o.label}</button>
      `).join('');

      pickerPills.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const f = btn.getAttribute('data-f') || 'all';
          PICK_CTX.filter = f;
          pickerPills.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === btn));
          renderPickerGrid();
        });
      });
    }

    function passesFilter(item){
      const mode = PICK_CTX?.mode;
      const f = PICK_CTX?.filter || 'all';

      if (mode === 'pet') return true;

      // passive mode always passive
      if (mode === 'passive') return isPassive(item);

      // character/ban
      if (f === 'all') return true;
      if (f === 'brmeta') return isBRMeta(item);
      if (f === 'csmeta') return isCSMeta(item);
      if (f === 'active') return isActive(item);
      if (f === 'passive') return isPassive(item);
      return true;
    }

    function listForMode(mode){
      if (mode === 'pet') return DATA.pets;
      // ban/character/passive all from characters
      return DATA.chars;
    }

    function renderPickerGrid(){
      if (!PICK_CTX) return;

      const mode = PICK_CTX.mode;
      const q = (pickerSearch.value || '').toLowerCase().trim();
      const all = listForMode(mode) || [];

      const filtered = all.filter(it => {
        if (!passesFilter(it)) return false;
        if (!q) return true;

        const name = safeText(it.name).toLowerCase();
        const skill = safeText(it.skill || it.ability || it.type || '').toLowerCase();
        const blob = [
          safeText(it.description),
          safeText(it.description_ms),
          safeText(it.special),
          safeText(it.desc),
        ].join(' ').toLowerCase();

        return name.includes(q) || skill.includes(q) || blob.includes(q);
      });

      pickerCount.textContent = `${filtered.length.toLocaleString()} item${filtered.length===1?'':'s'}`;

      pickerGrid.innerHTML = filtered.map((it, idx) => {
        const img = pickImg(it);
        const nm  = safeText(it.name || '—');
        const tip = (mode === 'pet')
          ? (safeText(it.skill || it.ability || '').trim() + (getDesc(it) ? ' — ' + getDesc(it) : '')).trim()
          : (safeText(it.skill || '').trim() + (getDesc(it) ? ' — ' + getDesc(it) : '')).trim();

        const tipFlat = safeText(tip).replace(/\n+/g,' | ');
        return `
          <div class="pick-card" data-idx="${idx}" title="${nm}${tipFlat ? ' — ' + tipFlat : ''}">
            <div class="pick-thumb"><img src="${img}" alt="${nm}" loading="lazy" referrerpolicy="no-referrer"></div>
            <div class="pick-name">${nm}</div>
          </div>
        `;
      }).join('');

      // store filtered list for click mapping
      pickerGrid.__filtered = filtered;
    }

    function applyPick(chosen){
      if (!PICK_CTX) return;

      const { mode, side, playerIdx, passiveIdx, banIdx } = PICK_CTX;

      if (mode === 'ban'){
        if (side === 'left') draftState.bans.left[banIdx] = chosen;
        else draftState.bans.right[banIdx] = chosen;
      }

      if (mode === 'character'){
        const p = (side === 'left') ? draftState.players.left[playerIdx] : draftState.players.right[playerIdx];
        p.character = chosen;
      }

      if (mode === 'pet'){
        const p = (side === 'left') ? draftState.players.left[playerIdx] : draftState.players.right[playerIdx];
        p.pet = chosen;
      }

      if (mode === 'passive'){
        const p = (side === 'left') ? draftState.players.left[playerIdx] : draftState.players.right[playerIdx];
        p.passives[passiveIdx] = chosen;
      }

      refreshUI();
      closePicker();
    }

    $('pickerClose')?.addEventListener('click', closePicker);
    pickerModal?.addEventListener('click', (e) => { if (e.target === pickerModal) closePicker(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && pickerModal.classList.contains('show')) closePicker(); });
    pickerSearch?.addEventListener('input', renderPickerGrid);

    pickerGrid?.addEventListener('click', (e) => {
      const card = e.target.closest('.pick-card');
      if (!card) return;
      const idx = Number(card.getAttribute('data-idx'));
      const list = pickerGrid.__filtered || [];
      const chosen = list[idx];
      if (!chosen) return;
      applyPick(chosen);
    });

    /**********************************************************
     * WIRE BOARD EVENTS
     **********************************************************/
    function wireBoardEvents(){
      // Team names
      document.querySelectorAll('.teamName').forEach(inp => {
        inp.addEventListener('input', () => {
          const t = Number(inp.getAttribute('data-team'));
          draftState.teamNames[t] = inp.value || (t===0?'TEAM LEFT':'TEAM RIGHT');
          renderSummary();
          saveLocal();
        });
      });

      // Scores
      document.querySelectorAll('.teamScore').forEach(inp => {
        inp.addEventListener('input', () => {
          const t = Number(inp.getAttribute('data-team'));
          const val = Number(inp.value || 0);
          if (t === 0) draftState.match.team_left_score = val;
          else draftState.match.team_right_score = val;
          renderSummary();
          saveLocal();
        });
      });

      // Player names
      document.querySelectorAll('.playerName').forEach(inp => {
        inp.addEventListener('input', () => {
          const side = inp.getAttribute('data-side');
          const i = Number(inp.getAttribute('data-player'));
          const p = (side === 'left') ? draftState.players.left[i] : draftState.players.right[i];
          p.name = inp.value || '';
          renderSummary();
          saveLocal();
        });
      });

      // Ban slots
      document.querySelectorAll('.ban-slot').forEach(w => {
        w.addEventListener('click', () => {
          const side = w.getAttribute('data-side');
          const banIdx = Number(w.getAttribute('data-ban'));
          openPicker({ mode:'ban', side, banIdx, filter:'all' });
        });
      });

      // Character slots
      document.querySelectorAll('.pick-char').forEach(w => {
        w.addEventListener('click', () => {
          const side = w.getAttribute('data-side');
          const playerIdx = Number(w.getAttribute('data-player'));
          openPicker({ mode:'character', side, playerIdx, filter:'all' });
        });
      });

      // Pet slots ✅
      document.querySelectorAll('.pick-pet').forEach(w => {
        w.addEventListener('click', () => {
          const side = w.getAttribute('data-side');
          const playerIdx = Number(w.getAttribute('data-player'));
          openPicker({ mode:'pet', side, playerIdx });
        });
      });

      // Passive slots
      document.querySelectorAll('.pick-passive').forEach(w => {
        w.addEventListener('click', () => {
          const side = w.getAttribute('data-side');
          const playerIdx = Number(w.getAttribute('data-player'));
          const passiveIdx = Number(w.getAttribute('data-passive'));
          openPicker({ mode:'passive', side, playerIdx, passiveIdx });
        });
      });
    }

    /**********************************************************
     * HISTORY (Supabase)
     **********************************************************/
    let HISTORY_ROWS = [];

    function normalizeRow(r){
      return {
        id: r.id,
        match_date: r.match_date || r.date || null,
        game_number: r.game_number || r.game || null,
        tournament_name: r.tournament_name || r.tournament || '',
        map_name: r.map_name || r.map || '',
        team_left: r.team_left || r.team_a || r.team1 || '',
        team_right: r.team_right || r.team_b || r.team2 || '',
        team_left_score: (r.team_left_score ?? r.score_left ?? 0),
        team_right_score: (r.team_right_score ?? r.score_right ?? 0),
        draft_state: r.draft_state || r.state || null,
        created_at: r.created_at || null
      };
    }

    function setHistoryBadge(){
      $('histBadge').textContent = `${HISTORY_ROWS.length} record${HISTORY_ROWS.length===1?'':'s'}`;
    }

    function buildHistoryFilters(){
      const tf = $('tournamentFilter');
      const teamF = $('teamFilter');

      const tournaments = Array.from(new Set(HISTORY_ROWS.map(r => safeText(r.tournament_name)).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b));
      const teams = Array.from(new Set(
        HISTORY_ROWS.flatMap(r => [safeText(r.team_left), safeText(r.team_right)]).filter(Boolean)
      )).sort((a,b)=>a.localeCompare(b));

      const prevT = tf.value || '__ALL__';
      const prevTeam = teamF.value || '__ALL__';

      tf.innerHTML = `<option value="__ALL__">All tournaments</option>` + tournaments.map(t => `<option value="${t}">${t}</option>`).join('');
      teamF.innerHTML = `<option value="__ALL__">All teams</option>` + teams.map(t => `<option value="${t}">${t}</option>`).join('');

      // ✅ Default tournament filter = most recent record's tournament (if not chosen)
      const latestTournament = (HISTORY_ROWS.find(r => r.tournament_name)?.tournament_name) || '';
      if (!prevT || prevT === '__ALL__') {
        tf.value = latestTournament ? latestTournament : '__ALL__';
      } else {
        tf.value = tournaments.includes(prevT) ? prevT : '__ALL__';
      }

      teamF.value = teams.includes(prevTeam) ? prevTeam : '__ALL__';
    }

    function applyHistoryFilter(rows){
      const tf = $('tournamentFilter').value || '__ALL__';
      const teamF = $('teamFilter').value || '__ALL__';
      const q = ($('historySearch').value || '').toLowerCase().trim();

      return rows.filter(r => {
        if (tf !== '__ALL__' && safeText(r.tournament_name) !== tf) return false;

        if (teamF !== '__ALL__') {
          const a = safeText(r.team_left);
          const b = safeText(r.team_right);
          if (a !== teamF && b !== teamF) return false;
        }

        if (q) {
          const blob = [
            r.tournament_name, r.map_name, r.team_left, r.team_right,
            String(r.game_number||''), String(r.match_date||'')
          ].join(' ').toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });
    }

    function renderHistory(){
      const body = $('historyBody');
      const rows = applyHistoryFilter(HISTORY_ROWS);

      if (!rows.length) {
        body.innerHTML = `<tr><td colspan="7" class="muted">No records found.</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(r => {
        const d = safeText(r.match_date || '').slice(0,10) || '—';
        const g = r.game_number ?? '—';
        const t = safeText(r.tournament_name || '—');
        const m = safeText(r.map_name || '—');
        const match = `${safeText(r.team_left||'—')} vs ${safeText(r.team_right||'—')}`;
        const sc = `${Number(r.team_left_score||0)}-${Number(r.team_right_score||0)}`;
        return `
          <tr>
            <td>${d}</td>
            <td>${g}</td>
            <td>${t}</td>
            <td>${match}</td>
            <td>${m}</td>
            <td>${sc}</td>
            <td>
              <div class="hist-actions">
                <button class="mini" data-load="${r.id}">Load</button>
                <button class="mini" data-copyid="${r.id}">Copy ID</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function loadHistory(){
      try{
        setStatus('Loading history…');
        const { data, error } = await client
          .from(TABLE_DRAFTS)
          .select('*')
          .order('match_date', { ascending: false })
          .order('created_at', { ascending: false })
          .limit(200);

        if (error) {
          console.error(error);
          setStatus("Supabase error:\n" + JSON.stringify(error, null, 2), true);
          $('historyBody').innerHTML = `<tr><td colspan="7" class="muted">Failed to load records.</td></tr>`;
          return;
        }

        HISTORY_ROWS = (data || []).map(normalizeRow);
        setHistoryBadge();
        buildHistoryFilters();
        renderHistory();
        setStatus('Ready.');
      }catch(err){
        console.error(err);
        setStatus('History load failed: ' + err.message, true);
      }
    }

    async function loadRecordById(id){
      try{
        setStatus('Loading record…');
        const { data, error } = await client
          .from(TABLE_DRAFTS)
          .select('*')
          .eq('id', id)
          .maybeSingle();

        if (error) {
          console.error(error);
          setStatus("Supabase error:\n" + JSON.stringify(error, null, 2), true);
          return;
        }
        if (!data) {
          setStatus('Record not found.', true);
          return;
        }

        const r = normalizeRow(data);
        CURRENT_RECORD_ID = r.id;

        // Load draft_state if present, otherwise reconstruct minimally
        if (r.draft_state) {
          draftState = r.draft_state;
        } else {
          draftState = newState();
        }

        // Patch match meta from columns (in case draft_state missing these)
        draftState.match.match_date = r.match_date || draftState.match.match_date;
        draftState.match.game_number = r.game_number ?? draftState.match.game_number;
        draftState.match.tournament_name = r.tournament_name || draftState.match.tournament_name;
        draftState.match.map_name = r.map_name || draftState.match.map_name;
        draftState.match.team_left_score = Number(r.team_left_score||0);
        draftState.match.team_right_score = Number(r.team_right_score||0);

        // Patch team names from columns if present
        if (r.team_left) draftState.teamNames[0] = r.team_left;
        if (r.team_right) draftState.teamNames[1] = r.team_right;

        refreshUI();
        setStatus('Loaded.');
      }catch(err){
        console.error(err);
        setStatus('Load failed: ' + err.message, true);
      }
    }

    async function saveRecord(){
      try{
        pullMatchInputs();

        const payload = {
          match_date: draftState.match.match_date,
          game_number: Number(draftState.match.game_number||1),
          tournament_name: draftState.match.tournament_name || null,
          stage_name: draftState.match.stage_name || null,
          map_name: draftState.match.map_name || null,
          team_left: draftState.teamNames[0] || 'TEAM LEFT',
          team_right: draftState.teamNames[1] || 'TEAM RIGHT',
          team_left_score: Number(draftState.match.team_left_score||0),
          team_right_score: Number(draftState.match.team_right_score||0),
          draft_state: draftState,
          updated_at: new Date().toISOString()
        };

        setStatus('Saving…');

        if (CURRENT_RECORD_ID) {
          const { error } = await client
            .from(TABLE_DRAFTS)
            .update(payload)
            .eq('id', CURRENT_RECORD_ID);

          if (error) {
            console.error(error);
            setStatus("Supabase error:\n" + JSON.stringify(error, null, 2), true);
            return;
          }
          setStatus('Saved.');
        } else {
          const { data, error } = await client
            .from(TABLE_DRAFTS)
            .insert(payload)
            .select('id')
            .single();

          if (error) {
            console.error(error);
            setStatus("Supabase error:\n" + JSON.stringify(error, null, 2), true);
            return;
          }

          CURRENT_RECORD_ID = data?.id || null;
          setStatus('Saved.');
        }

        setRecordBadge();
        saveLocal();
        await loadHistory();
      }catch(err){
        console.error(err);
        setStatus('Save failed: ' + err.message, true);
      }
    }

    /**********************************************************
     * ACTIONS
     **********************************************************/
    function resetDraft(keepMatch=false){
      const oldMatch = JSON.parse(JSON.stringify(draftState.match));
      const oldTeams = [...draftState.teamNames];

      draftState = newState();
      if (keepMatch) {
        draftState.match = oldMatch;
        draftState.teamNames = oldTeams;
      }
      CURRENT_RECORD_ID = null;
      refreshUI();
      setStatus('Ready.');
    }

    async function copySummary(){
      const L = safeText(draftState.teamNames[0] || 'TEAM LEFT');
      const R = safeText(draftState.teamNames[1] || 'TEAM RIGHT');
      const sc = `${Number(draftState.match.team_left_score||0)}-${Number(draftState.match.team_right_score||0)}`;

      const meta = [
        `Date: ${draftState.match.match_date || ''}`,
        `Game: ${draftState.match.game_number || ''}`,
        `Tournament: ${draftState.match.tournament_name || ''}`,
        `Stage: ${draftState.match.stage_name || ''}`,
        `Map: ${draftState.match.map_name || ''}`,
      ].filter(Boolean).join('\n');

      const bansL = 'Bans: ' + bansLine(draftState.bans.left);
      const bansR = 'Bans: ' + bansLine(draftState.bans.right);

      const linesTeam = (side) => {
        const arr = (side==='left') ? draftState.players.left : draftState.players.right;
        return arr.map(p => {
          const name = safeText(p.name || '—');
          const ch = safeText(p.character?.name || '—');
          const pet = safeText(p.pet?.name || '—');
          const pas = (p.passives||[]).map(x => safeText(x?.name||'—')).join(' / ');
          return `- ${name}: ${ch} | Pet: ${pet} | Passives: ${pas}`;
        }).join('\n');
      };

      const text =
`${meta}

${L} vs ${R} (${sc})

${L}
${bansL}
${linesTeam('left')}

${R}
${bansR}
${linesTeam('right')}
`;

      try{
        await navigator.clipboard.writeText(text);
        setStatus('Summary copied.');
      }catch(_){
        // fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        setStatus('Summary copied.');
      }
    }

    /**********************************************************
     * INIT
     **********************************************************/
    async function init(){
      loadLocal();

      syncLangBtn();
      $('langBtn')?.addEventListener('click', () => {
        currentLang = (currentLang === 'en') ? 'ms' : 'en';
        localStorage.setItem(LANG_KEY, currentLang);
        syncLangBtn();
        // just re-render (descriptions are in titles)
        refreshUI();
      });

      SESSION = await ensureSession();
      if (!SESSION) return;

      const email = SESSION.user?.email || '';
      $('userEmail').textContent = email || 'signed in';
      $('gamertag').textContent = email ? email.split('@')[0] : 'PlayerOne';

      client.auth.onAuthStateChange((_event, newSession) => {
        if (!newSession) window.location.href = "index.html";
      });

      $('logoutBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

      // Match inputs listeners
      $('matchDate').addEventListener('input', () => { pullMatchInputs(); saveLocal(); });
      $('gameNumber').addEventListener('input', () => { pullMatchInputs(); saveLocal(); });
      $('tournamentName').addEventListener('input', () => { pullMatchInputs(); saveLocal(); });
      $('stageName').addEventListener('input', () => { pullMatchInputs(); saveLocal(); });
      $('mapName').addEventListener('input', () => { pullMatchInputs(); saveLocal(); });

      // Buttons
      $('saveBtn').addEventListener('click', saveRecord);
      $('newBtn').addEventListener('click', () => resetDraft(true));
      $('resetBtn').addEventListener('click', () => resetDraft(false));
      $('copyBtn').addEventListener('click', copySummary);
      $('refreshHistoryBtn').addEventListener('click', loadHistory);

      // History filter listeners
      $('tournamentFilter').addEventListener('change', renderHistory);
      $('teamFilter').addEventListener('change', renderHistory);
      $('historySearch').addEventListener('input', renderHistory);

      // History action buttons (delegate)
      $('historyBody').addEventListener('click', async (e) => {
        const loadBtn = e.target.closest('[data-load]');
        const copyBtn = e.target.closest('[data-copyid]');
        if (loadBtn) {
          const id = loadBtn.getAttribute('data-load');
          await loadRecordById(id);
        }
        if (copyBtn) {
          const id = copyBtn.getAttribute('data-copyid');
          try{
            await navigator.clipboard.writeText(id);
            setStatus('ID copied.');
          }catch(_){
            setStatus('Copy failed.', true);
          }
        }
      });

      // Load datasets
      try{
        const [chars, pets] = await Promise.all([ loadJson(URL_CHAR), loadJson(URL_PET) ]);
        DATA.chars = Array.isArray(chars) ? chars : [];
        DATA.pets  = Array.isArray(pets) ? pets : [];
        $('dataBadge').textContent = `Data: ${DATA.chars.length} chars • ${DATA.pets.length} pets`;
      }catch(err){
        console.error(err);
        $('dataBadge').textContent = 'Data: failed to load';
        setStatus('Data load failed: ' + err.message, true);
      }

      // Initial UI
      if (!draftState?.match?.match_date) draftState.match.match_date = todayISO();
      refreshUI();
      await loadHistory();
      setStatus('Ready.');
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
