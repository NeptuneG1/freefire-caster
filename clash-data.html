<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clash Squad — Skills Report & Summary</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.25rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:#1b1b1b;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:hover{background:#e6a74f}
    .shell{max-width:1200px;margin:22px auto;padding:0 12px}

    .block{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:16px}
    .block h2{margin:0 0 10px 0;color:var(--brand)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 10px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="date"],.controls input[type="text"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}
    .muted{color:var(--muted);font-size:.9rem}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
    thead th{background:#191919;text-align:left}
    tbody tr:hover{background:#141414}
    .wl{font-weight:700;padding:2px 8px;border-radius:999px;display:inline-block}
    .wl.W{background:#193e2b;color:var(--good);border:1px solid #245b3e}
    .wl.L{background:#401e1e;color:var(--bad);border:1px solid #6b2c2c}

    /* Player mini-cards with images in Per-Match rows */
    .playersWrap{display:flex;flex-wrap:wrap;gap:8px}
    .pCard{
      display:inline-flex;align-items:center;gap:8px;
      background:#141414;border:1px solid #2a2a2a;border-radius:10px;
      padding:6px 8px;min-width:220px;max-width:260px
    }
    .pAct{
      width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #333;background:#0f0f0f
    }
    .pStack{display:flex;flex-direction:column;gap:3px}
    .pStack img{
      width:16px;height:16px;object-fit:cover;border-radius:3px;border:1px solid #333;background:#0f0f0f
    }
    .pInfo{display:flex;flex-direction:column;line-height:1.2}
    .pName{font-weight:700;font-size:.92rem}
    .pHero{font-size:.86rem;color:#d8d8d8}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:12px}
    .card h3{margin:0 0 6px 0;color:var(--brand2);font-size:1.05rem}
    .kpis{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 8px;font-size:.9rem}
    .sum-table{width:100%;border-collapse:collapse;font-size:.92rem}
    .sum-table th,.sum-table td{border-bottom:1px solid #2a2a2a;padding:6px 6px}
    .right{text-align:right}
    .tight{line-height:1.25}
    .caption{margin:4px 0 10px 0}
  </style>
</head>
<body>
  <header>
    <h1>Clash Squad — Skills Report & Summary</h1>
    <div class="user-controls">
      <span class="chip" id="user-info">Checking login…</span>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="shell">
    <!-- FILTERS -->
    <div class="block">
      <h2>Filters</h2>
      <div class="controls">
        <label>From
          <input type="date" id="fFrom">
        </label>
        <label>To
          <input type="date" id="fTo">
        </label>
        <label>Map
          <select id="fMap">
            <option value="__ALL__">All maps</option>
            <option value="Bermuda">Bermuda</option>
            <option value="Kalahari">Kalahari</option>
            <option value="Purgatory">Purgatory</option>
            <option value="Alpine">Alpine</option>
            <option value="Nexterra">Nexterra</option>
            <option value="Solara">Solara</option>
          </select>
        </label>
        <label>Team
          <select id="fTeam"></select>
        </label>
        <label>Outcome
          <select id="fWL">
            <option value="__ALL__">All</option>
            <option value="W">Wins only</option>
            <option value="L">Losses only</option>
          </select>
        </label>
        <button class="btn" id="applyBtn">Apply</button>
      </div>
      <div class="muted" id="filterMeta">—</div>
    </div>

    <!-- MATCH LIST (per team per match) -->
    <div class="block">
      <h2>Per-Match Team Rows</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Game</th>
            <th>Map</th>
            <th>Team</th>
            <th>Opponent</th>
            <th>Score</th>
            <th>Result</th>
            <th>Ban</th>
            <th>Players (Active + 3×Passive)</th>
          </tr>
        </thead>
        <tbody id="rowsBody"></tbody>
      </table>
    </div>

    <!-- SUMMARY SECTION -->
    <div class="block">
      <h2>Summary: Picks/Bans</h2>
      <div class="controls sum-controls">
        <label class="muted">Group by
          <select id="sumGroupBy">
            <option value="team">Team</option>
            <option value="player" selected>Player</option>
          </select>
        </label>
        <label class="muted">Subject
          <select id="sumKind">
            <option value="active">Active skills</option>
            <option value="passive">Passive skills</option>
            <option value="ban">Bans</option>
          </select>
        </label>
        <label class="muted">Card order (per subject)
          <select id="sumCardSort">
            <option value="subjectAppear" selected>Appearances</option>
            <option value="subjectRate">Appear Rate</option>
            <option value="subjectWinrate">Win %</option>
            <option value="matches">Matches</option>
            <option value="wins">Wins</option>
            <option value="winpct">Overall Win %</option>
            <option value="name">A→Z</option>
          </select>
        </label>
        <label class="muted">Card dir
          <select id="sumCardDir">
            <option value="desc" selected>Desc</option>
            <option value="asc">Asc</option>
          </select>
        </label>
        <label class="muted">Skills order
          <select id="sumSkillSort">
            <option value="appearRate" selected>Rate</option>
            <option value="count">Count</option>
            <option value="winrate">Win %</option>
            <option value="name">A→Z</option>
          </select>
        </label>
        <label class="muted">Skills dir
          <select id="sumSkillDir">
            <option value="desc" selected>Desc</option>
            <option value="asc">Asc</option>
          </select>
        </label>
      </div>
      <div class="caption muted" id="sumMeta">—</div>
      <div class="grid" id="sumGrid"></div>
    </div>
  </div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) {
    window.location.href = "index.html";
    return;
  }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = "index.html";
};

/* ========= Utilities ========= */
const PLACEHOLDER = 'https://imgur.com/AdvPwAO.png';
const fmtPct = (num) => isFinite(num) ? (num*100).toFixed(1) + '%' : '—';
const pct = (num, den) => den ? fmtPct(num/den) : '—';
const safe = (v, d='') => (v===null||v===undefined)?d:v;
const uniq = (arr) => [...new Set(arr)];
function ymd(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

/* ========= State ========= */
let RAW_RECORDS = [];   // raw draft_records rows (filtered by date/map/team on fetch)
let CURRENT_ROWS = [];  // flattened team-per-match rows after win/loss filter

/* ========= DOM ========= */
const el = (id) => document.getElementById(id);

/* ========= Init filters ========= */
(function initFilters(){
  const today = new Date();
  const from = new Date(today); from.setDate(from.getDate()-30);
  el('fFrom').value = ymd(from);
  el('fTo').value = ymd(today);
  el('fMap').value = '__ALL__';
  el('fWL').value = '__ALL__';
})();

/* ========= Fetch & build ========= */
async function fetchRecords(){
  const from = el('fFrom').value;
  const to   = el('fTo').value;
  const map  = el('fMap').value;
  const team = el('fTeam').value || '__ALL__';

  let q = client
    .from('draft_records')
    .select('id, match_date, game_number, team_left, team_right, team_left_score, team_right_score, map, state')
    .gte('match_date', from).lte('match_date', to)
    .order('match_date', { ascending:false })
    .order('id', { ascending:false });

  if (map !== '__ALL__') q = q.eq('map', map);
  if (team && team !== '__ALL__') {
    q = q.or(`team_left.eq.${team},team_right.eq.${team}`);
  }

  const { data, error } = await q;
  if (error) {
    console.error('Fetch error', error);
    alert('Failed to load records');
    return [];
  }
  return data || [];
}

function populateTeamDropdown(records){
  const teams = new Set();
  records.forEach(r => { teams.add(r.team_left); teams.add(r.team_right); });
  const dd = el('fTeam');
  const prior = dd.value;
  dd.innerHTML = '';
  const all = document.createElement('option'); all.value='__ALL__'; all.textContent='All teams';
  dd.appendChild(all);
  [...teams].sort().forEach(t => {
    const o=document.createElement('option'); o.value=t; o.textContent=t; dd.appendChild(o);
  });
  dd.value = prior || '__ALL__';
}

/* Build per-team rows from a record; include image URLs */
function explodeRecordToRows(rec){
  const s = rec.state || {};
  const picks = s.picks || [];
  const passives = s.passives || [];
  const bans = s.bans || [];
  const names = s.playerCards || [];

  const leftWin = (rec.team_left_score ?? 0) > (rec.team_right_score ?? 0);
  const rightWin = (rec.team_right_score ?? 0) > (rec.team_left_score ?? 0);

  function sideRow(side){
    const isLeft = side==='L';
    const team   = isLeft ? rec.team_left : rec.team_right;
    const opp    = isLeft ? rec.team_right : rec.team_left;
    const tScore = isLeft ? rec.team_left_score : rec.team_right_score;
    const oScore = isLeft ? rec.team_right_score : rec.team_left_score;
    const res    = (isLeft ? leftWin : rightWin) ? 'W' : 'L';
    const banObj = bans[ isLeft ? 0 : 1 ];
    const ban    = banObj?.name || '';
    const banImg = banObj?.image_url || '';

    const idx = isLeft ? [0,1,2,3] : [7,6,5,4];

    const actives = idx.map((i, k) => {
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const heroObj= picks[i] || null;
      return { player, hero: heroObj?.name || '', heroImg: heroObj?.image_url || PLACEHOLDER };
    });

    const passiveLines = idx.map((i, k) => {
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const trioObjs = (passives[i] || []).filter(Boolean).map(ps => ({
        name: ps?.name || '',
        img : ps?.image_url || PLACEHOLDER
      }));
      // Ensure up to 3 spots (pad with blanks for consistent stack)
      while (trioObjs.length < 3) trioObjs.push({name:'', img: PLACEHOLDER});
      return { player, trio: trioObjs.slice(0,3) };
    });

    return {
      rec_id: rec.id,
      match_date: rec.match_date,
      game_number: rec.game_number,
      map: rec.map,
      team, opponent: opp,
      team_score: tScore ?? 0,
      opp_score: oScore ?? 0,
      result: res,
      banName: ban,
      banImg,
      actives,          // [{player, hero, heroImg}]
      passives: passiveLines // [{player, trio:[{name,img}×3]}]
    };
  }

  return [sideRow('L'), sideRow('R')];
}

function applyRowFilters(allRows){
  const wl = el('fWL').value;
  const team = el('fTeam').value || '__ALL__';
  let rows = allRows.slice();

  if (team !== '__ALL__') rows = rows.filter(r => r.team === team);
  if (wl !== '__ALL__') rows = rows.filter(r => r.result === wl);
  return rows;
}

/* Build the player card HTML with images */
function playerCardHTML(player, heroName, heroImg, trio){
  const passHTML = (trio || []).slice(0,3).map(ps => {
    const src = ps?.img || PLACEHOLDER;
    return `<img src="${src}" alt="" loading="lazy">`;
  }).join('');
  const img = heroImg || PLACEHOLDER;
  const hero = heroName || '—';
  const p = player || '';
  return `
    <div class="pCard">
      <img class="pAct" src="${img}" alt="${hero}" loading="lazy">
      <div class="pStack">${passHTML}</div>
      <div class="pInfo">
        <div class="pName">${p}</div>
        <div class="pHero">${hero}</div>
      </div>
    </div>
  `;
}

function renderRows(rows){
  const body = el('rowsBody');
  body.innerHTML = '';
  if (!rows.length){
    const tr=document.createElement('tr');
    const td=document.createElement('td'); td.colSpan=9; td.className='muted'; td.textContent='No rows for your selection.';
    tr.appendChild(td); body.appendChild(tr); return;
  }

  rows.forEach(r => {
    const tr=document.createElement('tr');

    const tdDate = `<td>${r.match_date}</td>`;
    const tdGame = `<td>Game ${r.game_number}</td>`;
    const tdMap  = `<td>${r.map}</td>`;
    const tdTeam = `<td class="tight"><div><strong>${r.team}</strong></div><div class="muted">vs ${r.opponent}</div></td>`;
    const tdOpp  = `<td>${r.opponent}</td>`;
    const tdScore= `<td>${r.team_score} - ${r.opp_score}</td>`;
    const tdRes  = `<td><span class="wl ${r.result}">${r.result}</span></td>`;

    const banImg = r.banImg || PLACEHOLDER;
    const banTxt = r.banName || '—';
    const tdBan  = `<td><div style="display:flex;align-items:center;gap:6px;">
                      <img src="${banImg}" alt="${banTxt}" style="width:28px;height:28px;border-radius:6px;border:1px solid #333;background:#0f0f0f" loading="lazy">
                      <span>${banTxt}</span>
                    </div></td>`;

    // Build player cards, aligning actives with their matching passives by player
    const byPlayer = r.actives.map(a => {
      const p = r.passives.find(pp => pp.player === a.player) || { trio: [] };
      return playerCardHTML(a.player, a.hero, a.heroImg, p.trio);
    }).join('');

    const tdPlayers = `<td><div class="playersWrap">${byPlayer}</div></td>`;

    tr.innerHTML = tdDate + tdGame + tdMap + tdTeam + tdOpp + tdScore + tdRes + tdBan + tdPlayers;
    body.appendChild(tr);
  });
}

/* ===== Summary (unchanged logic, still sortable per player/team) ===== */
function buildBuckets(groupBy, kind){
  const buckets = new Map();
  CURRENT_ROWS.forEach(r => {
    let keys = [];
    if (groupBy === 'team'){
      keys = [r.team];
    } else {
      keys = uniq(r.actives.map(a => a.player)).filter(Boolean);
    }
    keys.forEach(key => {
      if (!buckets.has(key)){
        buckets.set(key, { name:key, matches:0, wins:0, skills:new Map() });
      }
      const B = buckets.get(key);
      B.matches += 1;
      if (r.result === 'W') B.wins += 1;

      if (kind === 'active'){
        r.actives.forEach(a => {
          if (groupBy==='player' && a.player !== key) return;
          const name = a.hero;
          if (!name) return;
          const S = B.skills.get(name) || { occ:0, appear:0, appearWins:0 };
          S.occ += 1; S.appear += 1; if (r.result === 'W') S.appearWins += 1;
          B.skills.set(name, S);
        });
      } else if (kind === 'passive'){
        r.passives.forEach(p => {
          if (groupBy==='player' && p.player !== key) return;
          (p.trio || []).forEach(nm => {
            const name = nm?.name || '';
            if (!name) return;
            const S = B.skills.get(name) || { occ:0, appear:0, appearWins:0 };
            S.occ += 1; S.appear += 1; if (r.result === 'W') S.appearWins += 1;
            B.skills.set(name, S);
          });
        });
      } else {
        const nm = r.banName;
        if (!nm) return;
        const S = B.skills.get(nm) || { occ:0, appear:0, appearWins:0 };
        S.occ += 1; S.appear += 1; if (r.result === 'W') S.appearWins += 1;
        B.skills.set(nm, S);
      }
    });
  });

  return buckets;
}

function renderSummary(buckets, groupBy, kind){
  const grid = el('sumGrid');
  const meta = el('sumMeta');
  const totalEntities = buckets.size;
  const totalRows = CURRENT_ROWS.length;

  const rateLabel = (kind === 'ban') ? 'Ban Rate' : 'Pick Rate';
  meta.textContent = `${totalEntities} ${groupBy === 'team' ? 'team' : 'player'} group(s) • ${totalRows} team-row(s) in view`;

  if (!totalEntities){
    grid.innerHTML = `<div class="card"><div class="muted">No data for this selection.</div></div>`;
    return;
  }

  const cardSort  = el('sumCardSort').value;
  const cardDir   = el('sumCardDir').value;
  const skillSort = el('sumSkillSort').value;
  const skillDir  = el('sumSkillDir').value;

  const ordered = [...buckets.values()].map(b => {
    const subj = [...b.skills.values()].reduce((acc, s) => {
      acc.appear     += (s.appear || 0);
      acc.appearWins += (s.appearWins || 0);
      acc.occ        += (s.occ || 0);
      return acc;
    }, { appear:0, appearWins:0, occ:0 });
    subj.rate    = b.matches ? (subj.appear / b.matches) : 0;
    subj.winrate = subj.appear ? (subj.appearWins / subj.appear) : 0;
    b._subj = subj;
    return b;
  });

  const cardCmp = (a, b) => {
    let A,B;
    if (cardSort==='name'){ A=a.name?.toLowerCase()||''; B=b.name?.toLowerCase()||''; }
    else if (cardSort==='matches'){ A=a.matches; B=b.matches; }
    else if (cardSort==='wins'){ A=a.wins; B=b.wins; }
    else if (cardSort==='winpct'){ A=a.matches ? a.wins/a.matches : -1; B=b.matches ? b.wins/b.matches : -1; }
    else if (cardSort==='subjectAppear'){ A=a._subj.appear; B=b._subj.appear; }
    else if (cardSort==='subjectRate'){ A=a._subj.rate; B=b._subj.rate; }
    else { A=a._subj.winrate; B=b._subj.winrate; }
    if (A<B) return cardDir==='asc' ? -1 : 1;
    if (A>B) return cardDir==='asc' ? 1 : -1;
    const nA=a.name?.toLowerCase()||'', nB=b.name?.toLowerCase()||'';
    if (nA<nB) return -1; if (nA>nB) return 1; return 0;
  };
  ordered.sort(cardCmp);

  const cards = [];
  ordered.forEach(b => {
    let skills = [...b.skills.entries()].map(([name, s]) => {
      const appearRate = b.matches ? (s.appear / b.matches) : 0;
      const winRate    = s.appear ? (s.appearWins / s.appear) : 0;
      return { name, ...s, appearRate, winRate };
    });

    const skillCmp = (x,y) => {
      let A,B;
      if (skillSort==='name'){ A=x.name.toLowerCase(); B=y.name.toLowerCase(); }
      else if (skillSort==='count'){ A=x.occ; B=y.occ; }
      else if (skillSort==='winrate'){ A=x.winRate; B=y.winRate; }
      else { A=x.appearRate; B=y.appearRate; }
      if (A<B) return skillDir==='asc' ? -1 : 1;
      if (A>B) return skillDir==='asc' ? 1 : -1;
      if (x.name.toLowerCase()<y.name.toLowerCase()) return -1;
      if (x.name.toLowerCase()>y.name.toLowerCase()) return 1;
      return 0;
    };
    skills.sort(skillCmp);

    const table = skills.length
      ? `<table class="sum-table">
           <thead><tr><th>Skill</th><th class="right">Count</th><th class="right">${rateLabel}</th><th class="right">Win Rate</th></tr></thead>
           <tbody>
             ${skills.map(s => `
               <tr>
                 <td>${s.name}</td>
                 <td class="right">${s.occ}</td>
                 <td class="right">${pct(s.appear,b.matches)}</td>
                 <td class="right">${pct(s.appearWins,s.appear)}</td>
               </tr>`).join('')}
           </tbody>
         </table>`
      : `<div class="muted">No ${kind} data.</div>`;

    cards.push(`
      <div class="card">
        <h3>${b.name}</h3>
        <div class="kpis">
          <div class="kpi">Matches <strong>${b.matches}</strong></div>
          <div class="kpi">Wins <strong>${b.wins}</strong> <span class="muted">(${pct(b.wins,b.matches)})</span></div>
          <div class="kpi">${(kind==='ban'?'Bans':'Picks')} <strong>${b._subj.appear}</strong> <span class="muted">(${pct(b._subj.appear,b.matches)})</span></div>
          <div class="kpi">When Appeared: <strong>${pct(b._subj.appearWins,b._subj.appear)}</strong></div>
        </div>
        ${table}
      </div>
    `);
  });

  grid.innerHTML = cards.join('');
}

/* ========= Main refresh ========= */
async function refresh(){
  RAW_RECORDS = await fetchRecords();

  populateTeamDropdown(RAW_RECORDS);

  const teamSel = el('fTeam').value || '__ALL__';
  el('filterMeta').textContent =
    `Loaded ${RAW_RECORDS.length} matches • Team: ${teamSel==='__ALL__'?'All teams':teamSel} • Map: ${el('fMap').value}`;

  const exploded = RAW_RECORDS.flatMap(explodeRecordToRows);
  CURRENT_ROWS = applyRowFilters(exploded);

  renderRows(CURRENT_ROWS);

  const groupBy = el('sumGroupBy').value;
  const kind    = el('sumKind').value;
  const buckets = buildBuckets(groupBy, kind);
  renderSummary(buckets, groupBy, kind);
}

/* ========= Events ========= */
el('applyBtn').onclick = refresh;
['sumGroupBy','sumKind','sumCardSort','sumCardDir','sumSkillSort','sumSkillDir'].forEach(id=>{
  el(id).addEventListener('change', () => {
    const buckets = buildBuckets(el('sumGroupBy').value, el('sumKind').value);
    renderSummary(buckets, el('sumGroupBy').value, el('sumKind').value);
  });
});

/* ========= First load ========= */
refresh();
</script>
</body>
</html>
