<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Report — Compact Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0d0d0d; --panel:#151515; --ink:#eee; --muted:#aaa;
      --brand:#ffbd59; --brand2:#ff7733; --line:#2a2a2a;
      --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html{font-size:clamp(12px, 0.85vw + 8px, 16px);}       /* responsive base */
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1a1a1a;border-bottom:2px solid var(--brand);padding:10px 12px}
    h1{margin:0;font-size:clamp(1rem,1.2vw,1.15rem);color:var(--brand);letter-spacing:.2px}

    .shell{max-width:min(1600px,98vw);margin:14px auto;padding:0 10px}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    label{display:flex;align-items:center;gap:6px}
    select{background:#1e1e1e;color:#ffe0b0;border:1px solid #3a3a3a;border-radius:8px;padding:6px 8px;font-weight:600}
    .chip{color:var(--muted);font-size:.82rem}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:8px;grid-auto-flow:dense}
    .card{grid-column:span 6;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px;overflow:auto}
    .card.s{grid-column:span 6}
    .card.l{grid-column:span 12}
    .card h3{margin:0 0 6px 0;color:var(--brand2);font-size:clamp(.9rem,1vw,.95rem)}

    /* KPI row */
    .kpis{display:flex;gap:6px;flex-wrap:wrap}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:10px;padding:6px 8px;font-size:.9rem;white-space:nowrap}
    .kpi b{font-size:1rem}

    /* Tables */
    .twrap{overflow:auto}                   /* enables horizontal scroll when needed */
    table{width:100%;border-collapse:collapse;font-size:clamp(.8rem,.9vw,.9rem);min-width:520px}
    th,td{border-bottom:1px solid #222;padding:6px 6px;vertical-align:top}
    thead th{background:#141414;text-align:left;color:#ddd;position:sticky;top:0}
    tbody tr:hover{background:#121212}
    .mono{font-variant-numeric:tabular-nums}
    .right{text-align:right}
    .muted{color:var(--muted)}

    /* Vector charts (no blur) */
    .chart{width:100%;height:auto;display:block}
    .legend{display:flex;gap:10px;align-items:center;font-size:.78rem;color:#cfcfcf}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .lg{width:10px;height:10px;border-radius:2px;background:#ffbd59;border:1px solid #6a4e23}
    .lg2{width:10px;height:10px;border-radius:2px;background:#4aa86a;border:1px solid #2c5a3a}

    .pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#111;border:1px solid #2a2a2a;margin:2px;font-size:.78rem;color:#ddd}

    @media (max-width: 980px){
      .card{grid-column:span 12}
      .card.s{grid-column:span 12}
    }
    @media (min-width:1600px){
      .grid{grid-template-columns:repeat(16,minmax(0,1fr))}
      .card{grid-column:span 8}
      .card.s{grid-column:span 4}
      .card.l{grid-column:span 16}
    }
  </style>
</head>
<body>
  <header><h1>Team Report — Compact Dashboard</h1></header>

  <div class="shell">
    <div class="controls">
      <label class="muted">Team
        <select id="teamSelect"></select>
      </label>
      <label class="muted">Tournament
        <select id="tournSelect"></select>
      </label>
      <span class="chip" id="meta">Loading…</span>
    </div>

    <div class="grid">
      <!-- KPI -->
      <div class="card l" id="kpiCard">
        <h3>Overview</h3>
        <div class="kpis" id="kpis"></div>
      </div>

      <!-- Most Banned -->
      <div class="card s" id="banCard">
        <h3>Most Banned (Count)</h3>
        <div id="banChartWrap"></div>
      </div>

      <!-- Performance by Map -->
      <div class="card s" id="mapCard">
        <h3>Performance by Map</h3>
        <div class="legend" style="margin-bottom:4px"><span><i class="lg"></i> Matches</span><span><i class="lg2"></i> Wins</span></div>
        <div id="mapChartWrap"></div>
      </div>

      <!-- Top Active Combos -->
      <div class="card l" id="comboCard">
        <h3>Top Active Combos</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Combo (4× Active)</th><th class="right">Picks</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th><th>Top Maps</th></tr></thead>
            <tbody id="comboBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Opponents -->
      <div class="card s" id="oppCard">
        <h3>Performance by Opponent</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Opponent</th><th class="right">Matches</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="oppBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Top Actives -->
      <div class="card s" id="actCard">
        <h3>Top Active Skills</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="actBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Top Passives -->
      <div class="card s" id="pasCard">
        <h3>Top Passive Skills</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="pasBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Ban Impact -->
      <div class="card s" id="biCard">
        <h3>Ban Impact (Δ Win %)</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Banned</th><th class="right">Win% (banned)</th><th class="right">Win% (not)</th><th class="right">Δ</th></tr></thead>
            <tbody id="biBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Recent Matches -->
      <div class="card l" id="recentCard">
        <h3>Recent Matches</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Date</th><th>Map</th><th>Opponent</th><th class="right">Score</th><th class="right">Res</th><th>Ban</th></tr></thead>
            <tbody id="recentBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= Supabase ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

/* ========= Utils ========= */
const PLACEHOLDER='https://imgur.com/AdvPwAO.png';
const pct=(n,d)=> d? ((n/d)*100).toFixed(1)+'%':'—';
const fmtP=(x)=> (x*100).toFixed(1)+'%';
const uniq=(a)=>[...new Set(a)];
function ymd(d){const dt=new Date(d);if(!d||isNaN(dt))return '';return dt.toISOString().slice(0,10)}
function parseState(v){if(!v) return {}; if (typeof v==='object') return v; try{return JSON.parse(v)}catch{ return {} }}

/* ========= Vector micro-charts with dynamic label width & font ========= */
function measureWrap(el, fallback=360){ return Math.max(220, el?.clientWidth || fallback); }
function guessLabelW(labels, fs){ const maxLen = Math.max(0, ...labels.map(s=>String(s).length)); return Math.min(160, Math.max(70, maxLen * (fs*0.62))); }

function barH(labels, values, opts={}){
  const W = opts.width || 360;
  const fs = opts.fontSize || 10;                   // px
  const labelW = opts.labelW ?? guessLabelW(labels, fs);
  const pad = 4, row = 12, gap = 2;
  const H = Math.max(36, labels.length*(row+gap) + pad*2);
  const max = Math.max(1, ...values);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - 18));

  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  labels.forEach((lb,i)=>{
    const y = pad + i*(row+gap);
    const w = scale(values[i]);
    svg.push(`<text x="2" y="${y+fs-1}" font-size="${fs}" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${w}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + w + 4}" y="${y+fs-1}" font-size="${fs}" fill="#ccc" class="mono">${values[i]}</text>`);
  });
  svg.push(`</svg>`);
  return svg.join('');
}

function groupedBars(labels, aVals, bVals, opts={}){
  const W = opts.width || 380;
  const fs = opts.fontSize || 10;
  const labelW = opts.labelW ?? guessLabelW(labels, fs);
  const pad = 6, row = 11, gap = 2, grpGap = 5;
  const H = Math.max(36, labels.length*(row+gap) + labels.length*grpGap + pad*2);
  const max = Math.max(1, ...aVals, ...bVals);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - 20));

  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  let y = pad;
  labels.forEach((lb, i)=>{
    const a = scale(aVals[i]), b = scale(bVals[i]);
    svg.push(`<text x="2" y="${y+fs-1}" font-size="${fs}" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${a}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    y += row + gap;
    svg.push(`<rect x="${labelW}" y="${y}" width="${b}" height="${row}" fill="#4aa86a" stroke="#2c5a3a" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + Math.max(a,b) + 4}" y="${y-3}" font-size="${fs-1}" fill="#bbb" class="mono">${aVals[i]}/${bVals[i]}</text>`);
    y += row + grpGap;
  });
  svg.push(`</svg>`);
  return svg.join('');
}

/* ========= Data plumbing ========= */
let ALL_RECORDS=[]; // raw
let CURR_ROWS=[];   // filtered to team + tourn

async function fetchAll(){
  const { data, error } = await client
    .from('draft_records')
    .select('id, match_date, map, team_left, team_right, team_left_score, team_right_score, state, tournament_name')
    .order('match_date', { ascending:false })
    .order('id',{ ascending:false });
  if(error){ console.error(error); alert('Failed to load records: '+error.message); return [] }
  return data||[];
}

function explodeRecordToRows(rec){
  const s=parseState(rec.state);
  const picks=Array.isArray(s.picks)?s.picks:[]; const passives=Array.isArray(s.passives)?s.passives:[]; const bans=Array.isArray(s.bans)?s.bans:[];
  const leftWin=(rec.team_left_score??0)>(rec.team_right_score??0);
  const rightWin=(rec.team_right_score??0)>(rec.team_left_score??0);
  function side(isLeft){
    const team=isLeft?rec.team_left:rec.team_right;
    const opp =isLeft?rec.team_right:rec.team_left;
    const ts  =isLeft?(rec.team_left_score??0):(rec.team_right_score??0);
    const os  =isLeft?(rec.team_right_score??0):(rec.team_left_score??0);
    const res =(isLeft?leftWin:rightWin)?'W':'L';
    const ban=(bans[isLeft?0:1]||{});
    const idx=isLeft?[0,1,2,3]:[7,6,5,4];
    const act=idx.map(i=>({hero:(picks[i]?.name)||'', img:(picks[i]?.image_url)||PLACEHOLDER}));
    const pas=idx.map(i=>Array.isArray(passives[i])?passives[i].map(x=>x?.name||'').filter(Boolean):[]);
    return {rec_id:rec.id,date:ymd(rec.match_date),map:rec.map,team,opp,ts,os,res,ban:ban.name||'',act,pass:pas,tourn:rec.tournament_name||''};
  }
  return [side(true), side(false)];
}

function teamsFrom(records){
  const S=new Set(); records.forEach(r=>{ if(r.team_left)S.add(r.team_left); if(r.team_right)S.add(r.team_right) }); return [...S].sort();
}
function tournamentsFrom(records){
  // return [{name,lastDate}, ...] sorted by lastDate desc
  const m = new Map();
  records.forEach(r=>{
    const nm = r.tournament_name || '';
    if(!nm) return;
    const d = String(r.match_date||'');
    const t = m.get(nm);
    if(!t || d > t) m.set(nm, d);
  });
  return [...m.entries()].map(([name,lastDate])=>({name,lastDate})).sort((a,b)=> b.lastDate.localeCompare(a.lastDate));
}

function rowsForTeam(records, team, tournSel){
  return records.flatMap(explodeRecordToRows)
    .filter(r=>r.team===team)
    .filter(r=> tournSel==='__ALL__' ? true : r.tourn===tournSel);
}

/* ========= Aggregations ========= */
const kpis = (rows)=>{
  const matches=rows.length, wins=rows.filter(r=>r.res==='W').length, winpct=matches?wins/matches:0;
  const diffAvg=matches? (rows.reduce((a,r)=>a+(r.ts-r.os),0)/matches):0;
  const maps=uniq(rows.map(r=>r.map)).length, opps=uniq(rows.map(r=>r.opp)).length;
  return {matches,wins,winpct,diffAvg,maps,opps};
};
const mostBanned = rows => {
  const m=new Map(); rows.forEach(r=>{ const b=r.ban||''; if(!b)return; m.set(b,(m.get(b)||0)+1) });
  const arr=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10); return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
};
const perfByMap = rows => {
  const m=new Map();
  rows.forEach(r=>{ if(!m.has(r.map)) m.set(r.map,{m:0,w:0}); const o=m.get(r.map); o.m++; if(r.res==='W') o.w++; });
  return [...m.entries()].map(([name,o])=>({name,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.name.localeCompare(b.name));
};
const topCombos = rows => {
  const combos=new Map();
  rows.forEach(r=>{
    const names=r.act.map(a=>a.hero).filter(Boolean);
    if(names.length!==4) return;
    const key=names.slice().sort((a,b)=>a.localeCompare(b)).join('|');
    if(!combos.has(key)) combos.set(key,{names:key.split('|'), picks:0,wins:0,maps:new Map()});
    const C=combos.get(key); C.picks++; if(r.res==='W')C.wins++; C.maps.set(r.map,(C.maps.get(r.map)||0)+1);
  });
  return [...combos.values()].map(c=>({
    ...c, winpct:c.picks?c.wins/c.picks:0,
    topMaps:[...c.maps.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]} ×${x[1]}`).join(', ')
  })).sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,10);
};
const topActives = rows => {
  const S=new Map(); rows.forEach(r=>{ r.act.forEach(a=>{ if(!a.hero)return; if(!S.has(a.hero))S.set(a.hero,{p:0,w:0}); const o=S.get(a.hero); o.p++; if(r.res==='W')o.w++; }) });
  const den=rows.length*4;
  return [...S.entries()].map(([name,o])=>({name,picks:o.p, pickRate: den?o.p/den:0, wins:o.w, winRate: o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
};
const topPassives = rows => {
  const S=new Map(); rows.forEach(r=>{ r.pass.forEach(trio=>trio.forEach(n=>{ if(!n)return; if(!S.has(n))S.set(n,{p:0,w:0}); const o=S.get(n); o.p++; if(r.res==='W')o.w++; })) });
  const den=rows.length*12;
  return [...S.entries()].map(([name,o])=>({name,picks:o.p, pickRate: den?o.p/den:0, wins:o.w, winRate: o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
};
const perfByOpponent = rows => {
  const m=new Map(); rows.forEach(r=>{ if(!m.has(r.opp)) m.set(r.opp,{m:0,w:0}); const o=m.get(r.opp); o.m++; if(r.res==='W')o.w++; });
  return [...m.entries()].map(([opp,o])=>({opp,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.opp.localeCompare(b.opp)).slice(0,20);
};
const banImpactAgg = rows => {
  const skills=new Map(); rows.forEach(r=>{ if(!r.ban) return; if(!skills.has(r.ban)) skills.set(r.ban,{ban:{n:0,w:0}, noban:{n:0,w:0}}); const S=skills.get(r.ban); S.ban.n++; if(r.res==='W') S.ban.w++; });
  const names=[...skills.keys()];
  rows.forEach(r=>{ names.forEach(n=>{ if(r.ban!==n){ const S=skills.get(n); S.noban.n++; if(r.res==='W')S.noban.w++; }}) });
  return [...skills.entries()].map(([name,S])=>{
    const w1=S.ban.n?S.ban.w/S.ban.n:0; const w2=S.noban.n?S.noban.w/S.noban.n:0; return {name,banned:S.ban.n, wBan:w1, wNot:w2, delta:w1-w2};
  }).sort((a,b)=>b.delta-a.delta||b.banned-a.banned).slice(0,12);
};
const recent = rows => rows.slice().sort((a,b)=> (b.date.localeCompare(a.date)) || (b.rec_id-a.rec_id)).slice(0,12);

/* ========= Renderers ========= */
function renderKPIs(rows){
  const k=kpis(rows);
  document.getElementById('kpis').innerHTML = `
    <div class="kpi">Matches <b>${k.matches}</b></div>
    <div class="kpi">Wins <b>${k.wins}</b> <span class="muted">(${pct(k.wins,k.matches)})</span></div>
    <div class="kpi">Avg Score Diff <b>${k.diffAvg.toFixed(2)}</b></div>
    <div class="kpi">Maps <b>${k.maps}</b></div>
    <div class="kpi">Opponents <b>${k.opps}</b></div>`;
}

function renderMostBanned(rows){
  const {labels, values}=mostBanned(rows);
  const wrap=document.getElementById('banChartWrap');
  if(!labels.length){ wrap.innerHTML = `<div class="muted">No bans recorded for this team.</div>`; return; }
  const W = measureWrap(wrap, 360), fs = Math.max(9, Math.min(12, W/48));
  wrap.innerHTML = barH(labels, values, {width: W, fontSize: fs});
}

function renderPerfByMap(rows){
  const data=perfByMap(rows), wrap=document.getElementById('mapChartWrap');
  if(!data.length){ wrap.innerHTML='<div class="muted">No map data.</div>'; return; }
  const labels=data.map(x=>x.name), matches=data.map(x=>x.matches), wins=data.map(x=>x.wins);
  const W = measureWrap(wrap, 380), fs = Math.max(9, Math.min(12, W/52));
  wrap.innerHTML = groupedBars(labels, matches, wins, {width: W, fontSize: fs});
}

function renderCombos(rows){
  const list=topCombos(rows);
  const tbody=document.getElementById('comboBody'); tbody.innerHTML='';
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="5" class="muted">No combos found.</td></tr>`; return; }
  list.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="muted">${c.names.join(' · ')}</td><td class="right mono">${c.picks}</td><td class="right mono">${c.wins}</td><td class="right mono">${fmtP(c.winpct)}</td><td>${c.topMaps||'—'}</td>`;
    tbody.appendChild(tr);
  });
}
function renderOpp(rows){
  const list=perfByOpponent(rows), tb=document.getElementById('oppBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="4" class="muted">No opponent data.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.opp}</td><td class="right mono">${r.matches}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winpct)}</td>`;
    tb.appendChild(tr);
  })
}
function renderTopAct(rows){
  const list=topActives(rows), tb=document.getElementById('actBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">No active picks.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  })
}
function renderTopPas(rows){
  const list=topPassives(rows), tb=document.getElementById('pasBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">No passive picks.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  })
}
function renderBanImpact(rows){
  const list=banImpactAgg(rows), tb=document.getElementById('biBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">Not enough ban data.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.banned}</td><td class="right mono">${fmtP(r.wBan)}</td><td class="right mono">${fmtP(r.wNot)}</td><td class="right mono" style="font-weight:700;">${fmtP(r.delta)}</td>`;
    tb.appendChild(tr);
  })
}
function renderRecent(rows){
  const list=recent(rows), tb=document.getElementById('recentBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="muted">No recent matches.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    const score=`${r.ts}-${r.os}`;
    const wl=r.res==='W'?`<span style="color:var(--good);font-weight:700">W</span>`:`<span style="color:var(--bad);font-weight:700">L</span>`;
    tr.innerHTML=`<td>${r.date}</td><td>${r.map}</td><td>${r.opp}</td><td class="right mono">${score}</td><td class="right">${wl}</td><td>${r.ban||'—'}</td>`;
    tb.appendChild(tr);
  })
}

/* ========= Orchestrator ========= */
let CURRENT_TEAM = '';
let CURRENT_TOURN = '__ALL__';

async function init(){
  ALL_RECORDS = await fetchAll();

  // Populate team select
  const teams = teamsFrom(ALL_RECORDS);
  const teamSel=document.getElementById('teamSelect');
  teamSel.innerHTML = teams.map(t=>`<option value="${t}">${t}</option>`).join('');

  // Populate tournament select; default = latest
  const tournSel=document.getElementById('tournSelect');
  const tourns = tournamentsFrom(ALL_RECORDS);
  const latest = tourns[0]?.name || '__ALL__';
  tournSel.innerHTML = `<option value="__ALL__">All tournaments</option>` +
                       tourns.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
  tournSel.value = latest;                       // auto-init to latest
  CURRENT_TOURN = tournSel.value;

  // Set initial team
  const qTeam = new URLSearchParams(location.search).get('team');
  const startTeam = (qTeam && teams.includes(qTeam)) ? qTeam : (teams[0] || '');
  teamSel.value = startTeam;
  CURRENT_TEAM = startTeam;

  teamSel.addEventListener('change', ()=>{ CURRENT_TEAM = teamSel.value; load(); });
  tournSel.addEventListener('change', ()=>{ CURRENT_TOURN = tournSel.value; load(); });

  load();

  // Re-render charts on resize to stop label/text clipping
  window.addEventListener('resize', ()=>{
    renderMostBanned(CURR_ROWS);
    renderPerfByMap(CURR_ROWS);
  });
}

function setMeta(team, rows){
  const t = rows.length;
  const tourns = new Set();
  ALL_RECORDS.forEach(r=>{ if(r.team_left===team||r.team_right===team) tourns.add(r.tournament_name||'') });
  const tLabel = (CURRENT_TOURN==='__ALL__') ? 'All tournaments' : CURRENT_TOURN;
  document.getElementById('meta').textContent = `${team} • ${t} team-rows • ${tLabel} • ${tourns.size} tournament(s) total`;
}

function load(){
  CURR_ROWS = rowsForTeam(ALL_RECORDS, CURRENT_TEAM, CURRENT_TOURN);
  setMeta(CURRENT_TEAM, CURR_ROWS);
  renderKPIs(CURR_ROWS);
  renderMostBanned(CURR_ROWS);
  renderPerfByMap(CURR_ROWS);
  renderCombos(CURR_ROWS);
  renderOpp(CURR_ROWS);
  renderTopAct(CURR_ROWS);
  renderTopPas(CURR_ROWS);
  renderBanImpact(CURR_ROWS);
  renderRecent(CURR_ROWS);
}

init();
</script>
</body>
</html>
