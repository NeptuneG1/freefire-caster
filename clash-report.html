<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Report Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Optional: nicer Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070707;
      --bg2:#0c0c0c;

      --panel:#121212;
      --panel2:#161616;

      --ink:#f2f2f2;
      --muted:#a8a8a8;
      --muted2:#8a8a8a;

      --brand:#ffbd59;
      --brand2:#ff7733;
      --line:rgba(255,255,255,.08);

      --good:#71d083;
      --bad:#ff6b6b;

      --radius:14px;
      --radius-sm:10px;
      --shadow: 0 10px 28px rgba(0,0,0,.45);
      --shadow-soft: 0 6px 16px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html{font-size:clamp(12px, 0.75vw + 8px, 16px);}
    body{
      margin:0;
      color:var(--ink);
      font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 18% -10%, rgba(255,189,89,.18), transparent 55%),
        radial-gradient(1100px 650px at 85% 0%, rgba(255,119,51,.12), transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    header{
      position:sticky; top:0; z-index:10;
      background:rgba(12,12,12,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,189,89,.28);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    header .hdr{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      max-width:min(1600px,98vw); margin:0 auto;
    }
    h1{
      margin:0;
      font-size:clamp(1rem,1.2vw,1.18rem);
      color:var(--brand);
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .hdr small{
      color:var(--muted);
      font-weight:600;
      font-size:.82rem;
      white-space:nowrap;
    }

    .shell{max-width:min(1600px,98vw);margin:12px auto;padding:0 10px}

    /* Top toolbar */
    .bar{
      display:flex;align-items:center;gap:10px;
      background:linear-gradient(180deg, rgba(22,22,22,.92), rgba(14,14,14,.92));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px 10px;
      box-shadow: var(--shadow-soft);
    }

    .btn{
      display:inline-flex;align-items:center;gap:10px;
      background:linear-gradient(180deg, #ffcf78, var(--brand));
      color:#151515;
      border:1px solid rgba(255,189,89,.55);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      text-decoration:none;
      box-shadow:0 2px 0 rgba(0,0,0,.35);
      transition:transform .06s ease, filter .15s ease;
      white-space:nowrap;
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn:active{ transform:translateY(1px); }

    .controls{
      margin-left:auto;
      display:flex;flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    label{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700;font-size:.86rem}

    .selectWrap{
      position:relative;
      display:inline-flex;
      align-items:center;
    }
    select{
      appearance:none;
      background:linear-gradient(180deg, rgba(18,18,18,.98), rgba(10,10,10,.98));
      color:#ffe7c5;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:9px 34px 9px 10px;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
      outline:none;
      min-width: 210px;
    }
    .selectWrap:after{
      content:"▾";
      position:absolute;
      right:10px;
      color:rgba(255,255,255,.65);
      pointer-events:none;
      font-size:12px;
      transform:translateY(-1px);
    }
    select:focus{
      border-color:rgba(255,189,89,.55);
      box-shadow:0 0 0 3px rgba(255,189,89,.14);
    }

    .chip{
      color:var(--muted);
      font-size:.82rem;
      font-weight:700;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }

    @media (max-width:980px){
      .bar{flex-wrap:wrap}
      .btn{width:100%;justify-content:center}
      .controls{margin-left:0;width:100%;justify-content:space-between}
      select{min-width: min(100%, 520px); width:100%;}
      label{width:100%; justify-content:space-between;}
      .selectWrap{width:100%;}
      .chip{width:100%; text-align:center;}
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
      grid-auto-flow:dense;
      align-items:start;
    }

    .card{
      position:relative;
      background:
        radial-gradient(1000px 240px at 30% -40%, rgba(255,189,89,.10), transparent 60%),
        linear-gradient(180deg, rgba(20,20,20,.95), rgba(14,14,14,.95));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    /* Accent strip */
    .card:before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:3px;
      background:linear-gradient(180deg, rgba(255,189,89,.9), rgba(255,119,51,.65));
      opacity:.55;
    }

    .card.q{grid-column:span 3;}
    .card.h{grid-column:span 6;}
    .card.l{grid-column:span 12;}

    .card h3{
      margin:0 0 8px 0;
      color:#ffd59a;
      font-size:clamp(.92rem,1vw,1rem);
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    /* Charts: remove forced tall min-height so no empty blocks */
    .chartcard{min-height:auto;}
    .chart{width:100%;height:auto;display:block;overflow:visible}

    .legend{
      display:flex;gap:10px;align-items:center;
      font-size:.78rem;color:#cfcfcf;
      margin-bottom:6px;
    }
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .lg{width:10px;height:10px;border-radius:3px;background:#ffbd59;border:1px solid #6a4e23}
    .lg2{width:10px;height:10px;border-radius:3px;background:#4aa86a;border:1px solid #2c5a3a}

    /* KPI row: more compact + grid-like */
    .kpis{
      display:grid;
      grid-template-columns:repeat(5, minmax(0, 1fr));
      gap:8px;
    }
    .kpi{
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:8px 10px;
      font-size:.86rem;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      min-width:0;
      white-space:nowrap;
    }
    .kpi b{font-size:1.05rem}
    @media (max-width:980px){
      .kpis{grid-template-columns:repeat(2, minmax(0, 1fr));}
    }

    /* Tables */
    .twrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.18);
    }
    /* Keep page sleek: scroll inside cards instead of endless height */
    .card.h .twrap{max-height:340px;}
    .card.l .twrap{max-height:420px;}

    table{width:100%;border-collapse:collapse;font-size:clamp(.78rem,.9vw,.9rem);min-width:560px}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:7px 8px;
      vertical-align:middle;
      line-height:1.25;
    }
    thead th{
      background:rgba(15,15,15,.9);
      text-align:left;
      color:#e6e6e6;
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(6px);
    }
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    tbody tr:hover{background:rgba(255,189,89,.06)}
    .mono{font-variant-numeric:tabular-nums}
    .right{text-align:right}
    .muted{color:var(--muted)}

    /* Skill chips / icons */
    .cell-skill{display:flex;align-items:center;gap:8px}
    .cell-icons{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .avatar{width:18px;height:18px;border-radius:5px;object-fit:cover;background:#222;border:1px solid rgba(255,255,255,.10)}
    .avatar.s{width:16px;height:16px;border-radius:4px}
    .pill{
      display:inline-block;padding:2px 7px;border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      margin:2px;font-size:.76rem;color:#ddd
    }

    /* Mobile / responsive */
    @media (max-width: 980px){
      .card.q,.card.h,.card.l{grid-column:span 12}
      table{min-width:520px}
    }
    @media (min-width:1600px){
      .grid{grid-template-columns:repeat(16,minmax(0,1fr))}
      .card.q{grid-column:span 4}
      .card.h{grid-column:span 8}
      .card.l{grid-column:span 16}
    }
  </style>
</head>

<body>
  <header>
    <div class="hdr">
      <h1>Clash Squad — Team Report</h1>
      <small class="muted">Sleek view • dense layout</small>
    </div>
  </header>

  <div class="shell">
    <div class="bar">
      <a class="btn" href="dashboard.html"><span aria-hidden="true">←</span> Back to Dashboard</a>

      <div class="controls">
        <label>
          Tournament
          <span class="selectWrap">
            <select id="tournSelect" aria-label="Tournament"></select>
          </span>
        </label>

        <label>
          Team
          <span class="selectWrap">
            <select id="teamSelect" aria-label="Team"></select>
          </span>
        </label>

        <span class="chip" id="meta">Loading…</span>
      </div>
    </div>

    <div class="grid">
      <!-- Overview -->
      <div class="card l" id="kpiCard">
        <h3>Overview</h3>
        <div class="kpis" id="kpis"></div>
      </div>

      <!-- Charts row -->
      <div class="card q chartcard" id="actPickCard">
        <h3>Most Pick Active</h3>
        <div id="actPickWrap"></div>
      </div>
      <div class="card q chartcard" id="pasPickCard">
        <h3>Most Pick Passive</h3>
        <div id="pasPickWrap"></div>
      </div>
      <div class="card q chartcard" id="banCard">
        <h3>Most Banned (Count)</h3>
        <div id="banChartWrap"></div>
      </div>
      <div class="card q chartcard" id="mapCard">
        <h3>Performance by Map</h3>
        <div class="legend">
          <span><i class="lg"></i> Matches</span>
          <span><i class="lg2"></i> Wins</span>
        </div>
        <div id="mapChartWrap"></div>
      </div>

      <!-- Side-by-side tables -->
      <div class="card h" id="comboCard">
        <h3>Top Active Combos</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Combo (4× Active)</th><th class="right">Picks</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th><th>Top Maps</th></tr></thead>
            <tbody id="comboBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card h" id="ptrioCard">
        <h3>Top Passive Trio</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Trio (3× Passive)</th><th class="right">Picks</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th><th>Top Maps</th></tr></thead>
            <tbody id="ptrioBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card h" id="actCard">
        <h3>Top Active Skills</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="actBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card h" id="pasCard">
        <h3>Top Passive Skills</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="pasBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card h" id="oppCard">
        <h3>Performance by Opponent</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Opponent</th><th class="right">Matches</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
            <tbody id="oppBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card h" id="biCard">
        <h3>Ban Impact (Δ Win %)</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Skill</th><th class="right">Banned</th><th class="right">Win% (banned)</th><th class="right">Win% (not)</th><th class="right">Δ</th></tr></thead>
            <tbody id="biBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card l" id="recentCard">
        <h3>Recent Matches</h3>
        <div class="twrap">
          <table>
            <thead><tr><th>Date</th><th>Map</th><th>Opponent</th><th class="right">Score</th><th class="right">Res</th><th>Ban</th></tr></thead>
            <tbody id="recentBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= Supabase ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

/* ========= Utils ========= */
const PLACEHOLDER='https://imgur.com/AdvPwAO.png';
const ALL_TEAMS='__ALL_TEAMS__';
const pct=(n,d)=> d? ((n/d)*100).toFixed(1)+'%':'—';
const fmtP=(x)=> (x*100).toFixed(1)+'%';
const uniq=(a)=>[...new Set(a)];
function ymd(d){const dt=new Date(d);if(!d||isNaN(dt))return '';return dt.toISOString().slice(0,10)}
function parseState(v){if(!v) return {}; if (typeof v==='object') return v; try{return JSON.parse(v)}catch{ return {} }}

/* ========= Micro SVGs ========= */
function barH(labels, values, opts={}){
  const W = opts.width || 380;
  const labelW = 120;
  const pad = 4, row = 14, gap = 3;
  const H = Math.max(40, labels.length*(row+gap) + pad*2);
  const max = Math.max(1, ...values);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - 20));
  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  labels.forEach((lb,i)=>{
    const y = pad + i*(row+gap);
    const w = scale(values[i]);
    svg.push(`<text x="2" y="${y+10}" font-size="11" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${w}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + w + 4}" y="${y+10}" font-size="10" fill="#cfcfcf" class="mono">${values[i]}</text>`);
  });
  svg.push(`</svg>`);
  return svg.join('');
}

function groupedBars(labels, aVals, bVals, opts={}){
  const W = opts.width || 400;
  const labelW = 130;
  const rightPad = 86;
  const pad = 6, row = 12, gap = 2, grpGap = 6;
  const H = Math.max(40, labels.length*(row+gap) + labels.length*grpGap + pad*2);
  const max = Math.max(1, ...aVals, ...bVals);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - rightPad));

  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  let y = pad;
  labels.forEach((lb, i)=>{
    const a = scale(aVals[i]);
    const b = scale(bVals[i]);
    const wr = aVals[i] ? ((bVals[i]/aVals[i])*100).toFixed(1)+'%' : '—';

    svg.push(`<text x="2" y="${y+10}" font-size="11" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${a}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    y += row + gap;
    svg.push(`<rect x="${labelW}" y="${y}" width="${b}" height="${row}" fill="#4aa86a" stroke="#2c5a3a" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + Math.max(a,b) + 6}" y="${y-2}" font-size="10" fill="#bbb" class="mono">${bVals[i]}/${aVals[i]} (${wr})</text>`);
    y += row + grpGap;
  });
  svg.push(`</svg>`);
  return svg.join('');
}

/* ========= Data plumbing ========= */
let ALL_RECORDS=[];

function explodeRecordToRows(rec){
  const s=parseState(rec.state);
  const picks=Array.isArray(s.picks)?s.picks:[];
  const passives=Array.isArray(s.passives)?s.passives:[];
  const bans=Array.isArray(s.bans)?s.bans:[];

  const leftWin=(rec.team_left_score??0)>(rec.team_right_score??0);
  const rightWin=(rec.team_right_score??0)>(rec.team_left_score??0);

  function side(isLeft){
    const team = isLeft? rec.team_left : rec.team_right;
    const opp  = isLeft? rec.team_right : rec.team_left;
    const ts   = isLeft? (rec.team_left_score??0) : (rec.team_right_score??0);
    const os   = isLeft? (rec.team_right_score??0) : (rec.team_left_score??0);
    const res  = (isLeft?leftWin:rightWin)?'W':'L';
    const ban  = bans[isLeft?0:1] || {};
    const idx  = isLeft? [0,1,2,3] : [7,6,5,4];

    const act  = idx.map(i=>({
      hero: (picks[i]?.name)||'',
      img : (picks[i]?.image_url)||PLACEHOLDER
    }));

    const pas  = idx.map(i=>{
      const arr = Array.isArray(passives[i]) ? passives[i] : [];
      return arr.map(x=>({name:x?.name||'', img:x?.image_url||PLACEHOLDER})).filter(x=>x.name);
    });

    return {
      rec_id:rec.id,
      date:ymd(rec.match_date),
      map:rec.map,
      team,opp,ts,os,res,
      banName: ban?.name || '',
      banImg : ban?.image_url || PLACEHOLDER,
      act,
      pass:pas
    };
  }
  return [side(true), side(false)];
}

async function fetchAll(){
  const { data, error } = await client
    .from('draft_records')
    .select('id, match_date, map, team_left, team_right, team_left_score, team_right_score, state, tournament_name')
    .order('match_date', { ascending:false })
    .order('id',{ ascending:false });
  if(error){ console.error(error); alert('Failed to load records: '+error.message); return [] }
  return data||[];
}

/* ========= Filters ========= */
function tournamentsFrom(records){
  const map = new Map();
  records.forEach(r=>{
    const t = r.tournament_name || '—';
    const d = new Date(r.match_date);
    if(!map.has(t)) map.set(t, {name:t, first:d, last:d});
    const o = map.get(t); if(d<o.first) o.first=d; if(d>o.last) o.last=d;
  });
  return [...map.values()].sort((a,b)=> b.last - a.last);
}

function teamsForTournament(records, tournName){
  const S = new Set();
  records.forEach(r=>{
    if(tournName && tournName!=='__ALL__' && (r.tournament_name||'—')!==tournName) return;
    if(r.team_left) S.add(r.team_left);
    if(r.team_right) S.add(r.team_right);
  });
  return [...S].sort((a,b)=>a.localeCompare(b));
}

function rowsForTeamAndTournament(records, team, tournName){
  const inTourn = (r) => (tournName==='__ALL__') || ((r.tournament_name||'—')===tournName);
  const filtered = records.filter(inTourn).flatMap(explodeRecordToRows);

  if(team === ALL_TEAMS) return filtered;
  return filtered.filter(r=>r.team===team);
}

/* ========= Aggregations ========= */
function kpis(rows){
  const matches=rows.length;
  const wins=rows.filter(r=>r.res==='W').length;
  const winpct=matches?wins/matches:0;
  const diffAvg=matches? (rows.reduce((a,r)=>a+(r.ts-r.os),0)/matches):0;
  const maps=uniq(rows.map(r=>r.map)).length;
  const opps=uniq(rows.map(r=>r.opp)).length;
  return {matches,wins,winpct,diffAvg,maps,opps};
}
function mostBanned(rows){
  const m=new Map();
  rows.forEach(r=>{ const b=r.banName||''; if(!b)return; m.set(b,(m.get(b)||0)+1); });
  const arr=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
}
function perfByMap(rows){
  const m=new Map();
  rows.forEach(r=>{ if(!m.has(r.map)) m.set(r.map,{m:0,w:0}); const o=m.get(r.map); o.m++; if(r.res==='W') o.w++; });
  return [...m.entries()].map(([name,o])=>({name,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.name.localeCompare(b.name));
}
function mostPickActive(rows){
  const m=new Map();
  rows.forEach(r=>r.act.forEach(a=>{
    if(!a.hero) return;
    m.set(a.hero,(m.get(a.hero)||0)+1);
  }));
  const arr=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
}
function mostPickPassive(rows){
  const m=new Map();
  rows.forEach(r=>r.pass.forEach(trio=>trio.forEach(ps=>{
    if(!ps?.name) return;
    m.set(ps.name,(m.get(ps.name)||0)+1);
  })));
  const arr=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
}

function topCombos(rows){
  const combos=new Map();
  rows.forEach(r=>{
    const names=r.act.map(a=>a.hero).filter(Boolean);
    const imgMap=new Map(); r.act.forEach(a=>{ if(a.hero&&!imgMap.has(a.hero)) imgMap.set(a.hero,a.img||PLACEHOLDER); });
    if(names.length!==4) return;
    const key=names.slice().sort((a,b)=>a.localeCompare(b)).join('|');
    if(!combos.has(key)) combos.set(key,{names:key.split('|'), heroImgs:Object.fromEntries([...imgMap]), picks:0,wins:0,maps:new Map()});
    const C=combos.get(key); C.picks++; if(r.res==='W')C.wins++; C.maps.set(r.map,(C.maps.get(r.map)||0)+1);
  });
  return [...combos.values()].map(c=>({
    ...c, winpct:c.picks?c.wins/c.picks:0,
    topMaps:[...c.maps.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]} ×${x[1]}`).join(', ')
  })).sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,10);
}

function normalizeTrio(arr){
  const names=(arr||[]).map(x=>x?.name||'').filter(Boolean);
  if(names.length!==3) return null;
  const imgs={}; (arr||[]).forEach(x=>{ if(x?.name) imgs[x.name]=x.img||PLACEHOLDER; });
  const sorted=[...names].sort((a,b)=>a.localeCompare(b));
  return {key:sorted.join('|'), names:sorted, imgs};
}
function topPassiveTrios(rows){
  const M=new Map();
  rows.forEach(r=>{
    r.pass.forEach(tr=>{
      const n=normalizeTrio(tr); if(!n) return;
      if(!M.has(n.key)) M.set(n.key,{names:n.names, imgs:n.imgs, picks:0,wins:0,maps:new Map()});
      const T=M.get(n.key); T.picks++; if(r.res==='W')T.wins++; T.maps.set(r.map,(T.maps.get(r.map)||0)+1);
    });
  });
  return [...M.values()].map(T=>({
    ...T, winpct:T.picks?T.wins/T.picks:0,
    topMaps:[...T.maps.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]} ×${x[1]}`).join(', ')
  })).sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,10);
}

function topActives(rows){
  const S=new Map(); const IMG=new Map();
  rows.forEach(r=>{ r.act.forEach(a=>{
    if(!a.hero) return;
    if(!S.has(a.hero)) S.set(a.hero,{p:0,w:0});
    if(!IMG.has(a.hero)) IMG.set(a.hero, a.img||PLACEHOLDER);
    const o=S.get(a.hero); o.p++; if(r.res==='W')o.w++;
  })});
  const den=rows.length*4;
  return [...S.entries()].map(([name,o])=>({name,img:IMG.get(name),picks:o.p, pickRate:den?o.p/den:0, wins:o.w, winRate:o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
}
function topPassives(rows){
  const S=new Map(); const IMG=new Map();
  rows.forEach(r=>{ r.pass.forEach(trio=>trio.forEach(ps=>{
    if(!ps?.name) return;
    if(!S.has(ps.name)) S.set(ps.name,{p:0,w:0});
    if(!IMG.has(ps.name)) IMG.set(ps.name, ps.img||PLACEHOLDER);
    const o=S.get(ps.name); o.p++; if(r.res==='W')o.w++;
  }))});
  const den=rows.length*12;
  return [...S.entries()].map(([name,o])=>({name,img:IMG.get(name),picks:o.p, pickRate:den?o.p/den:0, wins:o.w, winRate:o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
}

function perfByOpponent(rows){
  const m=new Map();
  rows.forEach(r=>{ if(!m.has(r.opp)) m.set(r.opp,{m:0,w:0}); const o=m.get(r.opp); o.m++; if(r.res==='W')o.w++; });
  return [...m.entries()].map(([opp,o])=>({opp,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.opp.localeCompare(b.opp)).slice(0,20);
}

function banImpactAgg(rows){
  const skills=new Map(); const IMG=new Map();
  rows.forEach(r=>{
    if(!r.banName) return;
    if(!skills.has(r.banName)) skills.set(r.banName,{ban:{n:0,w:0},noban:{n:0,w:0}});
    if(!IMG.has(r.banName)) IMG.set(r.banName, r.banImg||PLACEHOLDER);
    const S=skills.get(r.banName); S.ban.n++; if(r.res==='W') S.ban.w++;
  });
  const names=[...skills.keys()];
  rows.forEach(r=>{
    const win = (r.res==='W')?1:0;
    names.forEach(k=>{ if(r.banName!==k){ const S=skills.get(k); S.noban.n++; S.noban.w += win; }});
  });
  return [...skills.entries()].map(([name,S])=>{
    const w1=S.ban.n?S.ban.w/S.ban.n:0; const w2=S.noban.n?S.noban.w/S.noban.n:0;
    return {name,img:IMG.get(name)||PLACEHOLDER,banned:S.ban.n, wBan:w1, wNot:w2, delta:w1-w2};
  }).sort((a,b)=>b.delta-a.delta||b.banned-a.banned).slice(0,12);
}

function recent(rows){
  return rows.slice().sort((a,b)=> (b.date.localeCompare(a.date)) || (b.rec_id-a.rec_id)).slice(0,12);
}

/* ========= Renderers ========= */
function renderKPIs(rows){
  const k=kpis(rows);
  document.getElementById('kpis').innerHTML = `
    <div class="kpi"><span class="muted">Matches</span> <b>${k.matches}</b></div>
    <div class="kpi"><span class="muted">Wins</span> <b>${k.wins}</b> <span class="muted">(${pct(k.wins,k.matches)})</span></div>
    <div class="kpi"><span class="muted">Avg Diff</span> <b>${k.diffAvg.toFixed(2)}</b></div>
    <div class="kpi"><span class="muted">Maps</span> <b>${k.maps}</b></div>
    <div class="kpi"><span class="muted">Opps</span> <b>${k.opps}</b></div>`;
}

function renderMostPickAct(rows){
  const {labels, values}=mostPickActive(rows);
  document.getElementById('actPickWrap').innerHTML =
    labels.length ? barH(labels, values) : `<div class="muted">No active picks.</div>`;
}
function renderMostPickPas(rows){
  const {labels, values}=mostPickPassive(rows);
  document.getElementById('pasPickWrap').innerHTML =
    labels.length ? barH(labels, values) : `<div class="muted">No passive picks.</div>`;
}
function renderMostBanned(rows){
  const {labels, values}=mostBanned(rows);
  document.getElementById('banChartWrap').innerHTML =
    labels.length ? barH(labels, values) : `<div class="muted">No bans recorded.</div>`;
}
function renderPerfByMap(rows){
  const data=perfByMap(rows);
  const wrap=document.getElementById('mapChartWrap');
  if(!data.length){ wrap.innerHTML='<div class="muted">No map data.</div>'; return; }
  wrap.innerHTML = groupedBars(data.map(x=>x.name), data.map(x=>x.matches), data.map(x=>x.wins));
}

function renderCombos(rows){
  const list=topCombos(rows);
  const tbody=document.getElementById('comboBody'); tbody.innerHTML='';
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="5" class="muted">No combos found.</td></tr>`; return; }
  list.forEach(c=>{
    const icons = c.names.map(n=>`<img class="avatar" src="${(c.heroImgs[n]||PLACEHOLDER)}" alt="${n}" title="${n}" loading="lazy">`).join('');
    const label = `<div class="cell-icons">${icons}<span class="muted" style="margin-left:6px">${c.names.join(' · ')}</span></div>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="right mono">${c.picks}</td><td class="right mono">${c.wins}</td><td class="right mono">${fmtP(c.winpct)}</td><td>${c.topMaps||'—'}</td>`;
    tbody.appendChild(tr);
  });
}

function renderPTrios(rows){
  const list=topPassiveTrios(rows);
  const tb=document.getElementById('ptrioBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="5" class="muted">No passive trio data.</td></tr>`; return; }
  list.forEach(t=>{
    const icons = t.names.map(n=>`<img class="avatar s" src="${(t.imgs[n]||PLACEHOLDER)}" alt="${n}" title="${n}" loading="lazy">`).join('');
    const label = `<div class="cell-icons">${icons}<span class="muted" style="margin-left:6px">${t.names.join(' · ')}</span></div>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="right mono">${t.picks}</td><td class="right mono">${t.wins}</td><td class="right mono">${fmtP(t.winpct)}</td><td>${t.topMaps||'—'}</td>`;
    tb.appendChild(tr);
  });
}

function renderTopAct(rows){
  const list=topActives(rows); const tb=document.getElementById('actBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="5" class="muted">No active picks.</td></tr>`; return; }
  list.forEach(r=>{
    const label=`<div class="cell-skill"><img class="avatar" src="${r.img||PLACEHOLDER}" alt="${r.name}" loading="lazy"><span>${r.name}</span></div>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  });
}

function renderTopPas(rows){
  const list=topPassives(rows); const tb=document.getElementById('pasBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="5" class="muted">No passive picks.</td></tr>`; return; }
  list.forEach(r=>{
    const label=`<div class="cell-skill"><img class="avatar" src="${r.img||PLACEHOLDER}" alt="${r.name}" loading="lazy"><span>${r.name}</span></div>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  });
}

function renderOpp(rows){
  const list=perfByOpponent(rows); const tb=document.getElementById('oppBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="4" class="muted">No opponent data.</td></tr>`; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.opp}</td><td class="right mono">${r.matches}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winpct)}</td>`;
    tb.appendChild(tr);
  });
}

function renderBanImpact(rows){
  const list=banImpactAgg(rows); const tb=document.getElementById('biBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="5" class="muted">Not enough ban data.</td></tr>`; return; }
  list.forEach(r=>{
    const label=`<div class="cell-skill"><img class="avatar" src="${r.img||PLACEHOLDER}" alt="${r.name}" loading="lazy"><span>${r.name}</span></div>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="right mono">${r.banned}</td><td class="right mono">${fmtP(r.wBan)}</td><td class="right mono">${fmtP(r.wNot)}</td><td class="right mono" style="font-weight:900;">${fmtP(r.delta)}</td>`;
    tb.appendChild(tr);
  });
}

function renderRecent(rows){
  const list=recent(rows); const tb=document.getElementById('recentBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML=`<tr><td colspan="6" class="muted">No recent matches.</td></tr>`; return; }
  list.forEach(r=>{
    const score=`${r.ts}-${r.os}`;
    const wl=r.res==='W'
      ? `<span style="color:var(--good);font-weight:900">W</span>`
      : `<span style="color:var(--bad);font-weight:900">L</span>`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.date}</td><td>${r.map}</td><td>${r.opp}</td><td class="right mono">${score}</td><td class="right">${wl}</td><td class="cell-skill"><img class="avatar" src="${r.banImg||PLACEHOLDER}" alt="${r.banName}" loading="lazy"><span>${r.banName||'—'}</span></td>`;
    tb.appendChild(tr);
  });
}

/* ========= Orchestrator ========= */
async function init(){
  ALL_RECORDS = await fetchAll();

  // Tournament dropdown (default to latest)
  const tourns = tournamentsFrom(ALL_RECORDS);
  const tSel = document.getElementById('tournSelect');
  tSel.innerHTML = `<option value="__ALL__">All tournaments</option>` +
                   tourns.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
  const latest = tourns[0]?.name || '__ALL__';
  tSel.value = latest;

  // Team dropdown linked to tournament + All Teams
  const teamSel = document.getElementById('teamSelect');
  const refreshTeams = ()=>{
    const teams = teamsForTournament(ALL_RECORDS, tSel.value);
    const prev = teamSel.value;

    teamSel.innerHTML =
      `<option value="${ALL_TEAMS}">All Teams</option>` +
      teams.map(x=>`<option value="${x}">${x}</option>`).join('');

    if(prev === ALL_TEAMS) teamSel.value = ALL_TEAMS;
    else teamSel.value = teams.includes(prev) ? prev : ALL_TEAMS;
  };
  refreshTeams();

  const load = ()=>{
    if(!teamSel.value) return;
    loadTeam(teamSel.value, tSel.value);
  };

  tSel.addEventListener('change', ()=>{ refreshTeams(); load(); });
  teamSel.addEventListener('change', load);
  load();
}

function setMeta(team, tourn, rows){
  const label = (team === ALL_TEAMS) ? 'All Teams' : team;
  document.getElementById('meta').textContent =
    `${label} • ${rows.length} team-rows • ${tourn==='__ALL__'?'All tournaments':tourn}`;
}

function loadTeam(team, tourn){
  const rows = rowsForTeamAndTournament(ALL_RECORDS, team, tourn);
  setMeta(team, tourn, rows);

  renderKPIs(rows);
  renderMostPickAct(rows);
  renderMostPickPas(rows);
  renderMostBanned(rows);
  renderPerfByMap(rows);

  renderCombos(rows);
  renderPTrios(rows);

  renderTopAct(rows);
  renderTopPas(rows);

  renderOpp(rows);
  renderBanImpact(rows);
  renderRecent(rows);
}

init();
</script>
</body>
</html>
