<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Report — Compact Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0d0d0d; --panel:#151515; --ink:#eee; --muted:#aaa;
      --brand:#ffbd59; --brand2:#ff7733; --line:#2a2a2a;
      --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1a1a1a;border-bottom:2px solid var(--brand);padding:10px 12px}
    h1{margin:0;font-size:1.05rem;color:var(--brand);letter-spacing:.2px}

    /* shell */
    .shell{
      max-width:min(1600px,98vw);
      margin:14px auto;
      padding:0 10px;
    }

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    select{background:#1e1e1e;color:#ffe0b0;border:1px solid #3a3a3a;border-radius:8px;padding:6px 8px;font-weight:600}
    .chip{color:var(--muted);font-size:.82rem}

    /* Grid layout (stable rows) */
    .grid{
      display:grid;
      grid-template-columns:repeat(12, minmax(0,1fr));
      gap:8px;
    }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px}
    .card.full{grid-column:span 12}
    .card.half{grid-column:span 6}
    .card.quarter{grid-column:span 3}
    .card h3{margin:0 0 6px 0;color:var(--brand2);font-size:.95rem;line-height:1.1}

    /* KPI row */
    .kpis{display:flex;gap:6px;flex-wrap:wrap}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:10px;padding:6px 8px;font-size:.85rem}
    .kpi b{font-size:.95rem}

    /* Tables */
    table{width:100%;border-collapse:collapse;font-size:.85rem;table-layout:fixed}
    th,td{border-bottom:1px solid #222;padding:5px 6px;vertical-align:top;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    thead th{background:#141414;text-align:left;color:#ddd}
    tbody tr:hover{background:#121212}
    .mono{font-variant-numeric:tabular-nums}
    .right{text-align:right}
    .muted{color:var(--muted)}

    /* Make first column a bit wider on text-heavy tables */
    #comboCard table th:first-child,
    #actCard   table th:first-child,
    #pasCard   table th:first-child { width:44% }

    /* Micro SVG bars */
    .chart{width:100%;height:auto;display:block}
    .legend{display:flex;gap:10px;align-items:center;font-size:.78rem;color:#cfcfcf}
    .legend span{display:inline-flex;align-items:center;gap:6px}
    .lg{width:10px;height:10px;border-radius:2px;background:#ffbd59;border:1px solid #6a4e23}
    .lg2{width:10px;height:10px;border-radius:2px;background:#4aa86a;border:1px solid #2c5a3a}

    .pill{display:inline-block;padding:2px 6px;border-radius:999px;background:#111;border:1px solid #2a2a2a;margin:2px;font-size:.78rem;color:#ddd}

    @media (max-width: 980px){
      .card.full,.card.half,.card.quarter{grid-column:span 12}
    }
    @media (min-width:1600px){
      .grid{grid-template-columns:repeat(16, minmax(0,1fr))}
      .card.full{grid-column:span 16}
      .card.half{grid-column:span 8}
      .card.quarter{grid-column:span 4}
    }
  </style>
</head>
<body>
  <header>
    <h1>Team Report — Compact Dashboard</h1>
  </header>

  <div class="shell">
    <div class="controls">
      <label class="muted">Team
        <select id="teamSelect"></select>
      </label>
      <span class="chip" id="meta">Loading…</span>
    </div>

    <div class="grid">
      <!-- KPI -->
      <div class="card full" id="kpiCard">
        <h3>Overview</h3>
        <div class="kpis" id="kpis"></div>
      </div>

      <!-- Row: two halves -->
      <div class="card half" id="banCard">
        <h3>Most Banned (Count)</h3>
        <div id="banChartWrap"></div>
      </div>

      <div class="card half" id="mapCard">
        <h3>Performance by Map</h3>
        <div class="legend" style="margin-bottom:4px">
          <span><i class="lg"></i> Matches</span>
          <span><i class="lg2"></i> Wins</span>
        </div>
        <div id="mapChartWrap"></div>
      </div>

      <!-- Full width -->
      <div class="card full" id="comboCard">
        <h3>Top Active Combos</h3>
        <table>
          <thead>
            <tr><th>Combo (4× Active)</th><th class="right">Picks</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th><th>Top Maps</th></tr>
          </thead>
          <tbody id="comboBody"></tbody>
        </table>
      </div>

      <!-- Four across -->
      <div class="card quarter" id="oppCard">
        <h3>Performance by Opponent</h3>
        <table>
          <thead><tr><th>Opponent</th><th class="right">Matches</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
          <tbody id="oppBody"></tbody>
        </table>
      </div>

      <div class="card quarter" id="actCard">
        <h3>Top Active Skills</h3>
        <table>
          <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
        <tbody id="actBody"></tbody>
        </table>
      </div>

      <div class="card quarter" id="pasCard">
        <h3>Top Passive Skills</h3>
        <table>
          <thead><tr><th>Skill</th><th class="right">Picks</th><th class="right">Pick&nbsp;%</th><th class="right">Wins</th><th class="right">Win&nbsp;%</th></tr></thead>
          <tbody id="pasBody"></tbody>
        </table>
      </div>

      <div class="card quarter" id="biCard">
        <h3>Ban Impact (Δ Win %)</h3>
        <table>
          <thead><tr><th>Skill</th><th class="right">Banned</th><th class="right">Win% (banned)</th><th class="right">Win% (not)</th><th class="right">Δ</th></tr></thead>
          <tbody id="biBody"></tbody>
        </table>
      </div>

      <!-- Full width -->
      <div class="card full" id="recentCard">
        <h3>Recent Matches</h3>
        <table>
          <thead><tr><th>Date</th><th>Map</th><th>Opponent</th><th class="right">Score</th><th class="right">Res</th><th>Ban</th></tr></thead>
          <tbody id="recentBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ========= Supabase ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

/* ========= Utils ========= */
const PLACEHOLDER='https://imgur.com/AdvPwAO.png';
const pct=(n,d)=> d? ((n/d)*100).toFixed(1)+'%':'—';
const fmtP=(x)=> (x*100).toFixed(1)+'%';
const uniq=(a)=>[...new Set(a)];
function ymd(d){const dt=new Date(d);if(!d||isNaN(dt))return '';return dt.toISOString().slice(0,10)}
function parseState(v){if(!v) return {}; if (typeof v==='object') return v; try{return JSON.parse(v)}catch{ return {} }}

/* ========= Micro SVGs (vector-crisp) ========= */
function barH(labels, values, opts={}){
  const W = opts.width || 360;
  const labelW = 96;
  const pad = 4, row = 12, gap = 2;
  const H = Math.max(36, labels.length*(row+gap) + pad*2);
  const max = Math.max(1, ...values);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - 18));

  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  labels.forEach((lb,i)=>{
    const y = pad + i*(row+gap);
    const w = scale(values[i]);
    svg.push(`<text x="2" y="${y+9}" font-size="10" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${w}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + w + 4}" y="${y+9}" font-size="10" fill="#ccc" class="mono">${values[i]}</text>`);
  });
  svg.push(`</svg>`);
  return svg.join('');
}

function groupedBars(labels, aVals, bVals, opts={}){
  const W = opts.width || 380;
  const labelW = 96;
  const pad = 6, row = 11, gap = 2, grpGap = 5;
  const H = Math.max(36, labels.length*(row+gap) + labels.length*grpGap + pad*2);
  const max = Math.max(1, ...aVals, ...bVals);
  const scale = (v)=> Math.max(1, (v/max)*(W - labelW - 20));

  const svg = [`<svg class="chart" viewBox="0 0 ${W} ${H}" width="100%" height="${H}" shape-rendering="crispEdges">`];
  let y = pad;
  labels.forEach((lb, i)=>{
    const a = scale(aVals[i]), b = scale(bVals[i]);
    svg.push(`<text x="2" y="${y+9}" font-size="10" fill="#ddd">${lb}</text>`);
    svg.push(`<rect x="${labelW}" y="${y}" width="${a}" height="${row}" fill="#ffbd59" stroke="#6a4e23" vector-effect="non-scaling-stroke"/>`);
    y += row + gap;
    svg.push(`<rect x="${labelW}" y="${y}" width="${b}" height="${row}" fill="#4aa86a" stroke="#2c5a3a" vector-effect="non-scaling-stroke"/>`);
    svg.push(`<text x="${labelW + Math.max(a,b) + 4}" y="${y-3}" font-size="9" fill="#bbb" class="mono">${aVals[i]}/${bVals[i]}</text>`);
    y += row + grpGap;
  });
  svg.push(`</svg>`);
  return svg.join('');
}

/* ========= Data plumbing ========= */
let ALL_RECORDS=[]; // for team dropdown only
let CURR_ROWS=[];

function explodeRecordToRows(rec){
  const s=parseState(rec.state);
  const picks=Array.isArray(s.picks)?s.picks:[];
  const passives=Array.isArray(s.passives)?s.passives:[];
  const bans=Array.isArray(s.bans)?s.bans:[];
  const leftWin=(rec.team_left_score??0)>(rec.team_right_score??0);
  const rightWin=(rec.team_right_score??0)>(rec.team_left_score??0);
  function side(isLeft){
    const team=isLeft?rec.team_left:rec.team_right;
    const opp =isLeft?rec.team_right:rec.team_left;
    const ts  =isLeft?(rec.team_left_score??0):(rec.team_right_score??0);
    const os  =isLeft?(rec.team_right_score??0):(rec.team_left_score??0);
    const res =(isLeft?leftWin:rightWin)?'W':'L';
    const ban=(bans[isLeft?0:1]||{});
    const idx=isLeft?[0,1,2,3]:[7,6,5,4];
    const act=idx.map(i=>({hero:(picks[i]?.name)||'', img:(picks[i]?.image_url)||PLACEHOLDER}));
    const pas=idx.map(i=>Array.isArray(passives[i])?passives[i].map(x=>x?.name||'').filter(Boolean):[]);
    return {rec_id:rec.id,date:ymd(rec.match_date),map:rec.map,team,opp,ts,os,res,ban:ban.name||'',act,pass:pas};
  }
  return [side(true), side(false)];
}

async function fetchAll(){
  const { data, error } = await client
    .from('draft_records')
    .select('id, match_date, map, team_left, team_right, team_left_score, team_right_score, state, tournament_name')
    .order('match_date', { ascending:false })
    .order('id',{ ascending:false });
  if(error){ console.error(error); alert('Failed to load records: '+error.message); return [] }
  return data||[];
}

function teamsFrom(records){
  const S=new Set();
  records.forEach(r=>{ if(r.team_left)S.add(r.team_left); if(r.team_right)S.add(r.team_right) });
  return [...S].sort();
}

function rowsForTeam(records, team){
  return records.flatMap(explodeRecordToRows).filter(r=>r.team===team);
}

/* ========= Aggregations ========= */
function kpis(rows){
  const matches=rows.length; const wins=rows.filter(r=>r.res==='W').length;
  const diffAvg=matches? (rows.reduce((a,r)=>a+(r.ts-r.os),0)/matches):0;
  const maps=uniq(rows.map(r=>r.map)).length; const opps=uniq(rows.map(r=>r.opp)).length;
  return {matches,wins,winpct: matches? wins/matches : 0, diffAvg, maps, opps};
}

function mostBanned(rows){
  const m=new Map(); rows.forEach(r=>{ const b=r.ban||''; if(!b)return; m.set(b,(m.get(b)||0)+1) });
  const arr=[...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10); return {labels:arr.map(x=>x[0]), values:arr.map(x=>x[1])};
}

function perfByMap(rows){
  const m=new Map();
  rows.forEach(r=>{ if(!m.has(r.map)) m.set(r.map,{m:0,w:0}); const o=m.get(r.map); o.m++; if(r.res==='W') o.w++; });
  return [...m.entries()]
    .map(([name,o])=>({name,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.name.localeCompare(b.name));
}

function topCombos(rows){
  const combos=new Map();
  rows.forEach(r=>{
    const names=r.act.map(a=>a.hero).filter(Boolean);
    if(names.length!==4) return;
    const key=names.slice().sort((a,b)=>a.localeCompare(b)).join('|');
    if(!combos.has(key)) combos.set(key,{names:key.split('|'), picks:0,wins:0,maps:new Map()});
    const C=combos.get(key); C.picks++; if(r.res==='W')C.wins++; C.maps.set(r.map,(C.maps.get(r.map)||0)+1);
  });
  return [...combos.values()].map(c=>({
    ...c, winpct: c.picks?c.wins/c.picks:0,
    topMaps: [...c.maps.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>`${x[0]} ×${x[1]}`).join(', ')
  })).sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,10);
}

function topActives(rows){
  const S=new Map(); rows.forEach(r=>{ r.act.forEach(a=>{ if(!a.hero)return; if(!S.has(a.hero))S.set(a.hero,{p:0,w:0}); const o=S.get(a.hero); o.p++; if(r.res==='W')o.w++; }) });
  const den=rows.length*4;
  return [...S.entries()].map(([name,o])=>({name,picks:o.p, pickRate: den?o.p/den:0, wins:o.w, winRate: o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
}

function topPassives(rows){
  const S=new Map(); rows.forEach(r=>{ r.pass.forEach(trio=>trio.forEach(n=>{ if(!n)return; if(!S.has(n))S.set(n,{p:0,w:0}); const o=S.get(n); o.p++; if(r.res==='W')o.w++; })) });
  const den=rows.length*12;
  return [...S.entries()].map(([name,o])=>({name,picks:o.p, pickRate: den?o.p/den:0, wins:o.w, winRate: o.p?o.w/o.p:0}))
    .sort((a,b)=>b.picks-a.picks||b.wins-a.wins).slice(0,15);
}

function perfByOpponent(rows){
  const m=new Map(); rows.forEach(r=>{ if(!m.has(r.opp)) m.set(r.opp,{m:0,w:0}); const o=m.get(r.opp); o.m++; if(r.res==='W')o.w++; });
  return [...m.entries()].map(([opp,o])=>({opp,matches:o.m,wins:o.w,winpct:o.m?o.w/o.m:0}))
    .sort((a,b)=>b.matches-a.matches||a.opp.localeCompare(b.opp)).slice(0,20);
}

function computeBanImpact(rows){
  const skills=new Map();
  rows.forEach(r=>{
    if(!r.ban) return;
    if(!skills.has(r.ban)) skills.set(r.ban,{ban:{n:0,w:0}, noban:{n:0,w:0}});
    const S=skills.get(r.ban); S.ban.n++; if(r.res==='W') S.ban.w++;
  });
  const names=[...skills.keys()];
  rows.forEach(r=>{
    names.forEach(n=>{
      if(r.ban!==n){ const S=skills.get(n); S.noban.n++; if(r.res==='W')S.noban.w++; }
    });
  });
  return [...skills.entries()].map(([name,S])=>{
    const w1=S.ban.n?S.ban.w/S.ban.n:0; const w2=S.noban.n?S.noban.w/S.noban.n:0;
    return {name,banned:S.ban.n, wBan:w1, wNot:w2, delta:w1-w2};
  }).sort((a,b)=>b.delta-a.delta||b.banned-a.banned).slice(0,12);
}

function recent(rows){
  return rows.slice().sort((a,b)=> (b.date.localeCompare(a.date)) || (b.rec_id-a.rec_id)).slice(0,12);
}

/* ========= Renderers ========= */
function renderKPIs(rows){
  const k=kpis(rows);
  document.getElementById('kpis').innerHTML = `
    <div class="kpi">Matches <b>${k.matches}</b></div>
    <div class="kpi">Wins <b>${k.wins}</b> <span class="muted">(${pct(k.wins,k.matches)})</span></div>
    <div class="kpi">Avg Score Diff <b>${k.diffAvg.toFixed(2)}</b></div>
    <div class="kpi">Maps <b>${k.maps}</b></div>
    <div class="kpi">Opponents <b>${k.opps}</b></div>`;
}

function renderMostBanned(rows){
  const {labels, values}=mostBanned(rows);
  const wrap=document.getElementById('banChartWrap');
  wrap.innerHTML = labels.length ? barH(labels, values, {height: labels.length*16+10}) : `<div class="muted">No bans recorded for this team.</div>`;
}

function renderPerfByMap(rows){
  const data=perfByMap(rows);
  const wrap=document.getElementById('mapChartWrap');
  if(!data.length){ wrap.innerHTML='<div class="muted">No map data.</div>'; return; }
  const labels=data.map(x=>x.name), matches=data.map(x=>x.matches), wins=data.map(x=>x.wins);
  wrap.innerHTML = groupedBars(labels, matches, wins, {height: labels.length*22+12});
}

function renderCombos(rows){
  const list=topCombos(rows);
  const tbody=document.getElementById('comboBody'); tbody.innerHTML='';
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="5" class="muted">No combos found.</td></tr>`; return; }
  list.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="muted">${c.names.join(' · ')}</td><td class="right mono">${c.picks}</td><td class="right mono">${c.wins}</td><td class="right mono">${fmtP(c.winpct)}</td><td>${c.topMaps||'—'}</td>`;
    tbody.appendChild(tr);
  });
}

function renderOpp(rows){
  const list=perfByOpponent(rows); const tb=document.getElementById('oppBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="4" class="muted">No opponent data.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.opp}</td><td class="right mono">${r.matches}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winpct)}</td>`;
    tb.appendChild(tr);
  });
}

function renderTopAct(rows){
  const list=topActives(rows); const tb=document.getElementById('actBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">No active picks.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  });
}

function renderTopPas(rows){
  const list=topPassives(rows); const tb=document.getElementById('pasBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">No passive picks.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.picks}</td><td class="right mono">${fmtP(r.pickRate)}</td><td class="right mono">${r.wins}</td><td class="right mono">${fmtP(r.winRate)}</td>`;
    tb.appendChild(tr);
  });
}

function renderBanImpact(rows){
  const list=computeBanImpact(rows); const tb=document.getElementById('biBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="5" class="muted">Not enough ban data.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="right mono">${r.banned}</td><td class="right mono">${fmtP(r.wBan)}</td><td class="right mono">${fmtP(r.wNot)}</td><td class="right mono" style="font-weight:700;">${fmtP(r.delta)}</td>`;
    tb.appendChild(tr);
  });
}

function renderRecent(rows){
  const list=recent(rows); const tb=document.getElementById('recentBody'); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="6" class="muted">No recent matches.</td></tr>'; return; }
  list.forEach(r=>{
    const tr=document.createElement('tr');
    const score=`${r.ts}-${r.os}`;
    const wl=r.res==='W'?`<span style="color:var(--good);font-weight:700">W</span>`:`<span style="color:var(--bad);font-weight:700">L</span>`;
    tr.innerHTML=`<td>${r.date}</td><td>${r.map}</td><td>${r.opp}</td><td class="right mono">${score}</td><td class="right">${wl}</td><td>${r.ban||'—'}</td>`;
    tb.appendChild(tr);
  });
}

/* ========= Orchestrator ========= */
async function init(){
  ALL_RECORDS = await fetchAll();
  const teams = teamsFrom(ALL_RECORDS);
  const sel=document.getElementById('teamSelect');
  sel.innerHTML = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
  const qTeam = new URLSearchParams(location.search).get('team');
  if(qTeam && teams.includes(qTeam)) sel.value=qTeam;
  sel.addEventListener('change', ()=> loadTeam(sel.value));
  if(teams.length){ loadTeam(sel.value||teams[0]); }
}

function setMeta(team, rows){
  const t = rows.length;
  const tourns = new Set(); ALL_RECORDS.forEach(r=>{ if(r.team_left===team||r.team_right===team) tourns.add(r.tournament_name||'') });
  document.getElementById('meta').textContent = `${team} • ${t} team-rows • ${tourns.size} tournament(s)`;
}

function loadTeam(team){
  CURR_ROWS = rowsForTeam(ALL_RECORDS, team);
  setMeta(team, CURR_ROWS);
  renderKPIs(CURR_ROWS);
  renderMostBanned(CURR_ROWS);
  renderPerfByMap(CURR_ROWS);
  renderCombos(CURR_ROWS);
  renderOpp(CURR_ROWS);
  renderTopAct(CURR_ROWS);
  renderTopPas(CURR_ROWS);
  renderBanImpact(CURR_ROWS);
  renderRecent(CURR_ROWS);
}

init();
</script>
</body>
</html>
