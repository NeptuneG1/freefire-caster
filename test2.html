<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FFBR — Player Performance</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
    --brand:#ffbd59; --brand2:#ff7733; --line:#313131;
    --heat-rgb:255,189,89; --heat-min:.06; --heat-max:.22; --heat-top-outline:.42; --heat-radius:8px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
  h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
  .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
  .chip{font-size:.85rem;color:#ddd}
  .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}
  .shell{max-width:1100px;margin:22px auto;padding:0 12px}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
  .section h2{margin:0 0 10px;color:var(--brand)}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
  .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
  .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
  .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:6px 8px;font-size:.9rem}
  .muted{color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chipbtn{cursor:pointer;border:1px solid #3a3a3a;background:#1a1a1a;color:#e6e6e6;border-radius:999px;padding:6px 10px;font-weight:700}
  .chipbtn:hover{border-color:#555}
  .chipbtn.active{background:var(--brand2);color:#111;border-color:#000}
  details.accordion{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:0;margin-bottom:14px}
  details.accordion > summary{list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line);user-select:none}
  details.accordion[open] > summary{border-bottom-color:var(--line)}
  details.accordion > .accordion-body{padding:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
  thead th{background:#191919;position:sticky;top:0;text-align:left;border-radius:8px;padding:8px 6px}
  th,td{padding:6px 6px;vertical-align:top}
  .right{text-align:right}
  td[data-key]{transition:background-color .18s ease, box-shadow .18s ease;border-radius:var(--heat-radius);background-clip:padding-box}
  td.heat-top{box-shadow:inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline))}
  @media (max-width: 880px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>FFBR — Player Performance</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <!-- PLAYER FILTER -->
  <div class="section">
    <h2>Player</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <label style="flex:1;min-width:240px">
        <input type="search" id="playerSearch" placeholder="Type a name and press Enter…" class="btn secondary" style="width:100%;padding:10px">
      </label>
      <label>
        <select id="playerSelect" class="btn secondary" style="min-width:220px;padding:10px">
          <option value="">— Select player —</option>
        </select>
      </label>
      <button class="btn secondary" id="clearPlayer">Clear</button>
      <button class="btn" id="copyLink">Copy Link</button>
    </div>
    <div class="muted" id="pickerHint">Loading…</div>
    <div id="playerChips" class="chips">—</div>
  </div>

  <!-- OVERVIEW -->
  <div class="section" id="playerHeader">
    <h2 id="playerTitle">Player Overview</h2>
    <div class="grid2">
      <div class="card" id="playerIdentity">
        <h3>Identity</h3>
        <div id="identityBody" class="muted">Select a player.</div>
      </div>
      <div class="card" id="playerKPIs">
        <h3>Key KPIs</h3>
        <div id="kpiBody">—</div>
      </div>
    </div>
  </div>

  <!-- PERFORMANCE BY MAP (Selected Player) -->
  <details class="accordion" open>
    <summary>Performance by Map (Selected Player)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblMapPerf">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: ACTIVE SKILL (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Active Skill Usage — All Players (Top 10 by count)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblActive">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: PET (ALL PLAYERS) -->
  <details class="accordion" open>
    <summary>Pet Usage — All Players (Top 10 by count)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblPet">—</div>
      </div>
    </div>
  </details>

  <!-- GLOBAL: TOP 10 PLAYERS BY KILLS -->
  <details class="accordion" open>
    <summary>Top 10 Players by Kills</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblTopKillers">—</div>
      </div>
    </div>
  </details>
</div>

<script>
/* ===== Supabase ===== */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);
(async ()=>{
  const { data: { session } } = await client.auth.getSession();
  const ui = document.getElementById('user-info');
  if (session?.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
  else ui.textContent = 'Anon access';
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ===== Utils ===== */
const el = id => document.getElementById(id);
const norm = v => (v==null ? '' : String(v).trim());
const n = v => {
  if (v == null || v === '') return 0;
  const x = typeof v === 'number' ? v : parseFloat(String(v).replace(/,/g,''));
  return Number.isFinite(x) ? x : 0;
};
const uniq = arr => Array.from(new Set(arr));
function sum(arr, k){ let t=0; for(const r of arr) t += n(r[k]); return t; }

/* column-insensitive getter */
function getCI(obj, ...names){
  if (!obj) return '';
  const keys = Object.keys(obj);
  // exact case-insensitive
  for (const want of names){
    const k = keys.find(x => x.toLowerCase() === String(want).toLowerCase());
    if (k) return obj[k];
  }
  // normalized space-insensitive
  for (const want of names){
    const rx = new RegExp('^'+String(want).replace(/\s+/g,'\\s*')+'$','i');
    const k = keys.find(x => rx.test(x));
    if (k) return obj[k];
  }
  // final loose match on normalized tokens
  const wantLow = names.map(s => String(s).toLowerCase().replace(/\s+/g,' ').trim());
  for (const k of keys){
    const lk = k.toLowerCase().replace(/\s+/g,' ').trim();
    if (wantLow.includes(lk)) return obj[k];
  }
  return '';
}

/* flexible helpers */
function firstNonEmpty(...vals){
  for (const v of vals){
    const s = v==null ? '' : String(v).trim();
    if (s) return s;
  }
  return '';
}
function findByWords(obj, words){
  const keys = Object.keys(obj||{});
  const k = keys.find(key => {
    const lk = key.toLowerCase();
    return words.every(w => lk.includes(String(w).toLowerCase()));
  });
  return k ? obj[k] : '';
}

/* ===== Normalizer for ffbr_lopsdata ===== */
function normalizeRow(r){
  const o = {...r};
  o._created   = getCI(o,'created_at','Created','Timestamp') || null;
  o._id        = n(getCI(o,'id','ID'));
  o._player    = norm(getCI(o,'Player name','Player Name','Player','IGN'));
  o._team      = norm(getCI(o,'Team','TAG','TeamName','Team Name'));
  o._map       = norm(getCI(o,'Map','map','Match Map'));

  o.kills      = n(getCI(o,'KILLS','Kills','Kill'));
  o.assists    = n(getCI(o,'ASSISTS','Assists','Assist'));
  o.headshots  = n(getCI(o,'HEADSHOTRS','HEADSHOTS','Headshots','HS'));
  o.damage     = n(getCI(o,'DAMAGE','Damage','DMG'));
  o.grenade    = n(getCI(o,'Grenade kill','Grenade kills','Nade Kills','Grenade'));

  // Active Skill: explicit support for "skillactive_1" + fallbacks
  o.active = norm(firstNonEmpty(
    getCI(o,'skillactive_1'),
    getCI(o,'Active Skill','Active','Skill','ActiveSkill','Active Skill Name','ActiveSkillName'),
    findByWords(o, ['active','skill']),
    getCI(o,'Character','Character Name','Active Character','ActiveCharacter')
  ));
  // Pet usage (common variants)
  o.pet = norm(firstNonEmpty(
    getCI(o,'Pet','Pet Name','PetName','Pet Skill Name','PetSkill','PetSkillName')
  ));

  o._tournament= norm(getCI(o,'Tournament','Event','Series'));
  return o;
}

/* ===== Data fetch (chunked) ===== */
async function fetchAllRows(){
  const CHUNK = 1000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_lopsdata')
      .select('*')
      .range(from, from + CHUNK - 1);
    if (error){ console.error('ffbr_lopsdata fetch failed:', error); break; }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }
  const normed = out.map(normalizeRow);
  document.getElementById('pickerHint').textContent =
    `Loaded ${normed.length} rows • Example columns: ${Object.keys(out[0]||{}).slice(0,8).join(', ')}${Object.keys(out[0]||{}).length>8?'…':''}`;
  return normed.filter(r => r._player);
}

/* ===== Heatmap (optional) ===== */
function applyColumnHeatmap(containerId, keys){
  const wrap = el(containerId);
  const table = wrap?.querySelector('table'); if (!table) return;
  table.querySelectorAll('td[data-key]').forEach(td=>{
    td.style.backgroundColor = ''; td.classList.remove('heat-top');
  });
  const styles = getComputedStyle(document.documentElement);
  const rgb    = styles.getPropertyValue('--heat-rgb') || '255,189,89';
  const minA   = parseFloat(styles.getPropertyValue('--heat-min')) || .06;
  const maxA   = parseFloat(styles.getPropertyValue('--heat-max')) || .22;
  const radius = styles.getPropertyValue('--heat-radius') || '8px';
  const BANDS  = 5;
  for (const key of keys){
    const cells = Array.from(table.querySelectorAll(`td[data-key="${key}"]`));
    if (!cells.length) continue;
    const entries = cells.map((td,i)=>{
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      return { td, i, v: isFinite(v) ? v : null };
    }).filter(e => e.v != null);
    if (!entries.length) continue;
    const asc = entries.slice().sort((a,b)=> a.v - b.v);
    const n   = asc.length;
    const topVal = asc[n-1].v;
    const bandByIndex = new Map();
    asc.forEach((e, rank)=>{
      const p = (n<=1) ? 1 : (rank/(n-1));
      const band = Math.min(BANDS-1, Math.floor(p * BANDS));
      bandByIndex.set(e.i, band);
    });
    cells.forEach((td,i)=>{
      const band = bandByIndex.get(i);
      if (band == null) return;
      const alpha = minA + ((band)/(BANDS-1)) * (maxA - minA);
      td.style.backgroundColor = `rgba(${rgb}, ${alpha.toFixed(3)})`;
      td.style.borderRadius = radius;
      td.style.backgroundClip = 'padding-box';
      const raw = (td.textContent||'').trim().replace('%','').replace(/,/g,'');
      const v = parseFloat(raw);
      if (isFinite(v) && v === topVal) td.classList.add('heat-top');
    });
  }
}

/* ===== Render helpers ===== */
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.html) v = c.html(r);
    else if (c.format==='pct') v = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
    else if (c.format==='1d') v = isFinite(v) ? Number(v).toFixed(1) : '—';
    else if (c.format==='2d') v = isFinite(v) ? Number(v).toFixed(2) : '—';
    else if (c.format==='0d') v = isFinite(v) ? Number(v).toFixed(0) : '—';
    return `<td data-key="${c.key}" class="${c.right?'right':''}">${(v==null||v==='')?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}
function identityBlock(playerName, rows){
  const teams = Array.from(new Set(rows.map(r=>r._team).filter(Boolean))).join(', ') || '—';
  const tourns = new Set(rows.map(r=>r._tournament).filter(Boolean)).size;
  return `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:72px;height:72px;border:1px solid #2a2a2a;border-radius:10px;background:#111;display:flex;align-items:center;justify-content:center;font-weight:800">${(playerName||'?').slice(0,2).toUpperCase()}</div>
      <div>
        <div style="font-size:1.1rem;font-weight:800">${playerName||'—'}</div>
        <div class="muted">${teams} • ${tourns||0} tournament(s)</div>
      </div>
    </div>`;
}
function kpisForPlayer(rows){
  const cnt = rows.length;
  const kills = sum(rows,'kills');
  const assists = sum(rows,'assists');
  const hs = sum(rows,'headshots');
  const dmg = sum(rows,'damage');
  const gk = sum(rows,'grenade');
  return {
    rows: cnt, kills, assists, hs, dmg, gk,
    kpr: cnt? kills/cnt : 0,
    apr: cnt? assists/cnt : 0,
    dpr: cnt? dmg/cnt : 0,
    hsr: kills? hs/kills : 0,
  };
}
function renderOverview(player, rows){
  el('playerTitle').textContent = player ? `Player Overview — ${player}` : 'Player Overview';
  el('identityBody').innerHTML = player ? identityBlock(player, rows) : 'Select a player.';
  const k = kpisForPlayer(rows);
  el('kpiBody').innerHTML = k.rows ? `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.rows}</strong></div>
      <div class="kpi">Kills <strong>${k.kills}</strong> <span class="muted">(${k.kpr.toFixed(2)}/row)</span></div>
      <div class="kpi">Assists <strong>${k.assists}</strong> <span class="muted">(${k.apr.toFixed(2)}/row)</span></div>
      <div class="kpi">Grenade <strong>${k.gk}</strong></div>
      <div class="kpi">Damage <strong>${Math.round(k.dmg)}</strong> <span class="muted">(${Math.round(k.dpr)}/row)</span></div>
      <div class="kpi">Headshots <strong>${k.hs}</strong> <span class="muted">(${(k.hsr*100).toFixed(1)}%)</span></div>
    </div>` : '<div class="muted">—</div>';
}

/* ===== Performance by Map (Selected Player) ===== */
function mapPerfForPlayer(rows){
  const byMap = new Map();
  for (const r of rows){
    const key = r._map || '—';
    if (!byMap.has(key)) byMap.set(key, { map:key, rows:0, kills:0, assists:0, headshots:0, grenade:0, damage:0 });
    const a = byMap.get(key);
    a.rows += 1;
    a.kills += n(r.kills);
    a.assists += n(r.assists);
    a.headshots += n(r.headshots);
    a.grenade += n(r.grenade);
    a.damage += n(r.damage);
  }
  const list = Array.from(byMap.values()).map(m=>({
    ...m,
    kpr: m.rows ? m.kills/m.rows : 0,
    apr: m.rows ? m.assists/m.rows : 0,
    hspr: m.rows ? m.headshots/m.rows : 0,
    nadpr: m.rows ? m.grenade/m.rows : 0,
    dpr: m.rows ? m.damage/m.rows : 0,
  }));
  // Default sort: by KPR desc, then kills desc, then map A→Z
  list.sort((a,b)=> b.kpr - a.kpr || b.kills - a.kills || a.map.localeCompare(b.map));
  return list;
}
function renderMapPerf(rows){
  if (!rows.length){
    el('tblMapPerf').innerHTML = '<div class="muted">Select a player to see per-map performance.</div>';
    return;
  }
  const list = mapPerfForPlayer(rows);
  el('tblMapPerf').innerHTML = renderSimpleTable(list, [
    { label:'Map', key:'map' },
    { label:'Rows', key:'rows', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'K/Row', key:'kpr', right:true, format:'1d' },
    { label:'Assists', key:'assists', right:true },
    { label:'A/Row', key:'apr', right:true, format:'1d' },
    { label:'HS', key:'headshots', right:true },
    { label:'HS/Row', key:'hspr', right:true, format:'1d' },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Nade/Row', key:'nadpr', right:true, format:'1d' },
    { label:'Damage', key:'damage', right:true },
    { label:'DMG/Row', key:'dpr', right:true, format:'1d' },
  ]);
  applyColumnHeatmap('tblMapPerf', ['kpr','apr','hspr','nadpr','dpr','kills','assists','headshots','grenade','damage']);
}

/* ===== GLOBAL AGGREGATES (COUNTS ONLY) ===== */
function countByName(rows, key){
  const m = new Map(); // normKey -> {name, picks}
  for (const r of rows){
    const raw = norm(r[key]);
    if (!raw) continue;
    const k = raw.toLowerCase().replace(/\s+/g,' ').trim();
    if (!m.has(k)) m.set(k, { name: raw, picks: 0 });
    m.get(k).picks += 1;
  }
  return Array.from(m.values());
}
function renderActiveGlobal(allRows){
  const list = countByName(allRows, 'active')
    .sort((a,b)=> b.picks - a.picks || a.name.localeCompare(b.name))
    .slice(0,10);
  el('tblActive').innerHTML = renderSimpleTable(list, [
    { label:'Active Skill', key:'name' },
    { label:'Picks', key:'picks', right:true },
  ]);
  applyColumnHeatmap('tblActive', ['picks']);
}
function renderPetGlobal(allRows){
  const list = countByName(allRows, 'pet')
    .sort((a,b)=> b.picks - a.picks || a.name.localeCompare(b.name))
    .slice(0,10);
  el('tblPet').innerHTML = renderSimpleTable(list, [
    { label:'Pet', key:'name' },
    { label:'Picks', key:'picks', right:true },
  ]);
  applyColumnHeatmap('tblPet', ['picks']);
}

/* ===== GLOBAL: Top 10 players by kills ===== */
function renderTopKillers(allRows){
  const m = new Map();
  for (const r of allRows){
    const p = r._player;
    if (!p) continue;
    if (!m.has(p)) m.set(p,{player:p, kills:0, assists:0, headshots:0, grenade:0, damage:0, rows:0});
    const o = m.get(p);
    o.kills += r.kills; o.assists += r.assists; o.headshots += r.headshots; o.grenade += r.grenade; o.damage += r.damage; o.rows++;
  }
  const list = Array.from(m.values()).sort((a,b)=> b.kills - a.kills || a.player.localeCompare(b.player)).slice(0,10);
  el('tblTopKillers').innerHTML = renderSimpleTable(list, [
    { label:'Player', key:'player' },
    { label:'Rows', key:'rows', right:true },
    { label:'Kills', key:'kills', right:true },
    { label:'Assists', key:'assists', right:true },
    { label:'HS', key:'headshots', right:true },
    { label:'Grenade', key:'grenade', right:true },
    { label:'Damage', key:'damage', right:true },
  ]);
  applyColumnHeatmap('tblTopKillers', ['rows','kills','assists','headshots','grenade','damage']);
}

/* ===== Player list & selection ===== */
let ALL = [];
let CURRENT_PLAYER = '';

function buildPlayerLists(allRows){
  const names = uniq(allRows.map(r=>r._player).filter(Boolean)).sort((a,b)=> a.localeCompare(b));
  const sel = el('playerSelect');
  sel.innerHTML = `<option value="">— Select player —</option>` + names.map(nm=>`<option value="${nm.replaceAll('"','&quot;')}">${nm}</option>`).join('');
  // Quick chips: top 10 by kills
  const m = new Map();
  for (const r of allRows){
    if (!r._player) continue;
    if (!m.has(r._player)) m.set(r._player, 0);
    m.set(r._player, m.get(r._player) + r.kills);
  }
  const chips = Array.from(m.entries()).map(([p,k])=>({p,k})).sort((a,b)=> b.k - a.k || a.p.localeCompare(b.p)).slice(0,10);
  el('playerChips').innerHTML = chips.map(x=>`<button class="chipbtn" data-name="${x.p}">${x.p} <span class="muted">• ${x.k}</span></button>`).join('') || '<div class="muted">No players.</div>';
  el('playerChips').querySelectorAll('.chipbtn').forEach(btn=> btn.onclick = ()=> selectPlayer(btn.getAttribute('data-name')));
  el('pickerHint').textContent = `${names.length} unique players • Top 10 chips shown below`;
}

function selectPlayer(name){
  CURRENT_PLAYER = (name||'').trim();
  el('playerSearch').value = CURRENT_PLAYER;
  el('playerSelect').value = CURRENT_PLAYER;

  const rows = ALL.filter(r => (r._player||'').toLowerCase() === CURRENT_PLAYER.toLowerCase());
  renderOverview(CURRENT_PLAYER, rows);
  renderMapPerf(rows);

  document.querySelectorAll('.chipbtn').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('data-name').toLowerCase() === CURRENT_PLAYER.toLowerCase());
  });
}

/* Copy link (?player=) */
function copyLinkToClipboard(){
  const url = new URL(window.location.href);
  if (CURRENT_PLAYER) url.searchParams.set('player', CURRENT_PLAYER);
  else url.searchParams.delete('player');
  navigator.clipboard.writeText(url.toString()).then(()=>{
    const btn = el('copyLink'); const old = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(()=> btn.textContent = old, 1200);
  });
}

/* ===== Wiring ===== */
async function initial(){
  ALL = await fetchAllRows();

  buildPlayerLists(ALL);

  // Global, player-independent tables
  renderActiveGlobal(ALL);
  renderPetGlobal(ALL);
  renderTopKillers(ALL);

  // URL ?player=
  const url = new URL(window.location.href);
  const qp = (url.searchParams.get('player')||'').trim();
  if (qp){ selectPlayer(qp); }

  // Search enter
  el('playerSearch').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const name = (e.target.value||'').trim();
      if (!name) return;
      const names = uniq(ALL.map(r=>r._player).filter(Boolean));
      const exact = names.find(nm=> nm.toLowerCase() === name.toLowerCase());
      selectPlayer(exact || name);
    }
  });

  // Dropdown change
  el('playerSelect').addEventListener('change', e=>{
    const v = (e.target.value||'').trim();
    if (!v) return;
    selectPlayer(v);
  });

  // Clear & copy
  el('clearPlayer').onclick = ()=>{
    CURRENT_PLAYER = '';
    el('playerSearch').value = '';
    el('playerSelect').value = '';
    el('playerTitle').textContent = 'Player Overview';
    el('identityBody').innerHTML = 'Select a player.';
    el('kpiBody').innerHTML = '—';
    el('tblMapPerf').innerHTML = '—';
    document.querySelectorAll('.chipbtn').forEach(b=> b.classList.remove('active'));
  };
  el('copyLink').onclick = copyLinkToClipboard;
}
initial();
</script>
</body>
</html>
