<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Path Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100vh; overflow: hidden;
      font-family: Arial, sans-serif;
      background: #121212; color: white;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #main { display: flex; height: 100vh; width: 100vw; }
    #map-container {
      flex: 1; position: relative; background: black;
    }
    #map {
      width: 100%; height: 100%;
      background-size: auto 100%;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      touch-action: none;
    }
    canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .unit {
      position: absolute; width: 30px; height: 30px;
      background: #2e2e2e; border-radius: 50%;
    }
    .unit img {
      width: 100%; height: 100%;
      box-shadow: 0 0 8px 2px rgba(255, 255, 255, 0.6);
      border-radius: 50%;
    }
    .unit-label {
      position: absolute; top: -18px; left: 0;
      font-size: 12px; background: rgba(0,0,0,0.6);
      padding: 2px 6px; border-radius: 4px;
    }
    .reset-btn {
      position: absolute; bottom: -20px; left: 0;
      background: rgba(255,255,255,0.9); color: #000;
      font-size: 10px; padding: 2px 5px;
      border: none; border-radius: 4px;
      cursor: pointer;
    }
    #sidebar {
      width: 240px;
      background: #1c1c1c;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      justify-items: center;
    }
    .team-icon {
      width: 60px; height: 60px;
      border: 2px solid #555;
      border-radius: 6px;
      cursor: pointer;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 10px;
    }
    #controls button, #map-select {
      padding: 8px;
      background: #ff7733;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #map-select {
      background: #333;
      color: #fff;
    }
    #import-file {
      display: none;
    }
  </style>
</head>
<body>
<div id="main">
  <div id="map-container">
    <div id="map">
      <canvas id="pathCanvas"></canvas>
    </div>
  </div>
  <div id="sidebar">
    <div class="icon-grid" id="teamIcons"></div>
    <div id="controls">
      <button id="draw-circle">Draw Circle</button>
      <select id="map-select">
        <option value="https://i.imgur.com/V6iUHaA.jpeg">Bermuda</option>
        <option value="https://i.imgur.com/ieY0LHk.jpeg">Purgatory</option>
        <option value="https://i.imgur.com/48O1Jf8.jpeg">Alpine</option>
        <option value="https://i.imgur.com/4Yz12P9.jpeg">Kalahari</option>
        <option value="https://i.imgur.com/0MZNMJZ.jpeg">NeXTerra</option>
        <option value="https://i.imgur.com/IX1oY9Z.jpeg">Solara</option>
      </select>
      <button id="undo-btn">Undo Last Point</button>
      <button id="reset-all-btn">Reset All</button>
      <button id="export-btn">Export</button>
      <button onclick="document.getElementById('import-file').click()">Import</button>
      <input type="file" id="import-file" accept=".json" />
    </div>
  </div>
</div>

<script>
const map = document.getElementById("map");
const canvas = document.getElementById("pathCanvas");
const ctx = canvas.getContext("2d");
const mapSelect = document.getElementById("map-select");
const teamPaths = {}, teamIcons = {}, undoStacks = {}, circles = [], circleUndoStack = [];

let selectedIcon = null, activeTeam = null;
let drawCircleMode = false;
let resizingCircle = null, isDragging = false;

const teamColors = [
  "#FF0000", "#00FF00", "#00FFFF", "#FFFF00", "#FF00FF", "#FFA500",
  "#00BFFF", "#FF69B4", "#7FFF00", "#FF4500", "#00FF7F", "#1E90FF",
  "#FFD700", "#ADFF2F", "#FF1493", "#40E0D0", "#FF6347", "#87CEEB"
];

const savedMap = localStorage.getItem("selectedMap");
map.style.backgroundImage = `url('${savedMap || mapSelect.value}')`;
mapSelect.value = savedMap || mapSelect.value;

mapSelect.onchange = () => {
  map.style.backgroundImage = `url('${mapSelect.value}')`;
  localStorage.setItem("selectedMap", mapSelect.value);
};

const ids = [
  "GZxPNXi","yXDnWtr","vjq0Mqn","i0VtqZ9","6pj4iPl","6eZfM0T","Ij8Dsbw",
  "3D3YNrl","NnVZy68","kTq43ai","QetHG72","cHJrJTZ","pa6Ne3B","KMgMXU2",
  "aVTdNhl","BQp28V6","YfTWxX8","O6Xjkbx"
];
ids.forEach((hash, i) => {
  const img = document.createElement("img");
  img.src = `https://i.imgur.com/${hash}.png`;
  img.className = "team-icon";
  img.dataset.id = "team" + (i + 1);
  img.onclick = () => selectedIcon = img;
  document.getElementById("teamIcons").appendChild(img);
});

document.getElementById("draw-circle").onclick = () => {
  drawCircleMode = !drawCircleMode;
  document.getElementById("draw-circle").textContent = drawCircleMode ? "Circle Mode: ON" : "Draw Circle";
};

function getCoords(e) {
  const rect = map.getBoundingClientRect();
  const touch = e.touches ? e.touches[0] : e;
  return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
}

map.addEventListener("click", handlePlace);
map.addEventListener("touchstart", e => {
  if (e.touches.length === 1) handlePlace(e);
});

function handlePlace(e) {
  const { x, y } = getCoords(e);
  if (drawCircleMode) {
    circles.push({ x, y, r: 50, color: "#FF2D00" });
    circleUndoStack.push({ type: "add" });
    drawPaths();
    return;
  }

  if (selectedIcon) {
    const id = selectedIcon.dataset.id;
    if (teamIcons[id]) return;

    const div = document.createElement("div");
    div.className = "unit";
    div.style.left = `${x - 15}px`;
    div.style.top = `${y - 15}px`;

    const img = selectedIcon.cloneNode(true);
    img.style.width = "30px";
    img.style.height = "30px";

    const label = document.createElement("div");
    label.className = "unit-label";
    label.textContent = id;

    const reset = document.createElement("button");
    reset.className = "reset-btn";
    reset.textContent = "Reset";
    reset.onclick = ev => {
      ev.stopPropagation();
      div.remove();
      delete teamPaths[id];
      delete teamIcons[id];
      delete undoStacks[id];
      drawPaths();
    };

    div.append(img, label, reset);
    map.appendChild(div);
    div.onclick = () => activeTeam = id;

    teamPaths[id] = [{ x, y }];
    undoStacks[id] = [];
    teamIcons[id] = div;
    activeTeam = id;
    selectedIcon = null;
    drawPaths();
  } else if (activeTeam) {
    undoStacks[activeTeam] ||= [];
    undoStacks[activeTeam].push([...teamPaths[activeTeam]]);
    teamPaths[activeTeam].push({ x, y });
    drawPaths();
  }
}

// Resize circle
function findResizeCircle({ x, y }) {
  return circles.find(c => Math.abs(Math.hypot(c.x - x, c.y - y) - c.r) < 12);
}
function startResize(e) {
  const pt = getCoords(e);
  resizingCircle = findResizeCircle(pt);
  isDragging = !!resizingCircle;
}
function moveResize(e) {
  if (!isDragging || !resizingCircle) return;
  const { x, y } = getCoords(e);
  resizingCircle.r = Math.max(10, Math.hypot(x - resizingCircle.x, y - resizingCircle.y));
  drawPaths();
}
function endResize() {
  resizingCircle = null;
  isDragging = false;
}

// Resize bindings
map.addEventListener("mousedown", startResize);
map.addEventListener("mousemove", resizeMove);
map.addEventListener("mouseup", endResize);
map.addEventListener("touchstart", startResize);
map.addEventListener("touchmove", resizeMove);
map.addEventListener("touchend", endResize);

// === DRAG CIRCLE START ===
let draggingCircle = null;
let dragOffset = { x: 0, y: 0 };

function findDraggableCircle({ x, y }) {
  return circles.find(c => Math.hypot(c.x - x, c.y - y) <= c.r);
}

function startDrag(e) {
  const pt = getCoords(e);
  if (resizingCircle) return; // don't conflict with resizing
  const target = findDraggableCircle(pt);
  if (target) {
    draggingCircle = target;
    dragOffset = { x: pt.x - target.x, y: pt.y - target.y };
    isDragging = true;
  }
}

function moveDrag(e) {
  if (!draggingCircle || !isDragging) return;
  const pt = getCoords(e);
  draggingCircle.x = pt.x - dragOffset.x;
  draggingCircle.y = pt.y - dragOffset.y;
  drawPaths();
}

function endDrag() {
  draggingCircle = null;
  isDragging = false;
}

// Drag bindings
map.addEventListener("mousedown", startDrag);
map.addEventListener("mousemove", moveDrag);
map.addEventListener("mouseup", endDrag);
map.addEventListener("touchstart", startDrag);
map.addEventListener("touchmove", moveDrag);
map.addEventListener("touchend", endDrag);
// === DRAG CIRCLE END ===
document.getElementById("undo-btn").onclick = () => {
  if (circleUndoStack.length > 0) {
    const last = circleUndoStack.pop();
    if (last.type === "add") circles.pop();
    drawPaths();
    return;
  }
  if (!activeTeam || !undoStacks[activeTeam]?.length) return;
  teamPaths[activeTeam] = undoStacks[activeTeam].pop();
  drawPaths();
};

document.getElementById("reset-all-btn").onclick = () => {
  if (!confirm("Reset all?")) return;
  Object.values(teamIcons).forEach(el => el.remove());
  Object.keys(teamIcons).forEach(k => delete teamIcons[k]);
  Object.keys(teamPaths).forEach(k => delete teamPaths[k]);
  Object.keys(undoStacks).forEach(k => delete undoStacks[k]);
  circles.length = 0;
  activeTeam = selectedIcon = null;
  drawPaths();
};

document.getElementById("export-btn").onclick = () => {
  const data = { map: mapSelect.value, paths: teamPaths, circles };
  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "team-paths.json";
  a.click(); URL.revokeObjectURL(url);
};

document.getElementById("import-file").onchange = function () {
  const file = this.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = JSON.parse(e.target.result);
    if (data.map) {
      mapSelect.value = data.map;
      map.style.backgroundImage = `url('${data.map}')`;
    }
    Object.values(teamIcons).forEach(el => el.remove());
    Object.keys(teamIcons).forEach(k => delete teamIcons[k]);
    Object.keys(teamPaths).forEach(k => delete teamPaths[k]);
    Object.keys(undoStacks).forEach(k => delete undoStacks[k]);
    circles.length = 0;

    for (let [id, pts] of Object.entries(data.paths || {})) {
      const icon = document.querySelector(`.team-icon[data-id="${id}"]`);
      if (!icon || !pts.length) continue;
      const [first] = pts;
      const div = document.createElement("div");
      div.className = "unit";
      div.style.left = `${first.x - 15}px`;
      div.style.top = `${first.y - 15}px`;
      const img = icon.cloneNode(true);
      img.style.width = img.style.height = "30px";
      const label = document.createElement("div");
      label.className = "unit-label"; label.textContent = id;
      const reset = document.createElement("button");
      reset.className = "reset-btn";
      reset.textContent = "Reset";
      reset.onclick = ev => {
        ev.stopPropagation();
        div.remove();
        delete teamPaths[id];
        delete teamIcons[id];
        delete undoStacks[id];
        drawPaths();
      };
      div.append(img, label, reset);
      map.appendChild(div);
      div.onclick = () => activeTeam = id;
      teamPaths[id] = pts;
      undoStacks[id] = [];
      teamIcons[id] = div;
    }

    (data.circles || []).forEach(c => circles.push(c));
    drawPaths();
  };
  reader.readAsText(file);
};

function drawArrow(from, to, color) {
  const dx = to.x - from.x, dy = to.y - from.y;
  const angle = Math.atan2(dy, dx);
  ctx.beginPath();
  ctx.shadowColor = color;
  ctx.shadowBlur = 5;
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.lineTo(to.x - 10 * Math.cos(angle - Math.PI / 6), to.y - 10 * Math.sin(angle - Math.PI / 6));
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(to.x - 10 * Math.cos(angle + Math.PI / 6), to.y - 10 * Math.sin(angle + Math.PI / 6));
  ctx.strokeStyle = color;
  ctx.lineWidth = 4;
  ctx.stroke();
}

function drawPaths() {
  canvas.width = map.clientWidth;
  canvas.height = map.clientHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let c of circles) {
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, 2 * Math.PI);
    ctx.strokeStyle = c.color;
    ctx.setLineDash([4, 4]);
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.beginPath();
    ctx.arc(c.x + c.r, c.y, 4, 0, 2 * Math.PI);
    ctx.fillStyle = c.color;
    ctx.fill();
  }

  for (let id in teamPaths) {
    const path = teamPaths[id];
    const i = parseInt(id.replace("team", "")) - 1;
    const color = teamColors[i] || "#fff";
    for (let j = 0; j < path.length - 1; j++) {
      drawArrow(path[j], path[j + 1], color);
    }
  }
}

window.addEventListener("resize", drawPaths);
drawPaths();
</script>
</body>
</html>
