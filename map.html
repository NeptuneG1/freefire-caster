<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Path Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
    }

    #main {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #map-container {
      flex: 1;
      position: relative;
      background: black;
    }

    #map {
      width: 100%;
      height: 100%;
      background-size: auto 100%;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      pointer-events: none;
    }

    .unit {
      position: absolute;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    .unit img {
      width: 30px;
      height: 30px;
      box-shadow: 0 0 8px 2px rgba(255, 255, 255, 0.6);
      border-radius: 50%;
    }

    .unit-label {
      position: absolute;
      top: -18px;
      left: 0;
      font-size: 12px;
      background: rgba(0,0,0,0.6);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .reset-btn {
      position: absolute;
      bottom: -20px;
      left: 0;
      background: rgba(255,255,255,0.9);
      color: #000;
      font-size: 10px;
      padding: 2px 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #sidebar {
      width: 240px;
      background: #1c1c1c;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      justify-items: center;
    }

    .team-icon {
      width: 60px;
      height: 60px;
      border: 2px solid #555;
      border-radius: 6px;
      cursor: pointer;
    }

    #controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 10px;
    }

    #controls button,
    #map-select {
      padding: 8px;
      background: #ff7733;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #map-select {
      background: #333;
      color: #fff;
      font-weight: normal;
    }

    #import-file {
      display: none;
    }
  </style>
</head>
<body>
<div id="main">
  <div id="map-container">
    <div id="map">
      <canvas id="pathCanvas"></canvas>
    </div>
  </div>
  <div id="sidebar">
    <div class="icon-grid" id="teamIcons"></div>
    <div id="controls">
      <select id="map-select">
        <option value="https://i.imgur.com/V6iUHaA.jpeg">Bermuda</option>
        <option value="https://i.imgur.com/ieY0LHk.jpeg">Purgatory</option>
        <option value="https://i.imgur.com/48O1Jf8.jpeg">Alpine</option>
        <option value="https://i.imgur.com/4Yz12P9.jpeg">Kalahari</option>
        <option value="https://i.imgur.com/0MZNMJZ.jpeg">NeXTerra</option>
        <option value="https://i.imgur.com/IX1oY9Z.jpeg">Solara</option>
      </select>
      <button id="undo-btn">Undo Last Point</button>
      <button id="reset-all-btn">Reset All</button>
      <button id="export-btn">Export</button>
      <button onclick="document.getElementById('import-file').click()">Import</button>
      <input type="file" id="import-file" accept=".json" />
    </div>
  </div>
</div>

<script>
const map = document.getElementById("map");
const canvas = document.getElementById("pathCanvas");
const ctx = canvas.getContext("2d");
const mapSelect = document.getElementById("map-select");
const teamPaths = {};
const teamIcons = {};
const undoStacks = {};

const teamColors = [
  "#FF0000", "#00FF00", "#00FFFF", "#FFFF00", "#FF00FF", "#FFA500",
  "#00BFFF", "#FF69B4", "#7FFF00", "#FF4500", "#00FF7F", "#1E90FF",
  "#FFD700", "#ADFF2F", "#FF1493", "#40E0D0", "#FF6347", "#87CEEB"
];

let selectedIcon = null;
let activeTeam = null;

const savedMap = localStorage.getItem("selectedMap");
if (savedMap) {
  map.style.backgroundImage = `url('${savedMap}')`;
  mapSelect.value = savedMap;
} else {
  map.style.backgroundImage = `url('${mapSelect.value}')`;
}

mapSelect.addEventListener("change", function () {
  map.style.backgroundImage = `url('${this.value}')`;
  localStorage.setItem("selectedMap", this.value);
});

const iconGrid = document.getElementById("teamIcons");
for (let i = 1; i <= 18; i++) {
  const img = document.createElement("img");
  img.src = `https://i.imgur.com/${[
    "GZxPNXi", "yXDnWtr", "vjq0Mqn", "i0VtqZ9", "6pj4iPl", "6eZfM0T",
    "Ij8Dsbw", "3D3YNrl", "NnVZy68", "kTq43ai", "QetHG72", "cHJrJTZ",
    "pa6Ne3B", "KMgMXU2", "aVTdNhl", "BQp28V6", "YfTWxX8", "O6Xjkbx"
  ][i - 1]}.png`;
  img.className = "team-icon";
  img.dataset.id = "team" + i;
  img.addEventListener("click", () => selectedIcon = img);
  iconGrid.appendChild(img);
}

map.addEventListener("click", e => {
  const rect = map.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const iconSize = 30;

  if (selectedIcon) {
    const id = selectedIcon.dataset.id;
    if (teamIcons[id]) return;

    const div = document.createElement("div");
    div.className = "unit";
    div.style.left = `${x - iconSize / 2}px`;
    div.style.top = `${y - iconSize / 2}px`;

    const img = selectedIcon.cloneNode(true);
    img.style.width = `${iconSize}px`;
    img.style.height = `${iconSize}px`;

    const label = document.createElement("div");
    label.className = "unit-label";
    label.textContent = id;

    const reset = document.createElement("button");
    reset.className = "reset-btn";
    reset.textContent = "Reset";
    reset.onclick = ev => {
      ev.stopPropagation();
      div.remove();
      delete teamPaths[id];
      delete teamIcons[id];
      delete undoStacks[id];
      drawPaths();
    };

    div.appendChild(img);
    div.appendChild(label);
    div.appendChild(reset);
    map.appendChild(div);
    div.addEventListener("click", () => activeTeam = id);

    teamPaths[id] = [{ x, y }];
    undoStacks[id] = [];
    teamIcons[id] = div;
    activeTeam = id;
    selectedIcon = null;
    drawPaths();
  } else if (activeTeam) {
    if (!undoStacks[activeTeam]) undoStacks[activeTeam] = [];
    undoStacks[activeTeam].push([...teamPaths[activeTeam]]);
    teamPaths[activeTeam].push({ x, y });
    drawPaths();
  }
});

document.getElementById("undo-btn").addEventListener("click", () => {
  if (!activeTeam || !undoStacks[activeTeam] || undoStacks[activeTeam].length === 0) return;
  teamPaths[activeTeam] = undoStacks[activeTeam].pop();
  drawPaths();
});

document.getElementById("reset-all-btn").addEventListener("click", () => {
  // Remove all icons from map
  Object.values(teamIcons).forEach(div => div.remove());

  // Clear all internal data
  for (let key in teamIcons) delete teamIcons[key];
  for (let key in teamPaths) delete teamPaths[key];
  for (let key in undoStacks) delete undoStacks[key];

  activeTeam = null;
  selectedIcon = null;
  drawPaths();
});

function drawArrow(from, to, color) {
  const headlen = 10;
  const dx = to.x - from.x;
  const dy = to.y - from.y;
  const angle = Math.atan2(dy, dx);
  ctx.beginPath();
  ctx.shadowColor = color;
  ctx.shadowBlur = 6;
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.lineTo(to.x - headlen * Math.cos(angle - Math.PI / 6), to.y - headlen * Math.sin(angle - Math.PI / 6));
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(to.x - headlen * Math.cos(angle + Math.PI / 6), to.y - headlen * Math.sin(angle + Math.PI / 6));
  ctx.strokeStyle = color;
  ctx.lineWidth = 4;
  ctx.stroke();
}

function drawPaths() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let id in teamPaths) {
    const path = teamPaths[id];
    const index = parseInt(id.replace("team", "")) - 1;
    const color = teamColors[index] || 'white';
    for (let i = 0; i < path.length - 1; i++) {
      drawArrow(path[i], path[i + 1], color);
    }
  }
}

document.getElementById("export-btn").addEventListener("click", () => {
  const data = {
    map: mapSelect.value,
    paths: teamPaths
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "team-paths.json";
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("import-file").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const loaded = JSON.parse(e.target.result);
    if (loaded.map) {
      map.style.backgroundImage = `url('${loaded.map}')`;
      mapSelect.value = loaded.map;
      localStorage.setItem("selectedMap", loaded.map);
    }

    Object.values(teamIcons).forEach(div => div.remove());
    Object.keys(teamIcons).forEach(id => delete teamIcons[id]);
    Object.keys(teamPaths).forEach(id => delete teamPaths[id]);
    Object.keys(undoStacks).forEach(id => delete undoStacks[id]);

    if (loaded.paths) {
      Object.entries(loaded.paths).forEach(([id, points]) => {
        teamPaths[id] = points;
        const baseIcon = document.querySelector(`.team-icon[data-id="${id}"]`);
        if (!baseIcon || !points.length) return;

        const first = points[0];
        const div = document.createElement("div");
        div.className = "unit";
        div.style.left = `${first.x - 15}px`;
        div.style.top = `${first.y - 15}px`;

        const img = baseIcon.cloneNode(true);
        img.style.width = "30px";
        img.style.height = "30px";

        const label = document.createElement("div");
        label.className = "unit-label";
        label.textContent = id;

        const reset = document.createElement("button");
        reset.className = "reset-btn";
        reset.textContent = "Reset";
        reset.onclick = ev => {
          ev.stopPropagation();
          div.remove();
          delete teamPaths[id];
          delete teamIcons[id];
          delete undoStacks[id];
          drawPaths();
        };

        div.appendChild(img);
        div.appendChild(label);
        div.appendChild(reset);
        map.appendChild(div);
        div.addEventListener("click", () => activeTeam = id);
        teamIcons[id] = div;
        undoStacks[id] = [];
      });
    }

    drawPaths();
  };
  reader.readAsText(file);
});

window.addEventListener("resize", () => {
  canvas.width = map.clientWidth;
  canvas.height = map.clientHeight;
  drawPaths();
});
canvas.width = map.clientWidth;
canvas.height = map.clientHeight;
</script>
</body>
</html>
