<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FF Team Report</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#07090f; --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.10);
      --ink:#f4f6ff; --muted:#aab1c5;
      --brand:#ffbd59; --brand2:#ff7733; --accent:#4dd3ff;
      --radius:16px; --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --good:#71d083; --bad:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(77,211,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,189,89,.20), transparent 55%),
        radial-gradient(900px 600px at 80% 110%, rgba(255,119,51,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family:var(--sans);
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(7,9,15,.80), rgba(7,9,15,.55));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:14px 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .fflogo{
      width:44px;height:44px;border-radius:14px;
      object-fit:contain;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
      padding:6px;
    }
    h1{font-size:16px;margin:0;letter-spacing:.3px;font-family:Orbitron, var(--sans)}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn, input, select{font-family:inherit}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(255,189,89,.35);
      background: linear-gradient(180deg, rgba(255,189,89,.16), rgba(255,119,51,.10));
    }
    .btn.bad{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.16), rgba(255,107,107,.08));
    }

    main{max-width:1280px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px}

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{font-size:14px;margin:0;letter-spacing:.25px}
    .card .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    label{font-size:12px;color:var(--muted)}

    input[type="text"], select{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
    }
    select{color-scheme: dark}
    input:focus, select:focus{
      border-color: rgba(77,211,255,.45);
      box-shadow: 0 0 0 3px rgba(77,211,255,.12);
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.3}

    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--ink);
      display:inline-flex;gap:8px;align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.neutral{background:var(--accent)}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(244,246,255,.92);
      line-height:1.35;
      white-space:pre-wrap;
    }

    .summary{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 1000px){ .summary{grid-template-columns: repeat(3, minmax(0, 1fr));} }
    @media (max-width: 560px){ .summary{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
    }
    .kpi .k{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:800;letter-spacing:.2px;margin-top:4px}

    .players{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .players{grid-template-columns:1fr} }

    details.pcard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      overflow:hidden;
    }
    details.pcard summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.pcard summary::-webkit-details-marker{display:none}
    .pname{display:flex;flex-direction:column;gap:2px}
    .pname .n{font-weight:800}
    .pname .s{font-size:12px;color:var(--muted);font-family:var(--mono)}
    .pright{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(244,246,255,.92);
      display:inline-flex;gap:6px;align-items:center;
    }
    .chip b{font-family:var(--mono)}
    .pbody{padding:12px;border-top:1px solid rgba(255,255,255,.08)}
    .statgrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 740px){ .statgrid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    .stat{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px 10px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:16px;font-weight:800;margin-top:4px}

    .barwrap{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      overflow:hidden;
      height:10px;
    }
    .barseg{height:100%;display:inline-block}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:var(--muted)}
    .lg{display:inline-flex;align-items:center;gap:6px}
    .sq{width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.18)}

    .tablewrap{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
      max-height: 260px;
      overflow:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead th{
      position: sticky; top: 0;
      background: rgba(7,9,15,.92);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 10px;
      text-align:left;
      white-space:nowrap;
      z-index:2;
    }
    tbody td{
      border-top:1px solid rgba(255,255,255,.06);
      padding:8px 10px;
      vertical-align:top;
      word-break: break-word;
      color: rgba(244,246,255,.92);
      font-family: var(--mono);
    }
    tbody tr:hover td{background: rgba(255,255,255,.03)}
    .small{font-size:11px;color:var(--muted);font-family: var(--sans)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img class="fflogo"
             src="https://upload.wikimedia.org/wikipedia/en/7/7d/Garena_Free_Fire_logo.png"
             alt="Free Fire"
             onerror="this.style.display='none'"/>
        <div>
          <h1>FF Team Report</h1>
          <div class="sub">Team = <b>team_name</b> (player’s team) • Eliminator = <b>eliminated_team_name</b></div>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="dashboard.html">Back to Dashboard</a>
        <button class="btn" id="btnReloadTeams">Reload Teams</button>
        <button class="btn bad" id="btnSignOut">Sign out</button>
        <span class="pill" id="authPill"><span class="dot neutral"></span><span id="authText">Checking session…</span></span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <div class="hd">
        <h2>1) Select Team</h2>
        <span class="pill"><span class="dot neutral"></span><span id="metaText">—</span></span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field" style="min-width:260px;flex:1.1">
            <label>Team (team_name)</label>
            <select id="teamSel">
              <option value="">Loading…</option>
            </select>
            <div class="hint">Shows players that belong to the selected team (from <span style="font-family:var(--mono)">team_name</span>).</div>
          </div>

          <!-- ✅ Filters changed to dropdowns (auto-filled from data for selected team) -->
          <div class="field" style="min-width:220px;flex:.9">
            <label>Filter: Tournament</label>
            <select id="fTournament" disabled>
              <option value="">All</option>
            </select>
          </div>

          <div class="field" style="min-width:200px;flex:.6">
            <label>Filter: Stage</label>
            <select id="fStage" disabled>
              <option value="">All</option>
            </select>
          </div>

          <div class="field" style="min-width:150px;flex:.4">
            <label>Filter: Year</label>
            <select id="fYear" disabled>
              <option value="">All</option>
            </select>
          </div>

          <div class="field" style="min-width:160px;flex:.5">
            <label>Filter: Match ID</label>
            <select id="fMatchId" disabled>
              <option value="">All</option>
            </select>
          </div>

          <div class="field" style="min-width:140px;flex:.35">
            <label>Kill range (m)</label>
            <select id="rangePreset">
              <option value="15,50" selected>Close ≤15 • Mid 16–50 • Long &gt;50</option>
              <option value="10,40">Close ≤10 • Mid 11–40 • Long &gt;40</option>
              <option value="20,60">Close ≤20 • Mid 21–60 • Long &gt;60</option>
            </select>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;align-items:center">
          <button class="btn primary" id="btnRun">Build Report</button>
        </div>

        <div class="status" id="status">Ready.</div>
      </div>
    </section>

    <section class="card" id="reportCard" style="display:none">
      <div class="hd">
        <h2>2) Team Summary</h2>
        <span class="pill"><span class="dot neutral"></span><span id="scopeText">—</span></span>
      </div>
      <div class="bd">
        <div class="summary" id="teamKpis"></div>
        <div style="height:12px"></div>
        <div class="players" id="players"></div>
      </div>
    </section>

  </div>
</main>

<script>
  // =============================
  // CONFIG
  // =============================
  const SUPABASE_URL = "https://gkugecflfddkpitlrmws.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE";
  const TABLE = "ff_stats_raw";

  // minimal columns needed for your report (team rows)
  const SELECT_COLS = [
    "owner_id","match_id","Mode","Tournament","Stage","Year","Week","Day","MatchNumber",
    "team_name","eliminated_team_name",
    "player_stats_account_id","player_stats_nickname",
    "player_stats_kills","player_stats_assists",
    "player_stats_kill_distance","player_stats_kill_info",
    "player_stats_torso_hits","player_stats_leg_hits","player_stats_headshots",
    "player_stats_headshot_killtimes",
    "player_stats_medkit_use",
    "player_stats_revived_times",
    "player_stats_revive_teammate_times","player_stats_revive_teammate_nums",
    "player_stats_weapon_usages"
  ].join(",");

  // lobby identity cols to resolve player_killed_id -> nickname (and weapon_id -> weapon_name)
  const LOBBY_COLS = [
    "match_id",
    "team_name",
    "player_stats_account_id",
    "player_stats_nickname",
    "player_stats_weapon_usages"
  ].join(",");

  // meta-only cols for building dropdown filters
  const META_COLS = ["Tournament","Stage","Year","match_id"].join(",");

  // =============================
  // Helpers
  // =============================
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function num(v){
    if(v === null || v === undefined || v === "") return 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function parsePipeInts(v){
    if(v === null || v === undefined) return [];
    if(Array.isArray(v)) return v.map(x=>Number(x)).filter(Number.isFinite);
    const s = String(v).trim();
    if(!s || s === "[]" || s.toLowerCase() === "nan") return [];
    if(s.startsWith("[") && s.endsWith("]")){
      try{
        const arr = JSON.parse(s);
        if(Array.isArray(arr)) return arr.map(x=>Number(x)).filter(Number.isFinite);
      }catch(_e){}
    }
    return s.split("|").map(x=>x.trim()).filter(Boolean).map(x=>Number(x)).filter(Number.isFinite);
  }

  function parseKillInfo(v){
    if(v === null || v === undefined) return [];
    if(Array.isArray(v)) return v;
    const s = String(v).trim();
    if(!s || s === "[]" || s.toLowerCase() === "nan") return [];
    try{
      const arr = JSON.parse(s);
      return Array.isArray(arr) ? arr : [];
    }catch(_e){
      return [];
    }
  }

  function parseJSONSafe(v){
    if(v === null || v === undefined) return null;
    if(typeof v === "object") return v;
    const s = String(v).trim();
    if(!s || s === "[]" || s.toLowerCase() === "nan") return null;
    try{
      return JSON.parse(s);
    }catch(_e){
      return null;
    }
  }

  function pickRanges(){
    const [closeMax, midMax] = ($("rangePreset").value || "15,50").split(",").map(x=>Number(x.trim()));
    return { closeMax: Number.isFinite(closeMax)?closeMax:15, midMax: Number.isFinite(midMax)?midMax:50 };
  }

  function setAuthPill(state, text){
    const pill = $("authPill");
    const dot = pill.querySelector(".dot");
    dot.classList.remove("good","bad","neutral");
    dot.classList.add(state);
    $("authText").textContent = text;
  }

  function setStatus(msg, isErr=false){
    $("status").textContent = msg;
    $("status").style.borderColor = isErr ? "rgba(255,107,107,.35)" : "rgba(255,255,255,.10)";
  }

  function chunk(arr, n){
    const out = [];
    for(let i=0;i<arr.length;i+=n) out.push(arr.slice(i, i+n));
    return out;
  }

  // ✅ W-D-M formatter (requested)
  function fmtWDM(week, day, matchNum){
    const w = (week !== null && week !== undefined && week !== "") ? `W${week}` : "W?";
    const d = (day !== null && day !== undefined && day !== "") ? `D${day}` : "D?";
    const m = (matchNum !== null && matchNum !== undefined && matchNum !== "") ? `M${matchNum}` : "M?";
    return `${w}-${d}-${m}`;
  }

  function setSelectOptions(sel, values, { allLabel="All", placeholderIfEmpty="All", sort="alpha" } = {}){
    const unique = Array.from(new Set((values || []).filter(v => v !== null && v !== undefined && String(v).trim() !== "")));

    if(sort === "alpha"){
      unique.sort((a,b)=>String(a).localeCompare(String(b)));
    }else if(sort === "num"){
      unique.sort((a,b)=>Number(a) - Number(b));
    }

    const hasData = unique.length > 0;
    sel.innerHTML = `<option value="">${escapeHtml(allLabel)}</option>` + unique.map(v=>{
      return `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`;
    }).join("");

    sel.disabled = !hasData;
    if(!hasData){
      sel.innerHTML = `<option value="">${escapeHtml(placeholderIfEmpty)}</option>`;
    }
  }

  // =============================
  // Supabase client + session gate
  // =============================
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  let SESSION = null;
  let UID = null;

  async function requireSessionOrRedirect(){
    if(location.protocol === "file:"){
      setAuthPill("bad", "file:// (host this folder)");
      setStatus(
        "You're opening via file://.\nSupabase sessions may not persist across pages, causing redirects.\n\nFix: host the folder, e.g.\npython3 -m http.server 8080\nthen open http://localhost:8080/index.html",
        true
      );
      return null;
    }

    const { data, error } = await sb.auth.getSession();
    if(error){
      setAuthPill("bad", "Auth error");
      setStatus("Auth error:\n" + error.message, true);
      window.location.replace("index.html");
      return null;
    }
    if(data?.session){
      SESSION = data.session;
      UID = data.session.user?.id || null;
      setAuthPill("good", data.session.user?.email || "signed in");
      return data.session;
    }

    setAuthPill("neutral", "Loading session…");
    return await new Promise((resolve) => {
      let done = false;

      const sub = sb.auth.onAuthStateChange(async (evt, session) => {
        if(done) return;
        if(evt === "INITIAL_SESSION" || evt === "SIGNED_IN" || evt === "TOKEN_REFRESHED"){
          if(session){
            done = true;
            sub?.data?.subscription?.unsubscribe?.();
            SESSION = session;
            UID = session.user?.id || null;
            setAuthPill("good", session.user?.email || "signed in");
            resolve(session);
          }
        }
      });

      setTimeout(async () => {
        if(done) return;
        const { data: d2 } = await sb.auth.getSession();
        if(d2?.session){
          done = true;
          sub?.data?.subscription?.unsubscribe?.();
          SESSION = d2.session;
          UID = d2.session.user?.id || null;
          setAuthPill("good", d2.session.user?.email || "signed in");
          resolve(d2.session);
          return;
        }
        window.location.replace("index.html");
      }, 1000);
    });
  }

  async function signOut(){
    try{ await sb.auth.signOut(); }catch(_e){}
    window.location.replace("index.html");
  }

  // =============================
  // Data fetch (paged)
  // =============================
  async function fetchAllTeams(){
    if(!UID) return [];
    const pageSize = 1000;
    let from = 0;
    const set = new Set();

    while(true){
      const { data, error } = await sb
        .from(TABLE)
        .select("team_name")
        .eq("owner_id", UID)
        .neq("team_name", null)
        .range(from, from + pageSize - 1);

      if(error) throw error;

      for(const r of (data || [])){
        const t = String(r.team_name || "").trim();
        if(t) set.add(t);
      }
      if(!data || data.length < pageSize) break;
      from += pageSize;
      if(from > 200000) break;
    }

    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  async function fetchTeamRows(teamName, filters){
    if(!UID) return [];
    const pageSize = 1000;
    let from = 0;
    const all = [];

    while(true){
      let q = sb
        .from(TABLE)
        .select(SELECT_COLS)
        .eq("owner_id", UID)
        .eq("team_name", teamName);

      if(filters.tournament) q = q.eq("Tournament", filters.tournament);
      if(filters.stage) q = q.eq("Stage", filters.stage);
      if(filters.year !== null && filters.year !== undefined && filters.year !== "") q = q.eq("Year", filters.year);
      if(filters.matchId) q = q.eq("match_id", filters.matchId);

      const { data, error } = await q.range(from, from + pageSize - 1);
      if(error) throw error;

      all.push(...(data || []));
      if(!data || data.length < pageSize) break;
      from += pageSize;
      if(from > 200000) break;
    }

    return all;
  }

  async function fetchTeamMeta(teamName){
    if(!UID) return { tournaments:[], stages:[], years:[], matchIds:[] };

    const pageSize = 1000;
    let from = 0;

    const tournaments = new Set();
    const stages = new Set();
    const years = new Set();
    const matchIds = new Set();

    while(true){
      const { data, error } = await sb
        .from(TABLE)
        .select(META_COLS)
        .eq("owner_id", UID)
        .eq("team_name", teamName)
        .range(from, from + pageSize - 1);

      if(error) throw error;

      for(const r of (data || [])){
        if(r.Tournament != null && String(r.Tournament).trim() !== "") tournaments.add(String(r.Tournament).trim());
        if(r.Stage != null && String(r.Stage).trim() !== "") stages.add(String(r.Stage).trim());
        if(r.Year != null && String(r.Year).trim() !== "") years.add(String(r.Year).trim());
        if(r.match_id != null && String(r.match_id).trim() !== "") matchIds.add(String(r.match_id).trim());
      }

      if(!data || data.length < pageSize) break;
      from += pageSize;
      if(from > 200000) break;
    }

    return {
      tournaments: Array.from(tournaments),
      stages: Array.from(stages),
      years: Array.from(years),
      matchIds: Array.from(matchIds),
    };
  }

  async function fetchLobbyRowsByMatchIds(matchIds){
    if(!UID || !matchIds.length) return [];

    const ids = Array.from(new Set(matchIds.map(x=>String(x)).filter(Boolean)));
    const chunks = chunk(ids, 50);

    let out = [];
    for(let i=0;i<chunks.length;i++){
      const partIds = chunks[i];
      setStatus(`Resolving nicknames… (${i+1}/${chunks.length})\nBuilding player map from full lobby rows...`);

      const { data, error } = await sb
        .from(TABLE)
        .select(LOBBY_COLS)
        .eq("owner_id", UID)
        .in("match_id", partIds);

      if(error) throw error;
      out.push(...(data || []));
    }
    return out;
  }

  function buildIdentityMaps(lobbyRows){
    const idToNick = new Map();
    const idToTeam = new Map();
    const weaponIdToName = new Map();

    for(const r of (lobbyRows || [])){
      const id = r.player_stats_account_id != null ? String(r.player_stats_account_id) : "";
      const nick = r.player_stats_nickname != null ? String(r.player_stats_nickname) : "";
      const team = r.team_name != null ? String(r.team_name) : "";

      if(id){
        if(nick && !idToNick.has(id)) idToNick.set(id, nick);
        if(team && !idToTeam.has(id)) idToTeam.set(id, team);
      }

      const usages = parseJSONSafe(r.player_stats_weapon_usages);
      if(Array.isArray(usages)){
        for(const u of usages){
          const wid = u?.weapon_id;
          const wnm = u?.weapon_name;
          if(wid != null && wnm != null){
            const key = String(wid);
            if(!weaponIdToName.has(key)) weaponIdToName.set(key, String(wnm));
          }
        }
      }
    }

    return { idToNick, idToTeam, weaponIdToName };
  }

  // =============================
  // Report build
  // =============================
  function buildReport(rows, maps){
    const { closeMax, midMax } = pickRanges();
    const idToNick = maps?.idToNick || new Map();
    const weaponIdToName = maps?.weaponIdToName || new Map();
    const idToTeam = maps?.idToTeam || new Map();

    const team = {
      matches: new Set(),
      players: new Map(),
      totalKills: 0,
      totalAssists: 0
    };

    for(const r of (rows || [])){
      const pid = r.player_stats_account_id;
      if(!pid) continue;

      const key = String(pid);
      const nick = (r.player_stats_nickname || idToNick.get(key) || "(unknown)");

      if(r.match_id !== null && r.match_id !== undefined) team.matches.add(String(r.match_id));

      if(!team.players.has(key)){
        team.players.set(key, {
          account_id: key,
          nickname: nick,
          matches: new Set(),
          kills: 0,
          assists: 0,
          torso: 0,
          leg: 0,
          headshots: 0,
          headshotKilltimes: 0,
          medkit: 0,
          revivedTimes: 0,           // player was revived
          reviveTeammateTimes: 0,    // player revived others
          reviveTeammateNums: 0,
          killDistances: [],
          killFeed: [],
          weaponCounts: {},
          eliminatedBy: {}
        });
      }

      const p = team.players.get(key);
      if(r.match_id !== null && r.match_id !== undefined) p.matches.add(String(r.match_id));
      if(!p.nickname || p.nickname === "(unknown)") p.nickname = nick;

      p.kills += num(r.player_stats_kills);
      p.assists += num(r.player_stats_assists);
      p.torso += num(r.player_stats_torso_hits);
      p.leg += num(r.player_stats_leg_hits);
      p.headshots += num(r.player_stats_headshots);
      p.headshotKilltimes += num(r.player_stats_headshot_killtimes);
      p.medkit += num(r.player_stats_medkit_use);
      p.revivedTimes += num(r.player_stats_revived_times);
      p.reviveTeammateTimes += num(r.player_stats_revive_teammate_times);
      p.reviveTeammateNums += num(r.player_stats_revive_teammate_nums);

      // distances list fallback (pipe list)
      p.killDistances.push(...parsePipeInts(r.player_stats_kill_distance));

      // kill feed from kill_info (victim + weapon + distance + timestamp)
      const kills = parseKillInfo(r.player_stats_kill_info);
      for(const k of kills){
        const killerId = (k?.killer_id ?? key);
        const victimId = (k?.player_killed_id ?? "");
        const weaponId = (k?.weapon_used_id ?? "");
        const dist = Number(k?.kill_distance);
        const ts = Number(k?.kill_timestamp);

        // prefer kill_info distance for bucketing
        if(Number.isFinite(dist)) p.killDistances.push(dist);

        const killerKey = String(killerId);
        const victimKey = String(victimId);
        const weaponKey = String(weaponId);

        const victimNick = victimKey ? (idToNick.get(victimKey) || "") : "";
        const killerNick = idToNick.get(killerKey) || (killerKey === key ? p.nickname : "");
        const weaponName = weaponIdToName.get(weaponKey) || "";

        p.killFeed.push({
          // ✅ requested: show Week-Day-MatchNumber instead of kill_timestamp
          wdm: fmtWDM(r.Week, r.Day, r.MatchNumber),

          // keep these for internal use / sorting
          match_id: (r.match_id != null ? String(r.match_id) : ""),
          kill_timestamp: Number.isFinite(ts) ? ts : null,

          killer_id: killerKey,
          killer_nickname: killerNick || killerKey,

          player_killed_id: victimKey,
          victim_nickname: victimNick || victimKey,
          victim_team: victimKey ? (idToTeam.get(victimKey) || "") : "",

          weapon_used_id: weaponKey,
          weapon_name: weaponName,

          kill_distance: Number.isFinite(dist) ? dist : null,
        });

        if(weaponKey && weaponKey !== "undefined" && weaponKey !== "null"){
          p.weaponCounts[weaponKey] = (p.weaponCounts[weaponKey] || 0) + 1;
        }
      }

      // who eliminated the player (team that eliminated them)
      const elimTeam = String(r.eliminated_team_name || "").trim();
      if(elimTeam){
        p.eliminatedBy[elimTeam] = (p.eliminatedBy[elimTeam] || 0) + 1;
      }
    }

    // team totals
    for(const p of team.players.values()){
      team.totalKills += p.kills;
      team.totalAssists += p.assists;
    }

    // finalize each player
    const players = Array.from(team.players.values()).map(p=>{
      const d = p.killDistances.filter(Number.isFinite);
      const close = d.filter(x=>x <= closeMax).length;
      const mid = d.filter(x=>x > closeMax && x <= midMax).length;
      const long = d.filter(x=>x > midMax).length;
      const avgDist = d.length ? (d.reduce((a,b)=>a+b,0) / d.length) : 0;

      // sort by timestamp if present (still useful), otherwise keep insertion order
      p.killFeed.sort((a,b)=>(a.kill_timestamp ?? 9e15) - (b.kill_timestamp ?? 9e15));

      const topWeapons = Object.entries(p.weaponCounts)
        .sort((a,b)=>b[1]-a[1])
        .slice(0, 6)
        .map(([wid,c])=>({ wid, c, name: (weaponIdToName.get(wid) || "") }));

      const topElimBy = Object.entries(p.eliminatedBy)
        .sort((a,b)=>b[1]-a[1])
        .slice(0, 3)
        .map(([t,c])=>({ t, c }));

      return {
        ...p,
        matchesPlayed: p.matches.size,
        dist: { close, mid, long, avg: avgDist, total: d.length },
        topWeapons,
        topElimBy
      };
    });

    players.sort((a,b)=> (b.kills - a.kills) || (b.assists - a.assists) || a.nickname.localeCompare(b.nickname));

    return {
      matchesPlayed: team.matches.size,
      playerCount: players.length,
      totalKills: team.totalKills,
      totalAssists: team.totalAssists,
      players
    };
  }

  // =============================
  // Render
  // =============================
  function kpiHTML(k, v){
    return `<div class="kpi"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>`;
  }

  function renderTeamKpis(teamName, report, filters){
    const scopeBits = [];
    if(filters.tournament) scopeBits.push(`Tournament=${filters.tournament}`);
    if(filters.stage) scopeBits.push(`Stage=${filters.stage}`);
    if(filters.year !== null && filters.year !== undefined && filters.year !== "") scopeBits.push(`Year=${filters.year}`);
    if(filters.matchId) scopeBits.push(`match_id=${filters.matchId}`);
    $("scopeText").textContent = scopeBits.length ? scopeBits.join(" • ") : "All rows for selected team";

    const box = $("teamKpis");
    box.innerHTML = [
      kpiHTML("Team", teamName),
      kpiHTML("Matches", String(report.matchesPlayed)),
      kpiHTML("Players", String(report.playerCount)),
      kpiHTML("Total Kills", String(report.totalKills)),
      kpiHTML("Total Assists", String(report.totalAssists)),
      kpiHTML("K+A", String(report.totalKills + report.totalAssists))
    ].join("");
  }

  function renderPlayers(players){
    const { closeMax, midMax } = pickRanges();

    const container = $("players");
    container.innerHTML = "";

    for(const p of players){
      const d = p.dist;
      const total = Math.max(1, d.total);
      const closePct = Math.round((d.close/total)*100);
      const midPct = Math.round((d.mid/total)*100);
      const longPct = Math.max(0, 100 - closePct - midPct);

      const bar = `
        <div class="barwrap" title="Kill distance distribution">
          <span class="barseg" style="width:${closePct}%;background: rgba(77,211,255,.75)"></span>
          <span class="barseg" style="width:${midPct}%;background: rgba(255,189,89,.72)"></span>
          <span class="barseg" style="width:${longPct}%;background: rgba(255,119,51,.72)"></span>
        </div>
        <div class="legend">
          <span class="lg"><span class="sq" style="background:rgba(77,211,255,.65)"></span>Close ≤${closeMax}: <b>${d.close}</b></span>
          <span class="lg"><span class="sq" style="background:rgba(255,189,89,.62)"></span>Mid ≤${midMax}: <b>${d.mid}</b></span>
          <span class="lg"><span class="sq" style="background:rgba(255,119,51,.62)"></span>Long &gt;${midMax}: <b>${d.long}</b></span>
          <span class="lg">Avg: <b>${d.avg ? d.avg.toFixed(1) : "0.0"}</b></span>
        </div>
      `;

      const topWeapons = p.topWeapons.length
        ? p.topWeapons.map(x=>{
            const label = x.name ? `${x.name} (${x.wid})` : x.wid;
            return `<span class="chip">${escapeHtml(label)} × ${escapeHtml(x.c)}</span>`;
          }).join(" ")
        : `<span class="small">No weapon ids found.</span>`;

      const topElimBy = p.topElimBy.length
        ? p.topElimBy.map(x=>`<span class="chip">${escapeHtml(x.t)}×${escapeHtml(x.c)}</span>`).join(" ")
        : `<span class="small">—</span>`;

      // ✅ show W-D-M instead of kill_timestamp
      const feedRows = (p.killFeed || []).slice(-30).reverse().map(k=>{
        const wdm = (k.wdm ?? "");
        const victim = k.victim_nickname || k.player_killed_id || "";
        const victimId = k.player_killed_id || "";
        const vteam = k.victim_team ? ` • ${k.victim_team}` : "";
        const weaponLabel = k.weapon_name ? `${k.weapon_name} (${k.weapon_used_id})` : (k.weapon_used_id || "");
        const dist = (k.kill_distance ?? "");

        return `
          <tr>
            <td>${escapeHtml(wdm)}</td>
            <td>
              ${escapeHtml(victim)}${vteam ? `<div class="small">${escapeHtml(vteam.trim())}</div>` : ""}
              ${victimId ? `<div class="small">id: ${escapeHtml(victimId)}</div>` : ""}
            </td>
            <td>${escapeHtml(weaponLabel || "")}</td>
            <td>${escapeHtml(dist)}</td>
          </tr>
        `;
      }).join("");

      const feedTable = `
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>W-D-M</th>
                <th>Victim (from player_killed_id)</th>
                <th>Weapon used</th>
                <th>Distance</th>
              </tr>
            </thead>
            <tbody>
              ${feedRows || `<tr><td colspan="4" class="small">No kills in kill_info for this player.</td></tr>`}
            </tbody>
          </table>
        </div>
        <div class="small" style="margin-top:6px">
          W-D-M is from the match row fields: <b>Week</b>, <b>Day</b>, <b>MatchNumber</b> (e.g., W1-D4-M2).
        </div>
      `;

      const el = document.createElement("details");
      el.className = "pcard";
      el.innerHTML = `
        <summary>
          <div class="pname">
            <div class="n">${escapeHtml(p.nickname)}</div>
            <div class="s">account_id: ${escapeHtml(p.account_id)} • matches: ${escapeHtml(p.matchesPlayed)}</div>
          </div>
          <div class="pright">
            <span class="chip">Kills <b>${escapeHtml(p.kills)}</b></span>
            <span class="chip">Asst <b>${escapeHtml(p.assists)}</b></span>
            <span class="chip">Medkit <b>${escapeHtml(p.medkit)}</b></span>
            <span class="chip">Revived <b>${escapeHtml(p.revivedTimes)}</b></span>
          </div>
        </summary>

        <div class="pbody">
          <div class="statgrid">
            <div class="stat"><div class="k">Elims / Kills</div><div class="v">${escapeHtml(p.kills)}</div></div>
            <div class="stat"><div class="k">Assists</div><div class="v">${escapeHtml(p.assists)}</div></div>
            <div class="stat"><div class="k">Torso Hits</div><div class="v">${escapeHtml(p.torso)}</div></div>
            <div class="stat"><div class="k">Leg Hits</div><div class="v">${escapeHtml(p.leg)}</div></div>
            <div class="stat"><div class="k">Headshots</div><div class="v">${escapeHtml(p.headshots)}</div></div>
            <div class="stat"><div class="k">Headshot Killtimes</div><div class="v">${escapeHtml(p.headshotKilltimes)}</div></div>
            <div class="stat"><div class="k">Medkit Use</div><div class="v">${escapeHtml(p.medkit)}</div></div>
            <div class="stat"><div class="k">Revived Times (was revived)</div><div class="v">${escapeHtml(p.revivedTimes)}</div></div>
            <div class="stat"><div class="k">Revive Teammate Times</div><div class="v">${escapeHtml(p.reviveTeammateTimes)}</div></div>
            <div class="stat"><div class="k">Revive Teammate Nums</div><div class="v">${escapeHtml(p.reviveTeammateNums)}</div></div>
            <div class="stat"><div class="k">Kill distances count</div><div class="v">${escapeHtml(p.dist.total)}</div></div>
            <div class="stat"><div class="k">Avg kill distance</div><div class="v">${escapeHtml(p.dist.avg ? p.dist.avg.toFixed(1) : "0.0")}</div></div>
          </div>

          <div style="margin-top:10px">
            <div class="small">Kill distance buckets</div>
            ${bar}
          </div>

          <div style="margin-top:10px">
            <div class="small">Player killed + weapon used (kill feed)</div>
            ${feedTable}
          </div>

          <div style="margin-top:10px">
            <div class="small">Top weapons (from kill_info / weapon usages map)</div>
            <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">${topWeapons}</div>
          </div>

          <div style="margin-top:10px">
            <div class="small">Eliminated by (team that eliminated this player) — from <span style="font-family:var(--mono)">eliminated_team_name</span></div>
            <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">${topElimBy}</div>
          </div>
        </div>
      `;
      container.appendChild(el);
    }
  }

  // =============================
  // Filter dropdown population
  // =============================
  const FILTER_CACHE = new Map(); // teamName -> meta sets

  async function loadFiltersForTeam(teamName){
    // reset report visibility when switching team
    $("reportCard").style.display = "none";

    // reset selects
    setSelectOptions($("fTournament"), [], { allLabel:"All", placeholderIfEmpty:"All" });
    setSelectOptions($("fStage"), [], { allLabel:"All", placeholderIfEmpty:"All" });
    setSelectOptions($("fYear"), [], { allLabel:"All", placeholderIfEmpty:"All" });
    setSelectOptions($("fMatchId"), [], { allLabel:"All", placeholderIfEmpty:"All" });

    if(!teamName) return;

    try{
      setStatus("Loading filter options…");
      let meta = FILTER_CACHE.get(teamName);
      if(!meta){
        meta = await fetchTeamMeta(teamName);
        FILTER_CACHE.set(teamName, meta);
      }

      setSelectOptions($("fTournament"), meta.tournaments, { allLabel:"All", placeholderIfEmpty:"All", sort:"alpha" });
      setSelectOptions($("fStage"), meta.stages, { allLabel:"All", placeholderIfEmpty:"All", sort:"alpha" });
      setSelectOptions($("fYear"), meta.years, { allLabel:"All", placeholderIfEmpty:"All", sort:"num" });
      setSelectOptions($("fMatchId"), meta.matchIds, { allLabel:"All", placeholderIfEmpty:"All", sort:"alpha" });

      setStatus("Ready.");
    }catch(e){
      console.error(e);
      setStatus("Failed to load filter options:\n" + (e.message || String(e)), true);
      // keep them disabled if failed
      $("fTournament").disabled = true;
      $("fStage").disabled = true;
      $("fYear").disabled = true;
      $("fMatchId").disabled = true;
    }
  }

  // =============================
  // Events
  // =============================
  async function loadTeamsUI(){
    setStatus("Loading teams…");
    $("teamSel").innerHTML = `<option value="">Loading…</option>`;
    $("metaText").textContent = "—";

    try{
      const teams = await fetchAllTeams();
      if(!teams.length){
        $("teamSel").innerHTML = `<option value="">(No teams found)</option>`;
        $("metaText").textContent = "0 teams";
        setStatus("No teams found for this account. Upload rows first.", true);
        return;
      }

      $("teamSel").innerHTML = `<option value="">Select a team…</option>` + teams.map(t=>(
        `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`
      )).join("");

      $("metaText").textContent = `${teams.length} teams`;

      // keep filters disabled until team selected
      await loadFiltersForTeam("");

      setStatus("Ready.");
    }catch(e){
      console.error(e);
      setStatus("Failed to load teams:\n" + (e.message || String(e)), true);
      $("teamSel").innerHTML = `<option value="">(Load failed)</option>`;
    }
  }

  async function runReport(){
    const teamName = ($("teamSel").value || "").trim();
    if(!teamName){
      setStatus("Pick a team first.", true);
      return;
    }

    const tournament = ($("fTournament").value || "").trim() || null;
    const stage = ($("fStage").value || "").trim() || null;
    const yearRaw = ($("fYear").value || "").trim();
    const matchId = ($("fMatchId").value || "").trim() || null;

    const filters = {
      tournament,
      stage,
      year: yearRaw ? (Number.isFinite(Number(yearRaw)) ? Number(yearRaw) : yearRaw) : null,
      matchId,
    };

    setStatus("Fetching team rows…");

    try{
      const rows = await fetchTeamRows(teamName, filters);
      if(!rows.length){
        setStatus("No rows found for this team (with current filters).", true);
        $("reportCard").style.display = "none";
        return;
      }

      const matchIds = Array.from(new Set(rows.map(r => r.match_id != null ? String(r.match_id) : "").filter(Boolean)));

      setStatus(`Rows: ${rows.length}\nMatches: ${matchIds.length}\nResolving player_killed_id → nickname…`);

      const lobbyRows = await fetchLobbyRowsByMatchIds(matchIds);
      const maps = buildIdentityMaps(lobbyRows);

      setStatus(`Building report…\nRows: ${rows.length}\nLobby rows for mapping: ${lobbyRows.length}`);

      const report = buildReport(rows, maps);

      renderTeamKpis(teamName, report, filters);
      renderPlayers(report.players);

      $("reportCard").style.display = "";
      setStatus(`Done ✅\nTeam: ${teamName}\nRows: ${rows.length}\nPlayers: ${report.playerCount}\nMatches: ${report.matchesPlayed}`);
    }catch(e){
      console.error(e);
      setStatus("Report failed:\n" + (e.message || String(e)), true);
      $("reportCard").style.display = "none";
    }
  }

  $("btnRun").addEventListener("click", runReport);
  $("btnReloadTeams").addEventListener("click", loadTeamsUI);
  $("btnSignOut").addEventListener("click", signOut);

  $("teamSel").addEventListener("change", async () => {
    const teamName = ($("teamSel").value || "").trim();
    await loadFiltersForTeam(teamName);
  });

  // =============================
  // Init
  // =============================
  (async function init(){
    await requireSessionOrRedirect();
    if(!SESSION) return;
    await loadTeamsUI();
  })();
</script>
</body>
</html>
