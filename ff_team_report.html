<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FF Team Report — Eliminations & Utility</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#07090f; --bg2:#0b1020;
      --panel: rgba(20, 26, 38, .72);
      --panel2: rgba(14, 18, 28, .70);
      --line: rgba(255,255,255,.10);
      --ink:#f4f6ff; --muted:#aab1c5;
      --brand:#ffbd59; --brand2:#ff7733; --accent:#4dd3ff;
      --radius:16px; --radius-lg:22px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --good:#71d083; --bad:#ff6b6b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(77,211,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,189,89,.20), transparent 55%),
        radial-gradient(900px 600px at 80% 110%, rgba(255,119,51,.16), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      font-family:var(--sans);
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(7,9,15,.80), rgba(7,9,15,.55));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:14px 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .fflogo{
      width:44px;height:44px;border-radius:14px;
      object-fit:contain;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
      padding:6px;
    }
    h1{font-size:16px;margin:0;letter-spacing:.3px;font-family:Orbitron, var(--sans)}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn, input, select{font-family:inherit}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(255,189,89,.35);
      background: linear-gradient(180deg, rgba(255,189,89,.16), rgba(255,119,51,.10));
    }
    .btn.good{
      border-color: rgba(113,208,131,.35);
      background: linear-gradient(180deg, rgba(113,208,131,.16), rgba(113,208,131,.08));
    }
    .btn.bad{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.16), rgba(255,107,107,.08));
    }

    main{max-width:1280px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{font-size:14px;margin:0;letter-spacing:.25px}
    .card .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"], select{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(77,211,255,.45);
      box-shadow: 0 0 0 3px rgba(77,211,255,.12);
    }
    select{
      color-scheme: dark;
      background: rgba(0,0,0,.25);
      color: var(--ink);
    }
    select option{
      background-color: #0b1020;
      color: var(--ink);
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.3}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--ink);
      display:inline-flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.neutral{background:var(--accent)}
    .mono{font-family:var(--mono)}
    .small{font-size:11px;color:var(--muted)}
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: rgba(244,246,255,.92);
      line-height:1.35;
      white-space:pre-wrap;
    }

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
      min-height:58px;
    }
    .kpi .k{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:16px;margin-top:3px;font-family:Orbitron, var(--sans);letter-spacing:.3px}

    .tablewrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    table{width:100%;border-collapse:collapse;font-size:12px}
    thead th{
      position: sticky; top: 0;
      background: rgba(7,9,15,.92);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 10px;
      text-align:left;
      white-space:nowrap;
      z-index:2;
    }
    tbody td{
      border-top:1px solid rgba(255,255,255,.06);
      padding:8px 10px;
      vertical-align:top;
      max-width: 420px;
      word-break: break-word;
      color: rgba(244,246,255,.92);
    }
    tbody tr:hover td{background: rgba(255,255,255,.03)}
    tbody tr.active td{
      background: linear-gradient(90deg, rgba(255,189,89,.10), rgba(77,211,255,.06));
      border-top-color: rgba(255,189,89,.20);
    }
    .clickable{cursor:pointer}
    .rightStack{display:flex;flex-direction:column;gap:12px}
    .split2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){ .split2{grid-template-columns:1fr} }

    .barrow{display:flex;align-items:center;gap:10px}
    .bar{
      flex:1;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(77,211,255,.75), rgba(255,189,89,.72), rgba(255,119,51,.72));
    }

    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px 12px;
    }
    details summary{cursor:pointer;color:rgba(244,246,255,.92)}
    .link{
      color: var(--brand);
      text-decoration:none;
    }
    .link:hover{color:#ffd48f}
    .badge{
      display:inline-flex;gap:6px;align-items:center;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:11px;color:rgba(244,246,255,.92);
      white-space:nowrap;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img class="fflogo"
          src="https://upload.wikimedia.org/wikipedia/en/7/7d/Garena_Free_Fire_logo.png"
          alt="Free Fire"
          onerror="this.style.display='none'"/>
        <div>
          <h1>FF Team Report</h1>
          <div class="sub">Select a team → players list + kill distance breakdown + kill feed (killed ID + weapon used) + utility.</div>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="dashboard.html">Back to Dashboard</a>
        <button class="btn" id="btnReload">Reload</button>
        <button class="btn bad" id="btnLogout">Sign out</button>
        <span class="pill" id="authPill"><span class="dot neutral"></span><span id="authText">Checking…</span></span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT: Team + Players -->
    <section class="card">
      <div class="hd">
        <h2>Team & Players</h2>
        <div class="pill"><span class="dot neutral"></span><span id="metaText">—</span></div>
      </div>
      <div class="bd">

        <div class="row">
          <div class="field" style="min-width:260px">
            <label>Team name</label>
            <input id="teamInput" type="text" placeholder="Type team (e.g. HB / KTP / RVG)" list="teamList"/>
            <datalist id="teamList"></datalist>
            <div class="hint">Tip: start typing to search teams from <span class="mono">ff_stats_raw</span>.</div>
          </div>
          <div class="field" style="min-width:180px;max-width:220px;flex:.55">
            <label>Mode</label>
            <select id="modeFilter">
              <option value="">All</option>
              <option value="BR">BR</option>
              <option value="CS">CS</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Tournament</label>
            <select id="tournamentFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="field">
            <label>Stage</label>
            <select id="stageFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="field" style="min-width:140px;max-width:180px;flex:.6">
            <label>Year</label>
            <select id="yearFilter">
              <option value="">All</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width:170px;max-width:210px;flex:.7">
            <label>Close range max (m)</label>
            <input id="closeMax" type="number" value="20" min="1" step="1"/>
          </div>
          <div class="field" style="min-width:170px;max-width:210px;flex:.7">
            <label>Mid range max (m)</label>
            <input id="midMax" type="number" value="60" min="2" step="1"/>
          </div>
          <div class="field" style="min-width:180px;max-width:220px;flex:.6">
            <label>&nbsp;</label>
            <button class="btn primary" id="btnLoad">Load Team Report</button>
          </div>
        </div>

        <div class="kpis" id="teamKpis">
          <div class="kpi"><div class="k">Players</div><div class="v" id="kpiPlayers">—</div></div>
          <div class="kpi"><div class="k">Kills</div><div class="v" id="kpiKills">—</div></div>
          <div class="kpi"><div class="k">Assists</div><div class="v" id="kpiAssists">—</div></div>
          <div class="kpi"><div class="k">Headshots</div><div class="v" id="kpiHeadshots">—</div></div>
          <div class="kpi"><div class="k">Medkits</div><div class="v" id="kpiMedkits">—</div></div>
          <div class="kpi"><div class="k">Revived (was)</div><div class="v" id="kpiRevived">—</div></div>
        </div>

        <div class="kpis" style="grid-template-columns:repeat(3,1fr)">
          <div class="kpi"><div class="k">Close</div><div class="v" id="kpiClose">—</div></div>
          <div class="kpi"><div class="k">Mid</div><div class="v" id="kpiMid">—</div></div>
          <div class="kpi"><div class="k">Long</div><div class="v" id="kpiLong">—</div></div>
        </div>

        <div class="status" id="status">Ready.</div>

        <div style="height:12px"></div>

        <div class="tablewrap" style="max-height:520px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>K</th>
                <th>Asst</th>
                <th>Close</th>
                <th>Mid</th>
                <th>Long</th>
                <th>HS</th>
                <th>HS Kills</th>
                <th>Med</th>
                <th>Revived</th>
                <th>Rev Teammate</th>
                <th>Torso</th>
                <th>Leg</th>
              </tr>
            </thead>
            <tbody id="playersBody">
              <tr><td colspan="13" class="small">Load a team to see players.</td></tr>
            </tbody>
          </table>
        </div>

        <details style="margin-top:12px">
          <summary>Diagnostics</summary>
          <div class="small" id="diagText" style="margin-top:10px;white-space:pre-wrap"></div>
        </details>

      </div>
    </section>

    <!-- RIGHT: Player Details -->
    <section class="card">
      <div class="hd">
        <h2>Player Detail</h2>
        <div class="pill"><span class="dot neutral"></span><span id="playerMeta">—</span></div>
      </div>
      <div class="bd">
        <div class="rightStack">
          <div id="playerHeader" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end">
            <div>
              <div class="small">Selected player</div>
              <div style="font-size:18px;font-family:Orbitron, var(--sans);letter-spacing:.3px" id="pName">—</div>
              <div class="small mono" id="pId">—</div>
            </div>
            <div class="row" style="gap:8px">
              <span class="badge" id="bMatches">Matches: —</span>
              <span class="badge" id="bBooyah">Booyah: —</span>
              <span class="badge" id="bElim">Eliminated: —</span>
            </div>
          </div>

          <div class="split2">
            <div class="kpi">
              <div class="k">Kills / Assists</div>
              <div class="v" id="pKillsAsst">—</div>
              <div class="small" id="pKdaHint">—</div>
            </div>
            <div class="kpi">
              <div class="k">Headshots</div>
              <div class="v" id="pHs">—</div>
              <div class="small">Headshot killtimes: <span class="mono" id="pHsKt">—</span></div>
            </div>
          </div>

          <div class="kpi">
            <div class="k">Kill Distance (Close / Mid / Long)</div>
            <div class="row" style="margin-top:8px;align-items:center;gap:10px">
              <span class="badge">Close: <span class="mono" id="pClose">—</span></span>
              <span class="badge">Mid: <span class="mono" id="pMid">—</span></span>
              <span class="badge">Long: <span class="mono" id="pLong">—</span></span>
            </div>
            <div class="barrow" style="margin-top:10px">
              <div class="small" style="min-width:92px">Distribution</div>
              <div class="bar"><i id="distBar"></i></div>
              <div class="small mono" id="distPct">—</div>
            </div>
          </div>

          <div class="split2">
            <div class="kpi">
              <div class="k">Utility</div>
              <div class="small" style="margin-top:8px">Medkit use: <span class="mono" id="pMed">—</span></div>
              <div class="small">Revived times (was revived): <span class="mono" id="pRevived">—</span></div>
              <div class="small">Revive teammate times: <span class="mono" id="pRevTeammate">—</span></div>
            </div>
            <div class="kpi">
              <div class="k">Hits</div>
              <div class="small" style="margin-top:8px">Torso hits: <span class="mono" id="pTorso">—</span></div>
              <div class="small">Leg hits: <span class="mono" id="pLeg">—</span></div>
              <div class="small">Headshots (hits): <span class="mono" id="pHsHits">—</span></div>
            </div>
          </div>

          <div class="kpi">
            <div class="k">Top Weapons (from Kill Info)</div>
            <div class="small" id="pWeapons">—</div>
          </div>

          <div class="tablewrap" style="max-height:360px; overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Match</th>
                  <th>Killer ID</th>
                  <th>Player killed</th>
                  <th>Weapon</th>
                  <th>Dist</th>
                  <th>Range</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="killFeedBody">
                <tr><td colspan="7" class="small">Select a player to view kill feed.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint">
            If you see “permission denied”, your table RLS is blocking SELECT for your current session.
            <br/>Go to <a class="link" href="index.html">index.html</a>, login, then open this page from the same site/origin.
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<script>
  /***********************
   * CONFIG
   ***********************/
  const SUPABASE_URL = "https://gkugecflfddkpitlrmws.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS"," +
    "I6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE";
  // ^ NOTE: The key above is intentionally embedded per your request.

  const TABLE = "ff_stats_raw";
  const LOGIN_PAGE = "index.html";

  // If true: requires an existing session; if missing/expired -> redirects to index.html (robust, avoids redirect loop).
  // If false: will still work for public SELECT (if your RLS allows it).
  const REQUIRE_AUTH = true;

  // How many rows to pull max per team (paginate).
  const MAX_ROWS = 20000;
  const PAGE_SIZE = 1000;

  const SELECT_COLS = [
    "match_id","Mode","Tournament","Stage","Year","Week","Day","MatchNumber",
    "team_id","team_name","booyah","is_eliminated",
    "player_stats_account_id","player_stats_nickname",
    "player_stats_kills","player_stats_assists",
    "player_stats_headshots","player_stats_headshot_killtimes",
    "player_stats_medkit_use",
    "player_stats_revived_times",
    "player_stats_revive_teammate_times",
    "player_stats_torso_hits","player_stats_leg_hits",
    "player_stats_kill_info","player_stats_kill_distance"
  ].join(",");

  /***********************
   * HELPERS
   ***********************/
  const $ = (id) => document.getElementById(id);

  function setAuthPill(state, text){
    const pill = $("authPill");
    const dot = pill.querySelector(".dot");
    dot.classList.remove("good","bad","neutral");
    dot.classList.add(state);
    $("authText").textContent = text || "";
  }

  function fmt(n){
    const x = Number(n);
    if(!isFinite(x)) return "0";
    return x.toLocaleString();
  }

  function n0(v){
    const x = Number(v);
    return isFinite(x) ? x : 0;
  }

  function safeStr(v){
    if(v === null || v === undefined) return "";
    if(typeof v === "string") return v;
    return String(v);
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function rangeBucket(dist, closeMax, midMax){
    const d = Number(dist);
    if(!isFinite(d)) return null;
    if(d <= closeMax) return "close";
    if(d <= midMax) return "mid";
    return "long";
  }

  function tryJson(v){
    if(v === null || v === undefined) return null;
    if(typeof v === "object") return v;
    const s = String(v).trim();
    if(!s) return null;
    try{ return JSON.parse(s); }catch(_e){ return null; }
  }

  function parseKillInfo(row){
    // expected: array of {killer_id, player_killed_id, weapon_used_id, kill_timestamp, kill_distance}
    const arr = tryJson(row?.player_stats_kill_info);
    if(Array.isArray(arr)) return arr.filter(x => x && typeof x === "object");
    return [];
  }

  function parseDistancesFallback(row){
    // player_stats_kill_distance is typically "5 | 111 | 1" or "[]"
    const raw = row?.player_stats_kill_distance;
    if(raw === null || raw === undefined) return [];
    const s = String(raw).trim();
    if(!s || s === "[]" || s === "[ ]") return [];
    // split by | (your uploader joined primitive arrays using " | ")
    const parts = s.split("|").map(x=>x.trim()).filter(Boolean);
    const out = [];
    for(const p of parts){
      const d = Number(p);
      if(isFinite(d)) out.push(d);
    }
    return out;
  }

  function uniq(arr){
    return Array.from(new Set(arr.filter(x=>x!==null && x!==undefined && String(x).trim()!=="").map(x=>String(x))));
  }

  function setStatus(msg, isError=false){
    $("status").textContent = msg;
    $("status").style.borderColor = isError ? "rgba(255,107,107,.35)" : "rgba(255,255,255,.10)";
  }

  function updateDiag(diag){
    $("diagText").textContent = diag;
  }

  /***********************
   * SUPABASE CLIENT
   ***********************/
  const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      // Force the same storage key across pages (default is this anyway, but explicit helps).
      storageKey: "sb-gkugecflfddkpitlrmws-auth-token"
    }
  });

  SB.auth.onAuthStateChange((event, session) => {
    // Avoid redirect loops: only redirect on real sign-out failures
    if(REQUIRE_AUTH && (event === "SIGNED_OUT" || event === "USER_DELETED" || event === "TOKEN_REFRESH_FAILED")){
      location.replace(LOGIN_PAGE);
      return;
    }
    renderAuth(session);
  });

  function renderAuth(session){
    const user = session?.user || null;
    if(user){
      setAuthPill("good", user.email ? `Signed in: ${user.email}` : "Signed in");
    } else {
      setAuthPill("neutral", "Anon");
    }
  }

  async function requireSessionOrRedirect(){
    const origin = location.origin;
    const storageKey = "sb-gkugecflfddkpitlrmws-auth-token";
    const rawToken = localStorage.getItem(storageKey);

    updateDiag(
`Origin: ${origin}
StorageKey present: ${rawToken ? "YES" : "NO"}
StorageKey: ${storageKey}

If you get redirected while logged-in:
- Make sure index.html and this page are opened under the SAME origin (not file:// vs http://, not different ports).`
    );

    // quick check: if no token stored, redirect fast (when REQUIRE_AUTH)
    if(REQUIRE_AUTH && !rawToken){
      setAuthPill("bad", "No session");
      setStatus("No stored session found on this origin. Redirecting to index.html…", true);
      await sleep(300);
      location.replace(LOGIN_PAGE);
      return null;
    }

    // robust session hydrate
    for(let attempt=1; attempt<=3; attempt++){
      const { data, error } = await SB.auth.getSession();
      if(error){
        setAuthPill("bad", "Auth error");
        setStatus(`Auth error: ${error.message}`, true);
        if(REQUIRE_AUTH){ await sleep(400); location.replace(LOGIN_PAGE); }
        return null;
      }

      if(data?.session?.user){
        renderAuth(data.session);
        return data.session;
      }

      // try refresh once
      try{ await SB.auth.refreshSession(); }catch(_e){}
      await sleep(180);
    }

    // still no session
    renderAuth(null);
    if(REQUIRE_AUTH){
      setAuthPill("bad", "Not signed in");
      setStatus("Session not available (expired or different origin). Redirecting…", true);
      await sleep(400);
      location.replace(LOGIN_PAGE);
      return null;
    }

    return null;
  }

  /***********************
   * STATE
   ***********************/
  let CURRENT_TEAM = "";
  let CURRENT_PLAYER_ID = null;

  // computed
  let PLAYER_LIST = []; // [{id,nickname,stats,..., killsFeed:[]}]
  let TEAM_SUMMARY = null;

  /***********************
   * DATA LOADERS
   ***********************/
  async function searchTeams(q){
    const query = String(q || "").trim();
    if(query.length < 1) return [];

    const { data, error } = await SB
      .from(TABLE)
      .select("team_name")
      .ilike("team_name", `%${query}%`)
      .limit(50);

    if(error) throw error;

    const names = uniq((data || []).map(r => r.team_name));
    names.sort((a,b)=>a.localeCompare(b));
    return names;
  }

  async function warmFilterOptions(){
    // best-effort: pulls some rows and de-dupes tournament/stage/year
    const { data, error } = await SB
      .from(TABLE)
      .select("Tournament,Stage,Year")
      .not("Tournament", "is", null)
      .limit(2000);

    if(error) return; // ignore

    const tourneys = uniq(data.map(r=>r.Tournament));
    const stages = uniq(data.map(r=>r.Stage));
    const years = uniq(data.map(r=>r.Year)).sort((a,b)=>Number(b)-Number(a));

    const tSel = $("tournamentFilter");
    const sSel = $("stageFilter");
    const ySel = $("yearFilter");

    for(const v of tourneys.sort((a,b)=>a.localeCompare(b))){
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      tSel.appendChild(opt);
    }
    for(const v of stages.sort((a,b)=>a.localeCompare(b))){
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      sSel.appendChild(opt);
    }
    for(const v of years){
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      ySel.appendChild(opt);
    }
  }

  async function fetchTeamRows(team){
    const mode = $("modeFilter").value.trim();
    const tournament = $("tournamentFilter").value.trim();
    const stage = $("stageFilter").value.trim();
    const year = $("yearFilter").value.trim();

    let all = [];
    for(let from=0; from<MAX_ROWS; from += PAGE_SIZE){
      let q = SB.from(TABLE)
        .select(SELECT_COLS)
        .eq("team_name", team)
        .order("match_id", { ascending:false })
        .range(from, from + PAGE_SIZE - 1);

      if(mode) q = q.eq("Mode", mode);
      if(tournament) q = q.eq("Tournament", tournament);
      if(stage) q = q.eq("Stage", stage);
      if(year) q = q.eq("Year", year);

      const { data, error } = await q;
      if(error) throw error;

      const rows = data || [];
      all.push(...rows);

      setStatus(`Loading… ${all.length} rows (page ${Math.floor(from/PAGE_SIZE)+1})`);

      if(rows.length < PAGE_SIZE) break;
      await sleep(50);
    }
    return all;
  }

  /***********************
   * AGGREGATION
   ***********************/
  function buildReport(rows){
    const closeMax = Math.max(1, Number($("closeMax").value) || 20);
    const midMax = Math.max(closeMax+1, Number($("midMax").value) || 60);

    const players = new Map();

    let teamKills=0, teamAsst=0, teamHs=0, teamHsKt=0, teamMed=0, teamRevived=0;
    let tClose=0, tMid=0, tLong=0;

    for(const r of (rows || [])){
      const pid = safeStr(r.player_stats_account_id);
      const nick = safeStr(r.player_stats_nickname) || "(no name)";
      if(!pid) continue;

      if(!players.has(pid)){
        players.set(pid, {
          id: pid,
          nickname: nick,
          matches: 0,
          booyahMatches: 0,
          eliminatedMatches: 0,
          kills: 0,
          assists: 0,
          headshots: 0,
          headshotKilltimes: 0,
          medkitUse: 0,
          revivedTimes: 0,
          reviveTeammateTimes: 0,
          torsoHits: 0,
          legHits: 0,
          close: 0, mid: 0, long: 0,
          killFeed: [], // {match_id, killer_id, player_killed_id, weapon_used_id, kill_distance, range, kill_timestamp}
          weaponCounts: new Map()
        });
      }

      const p = players.get(pid);

      p.matches += 1;
      if(Boolean(r.booyah)) p.booyahMatches += 1;
      if(Boolean(r.is_eliminated)) p.eliminatedMatches += 1;

      p.kills += n0(r.player_stats_kills);
      p.assists += n0(r.player_stats_assists);
      p.headshots += n0(r.player_stats_headshots);
      p.headshotKilltimes += n0(r.player_stats_headshot_killtimes);
      p.medkitUse += n0(r.player_stats_medkit_use);
      p.revivedTimes += n0(r.player_stats_revived_times);
      p.reviveTeammateTimes += n0(r.player_stats_revive_teammate_times);
      p.torsoHits += n0(r.player_stats_torso_hits);
      p.legHits += n0(r.player_stats_leg_hits);

      // kill info feed
      const killInfo = parseKillInfo(r);
      if(killInfo.length){
        for(const k of killInfo){
          const dist = k.kill_distance;
          const bucket = rangeBucket(dist, closeMax, midMax);
          if(bucket === "close"){ p.close++; tClose++; }
          else if(bucket === "mid"){ p.mid++; tMid++; }
          else if(bucket === "long"){ p.long++; tLong++; }

          const wid = k.weapon_used_id;
          if(wid !== undefined && wid !== null){
            const key = String(wid);
            p.weaponCounts.set(key, (p.weaponCounts.get(key) || 0) + 1);
          }

          p.killFeed.push({
            match_id: r.match_id,
            killer_id: k.killer_id ?? pid,
            player_killed_id: k.player_killed_id ?? "",
            weapon_used_id: k.weapon_used_id ?? "",
            kill_distance: k.kill_distance ?? "",
            range: bucket || "",
            kill_timestamp: k.kill_timestamp ?? ""
          });
        }
      } else {
        // fallback distances if kill_info is empty
        const dists = parseDistancesFallback(r);
        for(const d of dists){
          const bucket = rangeBucket(d, closeMax, midMax);
          if(bucket === "close"){ p.close++; tClose++; }
          else if(bucket === "mid"){ p.mid++; tMid++; }
          else if(bucket === "long"){ p.long++; tLong++; }
        }
      }

      teamKills += n0(r.player_stats_kills);
      teamAsst += n0(r.player_stats_assists);
      teamHs += n0(r.player_stats_headshots);
      teamHsKt += n0(r.player_stats_headshot_killtimes);
      teamMed += n0(r.player_stats_medkit_use);
      teamRevived += n0(r.player_stats_revived_times);
    }

    // finalize player list
    const list = Array.from(players.values()).map(p => {
      // sort killfeed newest-ish (timestamp is within match; also we have match_id ordering)
      p.killFeed.sort((a,b)=>{
        const ma = String(a.match_id), mb = String(b.match_id);
        if(ma !== mb) return mb.localeCompare(ma);
        return n0(b.kill_timestamp) - n0(a.kill_timestamp);
      });
      return p;
    });

    // sort by kills desc, then assists desc
    list.sort((a,b)=>{
      if(b.kills !== a.kills) return b.kills - a.kills;
      if(b.assists !== a.assists) return b.assists - a.assists;
      return a.nickname.localeCompare(b.nickname);
    });

    return {
      players: list,
      team: {
        players: list.length,
        kills: teamKills,
        assists: teamAsst,
        headshots: teamHs,
        headshotKilltimes: teamHsKt,
        medkits: teamMed,
        revived: teamRevived,
        close: tClose, mid: tMid, long: tLong
      }
    };
  }

  /***********************
   * RENDER
   ***********************/
  function renderTeamSummary(team){
    $("kpiPlayers").textContent = fmt(team.players);
    $("kpiKills").textContent = fmt(team.kills);
    $("kpiAssists").textContent = fmt(team.assists);
    $("kpiHeadshots").textContent = fmt(team.headshots);
    $("kpiMedkits").textContent = fmt(team.medkits);
    $("kpiRevived").textContent = fmt(team.revived);
    $("kpiClose").textContent = fmt(team.close);
    $("kpiMid").textContent = fmt(team.mid);
    $("kpiLong").textContent = fmt(team.long);

    $("metaText").textContent = `${CURRENT_TEAM || "—"} • ${team.players} players`;
  }

  function renderPlayersTable(players){
    const tb = $("playersBody");
    tb.innerHTML = "";
    if(!players.length){
      tb.innerHTML = `<tr><td colspan="13" class="small">No players found for this team (with current filters).</td></tr>`;
      return;
    }

    for(const p of players){
      const tr = document.createElement("tr");
      tr.className = "clickable";
      tr.dataset.pid = p.id;

      tr.innerHTML = `
        <td><div style="font-weight:600">${escapeHtml(p.nickname)}</div><div class="small mono">${escapeHtml(p.id)}</div></td>
        <td>${fmt(p.kills)}</td>
        <td>${fmt(p.assists)}</td>
        <td>${fmt(p.close)}</td>
        <td>${fmt(p.mid)}</td>
        <td>${fmt(p.long)}</td>
        <td>${fmt(p.headshots)}</td>
        <td>${fmt(p.headshotKilltimes)}</td>
        <td>${fmt(p.medkitUse)}</td>
        <td>${fmt(p.revivedTimes)}</td>
        <td>${fmt(p.reviveTeammateTimes)}</td>
        <td>${fmt(p.torsoHits)}</td>
        <td>${fmt(p.legHits)}</td>
      `;

      tr.addEventListener("click", ()=>selectPlayer(p.id));
      tb.appendChild(tr);
    }

    // auto select first
    selectPlayer(players[0].id);
  }

  function renderPlayerDetail(p){
    if(!p){
      $("playerMeta").textContent = "—";
      $("pName").textContent = "—";
      $("pId").textContent = "—";
      return;
    }

    $("pName").textContent = p.nickname;
    $("pId").textContent = `account_id: ${p.id}`;
    $("playerMeta").textContent = `Kills: ${fmt(p.kills)} • Asst: ${fmt(p.assists)} • HS: ${fmt(p.headshots)}`;

    $("bMatches").textContent = `Matches: ${fmt(p.matches)}`;
    $("bBooyah").textContent = `Booyah: ${fmt(p.booyahMatches)}`;
    $("bElim").textContent = `Eliminated: ${fmt(p.eliminatedMatches)}`;

    $("pKillsAsst").textContent = `${fmt(p.kills)} / ${fmt(p.assists)}`;
    const kda = (p.eliminatedMatches > 0) ? (p.kills / p.eliminatedMatches) : p.kills;
    $("pKdaHint").textContent = `Kills per eliminated-match: ${kda.toFixed(2)}`;

    $("pHs").textContent = fmt(p.headshots);
    $("pHsKt").textContent = fmt(p.headshotKilltimes);

    $("pClose").textContent = fmt(p.close);
    $("pMid").textContent = fmt(p.mid);
    $("pLong").textContent = fmt(p.long);

    const totalDistKills = p.close + p.mid + p.long;
    const cPct = totalDistKills ? (p.close/totalDistKills)*100 : 0;
    const mPct = totalDistKills ? (p.mid/totalDistKills)*100 : 0;
    const lPct = totalDistKills ? (p.long/totalDistKills)*100 : 0;

    $("distBar").style.width = `${Math.max(2, Math.min(100, (cPct+mPct+lPct)))}%`;
    $("distPct").textContent = totalDistKills
      ? `C ${cPct.toFixed(0)}% • M ${mPct.toFixed(0)}% • L ${lPct.toFixed(0)}%`
      : "No kill distances";

    $("pMed").textContent = fmt(p.medkitUse);
    $("pRevived").textContent = fmt(p.revivedTimes);
    $("pRevTeammate").textContent = fmt(p.reviveTeammateTimes);

    $("pTorso").textContent = fmt(p.torsoHits);
    $("pLeg").textContent = fmt(p.legHits);
    $("pHsHits").textContent = fmt(p.headshots);

    // weapons
    const wc = Array.from(p.weaponCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 12);
    if(!wc.length){
      $("pWeapons").textContent = "No weapon data (kill_info empty).";
    } else {
      $("pWeapons").innerHTML = wc.map(([wid,c])=>`<span class="badge">Weapon ${escapeHtml(wid)}: <span class="mono">${fmt(c)}</span></span>`).join(" ");
    }

    // kill feed table (top 40)
    const feed = p.killFeed.slice(0, 40);
    const tb = $("killFeedBody");
    tb.innerHTML = "";
    if(!feed.length){
      tb.innerHTML = `<tr><td colspan="7" class="small">No kill feed found for this player (kill_info empty).</td></tr>`;
    } else {
      for(const k of feed){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(String(k.match_id || ""))}</td>
          <td class="mono">${escapeHtml(String(k.killer_id || ""))}</td>
          <td class="mono">${escapeHtml(String(k.player_killed_id || ""))}</td>
          <td class="mono">${escapeHtml(String(k.weapon_used_id || ""))}</td>
          <td>${escapeHtml(String(k.kill_distance ?? ""))}</td>
          <td>${escapeHtml(String(k.range || ""))}</td>
          <td class="mono">${escapeHtml(String(k.kill_timestamp || ""))}</td>
        `;
        tb.appendChild(tr);
      }
    }
  }

  function highlightSelectedRow(pid){
    const rows = $("playersBody").querySelectorAll("tr");
    rows.forEach(r=>{
      if(r.dataset.pid === pid) r.classList.add("active");
      else r.classList.remove("active");
    });
  }

  function selectPlayer(pid){
    CURRENT_PLAYER_ID = pid;
    highlightSelectedRow(pid);
    const p = PLAYER_LIST.find(x=>x.id === pid);
    renderPlayerDetail(p);
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  /***********************
   * UI EVENTS
   ***********************/
  let teamSearchTimer = null;

  $("teamInput").addEventListener("input", ()=>{
    clearTimeout(teamSearchTimer);
    const q = $("teamInput").value.trim();
    teamSearchTimer = setTimeout(async ()=>{
      if(!q) return;
      try{
        const teams = await searchTeams(q);
        const dl = $("teamList");
        dl.innerHTML = "";
        for(const t of teams){
          const opt = document.createElement("option");
          opt.value = t;
          dl.appendChild(opt);
        }
      }catch(err){
        // ignore; likely RLS
      }
    }, 220);
  });

  $("btnLoad").addEventListener("click", ()=>loadTeam().catch(()=>{}));
  $("btnReload").addEventListener("click", ()=>location.reload());
  $("btnLogout").addEventListener("click", async ()=>{
    try{ await SB.auth.signOut(); }catch(_e){}
    location.replace(LOGIN_PAGE);
  });

  // recompute using same rows quickly when thresholds change
  $("closeMax").addEventListener("change", ()=>{
    if(!TEAM_SUMMARY || !TEAM_SUMMARY._rows) return;
    const report = buildReport(TEAM_SUMMARY._rows);
    TEAM_SUMMARY.team = report.team;
    PLAYER_LIST = report.players;
    renderTeamSummary(report.team);
    renderPlayersTable(PLAYER_LIST);
    setStatus("Updated distance thresholds.");
  });
  $("midMax").addEventListener("change", ()=>{
    if(!TEAM_SUMMARY || !TEAM_SUMMARY._rows) return;
    const report = buildReport(TEAM_SUMMARY._rows);
    TEAM_SUMMARY.team = report.team;
    PLAYER_LIST = report.players;
    renderTeamSummary(report.team);
    renderPlayersTable(PLAYER_LIST);
    setStatus("Updated distance thresholds.");
  });

  async function loadTeam(){
    const team = $("teamInput").value.trim();
    if(!team){
      setStatus("Enter a team name first.", true);
      return;
    }

    CURRENT_TEAM = team;
    setStatus("Loading team rows…");

    try{
      const rows = await fetchTeamRows(team);

      if(!rows.length){
        setStatus("No rows found for this team (with current filters).", true);
        $("playersBody").innerHTML = `<tr><td colspan="13" class="small">No rows found.</td></tr>`;
        $("metaText").textContent = `${team} • 0 players`;
        return;
      }

      const report = buildReport(rows);

      TEAM_SUMMARY = { ...report, _rows: rows };
      PLAYER_LIST = report.players;

      renderTeamSummary(report.team);
      renderPlayersTable(PLAYER_LIST);

      setStatus(
`Loaded ✅
Team: ${team}
Rows: ${rows.length}
Players: ${report.team.players}
Kills: ${report.team.kills} (Close ${report.team.close} / Mid ${report.team.mid} / Long ${report.team.long})`
      );

    }catch(err){
      console.error(err);
      const msg = (err && err.message) ? err.message : String(err);

      // common RLS error signals
      const deny = /permission|not allowed|RLS|JWT|row-level/i.test(msg);

      setStatus(
`Load failed:
${msg}

If this is RLS/permission:
- Login in index.html, then open this page from the same origin.`,
        true
      );

      if(REQUIRE_AUTH && deny){
        await sleep(600);
        location.replace(LOGIN_PAGE);
      }
    }
  }

  /***********************
   * INIT
   ***********************/
  (async function init(){
    setAuthPill("neutral", "Checking…");
    setStatus("Initializing…");

    const session = await requireSessionOrRedirect();
    renderAuth(session);

    // warm filter options (best effort)
    setStatus("Loading filters…");
    await warmFilterOptions();

    setStatus("Ready. Type a team and click Load Team Report.");
  })();
</script>
</body>
</html>
