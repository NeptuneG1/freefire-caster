<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Performance Compare</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{background:#e6a74f}
    .shell{max-width:1200px;margin:22px auto;padding:0 12px}

    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="number"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}
    .muted{color:var(--muted);font-size:.9rem}

    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:5px 8px;font-size:.9rem}

    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid #2a2a2a;padding:6px 6px;vertical-align:top}
    thead th{background:#191919;text-align:left;position:sticky;top:0}
    .right{text-align:right}
    .mono{font-variant-numeric:tabular-nums}
    .caption{margin:4px 0 8px}
    .tight{line-height:1.25}
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Performance Compare</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">

  <!-- FILTER BAR -->
  <div class="bar">
    <a class="btn" href="dashboard.html">← Back to Dashboard</a>
    <div class="controls" style="margin-left:auto">
      <label>Tournament <select id="fTourn"></select></label>
      <label>Year <select id="fYear"></select></label>
      <label>Season <select id="fSeason"></select></label>
      <label>Stage <select id="fStage"></select></label>
      <label>Group <select id="fGroup"></select></label>
      <label>Week <select id="fWeek"></select></label>
      <label>Day <select id="fDay"></select></label>
      <label>Map
        <select id="fMap">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Purgatory">Purgatory</option>
          <option value="Alpine">Alpine</option>
          <option value="Kalahari">Kalahari</option>
          <option value="Nexterra">Nexterra</option>
          <option value="Purgatory Remastered">Purgatory Remastered</option>
        </select>
      </label>
      <button class="btn" id="applyBtn">Apply</button>
      <button class="btn" id="resetBtn" title="Reset all filters">Reset</button>
    </div>
  </div>

  <!-- TEAM PICK -->
  <div class="section">
    <h2>Pick two teams</h2>
    <div class="controls">
      <label>Team A <select id="cmpTeamA"></select></label>
      <label>Team B <select id="cmpTeamB"></select></label>
      <button class="btn" id="cmpSwap" title="Swap A/B">Swap</button>
    </div>
    <div class="caption muted" id="meta">—</div>
  </div>

  <!-- OVERVIEW KPIs -->
  <div class="section">
    <h2>Overview KPIs</h2>
    <div class="grid2">
      <div class="card" id="kpiA"><h3>A</h3>Loading…</div>
      <div class="card" id="kpiB"><h3>B</h3>Loading…</div>
    </div>
  </div>

  <!-- MAP PERFORMANCE -->
  <div class="section">
    <h2>Map Performance</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelTMA">Team A</h3><div id="tmA">Loading…</div></div>
      <div class="card"><h3 id="labelTMB">Team B</h3><div id="tmB">Loading…</div></div>
    </div>
  </div>

  <!-- DROP HOTSPOTS -->
  <div class="section">
    <h2>Drop Hotspots (Top 10)</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelDropA">Team A</h3><div id="dropA">Loading…</div></div>
      <div class="card"><h3 id="labelDropB">Team B</h3><div id="dropB">Loading…</div></div>
    </div>
  </div>

  <!-- TRENDS -->
  <div class="section">
    <h2>Trend by Week/Day</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelTrendA">Team A</h3><div id="trendA">Loading…</div></div>
      <div class="card"><h3 id="labelTrendB">Team B</h3><div id="trendB">Loading…</div></div>
    </div>
    <div class="caption muted tight">Totals = placement + elimination; Win% here is Booyah rate.</div>
  </div>

  <!-- TEAM LEADERBOARD (current filters) -->
  <div class="section">
    <h2>Leaderboard (Current Filters)</h2>
    <div id="leaderboard">Loading…</div>
  </div>

  <!-- AI ANALYSIS PROMPT -->
  <div class="section">
    <h2>AI Analysis Prompt</h2>
    <div class="ai-actions" style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button class="btn" id="copyPromptBtn">Copy prompt</button>
      <span class="muted">Copies a structured prompt + current data snapshot for ChatGPT.</span>
    </div>
    <textarea id="aiPrompt" class="ai-text" readonly style="width:100%;min-height:220px;background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;font-size:.85rem;white-space:pre-wrap">Loading…</textarea>
  </div>

</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = "index.html"; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = "index.html";
};

/* ========= Utilities ========= */
const el = (id) => document.getElementById(id);
const fmtPct = (x) => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const pct = (num, den) => den ? fmtPct(num/den) : '—';
const n = (x) => Number(x ?? 0) || 0;
const labelWD = (w,d) => `W${w||'-'}D${d||'-'}`;
function sum(arr, f){ let t=0; for(const r of arr) t+=n(f?r[f]:r); return t; }
function groupBy(arr, keyFn){
  const m=new Map(); for(const r of arr){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r); } return m;
}
const norm = (v) => (v==null ? '' : String(v).trim());
function selectDistinctFull(rows, key){
  const s = new Set();
  rows.forEach(r => { const v = norm(r[key]); if (v!=='' && v!==undefined && v!==null) s.add(v); });
  return [...s];
}

/* ========= Filters init ========= */
function initFiltersPlaceholders(){
  const set = (id, vals, allLabel='All')=>{
    const dd = el(id);
    dd.innerHTML = `<option value="__ALL__">${allLabel}</option>` + (vals||[]).map(v=>`<option value="${v}">${v}</option>`).join('');
    dd.value='__ALL__';
  };
  set('fTourn', []);
  set('fYear', [], 'All years');
  set('fSeason', [], 'All seasons');
  set('fStage', [], 'All stages');
  set('fGroup', [], 'All groups');
  set('fWeek', [], 'All weeks');
  set('fDay', [], 'All days');
}
initFiltersPlaceholders();

/* ========= State ========= */
let ALL_ROWS = [];   // unfiltered full dataset
let ROWS = [];       // filtered working set

/* ========= Fetch (all rows) ========= */
async function fetchAllRecords(){
  const { data, error } = await client
    .from('ffbr_data')
    .select('id, team, "group", stage, day, match, map, booyah, placement, elimination, drop, damage, total, played, top3, tag, week, tournament, year, season')
    .order('year', { ascending:true })
    .order('week', { ascending:true })
    .order('day', { ascending:true })
    .order('match', { ascending:true })
    .order('id', { ascending:true });

  if (error){ console.error('ffbr_data select failed:', error); alert('Failed to load ffbr_data: '+(error?.message||'Unknown error')); return []; }
  return data || [];
}

/* ========= Client-side filters (from UI) ========= */
function applyFilters(rows){
  const filt = {
    tourn: el('fTourn').value,
    year:  el('fYear').value,
    season:el('fSeason').value,
    stage: el('fStage').value,
    group: el('fGroup').value,
    week:  el('fWeek').value,
    day:   el('fDay').value,
    map:   el('fMap').value,
  };
  let out = rows;
  if (filt.tourn !== '__ALL__') out = out.filter(r => norm(r.tournament) === norm(filt.tourn));
  if (filt.year  !== '__ALL__') out = out.filter(r => String(r.year) === String(filt.year));
  if (filt.season!== '__ALL__') out = out.filter(r => norm(r.season) === norm(filt.season));
  if (filt.stage !== '__ALL__') out = out.filter(r => norm(r.stage) === norm(filt.stage));
  if (filt.group !== '__ALL__') out = out.filter(r => norm(r.group) === norm(filt.group));
  if (filt.week  !== '__ALL__') out = out.filter(r => String(r.week) === String(filt.week));
  if (filt.day   !== '__ALL__') out = out.filter(r => String(r.day) === String(filt.day));
  if (filt.map   !== '__ALL__') out = out.filter(r => norm(r.map) === norm(filt.map));
  return out;
}

/* ========= Dropdowns from ALL_ROWS ========= */
async function populateFilterDropdowns(){
  const set = (id, arr, all='All')=>{
    const dd = el(id), prev = dd.value || '__ALL__';
    const opts = [`<option value="__ALL__">${all}</option>`, ...arr.sort((a,b)=>String(a).localeCompare(String(b),undefined,{numeric:true})).map(v=>`<option value="${v}">${v}</option>`)];
    dd.innerHTML = opts.join('');
    dd.value = (prev && (prev==='__ALL__' || arr.includes(prev))) ? prev : '__ALL__';
  };

  set('fTourn',  selectDistinctFull(ALL_ROWS, 'tournament'), 'All tournaments');
  set('fYear',   selectDistinctFull(ALL_ROWS, 'year'),       'All years');
  set('fSeason', selectDistinctFull(ALL_ROWS, 'season'),     'All seasons');
  set('fStage',  selectDistinctFull(ALL_ROWS, 'stage'),      'All stages');
  set('fGroup',  selectDistinctFull(ALL_ROWS, 'group'),      'All groups');
  set('fWeek',   selectDistinctFull(ALL_ROWS, 'week'),       'All weeks');
  set('fDay',    selectDistinctFull(ALL_ROWS, 'day'),        'All days');
}

/* ========= Team dropdowns from filtered set ========= */
function populateTeamDropdowns(rows){
  const teams = [...new Set(rows.map(r=>r.team).filter(Boolean))].sort();
  const A = el('cmpTeamA'), B = el('cmpTeamB');
  const prevA=A.value, prevB=B.value;
  const opts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
  A.innerHTML = opts; B.innerHTML = opts;
  A.value = teams.includes(prevA) ? prevA : (teams[0]||'');
  B.value = teams.includes(prevB) ? prevB : (teams[1]||teams[0]||'');
}

/* ========= Team slices ========= */
function rowsForTeam(team){ return ROWS.filter(r => r.team === team); }

/* ========= Aggregations ========= */
function kpis(rows){
  const matches = rows.length || sum(rows, 'played') || 0;
  const booyah  = sum(rows, 'booyah');
  const top3    = sum(rows, 'top3');
  const elim    = sum(rows, 'elimination');
  const dmg     = sum(rows, 'damage');
  const place   = sum(rows, 'placement');
  const total   = sum(rows, 'total');
  return {
    matches, total,
    total_per_match: matches ? total/matches : 0,
    booyah_rate: matches ? (booyah/matches) : 0,
    top3_rate: matches ? (top3/matches) : 0,
    avg_elims: matches ? (elim/matches) : 0,
    avg_damage: matches ? (dmg/matches) : 0,
    avg_placement_pts: matches ? (place/matches) : 0
  };
}

function mapPerformance(rows){
  const byMap = groupBy(rows, r=>r.map||'—');
  const out=[];
  for(const [map, list] of byMap.entries()){
    const matches=list.length;
    out.push({
      map,
      matches,
      booyah: sum(list,'booyah'),
      booyah_rate: matches? sum(list,'booyah')/matches : 0,
      avg_elims: matches? sum(list,'elimination')/matches : 0,
      avg_total: matches? sum(list,'total')/matches : 0
    });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.avg_total-a.avg_total || a.map.localeCompare(b.map));
}

function dropHotspots(rows, limit=10){
  const byDrop = groupBy(rows, r=>r.drop||'—');
  const out=[];
  for(const [drop, list] of byDrop.entries()){
    const matches=list.length;
    out.push({
      drop,
      matches,
      booyah: sum(list,'booyah'),
      booyah_rate: matches? sum(list,'booyah')/matches : 0,
      avg_elims: matches? sum(list,'elimination')/matches : 0,
      avg_total: matches? sum(list,'total')/matches : 0
    });
  }
  return out
    .sort((a,b)=> b.matches-a.matches || b.avg_total-a.avg_total || b.booyah_rate-a.booyah_rate)
    .slice(0, limit);
}

function trendWD(rows){
  const byWD = groupBy(rows, r=>labelWD(r.week,r.day));
  const out=[];
  for(const [wd, list] of byWD.entries()){
    const matches=list.length;
    out.push({
      wd,
      matches,
      total: sum(list,'total'),
      total_per_match: matches? sum(list,'total')/matches : 0,
      booyah_rate: matches? sum(list,'booyah')/matches : 0,
      avg_elims: matches? sum(list,'elimination')/matches : 0
    });
  }
  return out.sort((a,b)=> a.wd.localeCompare(b.wd, undefined, {numeric:true}));
}

function leaderboardAllTeams(rows, limit=20){
  const byTeam = groupBy(rows, r=>r.team);
  const out=[];
  for(const [team, list] of byTeam.entries()){
    const kp=kpis(list);
    out.push({ team, matches:kp.matches, total:kp.total, total_per_match:kp.total_per_match, booyah_rate:kp.booyah_rate });
  }
  return out.sort((a,b)=> b.total - a.total || b.total_per_match - a.total_per_match).slice(0,limit);
}

/* ========= Renderers ========= */
function kpiCard(name, k){
  if (!k || !k.matches) return `<div class="muted">No data.</div>`;
  return `
    <h3>${name}</h3>
    <div class="kpis">
      <div class="kpi">Matches <strong>${k.matches}</strong></div>
      <div class="kpi">Total pts <strong>${k.total}</strong> <span class="muted">(${k.total_per_match.toFixed(1)}/match)</span></div>
      <div class="kpi">Booyah <strong>${fmtPct(k.booyah_rate)}</strong></div>
      <div class="kpi">Top 3 <strong>${fmtPct(k.top3_rate)}</strong></div>
      <div class="kpi">Elims <strong>${k.avg_elims.toFixed(1)}</strong>/match</div>
      <div class="kpi">Damage <strong>${k.avg_damage.toFixed(0)}</strong>/match</div>
      <div class="kpi">Placement pts <strong>${k.avg_placement_pts.toFixed(1)}</strong>/match</div>
    </div>`;
}
function tableMapPerf(list){
  if (!list.length) return `<div class="muted">No map stats.</div>`;
  return `
    <table>
      <thead><tr><th>Map</th><th class="right">Matches</th><th class="right">Booyah %</th><th class="right">Elims / m</th><th class="right">Total / m</th></tr></thead>
      <tbody>
        ${list.map(r=>`<tr>
          <td>${r.map}</td>
          <td class="right">${r.matches}</td>
          <td class="right">${fmtPct(r.booyah_rate)}</td>
          <td class="right">${r.avg_elims.toFixed(1)}</td>
          <td class="right">${r.avg_total.toFixed(1)}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}
function tableDrop(list){
  if (!list.length) return `<div class="muted">No drops for selection.</div>`;
  return `
    <table>
      <thead><tr><th>Drop</th><th class="right">Matches</th><th class="right">Booyah %</th><th class="right">Elims / m</th><th class="right">Total / m</th></tr></thead>
      <tbody>
        ${list.map(r=>`<tr>
          <td>${r.drop}</td>
          <td class="right">${r.matches}</td>
          <td class="right">${fmtPct(r.booyah_rate)}</td>
          <td class="right">${r.avg_elims.toFixed(1)}</td>
          <td class="right">${r.avg_total.toFixed(1)}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}
function tableTrend(list){
  if (!list.length) return `<div class="muted">No trend rows.</div>`;
  return `
    <table>
      <thead><tr><th>Week/Day</th><th class="right">Matches</th><th class="right">Booyah %</th><th class="right">Elims / m</th><th class="right">Total / m</th><th class="right">Total</th></tr></thead>
      <tbody>
        ${list.map(r=>`<tr>
          <td>${r.wd}</td>
          <td class="right">${r.matches}</td>
          <td class="right">${fmtPct(r.booyah_rate)}</td>
          <td class="right">${r.avg_elims.toFixed(1)}</td>
          <td class="right">${r.total_per_match.toFixed(1)}</td>
          <td class="right">${r.total}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}
function tableLeaderboard(list){
  if (!list.length) return `<div class="muted">No teams for current filters.</div>`;
  return `
    <table>
      <thead><tr><th>#</th><th>Team</th><th class="right">Matches</th><th class="right">Total</th><th class="right">Total / m</th><th class="right">Booyah %</th></tr></thead>
      <tbody>
        ${list.map((r,i)=>`<tr>
          <td class="right">${i+1}</td>
          <td>${r.team}</td>
          <td class="right">${r.matches}</td>
          <td class="right">${r.total}</td>
          <td class="right">${r.total_per_match.toFixed(1)}</td>
          <td class="right">${fmtPct(r.booyah_rate)}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

/* ========= AI Prompt ========== */
function buildAIPrompt(meta, A, B){
  const payload = {
    meta,
    teamA:{ kpis:A.kpi, map_perf:A.map, drops:A.drop, trend:A.trend },
    teamB:{ kpis:B.kpi, map_perf:B.map, drops:B.drop, trend:B.trend },
    leaderboard: B.leader
  };
  return `You are an esports analyst. Compare two Free Fire Battle Royale teams using the snapshot below.

Context:
- Teams: ${meta.teamA} vs ${meta.teamB}
- Filters: Tournament=${meta.tournament||'All'}, Year=${meta.year||'All'}, Season=${meta.season||'All'}, Stage=${meta.stage||'All'}, Group=${meta.group||'All'}, Week=${meta.week||'All'}, Day=${meta.day||'All'}, Map=${meta.map||'All'}
Tasks:
1) Summarize overall performance (matches, total points, Booyah rate, elims/m, damage/m, placement pts/m).
2) Identify best/worst maps and drops (use volume + per-match totals).
3) Describe trends across week/day (hot/cold streaks). 
4) Finish with 3 actionable prep notes vs each team.

JSON:
${JSON.stringify(payload,null,2)}`;
}

/* ========= Render all ========= */
function renderAll(){
  const Aname = el('cmpTeamA').value, Bname = el('cmpTeamB').value;

  const labels = (id)=> (el(id).value==='__ALL__' ? 'All' : el(id).value);
  const metaLbl = `Tourn: ${labels('fTourn')} • Stage: ${labels('fStage')} • Group: ${labels('fGroup')} • Week: ${labels('fWeek')} • Day: ${labels('fDay')} • Map: ${labels('fMap')} • Rows: ${ROWS.length}/${ALL_ROWS.length}`;

  if (!Aname || !Bname || Aname===Bname){
    el('meta').textContent = `Pick two different teams • ${metaLbl}`;
    ['kpiA','kpiB','tmA','tmB','dropA','dropB','trendA','trendB','leaderboard'].forEach(id=>{ if(el(id)) el(id).innerHTML = '<div class="muted">—</div>'; });
    el('aiPrompt').value = 'Pick two different teams.';
    return;
  }

  el('meta').textContent = `${Aname} vs ${Bname} • ${metaLbl}`;

  const rowsA = rowsForTeam(Aname), rowsB = rowsForTeam(Bname);

  const A = { 
    kpi: kpis(rowsA),
    map: mapPerformance(rowsA),
    drop: dropHotspots(rowsA, 10),
    trend: trendWD(rowsA)
  };
  const B = { 
    kpi: kpis(rowsB),
    map: mapPerformance(rowsB),
    drop: dropHotspots(rowsB, 10),
    trend: trendWD(rowsB)
  };

  el('kpiA').innerHTML = kpiCard(Aname, A.kpi);
  el('kpiB').innerHTML = kpiCard(Bname, B.kpi);

  el('labelTMA').textContent = Aname; el('labelTMB').textContent = Bname;
  el('tmA').innerHTML = tableMapPerf(A.map);
  el('tmB').innerHTML = tableMapPerf(B.map);

  el('labelDropA').textContent = Aname; el('labelDropB').textContent = Bname;
  el('dropA').innerHTML = tableDrop(A.drop);
  el('dropB').innerHTML = tableDrop(B.drop);

  el('labelTrendA').textContent = Aname; el('labelTrendB').textContent = Bname;
  el('trendA').innerHTML = tableTrend(A.trend);
  el('trendB').innerHTML = tableTrend(B.trend);

  const lead = leaderboardAllTeams(ROWS, 20);
  el('leaderboard').innerHTML = tableLeaderboard(lead);
  B.leader = lead;

  const m = {
    tournament: el('fTourn').value,
    year: el('fYear').value,
    season: el('fSeason').value,
    stage: el('fStage').value,
    group: el('fGroup').value,
    week: el('fWeek').value,
    day: el('fDay').value,
    map: el('fMap').value,
    teamA: Aname, teamB: Bname
  };
  el('aiPrompt').value = buildAIPrompt(m, A, B);
}

/* ========= Refresh flow ========= */
async function initialLoad(){
  ALL_ROWS = await fetchAllRecords();
  await populateFilterDropdowns();     // from ALL_ROWS (shows all seasons/tournaments)
  ROWS = applyFilters(ALL_ROWS);       // apply current UI filters
  populateTeamDropdowns(ROWS);         // teams from filtered scope
  renderAll();
}

/* Apply button: do NOT refetch; filter locally */
function applyAndRender(){
  ROWS = applyFilters(ALL_ROWS);
  populateTeamDropdowns(ROWS);
  renderAll();
}

/* ========= Events ========= */
el('applyBtn').onclick = applyAndRender;
el('resetBtn').onclick = ()=>{
  ['fTourn','fYear','fSeason','fStage','fGroup','fWeek','fDay','fMap'].forEach(id=>{ if(el(id)) el(id).value='__ALL__'; });
  applyAndRender();
};
['cmpTeamA','cmpTeamB'].forEach(id=> el(id).addEventListener('change', renderAll));
el('cmpSwap').addEventListener('click', ()=>{
  const A = el('cmpTeamA'), B = el('cmpTeamB'); const t = A.value; A.value = B.value; B.value = t; renderAll();
});
el('copyPromptBtn').addEventListener('click', async ()=>{
  const text = el('aiPrompt').value || '';
  try{
    await navigator.clipboard.writeText(text);
    const btn = el('copyPromptBtn'); const orig=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=orig,1200);
  }catch(e){
    alert('Copy failed: '+e.message);
  }
});

/* ========= First load ========= */
initialLoad();
</script>
</body>
</html>
