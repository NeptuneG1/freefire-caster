<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Full Table Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{background:#e6a74f}
    .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}

    .shell{max-width:1280px;margin:22px auto;padding:0 12px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="search"],.controls input[type="number"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}

    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:5px 8px;font-size:.9rem}

    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid #2a2a2a;padding:6px 6px;vertical-align:top}
    thead th{background:#191919;text-align:left;position:sticky;top:0}
    .right{text-align:right}
    .mono{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted);font-size:.9rem}
    .caption{margin:4px 0 8px}
    .tight{line-height:1.25}

    .barrow{display:flex;align-items:center;gap:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#111;border:1px solid #2a2a2a;margin:2px;font-size:.85rem;color:#ddd}

    .bar-rail{height:9px;background:#181818;border:1px solid #2a2a2a;border-radius:6px;overflow:hidden}
    .bar-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

    @media (max-width: 980px){ .grid3{grid-template-columns:1fr} }
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Full Table Analysis</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">

  <!-- FILTER BAR -->
  <div class="bar">
    <a class="btn" href="dashboard.html">← Back to Dashboard</a>
    <div class="controls" style="margin-left:auto">
      <label>Tournament <select id="fTourn"></select></label>
      <label>Year <select id="fYear"></select></label>
      <label>Season <select id="fSeason"></select></label>
      <label>Stage <select id="fStage"></select></label>
      <label>Group <select id="fGroup"></select></label>
      <label>Week <select id="fWeek"></select></label>
      <label>Day <select id="fDay"></select></label>
      <label>Map
        <select id="fMap">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Purgatory">Purgatory</option>
          <option value="Alpine">Alpine</option>
          <option value="Kalahari">Kalahari</option>
          <option value="Nexterra">Nexterra</option>
          <option value="Purgatory Remastered">Purgatory Remastered</option>
        </select>
      </label>
      <label>Team <select id="fTeam"></select></label>
      <label>Search <input type="search" id="fSearch" placeholder="Team / Tournament / Drop"/></label>
      <button class="btn" id="applyBtn">Apply</button>
      <button class="btn secondary" id="resetBtn" title="Reset all filters">Reset</button>
      <button class="btn secondary" id="exportBtn" title="Export current rows as CSV">Export CSV</button>
    </div>
  </div>

  <!-- DATASET OVERVIEW -->
  <div class="section">
    <h2>Dataset Overview</h2>
    <div class="grid3">
      <div class="card" id="summaryA"><h3>Scope Summary</h3>Loading…</div>
      <div class="card" id="summaryB"><h3>Coverage (Year × Season)</h3>Loading…</div>
      <div class="card" id="summaryC"><h3>Coverage (Tournament)</h3>Loading…</div>
    </div>
    <div class="caption muted" id="meta">—</div>
  </div>

  <!-- TEAM LEADERBOARDS -->
  <div class="section">
    <h2>Team Leaderboards</h2>
    <div class="grid2">
      <div class="card"><h3>Total Points</h3><div id="leadTotal">Loading…</div></div>
      <div class="card"><h3>Booyah Rate</h3><div id="leadBooyah">Loading…</div></div>
      <div class="card"><h3>Elims per Match</h3><div id="leadElims">Loading…</div></div>
      <div class="card"><h3>Damage per Match</h3><div id="leadDamage">Loading…</div></div>
    </div>
  </div>

  <!-- MAP & DROP ANALYSIS -->
  <div class="section">
    <h2>Map and Drop Analysis (by Team)</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelMapTeam">Map Performance — Team</h3><div id="tblMapTeam">Loading…</div></div>
      <div class="card"><h3 id="labelDropTeam">Drop Hotspots — Team</h3><div id="tblDropTeam">Loading…</div></div>
    </div>
  </div>

  <!-- STAGE/GROUP/TIME TRENDS -->
  <div class="section">
    <h2>Stage / Group / Time Trends</h2>
    <div class="grid3">
      <div class="card"><h3>By Stage</h3><div id="tblStage">Loading…</div></div>
      <div class="card"><h3>By Group</h3><div id="tblGroup">Loading…</div></div>
      <div class="card"><h3>By Week / Day</h3><div id="tblWD">Loading…</div></div>
    </div>
  </div>

  <!-- RAW TABLE (current filters) -->
  <div class="section">
    <h2>Raw Rows (Current Filters)</h2>
    <div id="rawTable">Loading…</div>
  </div>

  <!-- AI PROMPT -->
  <div class="section">
    <h2>AI Analysis Prompt</h2>
    <div class="barrow">
      <button class="btn" id="copyPromptBtn">Copy prompt</button>
      <span class="muted">Copies a structured prompt + data snapshot for ChatGPT.</span>
    </div>
    <textarea id="aiPrompt" class="ai-text" readonly style="width:100%;min-height:260px;background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;font-size:.85rem;white-space:pre-wrap">Loading…</textarea>
  </div>

</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ========= Utilities ========= */
const el = (id) => document.getElementById(id);
const fmtPct = (x) => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const n = (x) => Number(x ?? 0) || 0;
const norm = (v) => (v==null ? '' : String(v).trim());
const labelWD = (w,d) => `W${w||'-'}D${d||'-'}`;
function sum(arr, key){ let t=0; for(const r of arr) t += n(r[key]); return t; }
function avg(arr, key){ return arr.length ? sum(arr,key)/arr.length : 0; }
function groupBy(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }
function distinct(rows, key){ return [...new Set(rows.map(r=>r[key]).filter(Boolean))]; }
function csvEscape(s){ if(s==null) return ''; s=String(s); return /(,|\n|\"|\r)/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }

/* ========= State ========= */
let ALL = [];  // all rows from Supabase (paginated fetch)
let ROWS = []; // filtered by UI

/* ========= Paginated fetch (ensures ALL data is loaded) ========= */
async function fetchAllRows(){
  const CHUNK = 1000; // safe default for Supabase
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_data')
      .select('id, team, "group", stage, day, match, map, booyah, placement, elimination, drop, damage, total, played, top3, tag, week, tournament, year, season')
      .order('year', { ascending:true })
      .order('week', { ascending:true })
      .order('day', { ascending:true })
      .order('match', { ascending:true })
      .range(from, from + CHUNK - 1);

    if (error) { console.error('ffbr_data fetch failed:', error); alert('Failed to load ffbr_data: '+(error.message||'Unknown')); break; }
    const rows = data || [];
    if (!rows.length) break;           // no more pages
    out.push(...rows);
    from += rows.length;               // advance by what we actually got
  }
  console.log(`Loaded ${out.length} rows total.`);
  return out;
}


/* ========= Filters ========= */
function initDropdownsPlaceholders(){
  const set = (id, all='All')=>{ el(id).innerHTML = `<option value="__ALL__">${all}</option>`; };
  set('fTourn','All tournaments'); set('fYear','All years'); set('fSeason','All seasons');
  set('fStage','All stages'); set('fGroup','All groups'); set('fWeek','All weeks'); set('fDay','All days');
  el('fTeam').innerHTML = `<option value="__ALL__">All teams</option>`;
}
initDropdownsPlaceholders();

function populateFilterDropdowns(){
  // always from ALL so coverage shows everything
  const set = (id, arr, all) => {
    const dd = el(id); const prev = dd.value || '__ALL__';
    const opts = [`<option value="__ALL__">${all}</option>`, ...arr.sort((a,b)=>String(a).localeCompare(String(b),undefined,{numeric:true})).map(v=>`<option value="${v}">${v}</option>`)];
    dd.innerHTML = opts.join('');
    dd.value = (prev && (prev==='__ALL__' || arr.includes(prev))) ? prev : '__ALL__';
  };
  set('fTourn',  distinct(ALL,'tournament'), 'All tournaments');
  set('fYear',   distinct(ALL,'year'),       'All years');
  set('fSeason', distinct(ALL,'season'),     'All seasons');
  set('fStage',  distinct(ALL,'stage'),      'All stages');
  set('fGroup',  distinct(ALL,'group'),      'All groups');
  set('fWeek',   distinct(ALL,'week'),       'All weeks');
  set('fDay',    distinct(ALL,'day'),        'All days');
  const teams = distinct(ALL,'team');
  const teamDD = el('fTeam'); const prevT = teamDD.value||'__ALL__'; teamDD.innerHTML = ['<option value="__ALL__">All teams</option>', ...teams.sort().map(t=>`<option value="${t}">${t}</option>`)].join(''); teamDD.value = (prevT==='__ALL__'||teams.includes(prevT))?prevT:'__ALL__';
}

function applyFilters(){
  const F = {
    tourn: el('fTourn').value,
    year: el('fYear').value,
    season: el('fSeason').value,
    stage: el('fStage').value,
    group: el('fGroup').value,
    week: el('fWeek').value,
    day: el('fDay').value,
    map: el('fMap').value,
    team: el('fTeam').value,
    search: norm(el('fSearch').value).toLowerCase()
  };
  let rows = ALL;
  if (F.tourn !== '__ALL__') rows = rows.filter(r=>norm(r.tournament)===norm(F.tourn));
  if (F.year  !== '__ALL__') rows = rows.filter(r=>String(r.year)===String(F.year));
  if (F.season!== '__ALL__') rows = rows.filter(r=>norm(r.season)===norm(F.season));
  if (F.stage !== '__ALL__') rows = rows.filter(r=>norm(r.stage)===norm(F.stage));
  if (F.group !== '__ALL__') rows = rows.filter(r=>norm(r.group)===norm(F.group));
  if (F.week  !== '__ALL__') rows = rows.filter(r=>String(r.week)===String(F.week));
  if (F.day   !== '__ALL__') rows = rows.filter(r=>String(r.day)===String(F.day));
  if (F.map   !== '__ALL__') rows = rows.filter(r=>norm(r.map)===norm(F.map));
  if (F.team  !== '__ALL__') rows = rows.filter(r=>norm(r.team)===norm(F.team));
  if (F.search){
    rows = rows.filter(r=>{
      const hay = [r.team,r.tournament,r.drop,r.map,r.stage,r.season,r.group].map(x=>norm(x).toLowerCase()).join('|');
      return hay.includes(F.search);
    });
  }
  ROWS = rows;
}

/* ========= Aggregations ========= */
function kpiDataset(rows){
  const matches = rows.length;
  const teams = distinct(rows,'team').length;
  const tourns = distinct(rows,'tournament').length;
  const years = distinct(rows,'year').length;
  const booyah = sum(rows,'booyah');
  const total = sum(rows,'total');
  const elims = sum(rows,'elimination');
  const damage = sum(rows,'damage');
  const top3 = sum(rows,'top3');
  return {
    matches, teams, tourns, years,
    booyah_rate: matches? booyah/matches : 0,
    total_per_match: matches? total/matches : 0,
    elims_per_match: matches? elims/matches : 0,
    dmg_per_match: matches? damage/matches : 0,
    top3_rate: matches? top3/matches : 0
  };
}

function byKeyStats(rows, key){
  const g = groupBy(rows, r=>r[key]||'—');
  const out = [];
  for(const [val, list] of g.entries()){
    const m = list.length;
    out.push({
      key: val,
      matches: m,
      booyah_rate: m? sum(list,'booyah')/m : 0,
      elims_pm: m? sum(list,'elimination')/m : 0,
      total_pm: m? sum(list,'total')/m : 0
    });
  }
  return out.sort((a,b)=> b.matches - a.matches || b.total_pm - a.total_pm || String(a.key).localeCompare(String(b.key)));
}

function leaderboard(rows, metric){
  const g = groupBy(rows, r=>r.team);
  const out = [];
  for(const [team, list] of g.entries()){
    const m = list.length;
    const obj = { team, matches:m };
    obj.total = sum(list,'total');
    obj.total_pm = m? obj.total/m : 0;
    obj.booyah_rate = m? sum(list,'booyah')/m : 0;
    obj.elims_pm = m? sum(list,'elimination')/m : 0;
    obj.damage_pm = m? sum(list,'damage')/m : 0;
    out.push(obj);
  }
  const sorters = {
    total: (a,b)=> b.total - a.total || b.total_pm - a.total_pm,
    booyah: (a,b)=> b.booyah_rate - a.booyah_rate || b.total_pm - a.total_pm,
    elims: (a,b)=> b.elims_pm - a.elims_pm || b.total - a.total,
    damage: (a,b)=> b.damage_pm - a.damage_pm || b.total - a.total
  };
  const sorter = sorters[metric] || sorters.total;
  return out.sort(sorter).slice(0, 30);
}

function teamMapPerf(rows){
  const g = groupBy(rows, r=>r.map||'—');
  const out=[];
  for(const [map, list] of g.entries()){
    const m = list.length;
    out.push({ map, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0 });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.total_pm-a.total_pm || a.map.localeCompare(b.map));
}

function teamDropPerf(rows, limit=15){
  const g = groupBy(rows, r=>r.drop||'—');
  const out=[];
  for(const [drop, list] of g.entries()){
    const m = list.length;
    out.push({ drop, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0 });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.total_pm-a.total_pm || b.booyah_rate-a.booyah_rate).slice(0,limit);
}

function weekDayTrend(rows){
  const g = groupBy(rows, r=>labelWD(r.week,r.day));
  const out=[];
  for(const [wd, list] of g.entries()){
    const m = list.length;
    out.push({ wd, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0, total:sum(list,'total') });
  }
  return out.sort((a,b)=> String(a.wd).localeCompare(String(b.wd),undefined,{numeric:true}));
}

/* ========= Render helpers ========= */
function renderKPIBox(k){
  if (!k || !k.matches) return '<div class="muted">No rows in scope.</div>';
  return `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.matches}</strong></div>
      <div class="kpi">Teams <strong>${k.teams}</strong></div>
      <div class="kpi">Tournaments <strong>${k.tourns}</strong></div>
      <div class="kpi">Years <strong>${k.years}</strong></div>
      <div class="kpi">Booyah <strong>${fmtPct(k.booyah_rate)}</strong></div>
      <div class="kpi">Elims <strong>${k.elims_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Damage <strong>${k.dmg_per_match.toFixed(0)}</strong>/m</div>
      <div class="kpi">Total <strong>${k.total_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Top3 <strong>${fmtPct(k.top3_rate)}</strong></div>
    </div>`;
}

function renderCoverageMatrix(rows){
  // Year × Season matrix
  const years = [...new Set(rows.map(r=>r.year))].filter(Boolean).sort((a,b)=>a-b);
  const seasons = [...new Set(rows.map(r=>r.season))].filter(Boolean).sort();
  if (!years.length || !seasons.length) return '<div class="muted">No year/season coverage.</div>';
  const g = groupBy(rows, r=>`${r.year}|${r.season}`);
  const td = (y,s)=>{ const list = g.get(`${y}|${s}`)||[]; const m=list.length; const pct = Math.min(100, (m? 10+Math.log10(1+m)*30 : 0)); return `<td title="${m} rows"><div class="bar-rail"><div class="bar-fill" style="width:${pct}%"></div></div></td>`; };
  return `
    <table>
      <thead><tr><th>Year ↓ / Season →</th>${seasons.map(s=>`<th>${s}</th>`).join('')}</tr></thead>
      <tbody>
        ${years.map(y=>`<tr><td>${y}</td>${seasons.map(s=>td(y,s)).join('')}</tr>`).join('')}
      </tbody>
    </table>`;
}

function renderCoverageTournaments(rows){
  const list = byKeyStats(rows,'tournament').slice(0,12);
  if (!list.length) return '<div class="muted">No tournaments.</div>';
  return `
    <table>
      <thead><tr><th>Tournament</th><th class="right">Rows</th><th class="right">Booyah %</th><th class="right">Elims / m</th><th class="right">Total / m</th></tr></thead>
      <tbody>
        ${list.map(r=>`<tr><td>${r.key}</td><td class="right">${r.matches}</td><td class="right">${fmtPct(r.booyah_rate)}</td><td class="right">${r.elims_pm.toFixed(1)}</td><td class="right">${r.total_pm.toFixed(1)}</td></tr>`).join('')}
      </tbody>
    </table>`;
}

function renderLeaderboard(list, mode){
  if (!list.length) return '<div class="muted">No teams in scope.</div>';
  const cols = {
    total: ['Total','total','total_pm'],
    booyah: ['Booyah %','booyah_rate','total_pm'],
    elims: ['Elims / m','elims_pm','total'],
    damage: ['Damage / m','damage_pm','total']
  }[mode] || ['Total','total','total_pm'];
  const [labMain, keyMain, keyAux] = cols;
  return `
    <table>
      <thead><tr><th>#</th><th>Team</th><th class="right">Matches</th><th class="right">${labMain}</th><th class="right">Aux</th></tr></thead>
      <tbody>
        ${list.map((r,i)=>`<tr>
          <td class="right">${i+1}</td><td>${r.team}</td><td class="right">${r.matches}</td>
          <td class="right">${keyMain.includes('rate')?fmtPct(r[keyMain]):(keyMain.includes('_pm')?r[keyMain].toFixed(1):r[keyMain])}</td>
          <td class="right">${keyAux.includes('rate')?fmtPct(r[keyAux]):(keyAux.includes('_pm')?r[keyAux].toFixed(1):r[keyAux])}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.format==='pct') v = fmtPct(v);
    else if (c.format==='1d') v = Number(v).toFixed(1);
    else if (c.format==='0d') v = Number(v).toFixed(0);
    return `<td class="${c.right?'right':''}">${v==null?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}

function renderRawTable(rows){
  if (!rows.length) return '<div class="muted">No rows for current filters.</div>';
  const cols = ['id','team','group','stage','week','day','match','map','drop','booyah','placement','elimination','damage','total','top3','tournament','year','season'];
  const head = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${rows.slice(0,300).map(r=>`<tr>${cols.map(c=>`<td>${r[c]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  const note = rows.length>300? `<div class="muted">Showing first 300 of ${rows.length} rows.</div>`:'';
  return `<div style="overflow:auto"> <table>${head}${body}</table> </div>${note}`;
}

/* ========= AI Prompt ========= */
function buildPrompt(meta, snapshot){
  return `You are an esports analyst. Analyze this Free Fire Battle Royale dataset snapshot.\n\n`+
  `Filters: Tournament=${meta.tournament||'All'}, Year=${meta.year||'All'}, Season=${meta.season||'All'}, Stage=${meta.stage||'All'}, Group=${meta.group||'All'}, Week=${meta.week||'All'}, Day=${meta.day||'All'}, Map=${meta.map||'All'}, Team=${meta.team||'All'}, Search=${meta.search||''}.\n`+
  `Tasks: 1) Summarize dataset KPIs. 2) Identify teams overperforming on Booyah/Elims/Damage. 3) Call out best/worst maps & drops by volume and per-match totals. 4) Stage/Group trends. 5) Weekly consistency and spikes. 6) 5 actionable prep notes.\n\n`+
  `JSON:\n`+JSON.stringify(snapshot,null,2);
}

/* ========= Export CSV ========= */
function exportCSV(filename, rows){
  if (!rows || !rows.length){ alert('No rows to export.'); return; }
  const cols = Object.keys(rows[0]);
  const head = cols.map(csvEscape).join(',');
  const lines = rows.map(r=> cols.map(c=>csvEscape(r[c])).join(','));
  const blob = new Blob([head+'\n'+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* ========= Render All ========= */
function renderAll(){
  // Meta label
  const labels = (id)=> (el(id).value==='__ALL__' ? 'All' : el(id).value);
  const metaLbl = `Tourn: ${labels('fTourn')} • Year: ${labels('fYear')} • Season: ${labels('fSeason')} • Stage: ${labels('fStage')} • Group: ${labels('fGroup')} • Week: ${labels('fWeek')} • Day: ${labels('fDay')} • Map: ${labels('fMap')} • Team: ${labels('fTeam')} • Rows: ${ROWS.length}/${ALL.length}`;
  el('meta').textContent = metaLbl;

  // Overview
  const k = kpiDataset(ROWS);
  el('summaryA').innerHTML = `<h3>Scope Summary</h3>${renderKPIBox(k)}`;
  el('summaryB').innerHTML = `<h3>Coverage (Year × Season)</h3>${renderCoverageMatrix(ALL)}`;
  el('summaryC').innerHTML = `<h3>Coverage (Tournament)</h3>${renderCoverageTournaments(ALL)}`;

  // Leaderboards
  el('leadTotal').innerHTML  = renderLeaderboard(leaderboard(ROWS,'total'),'total');
  el('leadBooyah').innerHTML = renderLeaderboard(leaderboard(ROWS,'booyah'),'booyah');
  el('leadElims').innerHTML  = renderLeaderboard(leaderboard(ROWS,'elims'),'elims');
  el('leadDamage').innerHTML = renderLeaderboard(leaderboard(ROWS,'damage'),'damage');

  // Map/Drop by team (if a team is selected, use that; otherwise, use top by matches)
  let teamSel = el('fTeam').value;
  if (teamSel==='__ALL__'){
    const topTeam = leaderboard(ROWS,'total')[0]?.team || distinct(ROWS,'team')[0] || '';
    teamSel = topTeam;
  }
  const teamRows = ROWS.filter(r=>r.team===teamSel);
  el('labelMapTeam').textContent = `Map Performance — ${teamSel||'—'}`;
  el('labelDropTeam').textContent = `Drop Hotspots — ${teamSel||'—'}`;
  el('tblMapTeam').innerHTML = renderSimpleTable(
    teamMapPerf(teamRows),
    [ {label:'Map',key:'map'}, {label:'Matches',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblDropTeam').innerHTML = renderSimpleTable(
    teamDropPerf(teamRows, 15),
    [ {label:'Drop',key:'drop'}, {label:'Matches',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );

  // Stage / Group / Week-Day trends (from current ROWS)
  el('tblStage').innerHTML = renderSimpleTable(
    byKeyStats(ROWS,'stage'),
    [ {label:'Stage',key:'key'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblGroup').innerHTML = renderSimpleTable(
    byKeyStats(ROWS,'group'),
    [ {label:'Group',key:'key'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblWD').innerHTML = renderSimpleTable(
    weekDayTrend(ROWS),
    [ {label:'Week/Day',key:'wd'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true}, {label:'Total',key:'total',right:true} ]
  );

  // Raw table
  el('rawTable').innerHTML = renderRawTable(ROWS);

  // AI prompt snapshot
  const snapshot = {
    scope_kpis: k,
    leaderboards: {
      total: leaderboard(ROWS,'total'),
      booyah: leaderboard(ROWS,'booyah'),
      elims: leaderboard(ROWS,'elims'),
      damage: leaderboard(ROWS,'damage')
    },
    team_examples: {
      team: teamSel,
      map_perf: teamMapPerf(teamRows),
      drop_perf: teamDropPerf(teamRows, 15)
    },
    stage_stats: byKeyStats(ROWS,'stage'),
    group_stats: byKeyStats(ROWS,'group'),
    week_day: weekDayTrend(ROWS)
  };
  const meta = {
    tournament: el('fTourn').value, year: el('fYear').value, season: el('fSeason').value,
    stage: el('fStage').value, group: el('fGroup').value, week: el('fWeek').value, day: el('fDay').value,
    map: el('fMap').value, team: el('fTeam').value, search: el('fSearch').value
  };
  el('aiPrompt').value = buildPrompt(meta, snapshot);
}

/* ========= Wiring ========= */
async function initial(){
  ALL = await fetchAllRows();
  populateFilterDropdowns();
  applyFilters();
  renderAll();
}

el('applyBtn').onclick = ()=>{ applyFilters(); renderAll(); };

el('resetBtn').onclick = ()=>{
  ['fTourn','fYear','fSeason','fStage','fGroup','fWeek','fDay','fMap','fTeam','fSearch'].forEach(id=>{ if(el(id)) el(id).value='__ALL__'; });
  el('fSearch').value = '';
  applyFilters(); renderAll();
};

el('exportBtn').onclick = ()=>{
  exportCSV('ffbr_scope.csv', ROWS);
};

el('copyPromptBtn').onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(el('aiPrompt').value||'');
    const btn = el('copyPromptBtn'); const orig=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=orig,1200);
  }catch(e){ alert('Copy failed: '+e.message); }
};

['fTourn','fYear','fSeason','fStage','fGroup','fWeek','fDay','fMap','fTeam'].forEach(id=> el(id).addEventListener('change', ()=>{ applyFilters(); renderAll(); }));
el('fSearch').addEventListener('input', ()=>{ applyFilters(); renderAll(); });

initial();
</script>
</body>
</html>
