<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Full Table Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{background:#e6a74f}
    .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}

    .shell{max-width:1280px;margin:22px auto;padding:0 12px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="search"],.controls input[type="number"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}

    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:5px 8px;font-size:.9rem}

    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid #2a2a2a;padding:6px 6px;vertical-align:top}
    thead th{background:#191919;text-align:left;position:sticky;top:0}
    .right{text-align:right}
    .mono{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted);font-size:.9rem}
    .caption{margin:4px 0 8px}
    .tight{line-height:1.25}

    .barrow{display:flex;align-items:center;gap:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#111;border:1px solid #2a2a2a;margin:2px;font-size:.85rem;color:#ddd}

    .bar-rail{height:9px;background:#181818;border:1px solid #2a2a2a;border-radius:6px;overflow:hidden}
    .bar-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

    @media (max-width: 980px){ .grid3{grid-template-columns:1fr} }
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Full Table Analysis</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">

  <!-- FILTER BAR -->
  <div class="bar">
    <a class="btn" href="dashboard.html">← Back to Dashboard</a>
    <div class="controls" style="margin-left:auto">
      <label>Tournament <select id="fTourn"></select></label>
      <label>Year <select id="fYear"></select></label>
      <label>Season <select id="fSeason"></select></label>
      <label>Stage <select id="fStage"></select></label>
      <label>Group <select id="fGroup"></select></label>
      <label>Week <select id="fWeek"></select></label>
      <label>Day <select id="fDay"></select></label>
      <label>Map
        <select id="fMap">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Purgatory">Purgatory</option>
          <option value="Alpine">Alpine</option>
          <option value="Kalahari">Kalahari</option>
          <option value="Nexterra">Nexterra</option>
          <option value="Solara">Solara</option>
        </select>
      </label>
      <label>Team <select id="fTeam"></select></label>
      <label>Search <input type="search" id="fSearch" placeholder="Team / Tournament / Drop"/></label>
      <button class="btn" id="applyBtn">Apply</button>
      <button class="btn secondary" id="resetBtn" title="Reset all filters">Reset</button>
      <button class="btn secondary" id="exportBtn" title="Export current rows as CSV">Export CSV</button>
    </div>
  </div>

  <!-- DATASET OVERVIEW -->
  <div class="section">
    <h2>Dataset Overview</h2>
    <div class="grid3">
      <div class="card" id="summaryA"><h3>Scope Summary</h3>Loading…</div>
      <div class="card" id="summaryB"><h3>Coverage (Year × Season)</h3>Loading…</div>
      <div class="card" id="summaryC"><h3>Coverage (Tournament)</h3>Loading…</div>
    </div>
    <div class="caption muted" id="meta">—</div>
  </div>

  <!-- TEAM LEADERBOARDS -->
  <div class="section">
    <h2>Team Leaderboards</h2>
    <div class="grid2">
      <div class="card"><h3>Total Points</h3><div id="leadTotal">Loading…</div></div>
      <div class="card"><h3>Booyah Rate</h3><div id="leadBooyah">Loading…</div></div>
      <div class="card"><h3>Elims per Match</h3><div id="leadElims">Loading…</div></div>
      <div class="card"><h3>Damage per Match</h3><div id="leadDamage">Loading…</div></div>
    </div>
  </div>

  <!-- MAP & DROP ANALYSIS -->
  <div class="section">
    <h2>Map and Drop Analysis (by Team)</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelMapTeam">Map Performance — Team</h3><div id="tblMapTeam">Loading…</div></div>
      <div class="card"><h3 id="labelDropTeam">Drop Hotspots — Team</h3><div id="tblDropTeam">Loading…</div></div>
    </div>
  </div>

  <!-- STAGE/GROUP/TIME TRENDS -->
  <div class="section">
    <h2>Stage / Group / Time Trends</h2>
    <div class="grid3">
      <div class="card"><h3>By Stage</h3><div id="tblStage">Loading…</div></div>
      <div class="card"><h3>By Group</h3><div id="tblGroup">Loading…</div></div>
      <div class="card"><h3>By Week / Day</h3><div id="tblWD">Loading…</div></div>
    </div>
  </div>

  <!-- ===== POI CONTESTATION ===== -->
  <div class="section">
    <h2>POI Contestation</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelContestTeam">Team — Contest Rate & Outcomes</h3><div id="tblContestTeam">Loading…</div></div>
      <div class="card"><h3>Most Contested Drops (field)</h3><div id="tblContestField">Loading…</div></div>
    </div>
    <div class="caption muted tight">Contested = ≥2 teams same (tournament, stage, group, week, day, match, map, drop).</div>
  </div>

  <!-- ===== DROP LOYALTY / FLEX ===== -->
  <div class="section">
    <h2>Drop Loyalty & Flex Performance</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelLoyal">Team — Loyalty</h3><div id="tblLoyal">Loading…</div></div>
      <div class="card"><h3 id="labelFlex">Team — Flex vs Home</h3><div id="tblFlex">Loading…</div></div>
    </div>
  </div>

  <!-- ===== CONSISTENCY / CONVERSION / EFFICIENCY ===== -->
  <div class="section">
    <h2>Consistency, Conversion & Efficiency</h2>
    <div class="grid3">
      <div class="card"><h3>Consistency / Volatility</h3><div id="tblConsist">Loading…</div></div>
      <div class="card"><h3>Booyah Conversion (from Top-3)</h3><div id="tblConv">Loading…</div></div>
      <div class="card"><h3>Damage Efficiency</h3><div id="tblEff">Loading…</div></div>
    </div>
  </div>

  <!-- ===== FRAG VS PLACEMENT ===== -->
  <div class="section">
    <h2>Frag vs Placement Profile</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelProfileTeam">Team — Points Split</h3><div id="tblProfileTeam">Loading…</div></div>
      <div class="card"><h3>Field Comparison</h3><div id="tblProfileField">Loading…</div></div>
    </div>
  </div>

  <!-- ===== MOMENTUM & MAP SPECIALIZATION ===== -->
  <div class="section">
    <h2>Momentum (3-Match Rolling) & Map Specialization</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelMomentumTeam">Team — Rolling Total</h3><div id="tblMomentum">Loading…</div></div>
      <div class="card"><h3>Map Specialization</h3><div id="tblSpec">Loading…</div></div>
    </div>
  </div>

  <!-- ===== CLUTCH / SCUFFED ===== -->
  <div class="section">
    <h2>Clutch & Scuffed Buckets</h2>
    <div class="grid2">
      <div class="card"><h3 id="labelClutchTeam">Team — Rates</h3><div id="tblClutch">Loading…</div></div>
      <div class="card"><h3>Examples (last 10)</h3><div id="tblClutchEx">Loading…</div></div>
    </div>
    <div class="caption muted tight">Quartiles computed within current filter scope for each team.</div>
  </div>

  <!-- AI PROMPT -->
  <div class="section">
    <h2>AI Analysis Prompt</h2>
    <div class="barrow">
      <button class="btn" id="copyPromptBtn">Copy prompt</button>
      <span class="muted">Copies a structured prompt + data snapshot for ChatGPT.</span>
    </div>
    <textarea id="aiPrompt" class="ai-text" readonly style="width:100%;min-height:260px;background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;font-size:.85rem;white-space:pre-wrap">Loading…</textarea>
  </div>

</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ========= Utilities ========= */
const el = (id) => document.getElementById(id);
const fmtPct = (x) => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const n = (x) => Number(x ?? 0) || 0;
const norm = (v) => (v==null ? '' : String(v).trim());
const labelWD = (w,d) => `W${w||'-'}D${d||'-'}`;
function sum(arr, key){ let t=0; for(const r of arr) t += n(r[key]); return t; }
function avg(arr, key){ return arr.length ? sum(arr,key)/arr.length : 0; }
function groupBy(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }
function distinct(rows, key){ return [...new Set(rows.map(r=>r[key]).filter(Boolean))]; }
function csvEscape(s){ if(s==null) return ''; s=String(s); return /(,|\n|\"|\r)/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }

/* Extra helpers (for new analyses) */
function variance(arr, key){
  if (!arr.length) return 0;
  const mean = arr.reduce((a,r)=>a+n(r[key]),0)/arr.length;
  const v = arr.reduce((a,r)=>a+Math.pow(n(r[key])-mean,2),0)/arr.length;
  return v;
}
function stddev(arr, key){ return Math.sqrt(variance(arr,key)); }
function quantile(values, q){
  const a = values.map(n).filter(x=>isFinite(x)).sort((x,y)=>x-y);
  if (!a.length) return 0;
  const pos = (a.length-1)*q;
  const base = Math.floor(pos), rest = pos - base;
  return a[base] + (a[base+1]!==undefined ? rest*(a[base+1]-a[base]) : 0);
}
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.format==='pct') v = fmtPct(v);
    else if (c.format==='1d') v = Number(v).toFixed(1);
    else if (c.format==='2d') v = Number(v).toFixed(2);
    else if (c.format==='0d') v = Number(v).toFixed(0);
    return `<td class="${c.right?'right':''}">${v==null?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}
// Build unique match key across teams for contestation calc
function matchKey(r){
  return [r.tournament,r.stage,r.group,r.week,r.day,r.match,r.map].map(x=>String(x??'')).join('|');
}

/* ========= State ========= */
let ALL = [];  // all rows from Supabase (paginated fetch)
let ROWS = []; // filtered by UI

/* ========= Paginated fetch (ensures ALL data is loaded) ========= */
async function fetchAllRows(){
  const CHUNK = 1000; // safe default for Supabase
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_data')
      .select('id, team, "group", stage, day, match, map, booyah, placement, elimination, drop, damage, total, played, top3, tag, week, tournament, year, season')
      .order('year', { ascending:true })
      .order('week', { ascending:true })
      .order('day', { ascending:true })
      .order('match', { ascending:true })
      .range(from, from + CHUNK - 1);

    if (error) { console.error('ffbr_data fetch failed:', error); alert('Failed to load ffbr_data: '+(error.message||'Unknown')); break; }
    const rows = data || [];
    if (!rows.length) break;           // no more pages
    out.push(...rows);
    from += rows.length;               // advance by what we actually got
  }
  console.log(`Loaded ${out.length} rows total.`);
  return out;
}

/* ========= Filters ========= */
function initDropdownsPlaceholders(){
  const set = (id, all='All')=>{ el(id).innerHTML = `<option value="__ALL__">${all}</option>`; };
  set('fTourn','All tournaments'); set('fYear','All years'); set('fSeason','All seasons');
  set('fStage','All stages'); set('fGroup','All groups'); set('fWeek','All weeks'); set('fDay','All days');
  el('fTeam').innerHTML = `<option value="__ALL__">All teams</option>`;
}
initDropdownsPlaceholders();

function populateFilterDropdowns(){
  const set = (id, arr, all) => {
    const dd = el(id); const prev = dd.value || '__ALL__';
    const opts = [`<option value="__ALL__">${all}</option>`, ...arr.sort((a,b)=>String(a).localeCompare(String(b),undefined,{numeric:true})).map(v=>`<option value="${v}">${v}</option>`)];
    dd.innerHTML = opts.join('');
    dd.value = (prev && (prev==='__ALL__' || arr.includes(prev))) ? prev : '__ALL__';
  };
  set('fTourn',  distinct(ALL,'tournament'), 'All tournaments');
  set('fYear',   distinct(ALL,'year'),       'All years');
  set('fSeason', distinct(ALL,'season'),     'All seasons');
  set('fStage',  distinct(ALL,'stage'),      'All stages');
  set('fGroup',  distinct(ALL,'group'),      'All groups');
  set('fWeek',   distinct(ALL,'week'),       'All weeks');
  set('fDay',    distinct(ALL,'day'),        'All days');
  const teams = distinct(ALL,'team');
  const teamDD = el('fTeam'); const prevT = teamDD.value||'__ALL__';
  teamDD.innerHTML = ['<option value="__ALL__">All teams</option>', ...teams.sort().map(t=>`<option value="${t}">${t}</option>`)].join('');
  teamDD.value = (prevT==='__ALL__'||teams.includes(prevT))?prevT:'__ALL__';
}

function applyFilters(){
  const F = {
    tourn: el('fTourn').value,
    year: el('fYear').value,
    season: el('fSeason').value,
    stage: el('fStage').value,
    group: el('fGroup').value,
    week: el('fWeek').value,
    day: el('fDay').value,
    map: el('fMap').value,
    team: el('fTeam').value,
    search: norm(el('fSearch').value).toLowerCase()
  };
  let rows = ALL;
  if (F.tourn !== '__ALL__') rows = rows.filter(r=>norm(r.tournament)===norm(F.tourn));
  if (F.year  !== '__ALL__') rows = rows.filter(r=>String(r.year)===String(F.year));
  if (F.season!== '__ALL__') rows = rows.filter(r=>norm(r.season)===norm(F.season));
  if (F.stage !== '__ALL__') rows = rows.filter(r=>norm(r.stage)===norm(F.stage));
  if (F.group !== '__ALL__') rows = rows.filter(r=>norm(r.group)===norm(F.group));
  if (F.week  !== '__ALL__') rows = rows.filter(r=>String(r.week)===String(F.week));
  if (F.day   !== '__ALL__') rows = rows.filter(r=>String(r.day)===String(F.day));
  if (F.map   !== '__ALL__') rows = rows.filter(r=>norm(r.map)===norm(F.map));
  if (F.team  !== '__ALL__') rows = rows.filter(r=>norm(r.team)===norm(F.team));
  if (F.search){
    rows = rows.filter(r=>{
      const hay = [r.team,r.tournament,r.drop,r.map,r.stage,r.season,r.group].map(x=>norm(x).toLowerCase()).join('|');
      return hay.includes(F.search);
    });
  }
  ROWS = rows;
}

/* ========= Aggregations ========= */
function kpiDataset(rows){
  const matches = rows.length;
  const teams = distinct(rows,'team').length;
  const tourns = distinct(rows,'tournament').length;
  const years = distinct(rows,'year').length;
  const booyah = sum(rows,'booyah');
  const total = sum(rows,'total');
  const elims = sum(rows,'elimination');
  const damage = sum(rows,'damage');
  const top3 = sum(rows,'top3');
  return {
    matches, teams, tourns, years,
    booyah_rate: matches? booyah/matches : 0,
    total_per_match: matches? total/matches : 0,
    elims_per_match: matches? elims/matches : 0,
    dmg_per_match: matches? damage/matches : 0,
    top3_rate: matches? top3/matches : 0
  };
}

function byKeyStats(rows, key){
  const g = groupBy(rows, r=>r[key]||'—');
  const out = [];
  for(const [val, list] of g.entries()){
    const m = list.length;
    out.push({
      key: val,
      matches: m,
      booyah_rate: m? sum(list,'booyah')/m : 0,
      elims_pm: m? sum(list,'elimination')/m : 0,
      total_pm: m? sum(list,'total')/m : 0
    });
  }
  return out.sort((a,b)=> b.matches - a.matches || b.total_pm - a.total_pm || String(a.key).localeCompare(String(b.key)));
}

function leaderboard(rows, metric){
  const g = groupBy(rows, r=>r.team);
  const out = [];
  for(const [team, list] of g.entries()){
    const m = list.length;
    const obj = { team, matches:m };
    obj.total = sum(list,'total');
    obj.total_pm = m? obj.total/m : 0;
    obj.booyah_rate = m? sum(list,'booyah')/m : 0;
    obj.elims_pm = m? sum(list,'elimination')/m : 0;
    obj.damage_pm = m? sum(list,'damage')/m : 0;
    out.push(obj);
  }
  const sorters = {
    total: (a,b)=> b.total - a.total || b.total_pm - a.total_pm,
    booyah: (a,b)=> b.booyah_rate - a.booyah_rate || b.total_pm - a.total_pm,
    elims: (a,b)=> b.elims_pm - a.elims_pm || b.total - a.total,
    damage: (a,b)=> b.damage_pm - a.damage_pm || b.total - a.total
  };
  const sorter = sorters[metric] || sorters.total;
  return out.sort(sorter).slice(0, 30);
}

function teamMapPerf(rows){
  const g = groupBy(rows, r=>r.map||'—');
  const out=[];
  for(const [map, list] of g.entries()){
    const m = list.length;
    out.push({ map, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0 });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.total_pm-a.total_pm || a.map.localeCompare(b.map));
}

function teamDropPerf(rows, limit=15){
  const g = groupBy(rows, r=>r.drop||'—');
  const out=[];
  for(const [drop, list] of g.entries()){
    const m = list.length;
    out.push({ drop, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0 });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.total_pm-a.total_pm || b.booyah_rate-a.booyah_rate).slice(0,limit);
}

function weekDayTrend(rows){
  const g = groupBy(rows, r=>labelWD(r.week,r.day));
  const out=[];
  for(const [wd, list] of g.entries()){
    const m = list.length;
    out.push({ wd, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0, total:sum(list,'total') });
  }
  return out.sort((a,b)=> String(a.wd).localeCompare(String(b.wd),undefined,{numeric:true}));
}

/* ========= BR Analysis blocks ========= */

// POI Contestation
function contestMetrics(allRows, team){
  const byMatch = groupBy(allRows, matchKey);
  let contested=0, uncontested=0, pointsCont=0, pointsUn=0;
  const fieldContest = new Map(); // drop -> {contestedMatches, teamsSeen}

  for(const [k, list] of byMatch.entries()){
    const byDrop = groupBy(list, r=>r.drop||'—');
    for(const [drop, teams] of byDrop.entries()){
      if (teams.length>1){
        const key = drop||'—';
        const F = fieldContest.get(key) || { contestedMatches:0, teamsSeen:0 };
        F.contestedMatches += 1;
        F.teamsSeen += teams.length;
        fieldContest.set(key, F);
      }
    }
    const my = list.filter(r=>r.team===team);
    if (!my.length) continue;
    const r = my[0];
    const d = r.drop||'—';
    const isCont = (byDrop.get(d)?.length||0) > 1;
    if (isCont){ contested++; pointsCont += n(r.total); }
    else { uncontested++; pointsUn += n(r.total); }
  }
  return {
    contested, uncontested,
    total: contested+uncontested,
    total_pm_contested: contested ? pointsCont/contested : 0,
    total_pm_uncontested: uncontested ? pointsUn/uncontested : 0,
    fieldTop: [...fieldContest.entries()]
       .map(([drop,v])=>({ drop, contestedMatches:v.contestedMatches, avgTeams:(v.teamsSeen/v.contestedMatches) }))
       .sort((a,b)=> b.contestedMatches-a.contestedMatches || b.avgTeams-a.avgTeams)
       .slice(0,10)
  };
}
function renderContestation(allRows, team){
  const m = contestMetrics(allRows, team);
  el('labelContestTeam').textContent = `Team — Contest Rate & Outcomes (${team})`;
  el('tblContestTeam').innerHTML = renderSimpleTable([{
    contested: m.contested, uncontested: m.uncontested,
    rate: m.total? m.contested/m.total : 0,
    tpmC: m.total_pm_contested, tpmU: m.total_pm_uncontested
  }],[
    {label:'Contested',key:'contested',right:true},
    {label:'Uncontested',key:'uncontested',right:true},
    {label:'Contest Rate',key:'rate',format:'pct',right:true},
    {label:'Total / m (Contested)',key:'tpmC',format:'1d',right:true},
    {label:'Total / m (Uncontested)',key:'tpmU',format:'1d',right:true}
  ]);
  el('tblContestField').innerHTML = renderSimpleTable(m.fieldTop, [
    {label:'Drop',key:'drop'},
    {label:'Contested Matches',key:'contestedMatches',right:true},
    {label:'Avg Teams in Contest',key:'avgTeams',format:'1d',right:true},
  ]);
}

// Drop Loyalty & Flex
function loyaltyFlex(rows){
  if (!rows.length) return null;
  const byDrop = groupBy(rows, r=>r.drop||'—');
  const entries = [...byDrop.entries()].map(([d,list])=>({ drop:d, matches:list.length, total:sum(list,'total') }));
  entries.sort((a,b)=> b.matches-a.matches || b.total-a.total);
  const home = entries[0];
  const stay = byDrop.get(home.drop) || [];
  const flex = rows.filter(r => (r.drop||'—') !== home.drop);
  return {
    homeDrop: home.drop, homeShare: rows.length? (stay.length/rows.length) : 0,
    stay_tpm: stay.length? sum(stay,'total')/stay.length : 0,
    flex_tpm: flex.length? sum(flex,'total')/flex.length : 0,
    drops: entries.map(d=>({...d, total_pm: d.matches? d.total/d.matches : 0})).slice(0,10)
  };
}
function renderLoyalFlex(rows, team){
  const L = loyaltyFlex(rows);
  el('labelLoyal').textContent = `Team — Loyalty (${team})`;
  if (!L){ el('tblLoyal').innerHTML = '<div class="muted">No rows.</div>'; el('tblFlex').innerHTML=''; return; }
  el('tblLoyal').innerHTML = renderSimpleTable([{
    home: L.homeDrop, share: L.homeShare, stay:L.stay_tpm, flex:L.flex_tpm
  }],[
    {label:'Home Drop',key:'home'},
    {label:'Home Share',key:'share',format:'pct',right:true},
    {label:'Total / m — Stay',key:'stay',format:'1d',right:true},
    {label:'Total / m — Flex',key:'flex',format:'1d',right:true},
  ]);
  el('labelFlex').textContent = `Team — Flex vs Home (${team})`;
  el('tblFlex').innerHTML = renderSimpleTable(L.drops, [
    {label:'Drop',key:'drop'},
    {label:'Matches',key:'matches',right:true},
    {label:'Total',key:'total',right:true},
    {label:'Total / m',key:'total_pm',format:'1d',right:true}
  ]);
}

// Consistency / Conversion / Efficiency
function consistency(rows){
  if (!rows.length) return null;
  const mean = avg(rows,'total');
  const sd   = stddev(rows,'total');
  const cv   = mean ? sd/mean : 0;
  const t = rows.map(r=>n(r.total)).sort((a,b)=>a-b);
  const iqr = quantile(t,0.75) - quantile(t,0.25);
  return { matches: rows.length, mean, sd, cv, iqr };
}
function conversion(rows){
  const m = rows.length;
  const booy = sum(rows,'booyah');
  const t3   = sum(rows,'top3');
  return { booyah_rate: m? booy/m : 0, top3_rate: m? t3/m : 0, conv: t3? booy/t3 : 0 };
}
function efficiency(rows){
  const elims = sum(rows,'elimination');
  const dmg   = sum(rows,'damage');
  const dpe   = elims? (dmg/elims) : 0;
  const zeroElim = rows.filter(r=>n(r.elimination)===0).length;
  const hiDamageNoElim = rows.filter(r=>n(r.elimination)===0 && n(r.damage) >= quantile(rows.map(r=>n(r.damage)),0.75)).length;
  return { dpe, zeroElimRate: rows.length? zeroElim/rows.length : 0, hiDmgNoElimRate: rows.length? hiDamageNoElim/rows.length : 0 };
}
function renderConsConvEff(rows){
  const C = consistency(rows);
  el('tblConsist').innerHTML = C ? renderSimpleTable([{
    matches:C.matches, mean:C.mean, sd:C.sd, cv:C.cv, iqr:C.iqr
  }],[
    {label:'Matches',key:'matches',right:true},
    {label:'Mean Total',key:'mean',format:'1d',right:true},
    {label:'Std Dev',key:'sd',format:'1d',right:true},
    {label:'Coeff. Variation',key:'cv',format:'2d',right:true},
    {label:'IQR (Total)',key:'iqr',format:'1d',right:true},
  ]) : '<div class="muted">No rows.</div>';

  const V = conversion(rows);
  el('tblConv').innerHTML = renderSimpleTable([V],[
    {label:'Booyah %',key:'booyah_rate',format:'pct',right:true},
    {label:'Top-3 %',key:'top3_rate',format:'pct',right:true},
    {label:'Booyah ÷ Top-3',key:'conv',format:'2d',right:true},
  ]);

  const E = efficiency(rows);
  el('tblEff').innerHTML = renderSimpleTable([E],[
    {label:'Damage / Elim',key:'dpe',format:'1d',right:true},
    {label:'Zero-Elim %',key:'zeroElimRate',format:'pct',right:true},
    {label:'Hi-Damage No-Elim %',key:'hiDmgNoElimRate',format:'pct',right:true},
  ]);
}

// Frag vs Placement
function fragPlacement(rows){
  const elim = sum(rows,'elimination');
  const place= sum(rows,'placement');
  const total= sum(rows,'total');
  const elimPts = elim; // adjust if elim point weight differs
  const placePts = total - elimPts;
  const shareE = total? elimPts/total : 0;
  const shareP = total? placePts/total : 0;
  return { elimPts, placePts, total, shareE, shareP };
}
function renderFragPlacement(rows, fieldRows, team){
  el('labelProfileTeam').textContent = `Team — Points Split (${team})`;
  const T = fragPlacement(rows);
  el('tblProfileTeam').innerHTML = renderSimpleTable([T],[
    {label:'Elim Pts',key:'elimPts',right:true},
    {label:'Placement Pts',key:'placePts',right:true},
    {label:'Total Pts',key:'total',right:true},
    {label:'Elim Share',key:'shareE',format:'pct',right:true},
    {label:'Placement Share',key:'shareP',format:'pct',right:true},
  ]);
  // Field comparison by team
  const byTeam = groupBy(fieldRows, r=>r.team);
  const list = [...byTeam.entries()].map(([nm,list])=>{
    const s=fragPlacement(list);
    return { team:nm, total:s.total, elimShare:s.shareE, total_pm: list.length? s.total/list.length:0 };
  }).sort((a,b)=> b.elimShare-a.elimShare || b.total_pm-a.total_pm).slice(0,20);
  el('tblProfileField').innerHTML = renderSimpleTable(list,[
    {label:'Team',key:'team'},
    {label:'Elim Share',key:'elimShare',format:'pct',right:true},
    {label:'Total',key:'total',right:true},
    {label:'Total / m',key:'total_pm',format:'1d',right:true},
  ]);
}

// Momentum & Map Specialization
function rollingTotal(rows, k=3){
  if (!rows.length) return [];
  const s = [...rows].sort((a,b)=>
    String(a.year).localeCompare(String(b.year),undefined,{numeric:true}) ||
    String(a.week).localeCompare(String(b.week),undefined,{numeric:true}) ||
    String(a.day).localeCompare(String(b.day),undefined,{numeric:true}) ||
    String(a.match).localeCompare(String(b.match),undefined,{numeric:true}) ||
    a.id-b.id
  );
  const out=[];
  let window=[]; let sumT=0;
  for (const r of s){
    window.push(r); sumT += n(r.total);
    if (window.length>k){ sumT -= n(window.shift().total); }
    out.push({ wd: labelWD(r.week,r.day), match:r.match, total:r.total, roll_k: window.length>=k ? (sumT/k) : null });
  }
  return out.filter(x=>x.roll_k!=null);
}
function mapSpecialization(rows){
  const byMap = groupBy(rows, r=>r.map||'—');
  const totals = [...byMap.values()].map(list=>sum(list,'total'));
  const all = sum(rows,'total') || 1;
  const shares = totals.map(t=>t/all);
  const hhi = shares.reduce((a,x)=>a+x*x,0);
  const perf = [...byMap.entries()].map(([map,list])=>{
    const tpm = list.length? sum(list,'total')/list.length : 0;
    return { map, tpm };
  });
  const teamAvg = rows.length? sum(rows,'total')/rows.length : 0;
  perf.forEach(p=> p.delta = p.tpm - teamAvg);
  perf.sort((a,b)=> b.delta-a.delta || b.tpm-a.tpm);
  return { hhi, teamAvg, perfTop: perf.slice(0,5), perfBot: perf.slice(-5).reverse() };
}
function renderMomentumSpec(rows, team){
  el('labelMomentumTeam').textContent = `Team — Rolling Total (${team})`;
  const roll = rollingTotal(rows, 3);
  el('tblMomentum').innerHTML = renderSimpleTable(roll.slice(-20),[
    {label:'Week/Day',key:'wd'},
    {label:'Match',key:'match',right:true},
    {label:'3-match Avg',key:'roll_k',format:'1d',right:true},
  ]);
  const S = mapSpecialization(rows);
  el('tblSpec').innerHTML = renderSimpleTable([{
    hhi:S.hhi, avg:S.teamAvg, best:S.perfTop[0]?.map||'—', bestDelta:S.perfTop[0]?.delta||0,
    worst:S.perfBot[0]?.map||'—', worstDelta:S.perfBot[0]?.delta||0
  }],[
    {label:'Specialization (HHI)',key:'hhi',format:'2d',right:true},
    {label:'Team Avg / m',key:'avg',format:'1d',right:true},
    {label:'Best Map',key:'best'},
    {label:'Δ Best vs Avg',key:'bestDelta',format:'1d',right:true},
    {label:'Worst Map',key:'worst'},
    {label:'Δ Worst vs Avg',key:'worstDelta',format:'1d',right:true},
  ]);
}

// Clutch / Scuffed
function clutchScuffed(rows){
  if (!rows.length) return { rateClutch:0, rateScuff:0, exClutch:[], exScuff:[] };
  const P = rows.map(r=>n(r.placement)), E = rows.map(r=>n(r.elimination));
  const pQ1 = quantile(P,0.25), eQ3 = quantile(E,0.75), eQ1 = quantile(E,0.25);
  const exC = [], exS = [];
  let c=0,s=0;
  for (const r of rows){
    const isClutch = n(r.placement) <= pQ1 && n(r.elimination) >= eQ3;
    const isScuff  = n(r.placement) <= pQ1 && n(r.elimination) <= eQ1;
    if (isClutch){ c++; exC.push(r); }
    if (isScuff){ s++; exS.push(r); }
  }
  return {
    rateClutch: rows.length? c/rows.length : 0,
    rateScuff: rows.length? s/rows.length : 0,
    exClutch: exC.slice(-10), exScuff: exS.slice(-10)
  };
}
function renderClutch(rows, team){
  el('labelClutchTeam').textContent = `Team — Rates (${team})`;
  const C = clutchScuffed(rows);
  el('tblClutch').innerHTML = renderSimpleTable([{
    clutch:C.rateClutch, scuffed:C.rateScuff
  }],[
    {label:'Clutch %',key:'clutch',format:'pct',right:true},
    {label:'Scuffed %',key:'scuffed',format:'pct',right:true},
  ]);
  const ex = [
    ...C.exClutch.map(r=>({type:'Clutch', wd:labelWD(r.week,r.day), map:r.map, drop:r.drop, place:r.placement, elim:r.elimination, total:r.total})),
    ...C.exScuff.map(r=>({type:'Scuffed', wd:labelWD(r.week,r.day), map:r.map, drop:r.drop, place:r.placement, elim:r.elimination, total:r.total}))
  ].slice(-10);
  el('tblClutchEx').innerHTML = renderSimpleTable(ex,[
    {label:'Type',key:'type'},
    {label:'Wk/Day',key:'wd'},
    {label:'Map',key:'map'},
    {label:'Drop',key:'drop'},
    {label:'Placement',key:'place',right:true},
    {label:'Elims',key:'elim',right:true},
    {label:'Total',key:'total',right:true},
  ]);
}

/* ========= Overview render helpers ========= */
function renderKPIBox(k){
  if (!k || !k.matches) return '<div class="muted">No rows in scope.</div>';
  return `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.matches}</strong></div>
      <div class="kpi">Teams <strong>${k.teams}</strong></div>
      <div class="kpi">Tournaments <strong>${k.tourns}</strong></div>
      <div class="kpi">Years <strong>${k.years}</strong></div>
      <div class="kpi">Booyah <strong>${fmtPct(k.booyah_rate)}</strong></div>
      <div class="kpi">Elims <strong>${k.elims_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Damage <strong>${k.dmg_per_match.toFixed(0)}</strong>/m</div>
      <div class="kpi">Total <strong>${k.total_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Top3 <strong>${fmtPct(k.top3_rate)}</strong></div>
    </div>`;
}

function renderCoverageMatrix(rows){
  const years = [...new Set(rows.map(r=>r.year))].filter(Boolean).sort((a,b)=>a-b);
  const seasons = [...new Set(rows.map(r=>r.season))].filter(Boolean).sort();
  if (!years.length || !seasons.length) return '<div class="muted">No year/season coverage.</div>';
  const g = groupBy(rows, r=>`${r.year}|${r.season}`);
  const td = (y,s)=>{ const list = g.get(`${y}|${s}`)||[]; const m=list.length; const pct = Math.min(100, (m? 10+Math.log10(1+m)*30 : 0)); return `<td title="${m} rows"><div class="bar-rail"><div class="bar-fill" style="width:${pct}%"></div></div></td>`; };
  return `
    <table>
      <thead><tr><th>Year ↓ / Season →</th>${seasons.map(s=>`<th>${s}</th>`).join('')}</tr></thead>
      <tbody>
        ${years.map(y=>`<tr><td>${y}</td>${seasons.map(s=>td(y,s)).join('')}</tr>`).join('')}
      </tbody>
    </table>`;
}

function renderCoverageTournaments(rows){
  const list = byKeyStats(rows,'tournament').slice(0,12);
  if (!list.length) return '<div class="muted">No tournaments.</div>';
  return `
    <table>
      <thead><tr><th>Tournament</th><th class="right">Rows</th><th class="right">Booyah %</th><th class="right">Elims / m</th><th class="right">Total / m</th></tr></thead>
      <tbody>
        ${list.map(r=>`<tr><td>${r.key}</td><td class="right">${r.matches}</td><td class="right">${fmtPct(r.booyah_rate)}</td><td class="right">${r.elims_pm.toFixed(1)}</td><td class="right">${r.total_pm.toFixed(1)}</td></tr>`).join('')}
      </tbody>
    </table>`;
}

/* === Missing helpers added back === */
function renderLeaderboard(list, mode){
  if (!list.length) return '<div class="muted">No teams in scope.</div>';
  const cols = {
    total:  ['Total','total','total_pm'],
    booyah: ['Booyah %','booyah_rate','total_pm'],
    elims:  ['Elims / m','elims_pm','total'],
    damage: ['Damage / m','damage_pm','total']
  }[mode] || ['Total','total','total_pm'];

  const [labMain, keyMain, keyAux] = cols;
  const fmt = (key, v) =>
    key.includes('rate') ? fmtPct(v)
    : key.includes('_pm') ? Number(v).toFixed(1)
    : Number.isFinite(v) ? v : (v ?? '—');

  return `
    <table>
      <thead><tr><th>#</th><th>Team</th><th class="right">Matches</th><th class="right">${labMain}</th><th class="right">Aux</th></tr></thead>
      <tbody>
        ${list.map((r,i)=>`
          <tr>
            <td class="right">${i+1}</td>
            <td>${r.team ?? '—'}</td>
            <td class="right">${r.matches ?? 0}</td>
            <td class="right">${fmt(keyMain, r[keyMain])}</td>
            <td class="right">${fmt(keyAux, r[keyAux])}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
}

function exportCSV(filename, rows){
  if (!rows || !rows.length){ alert('No rows to export.'); return; }
  const cols = Object.keys(rows[0]);
  const escape = (s)=> {
    if (s == null) return '';
    s = String(s);
    return /(,|\n|\"|\r)/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
  };
  const head = cols.map(escape).join(',');
  const lines = rows.map(r=> cols.map(c=>escape(r[c])).join(','));
  const blob = new Blob([head+'\n'+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ========= Render All ========= */
function renderAll(){
  // Meta label
  const labels = (id)=> (el(id).value==='__ALL__' ? 'All' : el(id).value);
  const metaLbl = `Tourn: ${labels('fTourn')} • Year: ${labels('fYear')} • Season: ${labels('fSeason')} • Stage: ${labels('fStage')} • Group: ${labels('fGroup')} • Week: ${labels('fWeek')} • Day: ${labels('fDay')} • Map: ${labels('fMap')} • Team: ${labels('fTeam')} • Rows: ${ROWS.length}/${ALL.length}`;
  el('meta').textContent = metaLbl;

  // Overview
  const k = kpiDataset(ROWS);
  el('summaryA').innerHTML = `<h3>Scope Summary</h3>${renderKPIBox(k)}`;
  el('summaryB').innerHTML = `<h3>Coverage (Year × Season)</h3>${renderCoverageMatrix(ALL)}`;
  el('summaryC').innerHTML = `<h3>Coverage (Tournament)</h3>${renderCoverageTournaments(ALL)}`;

  // Leaderboards
  el('leadTotal').innerHTML  = renderLeaderboard(leaderboard(ROWS,'total'),'total');
  el('leadBooyah').innerHTML = renderLeaderboard(leaderboard(ROWS,'booyah'),'booyah');
  el('leadElims').innerHTML  = renderLeaderboard(leaderboard(ROWS,'elims'),'elims');
  el('leadDamage').innerHTML = renderLeaderboard(leaderboard(ROWS,'damage'),'damage');

  // Map/Drop by team (if a team is selected, use that; otherwise, use top by matches)
  let teamSel = el('fTeam').value;
  if (teamSel==='__ALL__'){
    const topTeam = leaderboard(ROWS,'total')[0]?.team || distinct(ROWS,'team')[0] || '';
    teamSel = topTeam;
  }
  const teamRows = ROWS.filter(r=>r.team===teamSel);
  el('labelMapTeam').textContent = `Map Performance — ${teamSel||'—'}`;
  el('labelDropTeam').textContent = `Drop Hotspots — ${teamSel||'—'}`;
  el('tblMapTeam').innerHTML = renderSimpleTable(
    teamMapPerf(teamRows),
    [ {label:'Map',key:'map'}, {label:'Matches',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblDropTeam').innerHTML = renderSimpleTable(
    teamDropPerf(teamRows, 15),
    [ {label:'Drop',key:'drop'}, {label:'Matches',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );

  // Stage / Group / Week-Day trends (from current ROWS)
  el('tblStage').innerHTML = renderSimpleTable(
    byKeyStats(ROWS,'stage'),
    [ {label:'Stage',key:'key'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblGroup').innerHTML = renderSimpleTable(
    byKeyStats(ROWS,'group'),
    [ {label:'Group',key:'key'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
  el('tblWD').innerHTML = renderSimpleTable(
    weekDayTrend(ROWS),
    [ {label:'Week/Day',key:'wd'}, {label:'Rows',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true}, {label:'Total',key:'total',right:true} ]
  );

  // BR analyses
  renderContestation(ROWS, teamSel);
  renderLoyalFlex(teamRows, teamSel);
  renderConsConvEff(teamRows);
  renderFragPlacement(teamRows, ROWS, teamSel);
  renderMomentumSpec(teamRows, teamSel);
  renderClutch(teamRows, teamSel);

  // AI prompt snapshot
  const snapshot = {
    scope_kpis: k,
    leaderboards: {
      total: leaderboard(ROWS,'total'),
      booyah: leaderboard(ROWS,'booyah'),
      elims: leaderboard(ROWS,'elims'),
      damage: leaderboard(ROWS,'damage')
    },
    team_examples: {
      team: teamSel,
      map_perf: teamMapPerf(teamRows),
      drop_perf: teamDropPerf(teamRows, 15)
    },
    stage_stats: byKeyStats(ROWS,'stage'),
    group_stats: byKeyStats(ROWS,'group'),
    week_day: weekDayTrend(ROWS)
  };
  const meta = {
    tournament: el('fTourn').value, year: el('fYear').value, season: el('fSeason').value,
    stage: el('fStage').value, group: el('fGroup').value, week: el('fWeek').value, day: el('fDay').value,
    map: el('fMap').value, team: el('fTeam').value, search: el('fSearch').value
  };
  el('aiPrompt').value = `You are an esports analyst. Analyze this Free Fire Battle Royale dataset snapshot.\n\n`+
    `Filters: Tournament=${meta.tournament||'All'}, Year=${meta.year||'All'}, Season=${meta.season||'All'}, Stage=${meta.stage||'All'}, Group=${meta.group||'All'}, Week=${meta.week||'All'}, Day=${meta.day||'All'}, Map=${meta.map||'All'}, Team=${meta.team||'All'}, Search=${meta.search||''}.\n`+
    `Tasks: 1) Summarize dataset KPIs. 2) Identify teams overperforming on Booyah/Elims/Damage. 3) Call out best/worst maps & drops by volume and per-match totals. 4) Stage/Group trends. 5) Weekly consistency and spikes. 6) 5 actionable prep notes.\n\n`+
    `JSON:\n`+JSON.stringify(snapshot,null,2);
}

/* ========= Wiring ========= */
async function initial(){
  ALL = await fetchAllRows();
  populateFilterDropdowns();
  applyFilters();
  renderAll();
}

el('applyBtn').onclick = ()=>{ applyFilters(); renderAll(); };

el('resetBtn').onclick = ()=>{
  ['fTourn','fYear','fSeason','fStage','fGroup','fWeek','fDay','fMap','fTeam'].forEach(id=>{ if(el(id)) el(id).value='__ALL__'; });
  el('fSearch').value = '';
  applyFilters(); renderAll();
};

el('exportBtn').onclick = ()=>{ exportCSV('ffbr_scope.csv', ROWS); };

el('copyPromptBtn').onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(el('aiPrompt').value||'');
    const btn = el('copyPromptBtn'); const orig=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=orig,1200);
  }catch(e){ alert('Copy failed: '+e.message); }
};

['fTourn','fYear','fSeason','fStage','fGroup','fWeek','fDay','fMap','fTeam'].forEach(id=> el(id).addEventListener('change', ()=>{ applyFilters(); renderAll(); }));
el('fSearch').addEventListener('input', ()=>{ applyFilters(); renderAll(); });

initial();
</script>
</body>
</html>
