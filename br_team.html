<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Teams</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9;
      --brand:#ffbd59; --brand2:#ff7733; --line:#313131;

      /* Compact team tiles (wrap grid, no horiz scroll) */
      --tile-w: 96px; --tile-h: 104px; --logo:44px; --code-fs:.74rem;

      /* Softer heatmap tint (brand-ish) */
      --heat-rgb: 255,189,89;   /* brand yellow */
      --heat-min: .06;          /* min alpha */
      --heat-max: .22;          /* max alpha */
      --heat-top-outline: .42;  /* alpha for top outline */
      --heat-radius: 8px;       /* rounded heatmap cells */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}

    .shell{max-width:1100px;margin:22px auto;padding:0 12px}
    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:5px 8px;font-size:.9rem}

    /* Team grid (wrap, no scroll, tiny tiles) */
    .team-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--tile-w), 1fr));
      gap:8px;
      align-items:stretch;
    }
    .team-tile{
      height:var(--tile-h);
      background:#131313;border:1px solid #2a2a2a;border-radius:10px;
      padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      cursor:pointer;transition:transform .1s ease, border-color .1s ease;overflow:hidden;
    }
    .team-tile:hover{transform:translateY(-2px);border-color:#444}
    .team-tile.active{outline:2px solid var(--brand2)}
    .team-logo{ width:var(--logo); height:var(--logo); object-fit:contain; filter:drop-shadow(0 0 8px rgba(0,0,0,.4)) }
    .team-code{ font-weight:800; font-size:var(--code-fs); line-height:1.1; letter-spacing:.2px }
    .team-tile .muted{ display:none }

    /* Controls */
    .bar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .bar label{color:var(--muted);font-size:.9rem}
    .input{background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:7px 10px}

    /* Lists */
    .list-compact{margin:0;padding-left:16px}
    .list-compact li{margin:2px 0}

    /* Collapsible */
    details.accordion{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:0;
      margin-bottom:14px;
    }
    details.accordion > summary{
      list-style:none;cursor:pointer;padding:12px 14px;color:var(--brand);font-weight:700;border-bottom:1px solid var(--line);user-select:none;
    }
    details.accordion[open] > summary{ border-bottom-color:var(--line); }
    details.accordion > .accordion-body{ padding:12px; }

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.92rem}
    thead th{background:#191919;position:sticky;top:0;text-align:left;border-radius:8px;padding:8px 6px}
    tbody tr td{border-bottom:none}
    th,td{padding:6px 6px;vertical-align:top}
    .right{text-align:right}

    /* Rounded heat cells */
    td[data-key]{ transition: background-color .18s ease, box-shadow .18s ease; border-radius: var(--heat-radius); background-clip: padding-box; }
    td.heat-top{ box-shadow: inset 0 0 0 1px rgba(var(--heat-rgb), var(--heat-top-outline)); }

    @media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Teams</h1>
  <div class="user-controls">
    <a class="btn secondary" href="dashboard.html">← Dashboard</a>
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <!-- TEAMS PICKER -->
  <div class="section">
    <h2>Select a Team</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="search" id="teamSearch" placeholder="Search team / region…" class="input" style="flex:1;max-width:420px">
    </div>
    <div id="teamGrid" class="team-grid">Loading teams…</div>
  </div>

  <!-- GLOBAL TOURNAMENT FILTER -->
  <div class="section">
    <h2>Filters</h2>
    <div class="bar">
      <label>Tournament
        <select id="gTournament" class="input" style="min-width:260px">
          <option value="__all__" selected>All tournaments</option>
        </select>
      </label>
      <button class="btn secondary" id="gTournReset">Reset</button>
    </div>
    <div class="muted" id="filterHint">—</div>
  </div>

  <!-- TEAM OVERVIEW -->
  <div class="section" id="teamHeader">
    <h2 id="teamTitle">Team Overview</h2>
    <div class="grid2">
      <div class="card" id="teamIdentity">
        <h3>Identity</h3>
        <div id="identityBody">Select a team.</div>
      </div>
      <div class="card" id="teamKPIs">
        <h3>Key KPIs</h3>
        <div id="kpiBody">—</div>
      </div>
    </div>
  </div>

  <!-- TEAM INFO -->
  <details class="accordion" id="teamInfoSection">
    <summary>Team Info</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="teamInfoBody" class="muted">—</div>
      </div>
    </div>
  </details>

  <!-- ROSTER -->
  <details class="accordion" id="teamRosterSection">
    <summary>Roster & Accolades</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="teamRosterBody" class="muted">—</div>
      </div>
    </div>
  </details>

  <!-- MAP PERFORMANCE (selected team) -->
  <details class="accordion" id="mapPerfSection" open>
    <summary>Map Performance (Selected Team)</summary>
    <div class="accordion-body">
      <div class="card" style="margin:0">
        <div id="tblMapTeam">—</div>
      </div>
    </div>
  </details>

  <!-- OVERALL PERFORMANCE (all teams) -->
  <details class="accordion" id="overallSection" open>
    <summary>Overall Performance (All Teams)</summary>
    <div class="accordion-body">
      <div class="bar">
        <label for="overallSortKey">Sort by</label>
        <select id="overallSortKey" class="input">
          <option value="total_pm" selected>Total / m</option>
          <option value="total">Total</option>
          <option value="elims_pm">Elims / m</option>
          <option value="elims">Elims</option>
          <option value="placement_pm">Placement / m</option>
          <option value="placement">Placement</option>
          <option value="booyah_rate">Booyah %</option>
          <option value="booyahs">Booyahs</option>
          <option value="matches">Matches</option>
          <option value="top3_rate">Top-3 %</option>
          <option value="team">Team (A→Z)</option>
        </select>
        <button class="btn secondary" id="overallSortDir" data-dir="desc" title="Toggle ascending/descending">Desc</button>
        <button class="btn secondary" id="overallReset">Reset</button>
      </div>
      <div class="card" style="margin:0">
        <div id="tblOverall">Loading…</div>
      </div>
    </div>
  </details>

  <!-- ALL TEAMS — PER-MAP BREAKDOWN -->
  <details class="accordion" id="perMapAllSection" open>
    <summary>All Teams — Per-Map Breakdown</summary>
    <div class="accordion-body">
      <div class="bar">
        <label for="mapFilter">Map</label>
        <select id="mapFilter" class="input" style="min-width:220px">
          <option value="__all__" selected>All maps</option>
        </select>

        <label for="perMapSortKey">Sort by</label>
        <select id="perMapSortKey" class="input">
          <option value="total_pm" selected>Total / m</option>
          <option value="total">Total</option>
          <option value="elims_pm">Elims / m</option>
          <option value="elims">Elims</option>
          <option value="placement_pm">Placement / m</option>
          <option value="placement">Placement</option>
          <option value="booyah_rate">Booyah %</option>
          <option value="booyahs">Booyahs</option>
          <option value="matches">Matches</option>
          <option value="top3_rate">Top-3 %</option>
          <option value="team">Team (A→Z)</option>
        </select>
        <button class="btn secondary" id="perMapSortDir" data-dir="desc" title="Toggle ascending/descending">Desc</button>
        <button class="btn secondary" id="perMapReset">Reset</button>
      </div>

      <div class="card" style="margin:0">
        <div id="tblPerMapAllTeams">Loading…</div>
      </div>
    </div>
  </details>
</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ========= Team Reference (18 teams) ========= */
const TEAMS = [
  { name:"AG",   fullname:"ALL GAMERS",                 region:"SEA",   logo:"https://i.imgur.com/KVvhezz.png" },
  { name:"BRU",  fullname:"BURIRAM UNITED ESPORTS",     region:"SEA",   logo:"https://i.imgur.com/ngHig8q.png" },
  { name:"CLVS", fullname:"CLEAR VISION ESPORTS",       region:"MEA",   logo:"https://i.imgur.com/AXkfYHk.png" },
  { name:"E1",   fullname:"E1 SPORTS",                  region:"BR",    logo:"https://i.imgur.com/bddVsgm.png" },
  { name:"EVOS", fullname:"EVOS DIVINE",                region:"SEA",   logo:"https://i.imgur.com/xWCHSwf.png" },
  { name:"FX",   fullname:"FLUXO",                      region:"BR",    logo:"https://i.imgur.com/OGJ5A7r.png" },
  { name:"GOW",  fullname:"GOW",                        region:"SEA",   logo:"https://i.imgur.com/CfmGEX6.png" },
  { name:"HEV",  fullname:"HEAVY",                      region:"SEA",   logo:"https://i.imgur.com/vqVyJSJ.png" },
  { name:"HS",   fullname:"HOTSHOT ESPORTS",            region:"PK",    logo:"https://i.imgur.com/f8ehquU.png" },
  { name:"NVL",  fullname:"NOVA LEGION",                region:"LATAM", logo:"https://i.imgur.com/iZmL3FT.png" },
  { name:"PE",   fullname:"P ESPORTS",                  region:"SEA",   logo:"https://i.imgur.com/kFcOez3.png" },
  { name:"R7",   fullname:"MOVISTAR R7",                region:"LATAM", logo:"https://i.imgur.com/95lg1Dp.png" },
  { name:"RC",   fullname:"RED CLIFF",                  region:"BD",    logo:"https://i.imgur.com/kX5wBEZ.png" },
  { name:"RHK",  fullname:"RED HAWKS",                  region:"BD",    logo:"https://i.imgur.com/E2MJQdH.png" },
  { name:"RRQ",  fullname:"RRQ KAZU",                   region:"SEA",   logo:"https://i.imgur.com/Afw7WMp.png" },
  { name:"FLCN", fullname:"TEAM FALCONS",               region:"SEA",   logo:"https://i.imgur.com/DwPXnv1.png" },
  { name:"TS",   fullname:"TEAM SOLID",                 region:"BR",    logo:"https://i.imgur.com/3Chm42Y.png" },
  { name:"WAG",  fullname:"WAG",                        region:"SEA",   logo:"https://i.imgur.com/EiRHnoW.png" },
];

const TEAM_BY_CODE = Object.fromEntries(TEAMS.map(t => [t.name.toLowerCase(), t]));
const TEAM_BY_NAME = Object.fromEntries(TEAMS.map(t => [t.fullname.toLowerCase(), t]));
const ALLOWED_TAGS = new Set(TEAMS.map(t => t.name.toUpperCase())); // STRICT by TAG

/* ========= Utilities ========= */
const el = (id) => document.getElementById(id);
const fmtPct = (x) => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const n = (x) => Number(x ?? 0) || 0;
const norm = (v) => (v==null ? '' : String(v).trim());
function looksLikeURL(v){ return /^https?:\/\//i.test(String(v||'')); }
function sum(arr, key){ let t=0; for(const r of arr) t += n(r[key]); return t; }
function groupBy(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }

/* Tuple comparator for latest detection (year,week,day,match,id) */
function keyTuple(r){
  return [
    Number(r.year)||0,
    Number(r.week)||0,
    Number(r.day)||0,
    Number(r.match)||0,
    Number(r.id)||0
  ];
}
function cmpTuple(a,b){
  for(let i=0;i<Math.max(a.length,b.length);i++){
    const av=a[i]??0, bv=b[i]??0;
    if(av>bv) return 1; if(av<bv) return -1;
  }
  return 0;
}

/* ========= Aggregations ========= */
function kpiDataset(rows){
  const matches = rows.length;
  const booyahs = sum(rows,'booyah');
  const total   = sum(rows,'total');
  const elims   = sum(rows,'elimination');
  const place   = sum(rows,'placement');
  const damage  = sum(rows,'damage');
  const top3    = sum(rows,'top3');
  return {
    matches,
    booyahs, elims, placement: place, total,
    booyah_rate: matches? booyahs/matches : 0,
    total_per_match: matches? total/matches : 0,
    elims_per_match: matches? elims/matches : 0,
    place_per_match: matches? place/matches : 0,
    dmg_per_match: matches? damage/matches : 0,
    top3_rate: matches? top3/matches : 0
  };
}

function teamMapPerf(rows){
  const g = groupBy(rows, r=>r.map||'—');
  const out=[];
  for (const [map, list] of g.entries()){
    const m = list.length;
    const booyahs = sum(list,'booyah');
    const elims   = sum(list,'elimination');
    const place   = sum(list,'placement');
    const total   = sum(list,'total');
    out.push({
      map, matches:m,
      booyahs, elims, placement:place, total,
      booyah_rate: m ? booyahs/m : 0,
      elims_pm:    m ? elims/m : 0,
      placement_pm:m ? place/m : 0,
      total_pm:    m ? total/m : 0
    });
  }
  return out.sort((a,b) => b.total_pm - a.total_pm || b.matches - a.matches || a.map.localeCompare(b.map));
}

/* ========= State ========= */
let ALL = [];        // rows (normalized) limited by TAG
let TEAM_ROWS = [];  // current team rows after tournament filter
let CURRENT_TEAM = null;

/* ========= Normalizer (handles tag/TAG + common alt names) ========= */
function normalizeRow(r){
  r._tag = norm(r.tag ?? r.TAG ?? '');
  // normalize optional tournament id variants if they exist
  if (r.tournament_id == null && r.tourn_id != null) r.tournament_id = r.tourn_id;
  if (r.tournament_id == null && r.tournamentId != null) r.tournament_id = r.tournamentId;

  if (r.elimination == null) r.elimination = r.elims ?? r.kills ?? 0;
  if (r.placement   == null) r.placement   = r.place ?? 0;
  if (r.top3        == null) r.top3        = r.top_3 ?? 0;
  return r;
}

/* ========= Helpers bound to TAG ========= */
function codeFromRow(r){
  const code = norm(r._tag).toUpperCase();
  return ALLOWED_TAGS.has(code) ? code : null;
}
function metaFromCode(code){
  return code ? TEAM_BY_CODE[code.toLowerCase()] : null;
}

/* ========= Fetch ffbr_data (safe select/order) ========= */
async function fetchAllRows(){
  const CHUNK = 1000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_data')
      .select('*')
      .order('year',  { ascending:true, nullsFirst:true })
      .order('week',  { ascending:true, nullsFirst:true })
      .order('day',   { ascending:true, nullsFirst:true })
      .order('match', { ascending:true, nullsFirst:true })
      .order('id',    { ascending:true })
      .range(from, from + CHUNK - 1);

    if (error){
      console.error('ffbr_data fetch failed:', error);
      break;
    }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }

  const normalized = out.map(normalizeRow);
  const limited = normalized.filter(r => ALLOWED_TAGS.has(norm(r._tag).toUpperCase()));

  if (!limited.length){
    console.warn('No rows matched ALLOWED_TAGS. First few raw rows (for debugging):', normalized.slice(0,5));
  }
  return limited;
}

/* ========= Tournament indexing & default pick ========= */
const PREFERRED_LATEST_NAME = 'ffws global finals 2025'; // force this if present

function tournamentsIndex(rows){
  // key by lower(name); keep max id and max tuple
  const map = new Map();
  for (const r of rows){
    const name = norm(r.tournament); if (!name) continue;
    const key = name.toLowerCase();
    const id  = Number(r.tournament_id);
    const tup = keyTuple(r);
    if (!map.has(key)){
      map.set(key, {
        name,
        idMax: Number.isFinite(id) ? id : -Infinity,
        tupMax: tup
      });
    } else {
      const o = map.get(key);
      if (Number.isFinite(id)) o.idMax = Math.max(o.idMax, id);
      if (cmpTuple(tup, o.tupMax) > 0) o.tupMax = tup;
    }
  }
  return map;
}

function defaultTournamentName(rows){
  const idx = tournamentsIndex(rows);
  if (!idx.size) return null;

  // 1) If preferred title exists, use it
  for (const v of idx.values()){
    if (v.name.toLowerCase() === PREFERRED_LATEST_NAME) return v.name;
  }

  // 2) Else, pick by highest tournament_id if any are finite
  const withId = Array.from(idx.values()).filter(v => Number.isFinite(v.idMax) && v.idMax !== -Infinity);
  if (withId.length){
    withId.sort((a,b)=> b.idMax - a.idMax || cmpTuple(b.tupMax, a.tupMax));
    return withId[0].name;
  }

  // 3) Else, fallback to tuple recency
  const all = Array.from(idx.values()).sort((a,b)=> cmpTuple(b.tupMax, a.tupMax));
  return all[0].name;
}

function uniqueTournaments(rows){
  const idx = tournamentsIndex(rows);
  const items = Array.from(idx.values());
  // sort by idMax desc (finite first), then tuple desc, then name
  items.sort((a,b)=>{
    const aId = Number.isFinite(a.idMax), bId = Number.isFinite(b.idMax);
    if (aId && bId){
      if (b.idMax !== a.idMax) return b.idMax - a.idMax;
      const t = cmpTuple(b.tupMax, a.tupMax); if (t) return t;
      return a.name.localeCompare(b.name);
    }
    if (aId && !bId) return -1;
    if (!aId && bId) return 1;
    const t = cmpTuple(b.tupMax, a.tupMax); if (t) return t;
    return a.name.localeCompare(b.name);
  });
  return items;
}

function populateGlobalTournament(){
  const sel = el('gTournament');
  if (!sel) return;

  const items = uniqueTournaments(ALL);
  const latest = defaultTournamentName(ALL);

  sel.innerHTML = `<option value="__all__">All tournaments</option>` +
    items.map(o=> `<option value="${o.name.replaceAll('"','&quot;')}">${o.name}</option>`).join('');

  sel.value = latest || '__all__';
  updateFilterHint();
}

function selectedTournament(){ return (el('gTournament')?.value || '__all__').trim(); }
function baseRowsByTournament(rows){
  const t = selectedTournament();
  if (t === '__all__') return rows;
  const lf = t.toLowerCase();
  return rows.filter(r => norm(r.tournament).toLowerCase() === lf);
}
function updateFilterHint(){
  const t = selectedTournament();
  const total = baseRowsByTournament(ALL).length;
  el('filterHint').textContent = t === '__all__'
    ? `Scope: All tournaments • Rows: ${total}`
    : `Scope: ${t} • Rows: ${total} • Default prefers “FFWS GLOBAL FINALS 2025”, else latest by tournament_id`;
}

/* ========= Overall & Per-Map aggregations (TAG-based) ========= */
function aggregateOverall(rows){
  const grouped = new Map(); // key: CODE (TAG)
  for (const r of rows){
    const code = codeFromRow(r);
    if (!code) continue;
    if (!grouped.has(code)) grouped.set(code, []);
    grouped.get(code).push(r);
  }
  const out = [];
  for (const [code, list] of grouped.entries()){
    const meta = metaFromCode(code);
    const m = list.length;
    if (!m || !meta) continue;
    const booyahs = sum(list,'booyah');
    const elims   = sum(list,'elimination');
    const place   = sum(list,'placement');
    const total   = sum(list,'total');
    out.push({
      team: meta.fullname,
      code: meta.name,
      region: meta.region || '—',
      matches: m,
      booyahs, elims, placement:place, total,
      booyah_rate:   booyahs/m,
      elims_pm:      elims/m,
      placement_pm:  place/m,
      total_pm:      total/m,
      top3_rate:     sum(list,'top3')/m
    });
  }
  return out;
}
function aggregateTeamsForMap(rows, mapValue){
  const perTeam = new Map(); // key: CODE (TAG)
  for (const r of rows){
    if (mapValue && mapValue !== '__all__'){
      if ((norm(r.map) || '').toLowerCase() !== mapValue.toLowerCase()) continue;
    }
    const code = codeFromRow(r);
    if (!code) continue;
    if (!perTeam.has(code)) perTeam.set(code, []);
    perTeam.get(code).push(r);
  }
  const out = [];
  for (const [code, list] of perTeam.entries()){
    const meta = metaFromCode(code);
    const m = list.length;
    if (!m || !meta) continue;
    const booyahs = sum(list,'booyah');
    const elims   = sum(list,'elimination');
    const place   = sum(list,'placement');
    const total   = sum(list,'total');
    out.push({
      team: meta.fullname,
      code: meta.name,
      region: meta.region || '—',
      matches: m,
      booyahs, elims, placement:place, total,
      booyah_rate:   booyahs/m,
      elims_pm:      elims/m,
      placement_pm:  place/m,
      total_pm:      total/m,
      top3_rate:     sum(list,'top3')/m
    });
  }
  return out;
}
function uniqueMaps(rows){
  const s = new Set();
  for (const r of rows){ const m = norm(r.map); if (m) s.add(m); }
  return Array.from(s).sort((a,b)=>a.localeCompare(b));
}
function populateMapFilter(){
  const sel = el('mapFilter');
  const current = sel.value || '__all__';
  const items = uniqueMaps(baseRowsByTournament(ALL));
  sel.innerHTML = `<option value="__all__">All maps</option>` + items.map(m=>`<option value="${m.replaceAll('"','&quot;')}">${m}</option>`).join('');
  const exists = [...sel.options].some(op => op.value === current);
  sel.value = exists ? current : '__all__';
}

/* ========= Sort helpers ========= */
function sortRowsGeneric(rows, key, dir){
  const mult = dir === 'asc' ? 1 : -1;
  return rows.sort((a,b)=>{
    if (key === 'team' || key === 'region' || key === 'code'){
      return mult * a[key].localeCompare(b[key]);
    }
    const av = Number(a[key]);
    const bv = Number(b[key]);
    if (isNaN(av) && isNaN(bv)) return 0;
    if (isNaN(av)) return 1 * mult;
    if (isNaN(bv)) return -1 * mult;
    return mult * (av - bv);
  });
}

/* ========= Table renderer ========= */
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th data-key="${c.key}" class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.format==='pct') v = isFinite(v) ? (v*100).toFixed(1)+'%' : '—';
    else if (c.format==='1d') v = isFinite(v) ? Number(v).toFixed(1) : '—';
    else if (c.format==='2d') v = isFinite(v) ? Number(v).toFixed(2) : '—';
    else if (c.format==='0d') v = isFinite(v) ? Number(v).toFixed(0) : '—';
    if (c.link && v && looksLikeURL(v)) v = `<a href="${v}" target="_blank" rel="noopener">${v}</a>`;
    return `<td data-key="${c.key}" class="${c.right?'right':''}">${(v==null||v==='')?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}

/* ========= Rounded Soft Heatmap ========= */
function applyColumnHeatmap(containerId, keys){
  const wrap = el(containerId);
  const table = wrap?.querySelector('table'); if (!table) return;

  table.querySelectorAll('td[data-key]').forEach(td=>{
    td.style.backgroundImage = 'none';
    td.style.backgroundColor = '';
    td.classList.remove('heat-top');
  });

  for (const key of keys){
    const cells = Array.from(table.querySelectorAll(`td[data-key="${key}"]`));
    if (!cells.length) continue;

    const vals = cells.map(td=>{
      const raw = (td.textContent||'').trim().replace('%','');
      const v = parseFloat(raw);
      return isFinite(v) ? v : null;
    });

    const entries = cells.map((td,i)=>({ td, v: vals[i] })).filter(x=>x.v!=null);
    if (!entries.length) continue;

    entries.sort((a,b)=> b.v - a.v);
    const n = entries.length;
    const topVal = entries[0].v;

    entries.forEach((e, idx)=>{
      const pctRank = n <= 1 ? 1 : 1 - (idx / (n - 1)); // 1 top → 0 bottom
      const eased = Math.pow(pctRank, 0.65);
      const styles = getComputedStyle(document.documentElement);
      const minA = parseFloat(styles.getPropertyValue('--heat-min')) || .06;
      const maxA = parseFloat(styles.getPropertyValue('--heat-max')) || .22;
      const alpha = minA + (maxA - minA) * eased;
      const rgb = styles.getPropertyValue('--heat-rgb') || '255,189,89';

      e.td.style.backgroundColor = `rgba(${rgb}, ${alpha.toFixed(3)})`;
      e.td.style.borderRadius = styles.getPropertyValue('--heat-radius') || '8px';
      e.td.style.backgroundClip = 'padding-box';
      if (e.v === topVal) e.td.classList.add('heat-top');
    });
  }
}

/* ========= Team Info & Roster ========= */
function uiShowTeamInfoError(msg){
  const box = document.getElementById('teamInfoBody');
  box.innerHTML = `<div class="muted" style="white-space:pre-wrap">${msg}</div>`;
}
function uiShowRosterError(msg){
  const box = document.getElementById('teamRosterBody');
  box.innerHTML = `<div class="muted" style="white-space:pre-wrap">${msg}</div>`;
}
function prettifyKey(k){
  return String(k).replace(/_/g,' ').replace(/\b\w/g, s=>s.toUpperCase());
}
async function fetchTeamInfoBy(codeRaw, nameRaw){
  const codeUp = norm(codeRaw).toUpperCase();
  const name = norm(nameRaw);
  try{
    let res = await client.from('br_team_info').select('*').eq('"Team Initials"', codeUp).limit(1);
    if (res.error) throw res.error;
    if (res.data && res.data.length) return res.data[0];
    const like = `*${name}*`;
    const tries = [
      ['team_name','ilike', like],
      ['team','ilike', like],
      ['team_code','eq', codeUp],
      ['code','eq', codeUp],
    ];
    for (const [col,op,val] of tries){
      const q = await client.from('br_team_info').select('*')[op](col, val).limit(1);
      if (q.error) continue;
      if (q.data && q.data.length) return q.data[0];
    }
  }catch(e){
    console.error('br_team_info fetch error:', e);
    uiShowTeamInfoError(`Team info error: ${e.message || e}`);
  }
  return null;
}
async function fetchPlayersBy(codeRaw, nameRaw, teamId){
  const codeUp = norm(codeRaw).toUpperCase();
  const name = norm(nameRaw);
  try{
    let res = await client.from('br_player_info').select('*').eq('"TAG"', codeUp);
    if (res.error) throw res.error;
    if (res.data && res.data.length) return res.data;
    if (teamId != null){
      const r2 = await client.from('br_player_info').select('*').eq('team_id', teamId);
      if (!r2.error && r2.data && r2.data.length) return r2.data;
    }
    const like = `*${name}*`;
    const tries = [
      ['team_name','ilike', like],
      ['team','ilike', like],
      ['team_code','eq', codeUp],
      ['code','eq', codeUp],
    ];
    for (const [col,op,val] of tries){
      const q = await client.from('br_player_info').select('*')[op](col, val);
      if (!q.error && q.data && q.data.length) return q.data;
    }
  }catch(e){
    console.error('br_player_info fetch error:', e);
    uiShowRosterError(`Player info error: ${e.message || e}`);
  }
  return [];
}
function asListHTML(val){
  const items = splitToLines(val);
  if (!items.length) return '—';
  return `<ul class="list-compact">${items.map(it=>`<li>${it}</li>`).join('')}</ul>`;
}
function splitToLines(val){
  if (val == null) return [];
  if (Array.isArray(val)) return val.flat().map(x=>String(x).trim()).filter(Boolean);
  let s = String(val).trim();
  try{
    if (/^\s*\[/.test(s)){
      const arr = JSON.parse(s);
      if (Array.isArray(arr)) return arr.flat().map(x=>String(x).trim()).filter(Boolean);
    }
  }catch{}
  s = s.replace(/[•\u2022\u00b7]/g, '\n');
  let parts = s.split(/\r?\n|;|\|/);
  if (parts.length === 1 && s.includes(',')) parts = s.split(',');
  return parts.map(x=>x.trim()).filter(Boolean);
}
function renderTeamInfo(info){
  const box = document.getElementById('teamInfoBody');
  if (!info){ box.innerHTML = '<div class="muted">No team info found.</div>'; return; }

  const keys = Object.keys(info);
  const rewardsKey = keys.find(k => k.toLowerCase() === 'rewards') || keys.find(k => /reward/i.test(k));
  const hide = new Set(['id','created_at','updated_at','code','team_code','team','team_name','logo','logo_url','photo','image','image_url']);
  const preferred = ['Team Initials','country','region','founded','coach','manager','owner','org','sponsor','hq','tagline','website','twitter','facebook','youtube','instagram','tiktok','discord'];
  if (rewardsKey) preferred.push(rewardsKey);

  const picked = [...preferred.filter(k => keys.includes(k)), ...keys.filter(k => !preferred.includes(k) && !hide.has(k))];

  const rows = picked.map(k=>{
    let v = info[k];
    if (v == null || v === '') return '';
    if (k === rewardsKey){
      v = asListHTML(v);
    } else {
      if (typeof v === 'object'){ try{ v = JSON.stringify(v); }catch{} }
      if (looksLikeURL(v)) v = `<a href="${v}" target="_blank" rel="noopener">${v}</a>`;
    }
    return `<tr><th style="width:160px;color:var(--muted);font-weight:600">${prettifyKey(k)}</th><td>${v}</td></tr>`;
  }).filter(Boolean).join('');

  const logoUrl = info.logo_url || info.logo || '';
  const maybeLogo = logoUrl ? `<div style="margin-bottom:8px"><img src="${logoUrl}" alt="team logo" style="width:84px;height:84px;object-fit:contain;border:1px solid #2a2a2a;border-radius:8px;background:#111"></div>` : '';
  box.innerHTML = `${maybeLogo}<table>${rows || '<tr><td class="muted">No visible fields.</td></tr>'}</table>`;
}
function renderRoster(players){
  const box = document.getElementById('teamRosterBody');
  if (!players || !players.length){ box.innerHTML = '<div class="muted">No players found.</div>'; return; }

  const keys = Object.keys(players[0] || {});
  const avatarKey = keys.find(k => /photo|avatar|image|picture/i.test(k)) || null;
  const ignKey    = keys.find(k => /ign|nickname|in.?game.?name|player.?name/i.test(k)) || 'name';
  const roleKey   = keys.find(k => /role|position/i.test(k)) || null;
  const countryKey= keys.find(k => /country|nation/i.test(k)) || null;
  const ageKey    = keys.find(k => /^age$/i.test(k)) || null;

  const accolKey  = keys.includes('Accolades') ? 'Accolades' : (keys.find(k => /accolade|achievement|title|awards/i.test(k)) || null);
  const formerKey = keys.find(k => /former(\s|_)?teams?/i.test(k.toLowerCase())) || null;

  const rows = players.slice().sort(
    (a,b)=> String(a[roleKey]||'').localeCompare(String(b[roleKey]||'')) || String(a[ignKey]||'').localeCompare(String(b[ignKey]||''))
  ).map(p=>{
      const avatar     = avatarKey && p[avatarKey] ? `<img class="avatar" src="${p[avatarKey]}" alt="">` : '';
      const ign        = p[ignKey] ?? '—';
      const role       = roleKey ? (p[roleKey] ?? '—') : '—';
      const country    = countryKey ? (p[countryKey] ?? '—') : '—';
      const age        = ageKey ? (p[ageKey] ?? '—') : '—';
      const accHTML    = accolKey ? asListHTML(p[accolKey]) : '—';
      const formerHTML = formerKey ? asListHTML(p[formerKey]) : '—';
      return { avatar, ign, role, country, age, formerHTML, accHTML };
    });

  box.innerHTML = renderSimpleTable(rows, [
    {label:'', key:'avatar'},
    {label:'IGN', key:'ign'},
    {label:'Role', key:'role'},
    {label:'Country', key:'country'},
    {label:'Age', key:'age', right:true},
    {label:'Former Team', key:'formerHTML'},
    {label:'Accolades', key:'accHTML'},
  ]);
}

/* ========= Render (selected team) ========= */
function renderTeamOverview(){
  if (!CURRENT_TEAM){
    el('teamTitle').textContent = 'Team Overview';
    el('identityBody').innerHTML = 'Select a team.';
    el('kpiBody').innerHTML = '—';
    el('tblMapTeam').innerHTML = '—';
    el('teamInfoBody').innerHTML = '—';
    el('teamRosterBody').innerHTML = '—';
    return;
  }
  el('teamTitle').textContent = `Team Overview — ${CURRENT_TEAM.name}`;
  el('identityBody').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${CURRENT_TEAM.logo}" alt="${CURRENT_TEAM.fullname} logo" style="width:72px;height:72px;object-fit:contain">
      <div>
        <div style="font-size:1.1rem;font-weight:800">${CURRENT_TEAM.name}</div>
        <div class="muted">${CURRENT_TEAM.fullname} • ${CURRENT_TEAM.region||'—'}</div>
      </div>
    </div>`;

  const k = kpiDataset(TEAM_ROWS);
  el('kpiBody').innerHTML = k.matches ? `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.matches}</strong></div>
      <div class="kpi">Booyahs <strong>${k.booyahs}</strong> (<strong>${fmtPct(k.booyah_rate)}</strong>)</div>
      <div class="kpi">Elims <strong>${k.elims}</strong> • <strong>${k.elims_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Placement <strong>${k.placement}</strong> • <strong>${k.place_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Damage <strong>${k.dmg_per_match.toFixed(0)}</strong>/m</div>
      <div class="kpi">Total <strong>${k.total}</strong> • <strong>${k.total_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Top3 <strong>${fmtPct(k.top3_rate)}</strong></div>
    </div>` : '<div class="muted">No rows.</div>';

  const rows = teamMapPerf(TEAM_ROWS);
  el('tblMapTeam').innerHTML = renderSimpleTable(
    rows,
    [
      {label:'Map',key:'map'},
      {label:'Matches',key:'matches',right:true},
      {label:'Booyahs',key:'booyahs',right:true},
      {label:'Elims',key:'elims',right:true},
      {label:'Placement',key:'placement',right:true},
      {label:'Total',key:'total',right:true},
      {label:'Booyah %',key:'booyah_rate',format:'pct',right:true},
      {label:'Elims / m',key:'elims_pm',format:'1d',right:true},
      {label:'Placement / m',key:'placement_pm',format:'1d',right:true},
      {label:'Total / m',key:'total_pm',format:'1d',right:true}
    ]
  );
  applyColumnHeatmap('tblMapTeam', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
}

/* ========= UI: Team grid ========= */
function renderTeamGrid(filter=''){
  const grid = el('teamGrid');
  const q = filter.trim().toLowerCase();
  const items = TEAMS.filter(t =>
    !q || t.name.toLowerCase().includes(q) || t.fullname.toLowerCase().includes(q) || (t.region||'').toLowerCase().includes(q)
  );
  if (!items.length){ grid.innerHTML = '<div class="muted">No matches.</div>'; return; }

  grid.innerHTML = items.map(t=>`
    <div class="team-tile" data-code="${t.name}" title="${t.fullname} • ${t.region||''}">
      <img class="team-logo" src="${t.logo}" alt="${t.fullname} logo" loading="lazy">
      <div class="team-code">${t.name}</div>
    </div>`).join('');

  grid.querySelectorAll('.team-tile').forEach(tile=>{
    tile.onclick = ()=>{
      const code = tile.getAttribute('data-code').toLowerCase();
      const info = TEAM_BY_CODE[code];
      if (info) {
        selectTeam(info);
        tile.scrollIntoView({ behavior:'smooth', inline:'center', block:'nearest' });
      }
    };
  });
  highlightActiveTile();
}
function highlightActiveTile(){
  const grid = el('teamGrid');
  if (!grid) return;
  [...grid.querySelectorAll('.team-tile')].forEach(div=>{
    const code = div.getAttribute('data-code');
    div.classList.toggle('active', !!CURRENT_TEAM && CURRENT_TEAM.name===code);
  });
}

/* ========= Selection (TAG-first) ========= */
async function selectTeam(teamObj){
  CURRENT_TEAM = teamObj;
  const url = new URL(window.location.href);
  url.searchParams.set('team', CURRENT_TEAM.name);
  history.replaceState(null, '', url.toString());

  const base = baseRowsByTournament(ALL);
  TEAM_ROWS = base.filter(r => (norm(r._tag).toUpperCase() || '') === teamObj.name.toUpperCase());

  renderTeamOverview();
  await loadTeamMeta(teamObj);
  highlightActiveTile();
}

/* ========= Overall (table) ========= */
function renderOverall(){
  const sortKey = el('overallSortKey')?.value || 'total_pm';
  const dir = el('overallSortDir')?.dataset?.dir || 'desc';

  const rows = aggregateOverall(baseRowsByTournament(ALL));
  sortRowsGeneric(rows, sortKey, dir);

  el('tblOverall').innerHTML = renderSimpleTable(rows, [
    {label:'Team',           key:'team'},
    {label:'Code',           key:'code'},
    {label:'Region',         key:'region'},
    {label:'Matches',        key:'matches',     right:true},
    {label:'Booyahs',        key:'booyahs',     right:true},
    {label:'Elims',          key:'elims',       right:true},
    {label:'Placement',      key:'placement',   right:true},
    {label:'Total',          key:'total',       right:true},
    {label:'Booyah %',       key:'booyah_rate', format:'pct', right:true},
    {label:'Elims / m',      key:'elims_pm',    format:'1d',  right:true},
    {label:'Placement / m',  key:'placement_pm',format:'1d',  right:true},
    {label:'Total / m',      key:'total_pm',    format:'1d',  right:true},
    {label:'Top-3 %',        key:'top3_rate',   format:'pct', right:true},
  ]);
  applyColumnHeatmap('tblOverall', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
}

/* ========= All Teams — Per-Map Breakdown ========= */
function renderPerMapAllTeams(){
  const mapSel = el('mapFilter');
  const sortKey = el('perMapSortKey')?.value || 'total_pm';
  const dir = el('perMapSortDir')?.dataset?.dir || 'desc';

  const rows = aggregateTeamsForMap(baseRowsByTournament(ALL), mapSel?.value || '__all__');
  sortRowsGeneric(rows, sortKey, dir);

  el('tblPerMapAllTeams').innerHTML = renderSimpleTable(rows, [
    {label:'Team',           key:'team'},
    {label:'Code',           key:'code'},
    {label:'Region',         key:'region'},
    {label:'Matches',        key:'matches',     right:true},
    {label:'Booyahs',        key:'booyahs',     right:true},
    {label:'Elims',          key:'elims',       right:true},
    {label:'Placement',      key:'placement',   right:true},
    {label:'Total',          key:'total',       right:true},
    {label:'Booyah %',       key:'booyah_rate', format:'pct', right:true},
    {label:'Elims / m',      key:'elims_pm',    format:'1d',  right:true},
    {label:'Placement / m',  key:'placement_pm',format:'1d',  right:true},
    {label:'Total / m',      key:'total_pm',    format:'1d',  right:true},
    {label:'Top-3 %',        key:'top3_rate',   format:'pct', right:true},
  ]);
  applyColumnHeatmap('tblPerMapAllTeams', ['total_pm','elims_pm','placement_pm','booyah_rate','matches','booyahs','elims','placement','total']);
}

/* ========= Load team meta ========= */
async function loadTeamMeta(teamObj){
  const code = (teamObj.name||'').trim();
  const name = (teamObj.fullname||'').trim();

  let info = null;
  try{ info = await fetchTeamInfoBy(code, name); }
  catch(e){ console.error('fetchTeamInfoBy threw:', e); uiShowTeamInfoError(`Team info error: ${e.message || e}`); }
  renderTeamInfo(info);

  let players = [];
  try{
    const teamId = info && (info.id ?? info.team_id);
    players = await fetchPlayersBy(code, name, teamId);
  }catch(e){
    console.error('fetchPlayersBy threw:', e);
    uiShowRosterError(`Player info error: ${e.message || e}`);
  }
  renderRoster(players);
}

/* ========= Wiring ========= */
async function initial(){
  renderTeamGrid('');
  el('teamSearch').addEventListener('input', e => renderTeamGrid(e.target.value||''));

  // Global tournament controls
  const gSel = el('gTournament');
  const gReset = el('gTournReset');
  gSel.addEventListener('change', ()=>{
    updateFilterHint();
    populateMapFilter();
    if (CURRENT_TEAM){
      const base = baseRowsByTournament(ALL);
      TEAM_ROWS = base.filter(r => (norm(r._tag).toUpperCase() || '') === CURRENT_TEAM.name.toUpperCase());
      renderTeamOverview();
    }
    renderOverall();
    renderPerMapAllTeams();
  });
  gReset.addEventListener('click', ()=>{
    // Reset to preferred name if present, else latest by tournament_id
    const preferred = defaultTournamentName(ALL);
    gSel.value = preferred || '__all__';
    gSel.dispatchEvent(new Event('change'));
  });

  // Overall controls
  const sortKey = el('overallSortKey');
  const sortDir = el('overallSortDir');
  const reset   = el('overallReset');
  sortKey.addEventListener('change', renderOverall);
  sortDir.addEventListener('click', ()=>{
    const cur = sortDir.dataset.dir === 'desc' ? 'asc' : 'desc';
    sortDir.dataset.dir = cur;
    sortDir.textContent = cur === 'desc' ? 'Desc' : 'Asc';
    renderOverall();
  });
  reset.addEventListener('click', ()=>{
    sortKey.value = 'total_pm';
    sortDir.dataset.dir = 'desc';
    sortDir.textContent = 'Desc';
    renderOverall();
  });

  // Per-map controls
  const mapSel = el('mapFilter');
  const pmKey = el('perMapSortKey');
  const pmDir = el('perMapSortDir');
  const pmReset = el('perMapReset');
  mapSel.addEventListener('change', renderPerMapAllTeams);
  pmKey.addEventListener('change', renderPerMapAllTeams);
  pmDir.addEventListener('click', ()=>{
    const cur = pmDir.dataset.dir === 'desc' ? 'asc' : 'desc';
    pmDir.dataset.dir = cur;
    pmDir.textContent = cur === 'desc' ? 'Desc' : 'Asc';
    renderPerMapAllTeams();
  });
  pmReset.addEventListener('click', ()=>{
    mapSel.value = '__all__';
    pmKey.value = 'total_pm';
    pmDir.dataset.dir = 'desc';
    pmDir.textContent = 'Desc';
    renderPerMapAllTeams();
  });

  // Load data (TAG-limited)
  ALL = await fetchAllRows();

  // Populate global tournament (DEFAULT = FFWS GLOBAL FINALS 2025 if present; else latest by tournament_id; else by tuple)
  populateGlobalTournament();
  populateMapFilter();

  // Apply default selection immediately
  el('gTournament').dispatchEvent(new Event('change'));

  // Auto-select ?team=
  const url = new URL(window.location.href);
  const qTeam = (url.searchParams.get('team')||'').trim().toLowerCase();
  if (qTeam){
    const found = TEAM_BY_CODE[qTeam] || TEAM_BY_NAME[qTeam];
    if (found) await selectTeam(found);
  }
  if (!CURRENT_TEAM && TEAMS.length) await selectTeam(TEAMS[0]);
}

initial();
</script>
</body>
</html>
