<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FFBR — Teams (Overview + Map Performance)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414; --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733; --line:#313131; --cols:6;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.1rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:var(--panel);border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn.secondary{background:#2a2a2a;color:#ddd;border:1px solid #3a3a3a}

    .shell{max-width:1100px;margin:22px auto;padding:0 12px}
    .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:14px}
    .section h2{margin:0 0 10px;color:var(--brand)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
    .card{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px;color:var(--brand2);font-size:1.0rem}
    .kpis{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .kpi{background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:5px 8px;font-size:.9rem}

    /* === Compact Logo Grid (logo remains 72×72) === */
    /* === Equal columns across breakpoints (always evenly divided) === */
.team-grid{
  --cols: 9; /* default desktop: 9 columns */
  display: grid;
  grid-template-columns: repeat(var(--cols), 1fr);
  gap: 8px;
  align-items: stretch;
}
@media (max-width: 1600px){ .team-grid{ --cols:8; } }
@media (max-width: 1400px){ .team-grid{ --cols:7; } }
@media (max-width: 1220px){ .team-grid{ --cols:6; } }
@media (max-width: 1060px){ .team-grid{ --cols:5; } }
@media (max-width: 920px){  .team-grid{ --cols:4; } }
@media (max-width: 740px){  .team-grid{ --cols:3; } }
@media (max-width: 560px){  .team-grid{ --cols:2; } }
    .team-tile{background:#131313;border:1px solid #2a2a2a;border-radius:10px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:transform .1s ease, border-color .1s ease;height:100%;}
    .team-tile:hover{transform:translateY(-2px);border-color:#444}
    .team-tile.active{outline:2px solid var(--brand2)}
    .team-logo{width:72px;height:72px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(0,0,0,.4))}
    .team-code{font-weight:800;font-size:.8rem;line-height:1.1}
    .team-name{font-size:.72rem;line-height:1.1;color:var(--muted);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .team-tile .muted{font-size:.68rem}

    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{border-bottom:1px solid #2a2a2a;padding:6px 6px;vertical-align:top}
    thead th{background:#191919;position:sticky;top:0;text-align:left}

    @media (max-width: 1100px){ :root{ --cols:5;} }
@media (max-width: 900px){ :root{ --cols:4;} }
@media (max-width: 700px){ :root{ --cols:3;} }
@media (max-width: 520px){ :root{ --cols:2;} }
@media (max-width: 360px){ :root{ --cols:1;} }
@media (max-width: 860px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>FFBR — Teams</h1>
  <div class="user-controls">
    <a class="btn secondary" href="dashboard.html">← Dashboard</a>
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <!-- TEAMS PICKER -->
  <div class="section">
    <h2>Select a Team</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="search" id="teamSearch" placeholder="Search team / region…" style="flex:1;max-width:420px;background:#121212;color:#eaeaea;border:1px solid #2a2a2a;border-radius:8px;padding:8px">
    </div>
    <div id="teamGrid" class="team-grid">Loading teams…</div>
  </div>

  <!-- TEAM OVERVIEW -->
  <div class="section" id="teamHeader">
    <h2 id="teamTitle">Team Overview</h2>
    <div class="grid2">
      <div class="card" id="teamIdentity">
        <h3>Identity</h3>
        <div id="identityBody">Select a team.</div>
      </div>
      <div class="card" id="teamKPIs">
        <h3>Key KPIs</h3>
        <div id="kpiBody">—</div>
      </div>
    </div>
  </div>

  <!-- MAP PERFORMANCE -->
  <div class="section">
    <h2>Map Performance</h2>
    <div class="card">
      <div id="tblMapTeam">—</div>
    </div>
  </div>
</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();

document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = 'index.html';
};

/* ========= Team Reference ========= */
const TEAMS = [
  { name:"AG",   fullname:"ALL GAMERS",                 region:"SEA",   logo:"https://i.imgur.com/KVvhezz.png" },
  { name:"BRU",  fullname:"BURIRAM UNITED ESPORTS",     region:"SEA",   logo:"https://i.imgur.com/ngHig8q.png" },
  { name:"CLVS", fullname:"CLEAR VISION ESPORTS",       region:"MEA",   logo:"https://i.imgur.com/AXkfYHk.png" },
  { name:"E1",   fullname:"E1 SPORTS",                  region:"BR",    logo:"https://i.imgur.com/bddVsgm.png" },
  { name:"EVOS", fullname:"EVOS DIVINE",                region:"SEA",   logo:"https://i.imgur.com/xWCHSwf.png" },
  { name:"FX",   fullname:"FLUXO",                      region:"BR",    logo:"https://i.imgur.com/OGJ5A7r.png" },
  { name:"GOW",  fullname:"GOW",                        region:"SEA",   logo:"https://i.imgur.com/CfmGEX6.png" },
  { name:"HEV",  fullname:"HEAVY",                      region:"SEA",   logo:"https://i.imgur.com/vqVyJSJ.png" },
  { name:"HS",   fullname:"HOTSHOT ESPORTS",            region:"PK",    logo:"https://i.imgur.com/f8ehquU.png" },
  { name:"NVL",  fullname:"NOVA LEGION",                region:"LATAM", logo:"https://i.imgur.com/iZmL3FT.png" },
  { name:"PE",   fullname:"P ESPORTS",                  region:"SEA",   logo:"https://i.imgur.com/kFcOez3.png" },
  { name:"R7",   fullname:"MOVISTAR R7",                region:"LATAM", logo:"https://i.imgur.com/95lg1Dp.png" },
  { name:"RC",   fullname:"RED CLIFF",                  region:"BD",    logo:"https://i.imgur.com/kX5wBEZ.png" },
  { name:"RHK",  fullname:"RED HAWKS",                  region:"BD",    logo:"https://i.imgur.com/E2MJQdH.png" },
  { name:"RRQ",  fullname:"RRQ KAZU",                   region:"SEA",   logo:"https://i.imgur.com/Afw7WMp.png" },
  { name:"FLCN", fullname:"TEAM FALCONS",               region:"SEA",   logo:"https://i.imgur.com/DwPXnv1.png" },
  { name:"TS",   fullname:"TEAM SOLID",                 region:"BR",    logo:"https://i.imgur.com/3Chm42Y.png" },
  { name:"WAG",  fullname:"WAG",                        region:"SEA",   logo:"https://i.imgur.com/EiRHnoW.png" },
];
const TEAM_BY_CODE = Object.fromEntries(TEAMS.map(t => [t.name.toLowerCase(), t]));
const TEAM_BY_NAME = Object.fromEntries(TEAMS.map(t => [t.fullname.toLowerCase(), t]));
const ALLOWED_SET = new Set(TEAMS.map(t => t.fullname.toLowerCase()));

/* ========= Utilities ========= */
const el = (id) => document.getElementById(id);
const fmtPct = (x) => isFinite(x) ? (x*100).toFixed(1)+'%' : '—';
const n = (x) => Number(x ?? 0) || 0;
const norm = (v) => (v==null ? '' : String(v).trim());
function sum(arr, key){ let t=0; for(const r of arr) t += n(r[key]); return t; }
function avg(arr, key){ return arr.length ? sum(arr,key)/arr.length : 0; }
function groupBy(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }
function renderSimpleTable(list, cols){
  if (!list.length) return '<div class="muted">No rows.</div>';
  const head = `<thead><tr>${cols.map(c=>`<th class="${c.right?'right':''}">${c.label}</th>`).join('')}</tr></thead>`;
  const body = `<tbody>${list.map(r=>`<tr>${cols.map(c=>{
    let v = r[c.key];
    if (c.format==='pct') v = fmtPct(v);
    else if (c.format==='1d') v = Number(v).toFixed(1);
    else if (c.format==='2d') v = Number(v).toFixed(2);
    else if (c.format==='0d') v = Number(v).toFixed(0);
    return `<td class="${c.right?'right':''}">${v==null?'—':v}</td>`;
  }).join('')}</tr>`).join('')}</tbody>`;
  return `<table>${head}${body}</table>`;
}

/* ========= Simple aggregations ========= */
function kpiDataset(rows){
  const matches = rows.length;
  const booyah = sum(rows,'booyah');
  const total = sum(rows,'total');
  const elims = sum(rows,'elimination');
  const damage = sum(rows,'damage');
  const top3 = sum(rows,'top3');
  return {
    matches,
    booyah_rate: matches? booyah/matches : 0,
    total_per_match: matches? total/matches : 0,
    elims_per_match: matches? elims/matches : 0,
    dmg_per_match: matches? damage/matches : 0,
    top3_rate: matches? top3/matches : 0
  };
}
function teamMapPerf(rows){
  const g = groupBy(rows, r=>r.map||'—');
  const out=[];
  for(const [map, list] of g.entries()){
    const m = list.length;
    out.push({ map, matches:m, booyah_rate:m?sum(list,'booyah')/m:0, elims_pm:m?sum(list,'elimination')/m:0, total_pm:m?sum(list,'total')/m:0 });
  }
  return out.sort((a,b)=> b.matches-a.matches || b.total_pm-a.total_pm || a.map.localeCompare(b.map));
}

/* ========= State ========= */
let ALL = [];
let TEAM_ROWS = [];
let CURRENT_TEAM = null;

/* ========= Fetch ffbr_data (paginated) ========= */
async function fetchAllRows(){
  const CHUNK = 1000;
  let from = 0;
  const out = [];
  for(;;){
    const { data, error } = await client
      .from('ffbr_data')
      .select('id, team, "group", stage, day, match, map, booyah, placement, elimination, drop, damage, total, played, top3, tag, week, tournament, year, season')
      .order('year', { ascending:true })
      .order('week', { ascending:true })
      .order('day', { ascending:true })
      .order('match', { ascending:true })
      .range(from, from + CHUNK - 1);
    if (error){ console.error('ffbr_data fetch failed:', error); break; }
    const rows = data || [];
    if (!rows.length) break;
    out.push(...rows);
    from += rows.length;
  }
  return out.filter(r => ALLOWED_SET.has((norm(r.team)||'').toLowerCase()));
}

/* ========= Render ========= */
function renderOverview(){
  if (!CURRENT_TEAM){
    el('teamTitle').textContent = 'Team Overview';
    el('identityBody').innerHTML = 'Select a team.';
    el('kpiBody').innerHTML = '—';
    el('tblMapTeam').innerHTML = '—';
    return;
  }
  el('teamTitle').textContent = `Team Overview — ${CURRENT_TEAM.fullname}`;
  el('identityBody').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${CURRENT_TEAM.logo}" alt="${CURRENT_TEAM.fullname} logo" style="width:84px;height:84px;object-fit:contain">
      <div>
        <div style="font-size:1.25rem;font-weight:800">${CURRENT_TEAM.fullname} <span class="muted">(${CURRENT_TEAM.name})</span></div>
        <div class="muted">Region: ${CURRENT_TEAM.region||'—'}</div>
      </div>
    </div>`;

  const k = kpiDataset(TEAM_ROWS);
  el('kpiBody').innerHTML = k.matches ? `
    <div class="kpis">
      <div class="kpi">Rows <strong>${k.matches}</strong></div>
      <div class="kpi">Booyah <strong>${fmtPct(k.booyah_rate)}</strong></div>
      <div class="kpi">Elims <strong>${k.elims_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Damage <strong>${k.dmg_per_match.toFixed(0)}</strong>/m</div>
      <div class="kpi">Total <strong>${k.total_per_match.toFixed(1)}</strong>/m</div>
      <div class="kpi">Top3 <strong>${fmtPct(k.top3_rate)}</strong></div>
    </div>` : '<div class="muted">No rows.</div>';

  el('tblMapTeam').innerHTML = renderSimpleTable(
    teamMapPerf(TEAM_ROWS),
    [ {label:'Map',key:'map'}, {label:'Matches',key:'matches',right:true}, {label:'Booyah %',key:'booyah_rate',format:'pct',right:true}, {label:'Elims / m',key:'elims_pm',format:'1d',right:true}, {label:'Total / m',key:'total_pm',format:'1d',right:true} ]
  );
}

/* ========= UI: Team grid ========= */
function renderTeamGrid(filter=''){
  const grid = el('teamGrid');
  const q = filter.trim().toLowerCase();
  const items = TEAMS.filter(t => !q || t.name.toLowerCase().includes(q) || t.fullname.toLowerCase().includes(q) || (t.region||'').toLowerCase().includes(q));
  if (!items.length){ grid.innerHTML = '<div class="muted">No matches.</div>'; return; }
  grid.innerHTML = items.map(t=>`
    <div class="team-tile" data-code="${t.name}">
      <img class="team-logo" src="${t.logo}" alt="${t.fullname} logo" loading="lazy">
      <div class="team-code">${t.name}</div>
      <div class="team-name">${t.fullname}</div>
      <div class="muted">${t.region||''}</div>
    </div>`).join('');
  [...grid.querySelectorAll('.team-tile')].forEach(tile=>{
    tile.onclick = ()=>{
      const code = tile.getAttribute('data-code').toLowerCase();
      const info = TEAM_BY_CODE[code];
      if (info) selectTeam(info);
    };
  });
  highlightActiveTile();
}
function highlightActiveTile(){
  const grid = el('teamGrid');
  if (!grid) return;
  [...grid.querySelectorAll('.team-tile')].forEach(div=>{
    const code = div.getAttribute('data-code');
    div.classList.toggle('active', !!CURRENT_TEAM && CURRENT_TEAM.name===code);
  });
}

/* ========= Selection ========= */
async function selectTeam(teamObj){
  CURRENT_TEAM = teamObj;
  const url = new URL(window.location.href);
  url.searchParams.set('team', CURRENT_TEAM.name);
  history.replaceState(null, '', url.toString());

  TEAM_ROWS = ALL.filter(r => (r.team||'').trim().toLowerCase() === teamObj.fullname.toLowerCase());
  renderOverview();
  highlightActiveTile();
}

/* ========= Wiring ========= */
async function initial(){
  renderTeamGrid('');
  el('teamSearch').addEventListener('input', e => renderTeamGrid(e.target.value||''));
  ALL = await fetchAllRows();

  // If URL has ?team= (code or name) select it
  const url = new URL(window.location.href);
  const qTeam = (url.searchParams.get('team')||'').trim().toLowerCase();
  if (qTeam){
    const found = TEAM_BY_CODE[qTeam] || TEAM_BY_NAME[qTeam];
    if (found) await selectTeam(found);
  }
  if (!CURRENT_TEAM && TEAMS.length) await selectTeam(TEAMS[0]);
}

initial();
</script>
</body>
</html>
