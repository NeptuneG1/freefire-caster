<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clash Squad — Passive Combos by Active</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0e0e0e; --panel:#1b1b1b; --panel2:#141414;
      --ink:#f5f5f5; --muted:#b9b9b9; --brand:#ffbd59; --brand2:#ff7733;
      --line:#313131; --good:#71d083; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:#1f1f1f;border-bottom:3px solid var(--brand);padding:14px 16px}
    h1{margin:0;font-size:1.25rem;letter-spacing:.3px;color:var(--brand)}
    .user-controls{position:absolute;right:16px;top:12px;display:flex;gap:10px;align-items:center}
    .chip{font-size:.85rem;color:#ddd}
    .btn{background:var(--brand);color:#1b1b1b;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{background:#e6a74f}
    .shell{max-width:1200px;margin:22px auto;padding:0 12px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .block{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:16px}
    .block h2{margin:0 0 10px 0;color:var(--brand)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 10px}
    .controls label{display:flex;align-items:center;gap:6px;background:var(--panel2);border:1px solid var(--line);padding:6px 8px;border-radius:8px}
    .controls select,.controls input[type="date"],.controls input[type="text"], .controls input[type="number"]{background:#212121;color:var(--brand);border:1px solid #3a3a3a;border-radius:6px;padding:6px 8px}
    .muted{color:var(--muted);font-size:.9rem}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
    thead th{background:#191919;text-align:left}
    tbody tr:hover{background:#141414}
    .wl{font-weight:700;padding:2px 8px;border-radius:999px;display:inline-block}
    .wl.W{background:#193e2b;color:var(--good);border:1px solid #245b3e}
    .wl.L{background:#401e1e;color:var(--bad);border:1px solid #6b2c2c}
    .tight{line-height:1.25}
    .caption{margin:4px 0 10px 0}
    .mono{font-variant-numeric: tabular-nums;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#111; border:1px solid #2a2a2a; margin:2px; font-size:.85rem; color:#ddd}
    .pill small{opacity:.8; font-size:.8em; margin-left:4px}
    .icons{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .icons img{width:28px; height:28px; border-radius:6px; border:1px solid #333; background:#111}
    .row-click{cursor:pointer}
    .detail td{background:#141414}
  </style>
</head>
<body>
<header>
  <h1>Clash Squad — Passive Combos by Active</h1>
  <div class="user-controls">
    <span class="chip" id="user-info">Checking login…</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="shell">
  <div class="bar">
    <a href="dashboard.html" class="btn">← Back to Dashboard</a>
    <a href="skills-report.html" class="btn">Skills Report</a>
  </div>

  <!-- FILTERS -->
  <div class="block">
    <h2>Filters</h2>
    <div class="controls">
      <label>From
        <input type="date" id="fFrom">
      </label>
      <label>To
        <input type="date" id="fTo">
      </label>
      <label>Map
        <select id="fMap">
          <option value="__ALL__">All maps</option>
          <option value="Bermuda">Bermuda</option>
          <option value="Kalahari">Kalahari</option>
          <option value="Purgatory">Purgatory</option>
          <option value="Alpine">Alpine</option>
          <option value="Nexterra">Nexterra</option>
          <option value="Solara">Solara</option>
        </select>
      </label>
      <label>Team
        <select id="fTeam"></select>
      </label>
      <label>Tournament
        <select id="fTourn"></select>
      </label>
      <label>Outcome
        <select id="fWL">
          <option value="__ALL__">All</option>
          <option value="W">Wins only</option>
          <option value="L">Losses only</option>
        </select>
      </label>
      <button class="btn" id="applyBtn">Apply</button>
    </div>
    <div class="muted" id="filterMeta">—</div>
  </div>

  <!-- ACTIVE PICKER -->
  <div class="block">
    <h2>Choose Active → See Passive Trios</h2>
    <div class="controls">
      <label>Active
        <select id="pbaActive">
          <option value="__ALL__">All actives</option>
        </select>
      </label>
      <label>Min picks
        <input type="number" id="pbaMin" value="3" min="1" step="1">
      </label>
      <label>Sort
        <select id="pbaSort">
          <option value="picks" selected>Picks</option>
          <option value="wins">Wins</option>
          <option value="winpct">Win %</option>
          <option value="name">Name</option>
        </select>
      </label>
      <label>Dir
        <select id="pbaDir">
          <option value="desc" selected>Desc</option>
          <option value="asc">Asc</option>
        </select>
      </label>
    </div>
    <div class="caption muted" id="pbaMeta">—</div>

    <h3 style="color:var(--brand2);margin:8px 0 6px">Top Passive Trios</h3>
    <table>
      <thead>
        <tr>
          <th>Active &nbsp;→&nbsp; Passive Trio</th>
          <th>Picks</th>
          <th>Wins</th>
          <th>Win %</th>
          <th>#Players</th>
          <th>#Teams</th>
          <th>Maps Used</th>
        </tr>
      </thead>
      <tbody id="triTable"></tbody>
    </table>
  </div>

  <!-- PER-PLAYER VIEW -->
  <div class="block">
    <h2>Per-Player — Passive Trios when using selected Active</h2>
    <div class="caption muted">
      Shows each player’s go-to passive trio(s) when they picked the chosen Active. Click a row to expand details.
    </div>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Active</th>
          <th>Total Picks</th>
          <th>Total Wins</th>
          <th>Win %</th>
          <th>Teams</th>
          <th>Top Trio</th>
        </tr>
      </thead>
      <tbody id="ppTable"></tbody>
    </table>
  </div>
</div>

<script>
/* ========= Supabase init + auth ========= */
const client = supabase.createClient(
  'https://gkugecflfddkpitlrmws.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdWdlY2ZsZmRka3BpdGxybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODMwNzQsImV4cCI6MjA2MTY1OTA3NH0.OgQOx9k71DDdK1yOa7VNKGSgoFD9kNGo8j-bR91zGKE'
);

(async () => {
  const { data: { session } } = await client.auth.getSession();
  if (!session) { window.location.href = "index.html"; return; }
  const ui = document.getElementById('user-info');
  if (ui && session.user?.email) ui.textContent = `Logged in as: ${session.user.email}`;
})();
document.getElementById('logoutBtn').onclick = async () => {
  await client.auth.signOut();
  window.location.href = "index.html";
};

/* ========= Utils ========= */
const PLACEHOLDER = 'https://imgur.com/AdvPwAO.png';
const fmtPct = n => isFinite(n) ? (n*100).toFixed(1)+'%' : '—';
const pct = (a,b) => b ? fmtPct(a/b) : '—';
const uniq = arr => [...new Set(arr)];
function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function parseState(val){ if(!val) return {}; if (typeof val==='object') return val; try { return JSON.parse(val); } catch(_){ return {}; } }
function pillsFromSet(setLike, maxShow=6){
  const arr = [...setLike].sort();
  const shown = arr.slice(0,maxShow).map(t=>`<span class="pill" title="${t}">${t}</span>`).join('');
  const more = arr.length>maxShow ? `<span class="pill" title="${arr.join(', ')}">+${arr.length-maxShow} more</span>` : '';
  return shown + more;
}
function pillsFromMapCount(mapCount, maxShow=6){
  const arr = [...mapCount.entries()].sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
  const shown = arr.slice(0, maxShow).map(([name,c]) => `<span class="pill" title="${name} ×${c}">${name} <small>×${c}</small></span>`).join('');
  const more = arr.length>maxShow ? `<span class="pill" title="${arr.map(([n,c])=>`${n}×${c}`).join(', ')}">+${arr.length-maxShow} more</span>` : '';
  return shown + more;
}

/* ========= State ========= */
let RAW_RECORDS = [];
let CURRENT_ROWS = [];

/* ========= DOM ========= */
const el = id => document.getElementById(id);

/* ========= Init filters ========= */
(function initFilters(){
  const today = new Date();
  const from = new Date(today); from.setDate(from.getDate()-30);
  el('fFrom').value = ymd(from);
  el('fTo').value = ymd(today);
  el('fMap').value = '__ALL__';
  el('fWL').value = '__ALL__';
  el('fTourn').innerHTML = `<option value="__ALL__">All tournaments</option>`;
})();

/* ========= Fetch & explode ========= */
async function fetchRecords(){
  const from = el('fFrom').value;
  const toRaw = el('fTo').value;
  const to = toRaw && /^\d{4}-\d{2}-\d{2}$/.test(toRaw) ? `${toRaw} 23:59:59` : toRaw;

  const map  = el('fMap').value;
  const team = el('fTeam').value || '__ALL__';
  const tourn= el('fTourn').value || '__ALL__';

  let q = client.from('draft_records')
    .select('id, match_date, game_number, team_left, team_right, team_left_score, team_right_score, map, tournament_name, state')
    .gte('match_date', from);

  if (to) q = q.lte('match_date', to);
  if (map !== '__ALL__') q = q.eq('map', map);
  if (team && team !== '__ALL__') q = q.or(`team_left.eq.${team},team_right.eq.${team}`);
  if (tourn && tourn !== '__ALL__') q = q.eq('tournament_name', tourn);
  q = q.order('match_date', { ascending:false }).order('id', { ascending:false });

  const { data, error } = await q;
  if (error) { console.error(error); alert('Failed to load records'); return []; }
  return data || [];
}

function populateTeamDropdown(records){
  const teams = new Set();
  records.forEach(r => { teams.add(r.team_left); teams.add(r.team_right); });
  const dd = el('fTeam'); const prior = dd.value || '__ALL__';
  dd.innerHTML = '';
  const all = document.createElement('option'); all.value='__ALL__'; all.textContent='All teams'; dd.appendChild(all);
  [...teams].filter(Boolean).sort().forEach(t => {
    const o=document.createElement('option'); o.value=t; o.textContent=t; dd.appendChild(o);
  });
  dd.value = prior;
}
function populateTournamentDropdown(records){
  const dd = el('fTourn'); const prior = dd.value || '__ALL__';
  const tourns = new Set(); let latest = null;
  records.forEach(r => {
    const tn = r.tournament_name; if (!tn) return;
    tourns.add(tn);
    if (!latest || (String(r.match_date) > String(latest.date))) latest = { name: tn, date: r.match_date };
  });
  dd.innerHTML = '';
  const all = document.createElement('option'); all.value='__ALL__'; all.textContent='All tournaments'; dd.appendChild(all);
  [...tourns].sort().forEach(tn => { const o=document.createElement('option'); o.value=tn; o.textContent=tn; dd.appendChild(o); });
  dd.value = prior;
}

function explodeRecordToRows(rec){
  const s = parseState(rec.state);
  const picks    = Array.isArray(s.picks)       ? s.picks       : [];
  const passives = Array.isArray(s.passives)    ? s.passives    : [];
  const bans     = Array.isArray(s.bans)        ? s.bans        : [];
  const names    = Array.isArray(s.playerCards) ? s.playerCards : [];

  const leftWin  = (rec.team_left_score ?? 0) > (rec.team_right_score ?? 0);
  const rightWin = (rec.team_right_score ?? 0) > (rec.team_left_score ?? 0);

  function sideRow(side){
    const isLeft = side==='L';
    const team   = isLeft ? rec.team_left : rec.team_right;
    const opp    = isLeft ? rec.team_right : rec.team_left;
    const tScore = isLeft ? rec.team_left_score : rec.team_right_score;
    const oScore = isLeft ? rec.team_right_score : rec.team_left_score;
    const res    = (isLeft ? leftWin : rightWin) ? 'W' : 'L';

    const idx = isLeft ? [0,1,2,3] : [7,6,5,4];

    const actives = idx.map((i, k) => {
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const heroObj= (picks[i] && typeof picks[i] === 'object') ? picks[i] : null;
      return { player, hero: heroObj?.name || '', heroImg: heroObj?.image_url || PLACEHOLDER };
    });

    const passiveLines = idx.map((i, k) => {
      const player = (names[i] && String(names[i]).trim()) ? names[i].trim() : `P${k+1}`;
      const trioRaw = Array.isArray(passives[i]) ? passives[i] : [];
      const trioObjs = trioRaw.filter(Boolean).map(ps => ({
        name: ps?.name || '',
        img : ps?.image_url || PLACEHOLDER
      }));
      while (trioObjs.length < 3) trioObjs.push({name:'', img: PLACEHOLDER});
      return { player, trio: trioObjs.slice(0,3) };
    });

    return {
      rec_id: rec.id,
      match_date: rec.match_date,
      game_number: rec.game_number,
      map: rec.map,
      team, opponent: opp,
      team_score: tScore ?? 0,
      opp_score: oScore ?? 0,
      result: res,
      actives,
      passives: passiveLines
    };
  }
  return [sideRow('L'), sideRow('R')];
}

function applyRowFilters(allRows){
  const wl = el('fWL').value;
  const team = el('fTeam').value || '__ALL__';
  let rows = allRows.slice();
  if (team !== '__ALL__') rows = rows.filter(r => r.team === team);
  if (wl !== '__ALL__') rows = rows.filter(r => r.result === wl);
  return rows;
}

/* ========= Build passive-combo events ========= */
function normalizeTrio(trio){
  const names = (trio||[]).map(x => (x?.name||'').trim()).filter(Boolean);
  if (names.length !== 3) return null;
  const imgs = {}; trio.forEach(x => { if (x?.name) imgs[x.name] = x.image_url || PLACEHOLDER; });
  const sorted = [...names].sort((a,b)=>a.localeCompare(b));
  return { key: sorted.join('|'), names: sorted, imgs };
}

function buildPassiveEvents(rows){
  // One event per player-slot: {active, trioKey, trioNames, trioImgs, player, team, map, won, heroImg, match}
  const events = [];
  rows.forEach(r=>{
    r.actives.forEach(a=>{
      const p = r.passives.find(x=>x.player===a.player);
      const trio = normalizeTrio(p?.trio || []);
      if (!a.hero || !trio) return;
      events.push({
        active: a.hero,
        heroImg: a.heroImg || PLACEHOLDER,
        trioKey: trio.key,
        trioNames: trio.names,
        trioImgs: trio.imgs,
        player: a.player || '',
        team: r.team,
        map: r.map || '—',
        won: r.result==='W',
        match: {
          date: r.match_date, game: r.game_number, map: r.map,
          team: r.team, opp: r.opponent, ts: r.team_score, os: r.opp_score, res: r.result
        }
      });
    });
  });
  return events;
}

/* ========= Populate Active dropdown ========= */
function populateActiveDropdown(rows){
  const actives = uniq(rows.flatMap(r=>r.actives.map(a=>a.hero).filter(Boolean))).sort();
  const dd = el('pbaActive');
  const prior = dd.value || '__ALL__';
  dd.innerHTML = `<option value="__ALL__">All actives</option>` + actives.map(a=>`<option value="${a}">${a}</option>`).join('');
  dd.value = prior;
}

/* ========= Aggregations ========= */
function matchLineHTML(m){
  const score = `${m.ts}-${m.os}`;
  return `<li>
    <strong>${m.team}</strong> vs ${m.opp}
    • <em>${m.map}</em> • Game ${m.game}
    • <span class="wl ${m.res}">${m.res}</span>
    • ${score}
    <span class="muted">(${m.date})</span>
  </li>`;
}

function renderTrios(events){
  const activeSel = el('pbaActive').value;
  const min = Math.max(1, parseInt(el('pbaMin').value||'1',10));
  const sort = el('pbaSort').value;
  const dir  = el('pbaDir').value;

  const filtered = (activeSel==='__ALL__') ? events : events.filter(e=>e.active===activeSel);

  // key = active||trioKey
  const combos = new Map();
  filtered.forEach(e=>{
    const key = e.active + '||' + e.trioKey;
    if (!combos.has(key)){
      combos.set(key, {
        active: e.active, heroImg: e.heroImg,
        trioKey: e.trioKey, trioNames: e.trioNames, trioImgs: e.trioImgs,
        picks:0, wins:0, players: new Set(), teams: new Set(), maps: new Map(), matches: []
      });
    }
    const C = combos.get(key);
    C.picks += 1;
    if (e.won) C.wins += 1;
    C.players.add(e.player);
    C.teams.add(e.team);
    C.maps.set(e.map, (C.maps.get(e.map)||0)+1);
    C.matches.push(e.match);
  });

  let rows = [...combos.values()].filter(c=>c.picks>=min).map(c=>({
    ...c, winpct: c.picks ? (c.wins/c.picks) : 0
  }));

  const sgn = (dir==='asc')?1:-1;
  rows.sort((a,b)=>{
    if (sort==='name'){
      const A = (a.active + '|' + a.trioNames.join('·')).toLowerCase();
      const B = (b.active + '|' + b.trioNames.join('·')).toLowerCase();
      return sgn * A.localeCompare(B);
    }
    if (sort==='wins') return sgn * (a.wins - b.wins);
    if (sort==='winpct') return sgn * (a.winpct - b.winpct);
    return sgn * (a.picks - b.picks);
  });

  const tbody = el('triTable'); tbody.innerHTML='';
  if (!rows.length){
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=7; td.className='muted'; td.textContent='No passive trio data for your selection.'; tr.appendChild(td);
    tbody.appendChild(tr);
  } else {
    rows.forEach((c, idx)=>{
      const id = 'tri_' + (c.active+'_'+c.trioKey).replace(/[^a-z0-9]+/gi,'_').toLowerCase() + '_' + idx;
      const activeIcon = `<img src="${c.heroImg||PLACEHOLDER}" alt="${c.active}" title="${c.active}" loading="lazy" style="width:28px;height:28px;border-radius:6px;border:1px solid #333;background:#111">`;
      const trioIcons = c.trioNames.map(n=>`<img src="${(c.trioImgs[n]||PLACEHOLDER)}" alt="${n}" title="${n}" loading="lazy">`).join('');
      const tr = document.createElement('tr');
      tr.className = 'row-click';
      tr.dataset.target = id;
      tr.innerHTML = `
        <td>
          <div class="icons" style="margin-bottom:4px">${activeIcon}<span class="muted">→</span>${trioIcons}</div>
          <div class="muted">${c.active} → ${c.trioNames.join(' · ')}</div>
        </td>
        <td class="mono">${c.picks}</td>
        <td class="mono">${c.wins}</td>
        <td class="mono">${fmtPct(c.winpct)}</td>
        <td class="mono">${c.players.size}</td>
        <td class="mono">${c.teams.size}</td>
        <td>${pillsFromMapCount(c.maps)}</td>
      `;
      tbody.appendChild(tr);

      const dr = document.createElement('tr');
      dr.className = 'detail';
      dr.id = id;
      dr.style.display = 'none';
      dr.innerHTML = `
        <td colspan="7">
          <div class="muted" style="margin-bottom:6px;">${c.matches.length} occurrence(s)</div>
          <ul style="margin:0; padding-left:18px; line-height:1.35;">
            ${c.matches.map(matchLineHTML).join('')}
          </ul>
        </td>`;
      tbody.appendChild(dr);
    });

    tbody.querySelectorAll('tr.row-click').forEach(row=>{
      row.addEventListener('click', ()=>{
        const d = document.getElementById(row.dataset.target);
        if (d) d.style.display = (d.style.display==='none' ? '' : 'none');
      });
    });
  }

  const actLabel = (activeSel==='__ALL__') ? 'All actives' : activeSel;
  el('pbaMeta').textContent = `${rows.length} trio row(s) • Active: ${actLabel}`;
}

/* ========= Per-player rendering ========= */
function renderPerPlayer(events){
  const activeSel = el('pbaActive').value; // if ALL, we still show per-player across all actives
  const filtered = (activeSel==='__ALL__') ? events : events.filter(e=>e.active===activeSel);

  // group key: player||active
  const groups = new Map();
  filtered.forEach(e=>{
    const key = e.player + '||' + e.active;
    if (!groups.has(key)){
      groups.set(key, {
        player: e.player, active: e.active, teams: new Set(),
        picks:0, wins:0, trios: new Map()
      });
    }
    const G = groups.get(key);
    G.picks += 1; if (e.won) G.wins += 1;
    G.teams.add(e.team);

    if (!G.trios.has(e.trioKey)){
      G.trios.set(e.trioKey, {
        names: e.trioNames, imgs: e.trioImgs, picks:0, wins:0, maps:new Map(), matches:[]
      });
    }
    const T = G.trios.get(e.trioKey);
    T.picks += 1; if (e.won) T.wins += 1;
    T.maps.set(e.map, (T.maps.get(e.map)||0)+1);
    T.matches.push(e.match);
  });

  // rows
  const tbody = el('ppTable'); tbody.innerHTML='';
  if (!groups.size){
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=7; td.className='muted'; td.textContent='No player rows for this selection.'; tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  const rows = [...groups.values()].map(G=>{
    // find top trio by picks (then wins)
    const allTrios = [...G.trios.values()].map(T=>({ ...T, winpct: T.picks ? (T.wins/T.picks) : 0 }));
    allTrios.sort((a,b)=> (b.picks - a.picks) || (b.wins - a.wins));
    const top = allTrios[0] || null;
    return {
      player: G.player,
      active: G.active,
      teams: G.teams,
      picks: G.picks,
      wins: G.wins,
      winpct: G.picks ? (G.wins/G.picks) : 0,
      topTrio: top,
      allTrios
    };
  }).sort((a,b)=> (b.picks - a.picks) || a.player.localeCompare(b.player) );

  rows.forEach((R, idx)=>{
    const id = 'pp_' + (R.player+'_'+R.active).replace(/[^a-z0-9]+/gi,'_').toLowerCase() + '_' + idx;

    const topIcons = R.topTrio
      ? R.topTrio.names.map(n=>`<img src="${(R.topTrio.imgs[n]||PLACEHOLDER)}" alt="${n}" title="${n}" loading="lazy" style="width:24px;height:24px;border-radius:6px;border:1px solid #333;background:#111">`).join('')
      : '<span class="muted">—</span>';

    const tr = document.createElement('tr');
    tr.className = 'row-click';
    tr.dataset.target = id;
    tr.innerHTML = `
      <td><strong>${R.player}</strong></td>
      <td>${R.active}</td>
      <td class="mono">${R.picks}</td>
      <td class="mono">${R.wins}</td>
      <td class="mono">${fmtPct(R.winpct)}</td>
      <td>${pillsFromSet(R.teams)}</td>
      <td>
        ${R.topTrio ? `<div class="icons" style="gap:4px">${topIcons}</div><div class="muted">${R.topTrio.names.join(' · ')} (${R.topTrio.picks} picks, ${fmtPct(R.topTrio.winpct)})</div>` : '—'}
      </td>
    `;
    tbody.appendChild(tr);

    const detail = document.createElement('tr');
    detail.className = 'detail';
    detail.id = id;
    detail.style.display = 'none';
    detail.innerHTML = `
      <td colspan="7">
        <div class="muted" style="margin-bottom:6px;">All trios used by ${R.player} with ${R.active}:</div>
        <ul style="margin:0; padding-left:18px; line-height:1.35;">
          ${R.allTrios.map(T => `
            <li>
              <span class="icons" style="gap:4px; vertical-align:middle;">
                ${T.names.map(n=>`<img src="${(T.imgs[n]||PLACEHOLDER)}" alt="${n}" title="${n}" loading="lazy" style="width:20px;height:20px;border-radius:4px;border:1px solid #333;background:#111">`).join('')}
              </span>
              &nbsp; ${T.names.join(' · ')} — <strong>${T.picks}</strong> picks, <strong>${T.wins}</strong> wins
              <span class="muted">(${fmtPct(T.winpct)})</span>
              <div style="margin-top:4px">${pillsFromMapCount(T.maps, 8)}</div>
              <details style="margin-top:4px;">
                <summary class="muted" style="cursor:pointer;">Show matches</summary>
                <ul style="margin:0; padding-left:18px; line-height:1.35;">
                  ${T.matches.map(matchLineHTML).join('')}
                </ul>
              </details>
            </li>
          `).join('')}
        </ul>
      </td>
    `;
    tbody.appendChild(detail);
  });

  tbody.querySelectorAll('tr.row-click').forEach(row=>{
    row.addEventListener('click', ()=>{
      const d = document.getElementById(row.dataset.target);
      if (d) d.style.display = (d.style.display==='none' ? '' : 'none');
    });
  });
}

/* ========= Refresh & wire-up ========= */
async function refresh(){
  RAW_RECORDS = await fetchRecords();

  populateTeamDropdown(RAW_RECORDS);
  populateTournamentDropdown(RAW_RECORDS);

  const teamSel  = el('fTeam').value || '__ALL__';
  const tournSel = el('fTourn').value || '__ALL__';
  el('filterMeta').textContent =
    `Loaded ${RAW_RECORDS.length} matches • Team: ${teamSel==='__ALL__'?'All teams':teamSel} • Map: ${el('fMap').value} • Tournament: ${tournSel==='__ALL__'?'All':tournSel}`;

  const exploded = RAW_RECORDS.flatMap(explodeRecordToRows);
  CURRENT_ROWS = applyRowFilters(exploded);

  populateActiveDropdown(CURRENT_ROWS);

  const events = buildPassiveEvents(CURRENT_ROWS);
  renderTrios(events);
  renderPerPlayer(events);
}

el('applyBtn').onclick = refresh;
['pbaActive','pbaMin','pbaSort','pbaDir'].forEach(id=>{
  el(id).addEventListener('change', ()=>{
    const events = buildPassiveEvents(CURRENT_ROWS);
    renderTrios(events);
    renderPerPlayer(events);
  });
});

/* ========= First load ========= */
refresh();
</script>
</body>
</html>
